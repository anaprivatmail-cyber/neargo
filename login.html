<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hitra registracija / vpis</title>
  <link rel="stylesheet" href="assets/app.css">
</head>
<body>
  <div class="login-container">
    <h1>Prijava</h1>
    <div style="margin-bottom:18px;text-align:center;">
      <button type="button" id="loginGoogle" style="width:100%;display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 0;font-size:16px;background:#fff;border:1px solid #cfe1ee;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.04);cursor:pointer;">
        <span style="display:inline-flex;width:18px;height:18px;align-items:center;justify-content:center;">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 48 48">
            <g>
              <path fill="#4285F4" d="M24 9.5c3.54 0 6.7 1.22 9.19 3.22l6.85-6.85C35.64 2.01 30.13 0 24 0 14.73 0 6.41 5.48 2.44 13.44l8.44 6.56C12.44 13.01 17.77 9.5 24 9.5z"/>
              <path fill="#34A853" d="M46.09 24.56c0-1.54-.14-3.03-.39-4.47H24v8.47h12.44c-.54 2.77-2.17 5.12-4.62 6.7l7.19 5.59C43.99 36.01 46.09 30.77 46.09 24.56z"/>
              <path fill="#FBBC05" d="M12.88 28.5c-.41-1.22-.64-2.52-.64-3.88s.23-2.66.64-3.88l-8.44-6.56C2.16 17.99 0 21.77 0 26c0 4.23 2.16 8.01 5.44 10.82l8.44-6.56z"/>
              <path fill="#EA4335" d="M24 46c6.13 0 11.64-2.01 15.85-5.48l-7.19-5.59c-2.01 1.35-4.59 2.15-7.66 2.15-6.23 0-11.56-3.51-13.88-8.56l-8.44 6.56C6.41 42.52 14.73 48 24 48z"/>
            </g>
          </svg>
        </span>
        Google
      </button>
    </div>
    <form id="login-form">
      <input type="email" name="email" placeholder="E-poÅ¡ta" autocomplete="email" required>
      <input type="password" name="password" placeholder="Geslo" autocomplete="current-password" required>
      <div style="display:flex;gap:10px;margin-top:16px;">
        <button type="submit" id="loginBtn" style="flex:1;">Prijava</button>
        <button type="button" id="showRegisterBtn" style="flex:1;background:#fff;color:#0bbbd6;border:1px solid #0bbbd6;">Registracija</button>
      </div>
      <div id="login-message" style="color:#d64c4c;margin-top:8px;"></div>
      <div style="margin-top:14px;text-align:center;font-size:14px;">
        <a href="#" id="forgotPasswordLink" style="color:#0bbbd6;margin-right:10px">Pozabljeno geslo?</a>
      </div>
    </form>
    <div id="register-section" style="display:none;margin-top:28px;">
      <form id="register-form">
        <div style="display:flex;gap:10px;">
          <input type="text" name="firstName" placeholder="Ime" autocomplete="given-name" required style="flex:1;">
          <input type="text" name="lastName" placeholder="Priimek" autocomplete="family-name" required style="flex:1;">
        </div>
        <div style="margin-top:10px;display:flex;gap:10px;align-items:center;">
          <select name="countryCode" id="countryCodeSelect" style="width:110px;">
            <!-- EU + USA drÅ¾ave z emoji zastavicami -->
            <option value="+386">ğŸ‡¸ğŸ‡® +386 Slovenija</option>
            <option value="+385">ğŸ‡­ğŸ‡· +385 HrvaÅ¡ka</option>
            <option value="+43">ğŸ‡¦ğŸ‡¹ +43 Avstrija</option>
            <option value="+49">ğŸ‡©ğŸ‡ª +49 NemÄija</option>
            <option value="+33">ğŸ‡«ğŸ‡· +33 Francija</option>
            <option value="+39">ğŸ‡®ğŸ‡¹ +39 Italija</option>
            <option value="+34">ğŸ‡ªğŸ‡¸ +34 Å panija</option>
            <option value="+41">ğŸ‡¨ğŸ‡­ +41 Å vica</option>
            <option value="+44">ğŸ‡¬ğŸ‡§ +44 UK</option>
            <option value="+31">ğŸ‡³ğŸ‡± +31 Nizozemska</option>
            <option value="+32">ğŸ‡§ğŸ‡ª +32 Belgija</option>
            <option value="+420">ğŸ‡¨ğŸ‡¿ +420 ÄŒeÅ¡ka</option>
            <option value="+421">ğŸ‡¸ğŸ‡° +421 SlovaÅ¡ka</option>
            <option value="+36">ğŸ‡­ğŸ‡º +36 MadÅ¾arska</option>
            <option value="+48">ğŸ‡µğŸ‡± +48 Poljska</option>
            <option value="+40">ğŸ‡·ğŸ‡´ +40 Romunija</option>
            <option value="+372">ğŸ‡ªğŸ‡ª +372 Estonija</option>
            <option value="+371">ğŸ‡±ğŸ‡» +371 Latvija</option>
            <option value="+370">ğŸ‡±ğŸ‡¹ +370 Litva</option>
            <option value="+358">ğŸ‡«ğŸ‡® +358 Finska</option>
            <option value="+47">ğŸ‡³ğŸ‡´ +47 NorveÅ¡ka</option>
            <option value="+45">ğŸ‡©ğŸ‡° +45 Danska</option>
            <option value="+353">ğŸ‡®ğŸ‡ª +353 Irska</option>
            <option value="+357">ğŸ‡¨ğŸ‡¾ +357 Ciper</option>
            <option value="+356">ğŸ‡²ğŸ‡¹ +356 Malta</option>
            <option value="+351">ğŸ‡µğŸ‡¹ +351 Portugalska</option>
            <option value="+1">ğŸ‡ºğŸ‡¸ +1 USA</option>
          </select>
          <input type="tel" name="phone" placeholder="Telefonska Å¡tevilka" autocomplete="tel" required style="flex:1;">
        </div>
        <input type="email" name="email" placeholder="E-poÅ¡ta" autocomplete="email" required style="margin-top:10px;">
        <input type="password" name="password" id="registerPassword" placeholder="Geslo (min. 6 znakov)" autocomplete="new-password" required style="margin-top:10px;">
        <div id="passwordRequirements" style="margin-top:6px;font-size:13px;color:#5b6b7b;display:none;">
          <div id="reqLength" style="color:#d64c4c;">âœ— Vsaj 6 znakov</div>
        </div>
        <div style="margin-top:10px;display:flex;gap:18px;">
          <button type="button" id="smsCodeBtn" class="code-method-btn selected" style="flex:1;border:1px solid #0bbbd6;color:#0bbbd6;background:#e9f7ff;font-weight:700;">Preveri s SMS kodo</button>
          <button type="button" id="emailCodeBtn" class="code-method-btn" style="flex:1;border:1px solid #cfe1ee;color:#5b6b7b;background:#fff;font-weight:700;">Preveri z email kodo</button>
        </div>
        <div id="register-code-row" style="margin-top:10px;display:none;">
          <input type="text" name="registerCode" placeholder="Vnesite kodo" style="width:140px;">
        </div>
        <button type="submit" id="registerBtn" style="margin-top:16px;width:100%;">Registracija</button>
        <div id="register-message" style="color:#d64c4c;margin-top:8px;"></div>
        <div style="margin-top:14px;text-align:center;font-size:14px;">
          <a href="#" id="backToLoginLink" style="color:#0bbbd6;">Nazaj na prijavo</a>
        </div>
      </form>
    </div>
  </div>
  <script src="assets/app-logic.js"></script>
  <script src="assets/supabase-client.js"></script>
  <script src="assets/utils.js"></script>
  <script>
  // LOGIN LOGIKA
    const loginForm = document.getElementById('login-form');
    const loginMsg = document.getElementById('login-message');
    const registerSection = document.getElementById('register-section');
    const registerLink = document.getElementById('registerLink');
    const forgotPasswordLink = document.getElementById('forgotPasswordLink');

    function getRedirectUrl() {
      const params = new URLSearchParams(window.location.search);
      const redirect = params.get('redirect');
      if (!redirect) return '/my.html';
      if (redirect === 'organizers') return '/organizers.html';
      if (redirect === 'premium') return '/premium.html';
      if (redirect === 'my') return '/my.html';
      if (redirect === 'scans') return '/scans.html';
      return '/my.html';
    }

    loginForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const email = loginForm.querySelector('input[name="email"]').value.trim();
      const password = loginForm.querySelector('input[name="password"]').value;
      loginMsg.textContent = '';
      loginMsg.style.color = '';
      if (!email || !password) {
        loginMsg.textContent = 'Vnesite email in geslo.';
        loginMsg.style.color = '#d64c4c';
        return;
      }
      if (password.length < 6) {
        loginMsg.textContent = 'Geslo mora imeti vsaj 6 znakov.';
        loginMsg.style.color = '#d64c4c';
        return;
      }
      loginMsg.textContent = 'Prijavljam ...';
      loginMsg.style.color = '#0bbbd6';
      try {
        const { testSignInEmail } = window;
        let result = await testSignInEmail(email, password);
        if (result?.data?.user) {
          loginMsg.textContent = 'âœ… Prijava uspeÅ¡na!';
          loginMsg.style.color = '#11a67a';
          window.location.href = getRedirectUrl();
        } else {
          loginMsg.textContent = 'Napaka: ' + (result?.error?.message || 'Uporabnik ne obstaja ali je geslo napaÄno.');
          loginMsg.style.color = '#d64c4c';
        }
      } catch (e) {
        loginMsg.textContent = 'Napaka: ' + e.message;
        loginMsg.style.color = '#d64c4c';
      }
    });

    // Gumb za prikaz registracije
    const showRegisterBtn = document.getElementById('showRegisterBtn');
    showRegisterBtn.addEventListener('click', function(e) {
      e.preventDefault();
      loginForm.style.display = 'none';
      registerSection.style.display = 'block';
      loginMsg.textContent = '';
    });

    forgotPasswordLink.addEventListener('click', function(e) {
      e.preventDefault();
      loginMsg.textContent = 'Za obnovitev gesla sledite navodilom v emailu.';
      // Lahko dodamo logiko za poÅ¡iljanje emaila za obnovitev gesla
    });

    // REGISTRACIJSKA LOGIKA
    // Google gumb
    document.addEventListener('DOMContentLoaded', function() {
      const googleBtn = document.getElementById('loginGoogle');
      if (googleBtn) {
        googleBtn.innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google" style="height:18px;vertical-align:middle;margin-right:8px"> Google';
      }
      
      // Password validation UI
      const passwordInput = document.getElementById('registerPassword');
      const passwordReq = document.getElementById('passwordRequirements');
      const reqLength = document.getElementById('reqLength');
      
      if (passwordInput && passwordReq && reqLength) {
        passwordInput.addEventListener('focus', function() {
          passwordReq.style.display = 'block';
        });
        
        passwordInput.addEventListener('input', function() {
          const password = passwordInput.value;
          const lengthValid = password.length >= 6;
          
          if (lengthValid) {
            reqLength.style.color = '#11a67a';
            reqLength.textContent = 'âœ“ Vsaj 6 znakov';
          } else {
            reqLength.style.color = '#d64c4c';
            reqLength.textContent = 'âœ— Vsaj 6 znakov';
          }
        });
        
        passwordInput.addEventListener('blur', function() {
          if (passwordInput.value.length >= 6) {
            passwordReq.style.display = 'none';
          }
        });
      }
    });
    const registerForm = document.getElementById('register-form');
    const registerMsg = document.getElementById('register-message');
    const registerCodeRow = document.getElementById('register-code-row');
    const backToLoginLink = document.getElementById('backToLoginLink');
    backToLoginLink.addEventListener('click', function(e) {
      e.preventDefault();
      registerSection.style.display = 'none';
      loginForm.style.display = 'block';
      codeSent = false;
      registerCodeRow.style.display = 'none';
      registerMsg.textContent = '';
      loginMsg.textContent = '';
      registerForm.reset();
    });

  let codeSent = false;
  let codeMethod = 'sms';

    if (registerForm) {
      // Gumbi za izbiro metode kode
      const smsCodeBtn = document.getElementById('smsCodeBtn');
      const emailCodeBtn = document.getElementById('emailCodeBtn');
    async function handleCodeSend(method) {
      codeMethod = method;
      if (method === 'sms') {
        smsCodeBtn.classList.add('selected');
        smsCodeBtn.style.background = '#e9f7ff';
        smsCodeBtn.style.color = '#0bbbd6';
        smsCodeBtn.style.border = '1px solid #0bbbd6';
        emailCodeBtn.classList.remove('selected');
        emailCodeBtn.style.background = '#fff';
        emailCodeBtn.style.color = '#5b6b7b';
        emailCodeBtn.style.border = '1px solid #cfe1ee';
      } else {
        emailCodeBtn.classList.add('selected');
        emailCodeBtn.style.background = '#e9f7ff';
        emailCodeBtn.style.color = '#0bbbd6';
        emailCodeBtn.style.border = '1px solid #0bbbd6';
        smsCodeBtn.classList.remove('selected');
        smsCodeBtn.style.background = '#fff';
        smsCodeBtn.style.color = '#5b6b7b';
        smsCodeBtn.style.border = '1px solid #cfe1ee';
      }
      // PoÅ¡lji kodo in prikaÅ¾i obrazec za vnos kode
      registerMsg.textContent = 'PoÅ¡iljam kodo ...';
      registerMsg.style.color = '#0bbbd6';
      const firstName = registerForm.firstName.value.trim();
      const lastName = registerForm.lastName.value.trim();
      const countryCode = registerForm.countryCode.value;
      const phone = registerForm.phone.value.trim();
      const email = registerForm.email.value.trim();
      const password = registerForm.password.value;
      
      if (!firstName || !lastName || !phone || !email) {
        registerMsg.textContent = 'Izpolnite vsa polja.';
        registerMsg.style.color = '#d64c4c';
        return;
      }
      if (password.length < 6) {
        registerMsg.textContent = 'Geslo mora imeti vsaj 6 znakov.';
        registerMsg.style.color = '#d64c4c';
        return;
      }
      
      let res;
      try {
        if (method === 'sms') {
          res = await fetch('/.netlify/functions/send-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ method: 'sms', phone, countryCode })
          });
        } else {
          res = await fetch('/.netlify/functions/send-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ method: 'email', email })
          });
        }
        const data = await res.json();
        if (data.ok && data.codeSent) {
          codeSent = true;
          registerMsg.textContent = 'Koda je bila poslana na ' + (method === 'sms' ? 'SMS' : 'e-poÅ¡to') + '.';
          registerMsg.style.color = '#11a67a';
          registerCodeRow.style.display = '';
          registerCodeRow.style.background = '#e9f7ff';
          registerCodeRow.style.padding = '12px';
          registerCodeRow.style.borderRadius = '10px';
        } else {
          registerMsg.textContent = 'Napaka pri poÅ¡iljanju kode: ' + (data.error || 'Neznana napaka');
          registerMsg.style.color = '#d64c4c';
        }
      } catch (err) {
        registerMsg.textContent = 'Napaka: ' + err.message;
        registerMsg.style.color = '#d64c4c';
      }
    }
    smsCodeBtn.addEventListener('click', function() { handleCodeSend('sms'); });
    emailCodeBtn.addEventListener('click', function() { handleCodeSend('email'); });

      registerForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        registerMsg.textContent = '';
        const firstName = registerForm.firstName.value.trim();
        const lastName = registerForm.lastName.value.trim();
        const countryCode = registerForm.countryCode.value;
        const phone = registerForm.phone.value.trim();
        const email = registerForm.email.value.trim();
        const password = registerForm.password.value;
        const registerCode = registerForm.registerCode.value.trim();

        // Validacija
        if (!firstName || !lastName) {
          registerMsg.textContent = 'Vnesite ime in priimek.';
          return;
        }
        if (!/^\d{6,}$/.test(phone.replace(/\D/g, ''))) {
          registerMsg.textContent = 'Vnesite veljavno telefonsko Å¡tevilko.';
          return;
        }
        if (!email.match(/^[^@]+@[^@]+\.[^@]+$/)) {
          registerMsg.textContent = 'Vnesite veljaven email naslov.';
          return;
        }
        if (password.length < 6) {
          registerMsg.textContent = 'Geslo mora imeti vsaj 6 znakov.';
          return;
        }

        // PoÅ¡lji kodo, Äe Å¡e ni bila poslana
        if (!codeSent) {
          registerMsg.textContent = 'PoÅ¡iljam kodo ...';
          registerMsg.style.color = '#0bbbd6';
          let res;
          try {
            if (codeMethod === 'sms') {
              res = await fetch('/.netlify/functions/send-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ method: 'sms', phone, countryCode })
              });
            } else {
              res = await fetch('/.netlify/functions/send-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ method: 'email', email })
              });
            }
            const data = await res.json();
            if (data.ok && data.codeSent) {
              codeSent = true;
              registerMsg.textContent = 'Koda je bila poslana. Preverite ' + (codeMethod === 'sms' ? 'SMS' : 'e-poÅ¡to') + '.';
              registerMsg.style.color = '#11a67a';
              registerCodeRow.style.display = '';
              // Ozadje okenca za vpis kode
              registerCodeRow.style.background = '#e9f7ff';
              registerCodeRow.style.padding = '12px';
              registerCodeRow.style.borderRadius = '10px';
              return;
            } else {
              registerMsg.textContent = 'Napaka pri poÅ¡iljanju kode: ' + (data.error || 'Neznana napaka');
              registerMsg.style.color = '#d64c4c';
              return;
            }
          } catch (err) {
            registerMsg.textContent = 'Napaka: ' + err.message;
            registerMsg.style.color = '#d64c4c';
            return;
          }
        }

        // Preveri kodo
        if (!registerCode) {
          registerMsg.textContent = 'Vnesite prejeto kodo.';
          registerMsg.style.color = '#d64c4c';
          return;
        }
        registerMsg.textContent = 'Preverjam kodo ...';
        registerMsg.style.color = '#0bbbd6';
        try {
          let verifyRes;
          if (codeMethod === 'sms') {
            verifyRes = await fetch('/.netlify/functions/verify-code', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ phone, code: registerCode, countryCode })
            });
          } else {
            verifyRes = await fetch('/.netlify/functions/verify-code', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, code: registerCode })
            });
          }
          const verifyData = await verifyRes.json();
          if (!verifyData.ok || !verifyData.verified) {
            registerMsg.textContent = verifyData.error || 'Koda ni pravilna.';
            registerMsg.style.color = '#d64c4c';
            return;
          }
        } catch (err) {
          registerMsg.textContent = 'Napaka: ' + err.message;
          registerMsg.style.color = '#d64c4c';
          return;
        }

        // Registracija v Supabase
        registerMsg.textContent = 'Registriram ...';
        registerMsg.style.color = '#0bbbd6';
        try {
          const { testSignUpEmail } = window;
          const result = await testSignUpEmail(email, password, {
            data: {
              first_name: firstName,
              last_name: lastName,
              phone: countryCode + phone
            }
          });
          if (result?.data?.user) {
            registerMsg.textContent = 'âœ… Registracija uspeÅ¡na!';
            registerMsg.style.color = '#11a67a';
            setTimeout(() => {
              window.location.href = getRedirectUrl();
            }, 800);
          } else {
            registerMsg.textContent = 'Napaka: ' + (result?.error?.message || 'Neznana napaka.');
            registerMsg.style.color = '#d64c4c';
          }
        } catch (err) {
          registerMsg.textContent = 'Napaka: ' + err.message;
          registerMsg.style.color = '#d64c4c';
        }
      });
    }
  </script>
</body>
</html>
