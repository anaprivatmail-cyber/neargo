<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NearGo ‚Äì Statistika dogodka</title>
  <style>
    :root{
      --bg:#f6fbfe; --card:#fff; --text:#0b1b2b; --muted:#5b6b7b; --border:#e6eef7;
      --brand:#0bbbd6; --brand2:#089ab1; --ok:#107a46; --warn:#d77b00; --bad:#c84040; --shadow:0 12px 30px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}

    /* Header */
    .topbar{position:sticky; top:0; z-index:10; backdrop-filter:blur(6px);
      background: color-mix(in srgb, #ffffff 88%, transparent);
      border-bottom: 1px solid var(--border);}
    .topnav{max-width:1100px; margin:0 auto; padding:10px 14px; display:flex; align-items:center; gap:10px;}
    .brand-mini{display:flex; align-items:center; gap:10px; font-weight:900; font-size:18px; color:var(--text); text-decoration:none}
    .brand-mini svg{width:26px; height:26px}
    .topnav .spacer{flex:1}
    .topbtn{display:inline-block; padding:8px 12px; border-radius:999px; font-weight:800; text-decoration:none;}
    .topbtn.back{background:#fff; color:#0b1b2b; border:1px solid var(--border)}

    .wrap{max-width:1100px;margin:24px auto;padding:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    h1{margin:6px 0 10px;font-size:22px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,input[type=text],button{padding:10px 12px;border:1px solid var(--border);border-radius:10px;font:16px/1.4 inherit}
    button{cursor:pointer}
    .btn{border:none;border-radius:10px;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;font-weight:800;padding:10px 14px}
    .btn.link{background:#fff;color:var(--text);border:1px solid var(--border)}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    .kpi{border:1px solid var(--border);border-radius:14px;padding:14px;background:#fff}
    .kpi b{font-size:22px}
    .grid{margin-top:12px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#f8fcff}
    .badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-weight:800;font-size:12px;background:#fff;margin-right:6px}
    .warn{color:var(--warn)} .bad{color:var(--bad)} .ok{color:var(--ok)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .box{border:1px solid var(--border); border-radius:14px; padding:12px; background:#fff; margin-top:12px}
    .two{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:900px){ .two{grid-template-columns:1fr 1fr} }
    .note{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="topbar">
    <div class="topnav">
      <a href="/" class="brand-mini" aria-label="NearGo">
        <svg viewBox="0 0 32 32" aria-hidden="true">
          <defs>
            <radialGradient id="g1" cx="50%" cy="50%">
              <stop offset="0%" stop-color="#0bbbd6"/><stop offset="100%" stop-color="#7de3f0"/>
            </radialGradient>
          </defs>
        <circle cx="16" cy="16" r="12" fill="none" stroke="url(#g1)" stroke-width="2"/>
        <circle cx="16" cy="16" r="3.2" fill="#0bbbd6"/>
        </svg>
        NearGo
      </a>
      <span class="spacer"></span>
      <a href="/org-stats.html" class="topbtn back" id="btnBackStats">Nazaj</a>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h1>üìà Statistika prodaje / unovƒçitev</h1>
          <div class="muted" id="subtitle"></div>
        </div>
        <div class="row" id="controls"></div>
      </div>

      <div id="meta" style="margin-top:10px"></div>

      <div class="kpis">
        <div class="kpi"><div class="muted">Prodano (issued)</div><b id="sold">‚Äì</b></div>
        <div class="kpi"><div class="muted">Unovƒçeno</div><b id="redeemed">‚Äì</b></div>
        <div class="kpi"><div class="muted">Zadnja prodaja</div><b id="lastSale">‚Äì</b></div>
      </div>

      <div class="two">
        <!-- By type -->
        <div class="box">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <b>Po tipu (vstopnice / kuponi)</b>
            <div class="actions">
              <button class="btn link" id="btnExportCsv">Izvozi CSV</button>
              <button class="btn link" id="btnRefresh">Osve≈æi</button>
            </div>
          </div>
          <div class="grid" style="margin-top:10px">
            <table>
              <thead><tr><th>Tip</th><th>Prodano</th><th>Unovƒçeno</th></tr></thead>
              <tbody id="byType"><tr><td colspan="3" class="muted" style="padding:14px">Ni podatkov.</td></tr></tbody>
            </table>
          </div>
          <div class="note" style="margin-top:6px">
            <span class="badge">Opomba</span> ‚ÄúProdano‚Äù je ≈°tevilo izdanih kosov; ‚ÄúUnovƒçeno‚Äù je ≈°tevilo validiranih QR (status=redeemed).
          </div>
        </div>

        <!-- Funnel (opcijsko) -->
        <div class="box">
          <b>Funnel (pogledi ‚Üí kliki ‚Üí nakupi)</b>
          <div class="grid" style="margin-top:10px">
            <table>
              <thead><tr><th>Metoda</th><th>Ogledi</th><th>Kliki</th><th>Nakupi</th><th>CTR</th><th>CR</th></tr></thead>
              <tbody id="funnel">
                <tr><td colspan="6" class="muted" style="padding:14px">
                  Za ‚ÄúOgledi / Kliki‚Äù je potrebna analitika. ƒåe ≈°e ni vklopljena, glej navodila spodaj.
                </td></tr>
              </tbody>
            </table>
          </div>
          <div class="note" style="margin-top:6px">
            CTR = kliki / ogledi, CR = nakupi / kliki. ƒåe vrednosti manjkajo, je analitika ≈°e izklopljena.
          </div>
        </div>
      </div>

      <!-- Navodila za analitiko (prika≈æi le, ko ni CTR podatkov) -->
      <div id="analyticsHint" class="box" style="display:none">
        <b>Kako vklopiti CTR/funnel?</b>
        <ol class="note">
          <li>Dodaj Netlify funkcijo <code>/api/analytics</code> (glej korake spodaj) in tabelo <code>analytics_events</code> v Supabase.</li>
          <li>V <code>index.html</code> po renderju kartic pokliƒçi <code>/api/analytics?ev=impression&event_id=‚Ä¶</code> (throttle) in ob kliku <code>‚Ä¶&ev=click</code>.</li>
          <li>V <code>/api/sales</code> agregiraj <code>views</code> in <code>clicks</code>, vrni jih kot <code>{ funnel:{ views, clicks, purchases } }</code>.</li>
        </ol>
      </div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const qs = new URLSearchParams(location.search);
    const statsToken = (qs.get('stats')||'').trim();
    const initialEid = (qs.get('eventId')||qs.get('eid')||'').trim();
    const fmtDT = s => s ? new Date(s).toLocaleString('sl-SI', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' }) : '‚Äì';

    // Sprejmi ?k= (scanner key) in odstrani iz URL
    (function applyScannerKeyFromQuery(){
      try{
        const u = new URL(location.href);
        const k = u.searchParams.get('k');
        if(k){
          localStorage.setItem('scanner_key', k);
          u.searchParams.delete('k');
          history.replaceState({}, '', u.pathname + (u.search?('?'+u.search):''));
        }
      }catch{}
    })();

    // UI
    (function setupUI(){
      const controls = $('#controls');
      const subtitle = $('#subtitle');
      if (statsToken){
        subtitle.textContent = 'Povzetek tvojega dogodka.';
        controls.innerHTML = `<button class="btn" id="btnRefresh">Osve≈æi</button>`;
      } else {
        subtitle.textContent = 'Povzetek (po ≈æelji omeji z eventId).';
        controls.innerHTML = `
          <select id="eventIdSel" title="Izberi dogodek (eventId)" style="min-width:220px"></select>
          <button class="btn" id="btnRefresh">Osve≈æi</button>
        `;
      }
    })();

    function buildSalesUrl(){
      const p = new URLSearchParams();
      if (statsToken) p.set('stats', statsToken);
      const sel = $('#eventIdSel');
      const eid = sel ? (sel.value||'').trim() : (initialEid||'');
      if (eid) p.set('eventId', eid);
      return '/api/sales' + (p.toString() ? ('?' + p.toString()) : '');
    }

    function maybeFillEventList(list){
      const sel = $('#eventIdSel');
      if (!sel) return;
      const ids = Array.isArray(list) ? list.filter(Boolean) : [];
      if (!ids.length && !initialEid){ sel.style.display='none'; return; }
      if (initialEid && !ids.includes(initialEid)) ids.unshift(initialEid);
      sel.innerHTML = ids.map(id=>`<option value="${id}">${id}</option>`).join('');
      if (initialEid) sel.value = initialEid;
      sel.addEventListener('change', ()=> load());
    }

    function setKPIs({sold, redeemed, lastSale}){
      $('#sold').textContent     = Number.isFinite(+sold)     ? sold     : '‚Äì';
      $('#redeemed').textContent = Number.isFinite(+redeemed) ? redeemed : '‚Äì';
      $('#lastSale').textContent = lastSale ? fmtDT(lastSale) : '‚Äì';
    }

    function setByType(byType){
      const tb = $('#byType'); tb.innerHTML='';
      const kinds = Object.keys(byType||{});
      if(!kinds.length){ tb.innerHTML = '<tr><td colspan="3" class="muted" style="padding:14px">Ni podatkov.</td></tr>'; return; }
      tb.innerHTML = kinds.map(k=>{
        const g = byType[k]||{};
        return `<tr><td>${k==='ticket'?'Vstopnice':'Kuponi'}</td><td>${g.sold??0}</td><td>${g.redeemed??0}</td></tr>`;
      }).join('');
    }

    function setFunnel(f){
      const tb = $('#funnel'); tb.innerHTML='';
      if(!f || (typeof f.views==='undefined' && typeof f.clicks==='undefined' && typeof f.purchases==='undefined')){
        tb.innerHTML = `<tr><td colspan="6" class="muted" style="padding:14px">Ogledi/kliki niso na voljo (analitika ni vklopljena).</td></tr>`;
        $('#analyticsHint').style.display='block';
        return;
      }
      $('#analyticsHint').style.display='none';
      const views = +f.views||0, clicks = +f.clicks||0, purchases = +f.purchases||0;
      const ctr = views>0 ? ((clicks/views)*100).toFixed(1)+'%' : '‚Äì';
      const cr  = clicks>0 ? ((purchases/clicks)*100).toFixed(1)+'%' : '‚Äì';
      tb.innerHTML = `<tr><td>Skupaj</td><td>${views}</td><td>${clicks}</td><td>${purchases}</td><td>${ctr}</td><td>${cr}</td></tr>`;
    }

    function toCsv(data){
      // Minimalni CSV: date,sold,redeemed,byType_ticket_sold,byType_ticket_redeemed,byType_coupon_sold,byType_coupon_redeemed
      const rows = [];
      const now = new Date().toISOString();
      const bt  = data.byType || {};
      rows.push(['exported_at','sold','redeemed','last_sale','ticket_sold','ticket_red','coupon_sold','coupon_red','views','clicks','purchases']);
      rows.push([
        now, data.sold||0, data.redeemed||0, data.lastSale||'',
        (bt.ticket?.sold||0), (bt.ticket?.redeemed||0),
        (bt.coupon?.sold||0), (bt.coupon?.redeemed||0),
        (data.funnel?.views||''), (data.funnel?.clicks||''), (data.funnel?.purchases||'')
      ]);
      return rows.map(r=>r.map(x=>String(x).replace(/"/g,'""')).map(x=>/[,"]/.test(x)?`"${x}"`:x).join(',')).join('\n');
    }

    async function load(){
      const headers = {};
      const hasStats = !!statsToken;

      if (!hasStats){
        const key = (localStorage.getItem('scanner_key')||'').trim();
        if (!key){
          $('#meta').innerHTML =
            '<span class="badge warn">Manjka stats ≈æeton</span> '+
            '<span class="badge">Ni skener kljuƒça</span>';
          setKPIs({sold:null, redeemed:null, lastSale:null}); setByType({}); setFunnel(null);
          return;
        }
        headers['x-scanner-key'] = key;
      }

      const url = buildSalesUrl();

      try{
        const r = await fetch(url, { headers });
        const data = await r.json();
        if(!data.ok){ throw new Error(data.error||'Napaka'); }
        maybeFillEventList(data.eventIds || []);
        const ev = data.event || null;
        $('#meta').innerHTML = ev
          ? `<span class="badge">Dogodek</span>${ev?.title?('<b>'+ev.title+'</b> ‚Ä¢ '):''}${ev?.city||''}${ev?.start?' ‚Ä¢ '+fmtDT(ev.start):''}`
          : `<span class="badge">Dogodek</span> Povzetek`;

        setKPIs(data);
        setByType(data.byType || {});
        setFunnel(data.funnel || null);

        // CSV export
        document.getElementById('btnExportCsv').onclick = ()=>{
          const csv = toCsv(data);
          const a = document.createElement('a');
          a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
          a.download = 'neargo-stats.csv';
          a.click();
          setTimeout(()=>URL.revokeObjectURL(a.href), 0);
        };
      }catch(e){
        $('#meta').innerHTML = `<span class="badge warn">Napaka</span> ${e?.message||e}`;
        setKPIs({sold:null, redeemed:null, lastSale:null}); setByType({}); setFunnel(null);
      }
    }

    document.addEventListener('click', (e)=>{
      if (e.target?.id === 'btnRefresh'){ load(); }
    });

    // pameten "nazaj"
    (function(){
      const b=document.getElementById('btnBackStats'); if(!b) return;
      b.addEventListener('click', function(e){
        const ref = document.referrer;
        if(ref && new URL(ref).origin === location.origin){ e.preventDefault(); history.back(); }
      });
    })();

    load();
  </script>
</body>
              </html>
