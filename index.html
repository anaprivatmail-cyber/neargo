<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NearGo ‚Äì najdi dogodke blizu</title>
  <meta name="theme-color" content="#0fb7c9" />

  <!-- Leaflet za zemljevid -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --teal:#0fb7c9;
      --teal-600:#0aa6b6;
      --ink:#0e1b2b;
      --muted:#6c7a89;
      --bg:#f6fbfd;
      --card:#ffffff;
      --ring: rgba(15,183,201,.15);
      --radius:16px;
    }
    [data-theme="dark"]{
      --bg:#0b1218;
      --card:#0f1720;
      --ink:#e7f2f6;
      --muted:#9fb2bd;
      --ring: rgba(15,183,201,.25);
    }
    html,body{height:100%}
    body{
      margin:0;
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:radial-gradient(1200px 700px at 50% -200px, #e9fbff 0%, var(--bg) 55%);
      color:var(--ink);
    }
    .wrap{max-width:980px;margin:0 auto;padding:12px}

    /* Header */
    header{display:flex;align-items:center;gap:12px;padding:10px 6px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:28px;letter-spacing:.3px}
    .target{
      width:28px;height:28px;border-radius:50%;
      position:relative;display:inline-block;background:radial-gradient(circle at 50% 50%, #5ad9e6 0 40%, #1fbdd0 41% 60%, transparent 61%);
      box-shadow:0 0 0 6px var(--ring);
      animation:pulse 2.4s ease-in-out infinite;
    }
    @keyframes pulse{
      0%{box-shadow:0 0 0 6px var(--ring), 0 0 0 0 rgba(15,183,201,.25)}
      70%{box-shadow:0 0 0 12px transparent, 0 0 0 10px rgba(15,183,201,0)}
      100%{box-shadow:0 0 0 6px transparent, 0 0 0 0 rgba(15,183,201,0)}
    }

    /* Theme switch ‚Äì vodoravno, kompaktno */
    .theme{
      display:flex;align-items:center;gap:8px;margin-left:4px;margin-right:4px;color:var(--muted)
    }
    .moon{font-size:18px}
    .toggle{
      width:48px;height:26px;border-radius:20px;background:#d7e4ea;position:relative;cursor:pointer;flex:0 0 auto;
      transition:background .2s ease;
    }
    .toggle::after{
      content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;
      background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.12);transition:transform .2s ease;
    }
    body[data-theme="dark"] .toggle{background:#1c2a34}
    body[data-theme="dark"] .toggle::after{transform:translateX(22px)}

    /* Lang + CTA */
    .lang{appearance:none;border:1px solid #d6e3ea;background:var(--card);color:var(--ink);
      border-radius:999px;padding:8px 34px 8px 14px;font-weight:600}
    .lang-wrap{position:relative}
    .lang-wrap::after{
      content:"‚ñæ";position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--muted);pointer-events:none
    }
    .cta{
      background:var(--teal);color:#fff;border:0;border-radius:999px;padding:12px 20px;font-weight:800;
      box-shadow:0 8px 20px rgba(15,183,201,.25);cursor:pointer
    }

    /* Cards */
    .card{background:var(--card);border-radius:24px;padding:18px;border:1px solid #e3edf2;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    h1{font-size:32px;line-height:1.15;margin:10px 0 12px}
    h2{font-size:22px;margin:2px 0 14px}
    .muted{color:var(--muted)}

    /* Search form */
    .form-row{display:flex;flex-direction:column;gap:8px;margin:10px 0}
    .label{font-weight:800}
    input[type=text], input[type=email], input[type=url], input[type=datetime-local], select, textarea{
      width:100%;padding:14px 14px;border:1px solid #d6e3ea;border-radius:14px;background:var(--card);color:var(--ink);
      outline:none
    }
    textarea{min-height:120px;resize:vertical}
    .range{display:flex;align-items:center;gap:12px}
    input[type=range]{width:100%}
    .pill-group{display:flex;flex-wrap:wrap;gap:12px;margin:10px 0}
    .pill{padding:10px 14px;border-radius:999px;border:1px solid #d6e3ea;cursor:pointer}
    .pill.active{background:var(--teal);border-color:var(--teal);color:#fff}
    .btn{display:inline-block;background:var(--teal);color:#fff;border-radius:16px;padding:12px 20px;font-weight:800;border:0;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--ink);border:1px solid #d6e3ea}

    /* Price + ‚Ç¨ inline */
    .price-wrap{position:relative}
    .price-wrap .euro{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--muted);font-weight:700}

    /* Featured */
    .featured-list{display:grid;grid-template-columns:1fr;gap:12px}
    .feat{display:flex;gap:12px;align-items:center;border:1px solid #d6e3ea;padding:12px;border-radius:16px}
    .feat img{width:60px;height:60px;object-fit:cover;border-radius:12px;flex:0 0 auto}

    /* Map box */
    #mapBox{display:none;margin-top:12px}
    #map{height:300px;border-radius:16px;border:1px solid #d6e3ea;overflow:hidden}

    /* Tiny foot space on mobile */
    .mb8{margin-bottom:8px}

    @media (min-width:680px){
      h1{font-size:38px}
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- HEADER -->
    <header>
      <span class="target" aria-hidden="true"></span>
      <div class="brand">NearGo</div>

      <div class="theme" style="margin-left:auto">
        <span class="moon">üåô</span>
        <div id="themeToggle" class="toggle" title="Noƒçni naƒçin"></div>
      </div>

      <div class="lang-wrap">
        <select id="langSel" class="lang" aria-label="Jezik">
          <option value="SL">SL</option>
          <option value="EN">EN</option>
          <option value="DE">DE</option>
        </select>
      </div>

      <button id="btnPublishTop" class="cta">Objavi dogodek</button>
    </header>

    <!-- HERO -->
    <section class="card" style="margin-top:6px">
      <h1>Najdi <span style="color:var(--teal)">dogodke blizu</span> ‚Äî koncerti, hrana, kultura, otroci &amp; veƒç</h1>
      <p class="muted">Vtipkaj, izberi kraj ali radij in dobi≈° dogodke v izbrani okolici ‚Äî kupi vstopnico, dodaj v koledar, povabi prijatelje.</p>
      <div style="display:flex; gap:12px; flex-wrap:wrap">
        <a href="#searchBox" class="btn">Zaƒçni iskati</a>
        <button id="btnMapJump" class="btn ghost">Zemljevid</button>
      </div>
    </section>

    <!-- FEATURED -->
    <section id="featuredBox" class="card" style="margin-top:12px">
      <h2>Izpostavljeno v tvoji bli≈æini</h2>
      <div id="featuredList" class="featured-list">
        <div class="muted">Trenutno ni izpostavljenih dogodkov v bli≈æini.</div>
      </div>
    </section>

    <!-- SEARCH -->
    <section id="searchBox" class="card" style="margin-top:12px">
      <h2>Iskanje</h2>

      <div class="form-row">
        <label class="label" for="q">Kaj</label>
        <input id="q" type="text" placeholder="npr. Metallica, street food..." />
      </div>

      <div class="form-row">
        <label class="label" for="city">Kje</label>
        <input id="city" type="text" placeholder="mesto ali kraj (npr. Ljubljana)" />
      </div>

      <div class="form-row">
        <label class="label" for="radius">Oddaljenost</label>
        <div class="range">
          <input id="radius" type="range" min="1" max="250" value="30" />
          <strong><span id="radiusVal">30</span> km</strong>
        </div>
      </div>

      <div class="pill-group" id="catChips">
        <span class="pill active" data-cat="">Vse</span>
        <span class="pill" data-cat="Koncert">Koncert</span>
        <span class="pill" data-cat="Kultura">Kultura</span>
        <span class="pill" data-cat="Otroci">Otroci</span>
        <span class="pill" data-cat="Hrana">Hrana</span>
        <span class="pill" data-cat="Narava">Narava</span>
        <span class="pill" data-cat="≈†port">≈†port</span>
        <span class="pill" data-cat="Za podjetja">Za podjetja</span>
      </div>

      <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:4px">
        <button id="btnSearch" class="btn">I≈°ƒçi</button>
        <button id="btnUseLocation" class="btn ghost">Uporabi mojo trenutno lokacijo</button>
        <button id="btnMap" class="btn ghost">Zemljevid</button>
      </div>

      <div id="mapBox">
        <div id="map"></div>
      </div>

      <div id="results" class="card" style="margin-top:12px">
        <div class="muted">Ni rezultatov. Poskusi veƒçji radij ali drugo mesto.</div>
      </div>
    </section>

    <!-- SUBMIT -->
    <section id="submitBox" class="card" style="margin-top:12px">
      <h2>Objavi dogodek</h2>
      <p class="muted mb8">Objava je brezplaƒçna. * oznaƒçuje obvezna polja.</p>

      <div class="form-row"><label class="label">Ime organizatorja *</label><input id="orgName" required type="text" /></div>
      <div class="form-row"><label class="label">E-po≈°ta *</label><input id="orgEmail" required type="email" /></div>

      <div class="form-row"><label class="label">Naslov dogodka *</label><input id="evName" required type="text" /></div>

      <div class="form-row"><label class="label">Prizori≈°ƒçe / naslov *</label><input id="venue" required type="text" placeholder="npr. Kri≈æanke" /></div>

      <div class="form-row"><label class="label">Kraj / mesto *</label><input id="city2" required type="text" placeholder="npr. Ljubljana" /></div>

      <div class="form-row"><label class="label">Dr≈æava (ISO koda, npr. SI) *</label>
        <select id="country" required>
          <option value="SI" selected>SI</option>
          <option value="AT">AT</option>
          <option value="HR">HR</option>
          <option value="IT">IT</option>
          <option value="DE">DE</option>
          <option value="EN">EN</option>
        </select>
      </div>

      <div class="form-row"><label class="label">Zaƒçetek *</label><input id="start" required type="datetime-local" /></div>
      <div class="form-row"><label class="label">Konec *</label><input id="end" required type="datetime-local" /></div>

      <div class="form-row"><label class="label">Povezava za veƒç info / nakup (ƒçe obstaja)</label><input id="url" type="url" placeholder="https://‚Ä¶" /></div>

      <div class="form-row"><label class="label">Kategorija (izberi) *</label>
        <select id="category" required>
          <option value="" disabled selected>‚Äî izberi ‚Äî</option>
          <option>Koncert</option><option>Kultura</option><option>Otroci</option>
          <option>Hrana</option><option>Narava</option><option>≈†port</option><option>Za podjetja</option>
        </select>
      </div>

      <div class="form-row"><label class="label">Tip ponudbe</label>
        <select id="saleType">
          <option value="none" selected>Brez plaƒçila</option>
          <option value="ticket">Vstopnica</option>
          <option value="coupon">Kupon</option>
        </select>
      </div>

      <div class="form-row price-wrap"><label class="label">Cena</label>
        <input id="price" inputmode="decimal" type="text" placeholder="npr. 12.00" />
        <span class="euro">‚Ç¨</span>
      </div>

      <div class="form-row"><label class="label">Zaloga (≈°t. kosov)</label><input id="stock" inputmode="numeric" type="text" /></div>
      <div class="form-row"><label class="label">Max na naroƒçilo</label><input id="maxPer" inputmode="numeric" type="text" /></div>

      <div class="form-row"><label class="label">Fotografija</label>
        <input id="photo" type="file" accept="image/*" />
        <div id="photoName" class="muted"></div>
      </div>

      <div class="form-row">
        <label><input id="featured" type="checkbox" /> Izpostavi (7 dni) ‚Äì 10 ‚Ç¨</label>
      </div>

      <div class="form-row">
        <label><input id="terms" type="checkbox" required /> Strinjam se s pogoji za plaƒçljive transakcije</label>
      </div>

      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <button id="btnSubmit" class="btn">Objavi</button>
      </div>
    </section>

    <footer style="padding:30px 6px;color:var(--muted)">&copy; NearGo</footer>
  </div>

<script>
/* ====== Theme toggle ====== */
const themeToggle = document.getElementById('themeToggle');
function setTheme(t){ document.body.setAttribute('data-theme', t); localStorage.setItem('theme', t); }
setTheme(localStorage.getItem('theme') || 'light');
themeToggle.addEventListener('click', ()=> setTheme(document.body.getAttribute('data-theme')==='dark'?'light':'dark'));

/* ====== Helpers ====== */
const $ = sel => document.querySelector(sel);
const resultsEl = $('#results');
const featuredList = $('#featuredList');
const mapBox = $('#mapBox');
let map, markersLayer;
function ensureMap(){
  if (map) return;
  map = L.map('map',{ zoomControl:true }).setView([46.0569,14.5058], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OSM' }).addTo(map);
  markersLayer = L.layerGroup().addTo(map);
}
function setMarkers(items){
  ensureMap();
  markersLayer.clearLayers();
  if (!items.length) return;
  const bounds = [];
  items.forEach(it=>{
    if (!it.venue || !Number.isFinite(it.venue.lat) || !Number.isFinite(it.venue.lon)) return;
    const m = L.marker([it.venue.lat, it.venue.lon]).addTo(markersLayer);
    m.bindPopup(`<b>${(it.name||'Dogodek')}</b><br>${(it.venue.address||'')}`);
    bounds.push([it.venue.lat, it.venue.lon]);
  });
  if (bounds.length) map.fitBounds(bounds,{padding:[20,20]});
}

/* ====== Search form wiring ====== */
const qEl = $('#q'); const cityEl = $('#city'); const radiusEl = $('#radius'); const radiusVal = $('#radiusVal');
const catChips = $('#catChips'); let currentCat = '';
radiusEl.addEventListener('input', ()=> radiusVal.textContent = radiusEl.value);
catChips.addEventListener('click', (e)=>{
  const pill = e.target.closest('.pill'); if (!pill) return;
  [...catChips.children].forEach(p=>p.classList.remove('active'));
  pill.classList.add('active'); currentCat = pill.dataset.cat || '';
});

async function geocodeCity(city, country='SI'){
  const q = encodeURIComponent(`${city}, ${country}`);
  const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${q}`;
  try{
    const r = await fetch(url, { headers:{ /* User-Agent dodamo na stre≈æniku, brskalnik doda svojega */ }});
    const j = await r.json();
    if (Array.isArray(j) && j.length){
      return { lat: parseFloat(j[0].lat), lon: parseFloat(j[0].lon) };
    }
  }catch(_){}
  return null;
}

async function runSearch(useMyLoc=false){
  let center = null;
  if (useMyLoc && navigator.geolocation){
    center = await new Promise(res=>{
      navigator.geolocation.getCurrentPosition(p=>res({lat:p.coords.latitude, lon:p.coords.longitude}), _=>res(null), {enableHighAccuracy:true, timeout:8000});
    });
  } else if (cityEl.value.trim()){
    center = await geocodeCity(cityEl.value.trim(), 'SI');
  }

  const params = new URLSearchParams();
  if (qEl.value.trim()) params.set('q', qEl.value.trim());
  if (currentCat) params.set('category', currentCat);
  if (center){ params.set('latlon', `${center.lat},${center.lon}`); params.set('radiuskm', radiusEl.value); }
  params.set('size','50');

  resultsEl.innerHTML = '<div class="muted">I≈°ƒçem‚Ä¶</div>';
  try{
    const r = await fetch(`/api/search?${params.toString()}`);
    const j = await r.json();
    if (!j.ok){ resultsEl.innerHTML = `<div class="muted">Napaka: ${j.error||'neznano'}</div>`; return; }
    renderResults(j.results||[]);
    setMarkers(j.results||[]);
  }catch(e){
    resultsEl.innerHTML = `<div class="muted">Napaka pri iskanju.</div>`;
  }
}

function renderResults(items){
  if (!items.length){ resultsEl.innerHTML = '<div class="muted">Ni rezultatov. Poskusi veƒçji radij ali drugo mesto.</div>'; return; }
  resultsEl.innerHTML = items.map(it=>{
    const img = (it.images && it.images[0]) ? `<img src="${it.images[0]}" alt="" style="width:72px;height:72px;object-fit:cover;border-radius:12px;flex:0 0 auto">` : '';
    const date = it.start ? new Date(it.start).toLocaleString() : '';
    return `<div class="feat" style="margin:6px 0">${img}
      <div>
        <div style="font-weight:800">${it.name||'Dogodek'}</div>
        <div class="muted" style="font-size:14px">${it.venue?.address||''}</div>
        <div class="muted" style="font-size:13px">${date}</div>
      </div>
    </div>`;
  }).join('');
}

/* Featured near me (filter featuredUntil future) */
async function loadFeatured(){
  let center = null;
  if (navigator.geolocation){
    center = await new Promise(res=>{
      navigator.geolocation.getCurrentPosition(p=>res({lat:p.coords.latitude, lon:p.coords.longitude}), _=>res(null), {timeout:4000});
    });
  }
  const p = new URLSearchParams({ size:'50' });
  if (center){ p.set('latlon', `${center.lat},${center.lon}`); p.set('radiuskm','60'); }

  try{
    const r = await fetch(`/api/search?${p.toString()}`);
    const j = await r.json();
    if (!j.ok) return;
    const now = Date.now();
    const featured = (j.results||[]).filter(it => it.featuredUntil && Date.parse(it.featuredUntil) > now).slice(0,2);
    if (!featured.length){ featuredList.innerHTML = '<div class="muted">Trenutno ni izpostavljenih dogodkov v bli≈æini.</div>'; return; }
    featuredList.innerHTML = featured.map(it=>{
      const img = (it.images && it.images[0]) ? `<img src="${it.images[0]}" alt="">` : `<div style="width:60px;height:60px;border-radius:12px;background:#e9f6f8"></div>`;
      const date = it.start ? new Date(it.start).toLocaleDateString() : '';
      return `<div class="feat">${img}
        <div><div style="font-weight:800">${it.name||'Dogodek'}</div>
        <div class="muted" style="font-size:14px">${it.venue?.address||''}</div>
        <div class="muted" style="font-size:13px">${date}</div></div></div>`;
    }).join('');
  }catch(_){}
}

/* Buttons */
$('#btnSearch').addEventListener('click', ()=>runSearch(false));
$('#btnUseLocation').addEventListener('click', ()=>runSearch(true));
$('#btnMap').addEventListener('click', ()=>{
  mapBox.style.display = mapBox.style.display==='none'?'block':'none';
  if (mapBox.style.display==='block') ensureMap();
});
$('#btnMapJump').addEventListener('click', ()=>{
  document.querySelector('#searchBox').scrollIntoView({behavior:'smooth'});
  mapBox.style.display='block'; ensureMap();
});
$('#btnPublishTop').addEventListener('click', ()=> document.querySelector('#submitBox').scrollIntoView({behavior:'smooth'}));

/* ====== SUBMIT (upload + save) ====== */
const photo = $('#photo'); const photoName = $('#photoName');
photo.addEventListener('change', ()=> photoName.textContent = photo.files?.[0]?.name || '');
async function submitForm(){
  const need = [
    ['orgName','Ime organizatorja'],['orgEmail','E-po≈°ta'],['evName','Naslov dogodka'],
    ['venue','Prizori≈°ƒçe'],['city2','Kraj'],['country','Dr≈æava'],
    ['start','Zaƒçetek'],['end','Konec'],['category','Kategorija']
  ];
  for (const [id,label] of need){
    const el = document.getElementById(id);
    if (!String(el.value||'').trim()){ alert(`Manjka: ${label}`); el.focus(); return; }
  }
  let imagePublicUrl=null;
  if (photo.files && photo.files[0]){
    const fd = new FormData(); fd.append('file', photo.files[0]);
    const up = await fetch('/api/provider-upload',{ method:'POST', body:fd });
    const uj = await up.json(); if (uj.ok) imagePublicUrl = uj.imagePublicUrl;
  }
  const payload = {
    organizer: $('#orgName').value.trim(),
    organizerEmail: $('#orgEmail').value.trim(),
    eventName: $('#evName').value.trim(),
    venue: $('#venue').value.trim(),
    city: $('#city2').value.trim(),
    country: $('#country').value,
    start: $('#start').value, end: $('#end').value,
    url: $('#url').value.trim(),
    description: $('#evName').value.trim(), // ƒçe ≈æeli≈° loƒçeno polje, dodaj <textarea id="desc">
    category: $('#category').value,
    offerType: $('#saleType').value,
    price: $('#price').value.trim(),
    stock: $('#stock').value.trim(),
    maxPerOrder: $('#maxPer').value.trim(),
    featured: $('#featured').checked,
    imagePublicUrl
  };
  const r = await fetch('/api/provider-submit',{ method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(payload) });
  const j = await r.json();
  if (j.ok){ alert('Hvala! Dogodek je shranjen.'); runSearch(false); loadFeatured(); }
  else { alert('Napaka: '+(j.error||'neznano')); }
}
$('#btnSubmit').addEventListener('click', submitForm);

/* init */
radiusVal.textContent = radiusEl.value;
loadFeatured();
</script>
</body>
</html>
