<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Uredi ponudbo ‚Äì NearGo</title>
  <script type="module" src="/assets/categories.js"></script>
  <style>
    :root{ --bg:#f6fbfe; --card:#fff; --text:#0b1b2b; --muted:#5b6b7b; --border:#e3eef7; --brand:#0bbbd6; --shadow:0 12px 30px rgba(0,0,0,.06);}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:22px auto;padding:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    h1{margin:6px 0 10px;font-size:22px}
    label{display:block;margin:10px 0 6px;font-weight:800}
    input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);font:15px/1.4}
    textarea{min-height:120px}
    .row{display:grid;gap:10px;grid-template-columns:1fr}
    @media(min-width:700px){ .row-2{grid-template-columns:1fr 1fr} .row-3{grid-template-columns:1fr 1fr 1fr} }
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer}
    .btn.link{background:#fff;color:var(--text);border:1px solid var(--border)}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Uredi dogodek</h1>
      <div id="msg" class="muted"></div>

      <div class="row row-3">
        <div>
          <label>Naslov</label>
          <input id="eventName">
        </div>
        <div>
          <label>Prizori≈°ƒçe</label>
          <input id="venue">
        </div>
        <div>
          <label>Mesto/kraj</label>
          <input id="city">
        </div>
      </div>

      <div class="row row-3">
        <div>
          <label>Zaƒçetek</label>
          <input id="start" type="datetime-local">
        </div>
        <div>
          <label>Konec</label>
          <input id="end" type="datetime-local">
        </div>
        <div>
          <label>Kategorija</label>
          <div id="editCategoryChips" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px"></div>
          <input type="hidden" id="category">
          <script>
          // User-specified emoji chips for category selection in edit form
          (function(){
            var cats = [
              { key: "koncert", emoji: "üé∏", label: "Koncerti" },
              { key: "kultura", emoji: "üé≠", label: "Kultura" },
              { key: "otroci", emoji: "üß∏", label: "Otroci" },
              { key: "hrana", emoji: "üçî", label: "Hrana" },
              { key: "narava", emoji: "üå≥", label: "Narava" },
              { key: "sport", emoji: "‚öΩ", label: "≈†port" },
              { key: "zabava", emoji: "üéâ", label: "Zabava" },
              { key: "za-podjetja", emoji: "üè¢", label: "Za podjetja" }
            ];
              function renderChips(){
                const cats = EVENT_CATEGORIES;
                const wrap = document.getElementById("editCategoryChips");
                const input = document.getElementById("category");
                if(!wrap || !input) return;
                wrap.innerHTML = "";
                cats.forEach(function(cat, idx){
                  const chip = document.createElement("button");
                  chip.className = "chip cat" + (idx===0 ? " active" : "");
                  chip.type = "button";
                  chip.setAttribute("data-cat", cat.key);
                  chip.innerHTML = '<span class="cat-icon">'+cat.emoji+'</span>' + '<span class="cat-label" style="display:none;">'+cat.label+'</span>';
                  chip.addEventListener("mouseenter", function(){ chip.querySelector(".cat-label").style.display = "block"; });
                  chip.addEventListener("mouseleave", function(){ if(!chip.classList.contains("active")) chip.querySelector(".cat-label").style.display = "none"; });
                  chip.addEventListener("touchstart", function(){ chip.querySelector(".cat-label").style.display = "block"; });
                  chip.addEventListener("touchend", function(){ if(!chip.classList.contains("active")) chip.querySelector(".cat-label").style.display = "none"; });
                  chip.addEventListener("click", function(){
                    const all = wrap.querySelectorAll(".cat");
                    all.forEach(function(b){ b.classList.remove("active"); b.querySelector(".cat-label").style.display = "none"; });
                    chip.classList.add("active");
                    chip.querySelector(".cat-label").style.display = "block";
                    input.value = cat.key;
                  });
                  wrap.appendChild(chip);
                });
                input.value = cats[0].key;
              }
              document.addEventListener("DOMContentLoaded", renderChips);
            })();
          </script>
        </div>
      </div>

      <div class="row row-2">
        <div>
          <label>Povezava (veƒç info / zunanji nakup)</label>
          <input id="url">
        </div>
        <div>
          <label>Tip ponudbe</label>
          <select id="offerType">
            <option value="none">(brez plaƒçila)</option>
            <option value="ticket">Vstopnice (NearGo)</option>
            <option value="coupon">Kupon (NearGo)</option>
          </select>
        </div>
      </div>

      <div class="row row-2">
        <div>
          <label>Cena (glavna)</label>
          <input id="price" type="number" step="0.01" min="0">
        </div>
        <div>
          <label>Izpostavi (7 dni)</label>
          <select id="featured"><option value="false">Ne</option><option value="true">Da</option></select>
        </div>
      </div>

      <div>
        <label>Opis</label>
        <textarea id="description" maxlength="800"></textarea>
        <div class="muted" id="descCount">0 / 800</div>
      </div>

      <div class="actions">
        <button id="save" class="btn">Shrani spremembe</button>
        <a id="back" class="btn link" href="/">Nazaj na domov</a>
      </div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const msg = $("#msg");
    const qs = new URLSearchParams(location.search);
    const token = qs.get("token")||"";
    const key   = qs.get("key")||""; // opcijsko: ƒçe pride v linku, je hitrej≈°e

    if(!token){ msg.textContent="Manjka edit token."; }

    // ≈°tevec opis
    const ta=$("#description"), dc=$("#descCount");
    const upd=()=>{ const n=(ta.value||"").length; dc.textContent=`${n} / 800`; if(n>800) ta.value=ta.value.slice(0,800); };
    ["input","change"].forEach(ev=>ta.addEventListener(ev,upd));

    // nalo≈æi
    (async function load(){
      try{
        const url = "/.netlify/functions/provider-edit?action=load&token="+encodeURIComponent(token)+(key?("&key="+encodeURIComponent(key)):"");
        const r = await fetch(url);
        const data = await r.json().catch(()=>({}));
        if(!r.ok || !data.ok){ msg.textContent = data.error || "Napaka pri nalaganju."; return; }

        const e = data.item||{};
        $("#eventName").value = e.eventName||"";
        $("#venue").value     = e.venue||"";
        $("#city").value      = e.city||e.city2||"";
        $("#start").value     = e.start ? new Date(e.start).toISOString().slice(0,16) : "";
        $("#end").value       = e.end   ? new Date(e.end).toISOString().slice(0,16)   : "";
        $("#category").value  = e.category||"";
        $("#url").value       = e.url||"";
        $("#offerType").value = e.offerType||e.saleType||"none";
        $("#price").value     = (e.price!=null? e.price : "");
        $("#featured").value  = String(!!e.featured);
        $("#description").value = e.description||"";
        upd();
      }catch(e){
        msg.textContent="Napaka pri nalaganju.";
      }
    })();

    // shrani
    $("#save").onclick = async ()=>{
      const body = {
        token, key,
        updates:{
          eventName: $("#eventName").value.trim(),
          venue:     $("#venue").value.trim(),
          city:      $("#city").value.trim(),
          start:     $("#start").value ? new Date($("#start").value).toISOString() : null,
          end:       $("#end").value   ? new Date($("#end").value).toISOString()   : null,
          category:  $("#category").value,
          url:       $("#url").value.trim(),
          offerType: $("#offerType").value,
          price:     $("#price").value === "" ? null : Number($("#price").value),
          featured:  $("#featured").value === "true",
          description: $("#description").value.trim()
        }
      };
      msg.textContent="Shranjujem‚Ä¶";
      try{
        const r = await fetch("/.netlify/functions/provider-edit", { method:"POST", headers:{ "content-type":"application/json" }, body:JSON.stringify(body) });
        const data = await r.json().catch(()=>({}));
        if(!r.ok || !data.ok){ msg.textContent = "Napaka: "+(data.error||""); return; }
        msg.textContent="‚úÖ Shranjeno.";
      }catch(e){ msg.textContent="Napaka pri shranjevanju."; }
    };
  </script>
</body>
</html>
