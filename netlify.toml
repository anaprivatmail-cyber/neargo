[build]
  publish = "."
  functions = "netlify/functions"

# ===== Redirects =====
# (tvoji redirecti ostanejo popolnoma nespremenjeni)

[[redirects]]
  from = "/api/search"
  to   = "/.netlify/functions/tm-search"
  status = 200
  force = true

[[redirects]]
  from = "/api/provider-submit"
  to   = "/.netlify/functions/provider-submit"
  status = 200
  force = true

[[redirects]]
  from = "/api/provider-upload"
  to   = "/.netlify/functions/provider-upload"
  status = 200
  force = true

[[redirects]]
  from = "/api/provider-list"
  to   = "/.netlify/functions/provider-list"
  status = 200
  force = true

[[redirects]]
  from = "/api/provider-edit"
  to   = "/.netlify/functions/provider-edit"
  status = 200
  force = true

[[redirects]]
  from = "/api/provider-update"
  to   = "/.netlify/functions/provider-update"
  status = 200
  force = true

[[redirects]]
  from = "/api/checkout"
  to   = "/.netlify/functions/checkout"
  status = 200
  force = true

[[redirects]]
  from = "/api/public-config"
  to   = "/.netlify/functions/public-config"
  status = 200
  force = true

[[redirects]]
  from = "/api/check-env"
  to   = "/.netlify/functions/check-env"
  status = 200
  force = true

[[redirects]]
  from = "/api/free-coupon"
  to   = "/.netlify/functions/free-coupon"
  status = 200
  force = true

[[redirects]]
  from = "/api/redeem/*"
  to   = "/.netlify/functions/redeem/:splat"
  status = 200
  force = true

[[redirects]]
  from = "/api/checker"
  to   = "/.netlify/functions/scan"
  status = 200
  force = true

[[redirects]]
  from = "/api/stripe-webhook"
  to   = "/.netlify/functions/stripe-webhook"
  status = 200
  force = true

[[redirects]]
  from = "/api/ticket-redeem"
  to   = "/.netlify/functions/ticket-redeem"
  status = 200
  force = true

[[redirects]]
  from = "/api/analytics"
  to   = "/.netlify/functions/analytics"
  status = 200
  force = true

[[redirects]]
  from = "/api/redirect-qr"
  to   = "/.netlify/functions/redirect-qr"
  status = 200
  force = true

[[redirects]]
  from = "/r/:token"
  to   = "/.netlify/functions/ticket-redeem?token=:token"
  status = 200
  force = true

[[redirects]]
  from = "/api/purchase-lookup"
  to   = "/.netlify/functions/purchase-lookup"
  status = 200
  force = true

[[redirects]]
  from = "/api/finalize-checkout"
  to   = "/.netlify/functions/finalize-checkout"
  status = 200
  force = true

[[redirects]]
  from = "/api/geo-worker"
  to   = "/.netlify/functions/geo-worker"
  status = 200
  force = true

[[redirects]]
  from = "/api/early-notify-offer"
  to   = "/.netlify/functions/early-notify-offer"
  status = 200
  force = true

[[redirects]]
  from = "/api/early-notify"
  to   = "/.netlify/functions/early-notify"
  status = 200
  force = true

[[redirects]]
  from = "/api/early-inbox"
  to   = "/.netlify/functions/early-inbox"
  status = 200
  force = true

[[redirects]]
  from = "/api/early-notify-count"
  to   = "/.netlify/functions/early-notify-count"
  status = 200
  force = true

[[redirects]]
  from = "/api/offers-early"
  to   = "/.netlify/functions/offers-early"
  status = 200
  force = true

[[redirects]]
  from = "/api/my"
  to   = "/.netlify/functions/my"
  status = 200
  force = true

[[redirects]]
  from = "/api/whoami"
  to   = "/.netlify/functions/whoami"
  status = 200
  force = true

[[redirects]]
  from = "/api/test-email"
  to   = "/.netlify/functions/test-email"
  status = 200
  force = true

[[redirects]]
  from = "/*"
  to   = "/index.html"
  status = 200


# ===== Headers =====

[[headers]]
  for = "/*.html"
  [headers.values]
    cache-control = "public, max-age=60, must-revalidate"

[[headers]]
  for = "/assets/*"
  [headers.values]
    cache-control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*"
  [headers.values]
    x-content-type-options = "nosniff"
    x-frame-options = "SAMEORIGIN"
    referrer-policy = "strict-origin-when-cross-origin"
    permissions-policy = "geolocation=(self), camera=(self)"
    Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"

[[headers]]
  for = "/.netlify/functions/*"
  [headers.values]
    Access-Control-Allow-Origin  = "*"
    Access-Control-Allow-Methods = "GET, POST, OPTIONS"
    Access-Control-Allow-Headers = "Content-Type, Authorization, x-scanner-key"


# ===== FUNCTION BUILD SETTINGS (GLOBAL) =====
[functions]
  node_bundler = "esbuild"
  external_node_modules = ["@netlify/blobs", "@supabase/supabase-js", "busboy"]
  included_files = [
    "providers/**",
    "netlify/functions/fonts/**"
  ]


# ===== INDIVIDUAL FUNCTION SCHEDULES =====

[functions."ticket-redeem"]
  node_bundler = "none"

[functions."geo-worker"]
  schedule = "*/10 * * * *"

[functions."early-notify"]
  schedule = "*/1 * * * *"

[functions."reminder"]
  schedule = "0 7 * * *"

# ===== NEW: Scraper place-worker cron =====
[functions."trigger-place-worker"]
  schedule = "*/1 * * * *" 
