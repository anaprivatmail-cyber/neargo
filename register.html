<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registracija – NearGo</title>
  <link rel="canonical" href="/register.html">
  <style>
    body { font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#f7fbfd; margin:0; }
    .center { max-width:340px; margin:40px auto; background:#fff; border-radius:16px; box-shadow:0 4px 32px rgba(0,0,0,0.13); padding:28px 22px; }
    .brand { display:flex;align-items:center;gap:10px;text-decoration:none;justify-content:center;margin-bottom:18px; }
    .btn { border:none; padding:12px 18px; border-radius:14px; font-weight:900; cursor:pointer; font-size:16px; background:#0bbbd6; color:#fff; width:100%; margin-top:10px; }
    .muted { color:#5b6b7b; font-size:15px; text-align:center; margin-bottom:18px; }
    input { width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #cfe1ee; font-size:15px; }
    .error { color:#d64c4c; font-size:14px; text-align:center; margin-bottom:8px; }
  </style>
</head>
<body>
  <div class="center">
    <a href="/" class="brand" aria-label="NearGo">
      <svg viewBox="0 0 32 32" aria-hidden="true" style="width:38px;height:38px;">
        <defs><radialGradient id="g1" cx="50%" cy="50%"><stop offset="0%" stop-color="#0bbbd6"/><stop offset="100%" stop-color="#7de3f0"/></radialGradient></defs>
        <circle cx="16" cy="16" r="13" class="ring" fill="none" stroke="url(#g1)" stroke-width="2"/>
        <circle cx="16" cy="16" r="8" class="ring" fill="none" stroke="url(#g1)" stroke-width="2" opacity=".9"/>
        <circle cx="16" cy="16" r="3.2" class="dot pulse"/>
      </svg>
      <span style="font-weight:900;font-size:22px;color:#14202b;letter-spacing:-1px;">NearGo</span>
    </a>
    <div class="muted">Ustvari nov račun</div>
    <form id="registerForm">
      <input type="email" id="regEmail" placeholder="E-pošta" required>
      <input type="password" id="regPassword" placeholder="Geslo" required>
      <input type="password" id="regPassword2" placeholder="Ponovi geslo" required>
      <div style="margin-bottom:10px">
        <select id="regCountry" style="width:100%;padding:10px;border-radius:8px;border:1px solid #cfe1ee;font-size:15px;margin-bottom:6px">
          <option value="+386">Slovenija (+386)</option>
          <option value="+385">Hrvaška (+385)</option>
          <option value="+43">Avstrija (+43)</option>
          <option value="+49">Nemčija (+49)</option>
          <option value="+39">Italija (+39)</option>
          <option value="+1">ZDA (+1)</option>
          <option value="+44">Velika Britanija (+44)</option>
          <option value="+33">Francija (+33)</option>
        </select>
        <input type="tel" id="regPhone" placeholder="Telefonska številka" required>
      </div>
      <div style="margin-bottom:10px">
        <label style="font-size:15px;">Način potrditve:</label><br>
        <select id="regMethod" style="width:100%;padding:10px;border-radius:8px;border:1px solid #cfe1ee;font-size:15px;margin-bottom:6px">
          <option value="email">Email</option>
          <option value="sms">SMS</option>
        </select>
      </div>
      <button type="button" class="btn" id="btnSendCode">Pošlji potrditveno kodo</button>
      <div id="codeSection" style="display:none;margin-top:10px;">
        <input type="text" id="regCode" placeholder="Vnesi potrditveno kodo" style="margin-bottom:8px;">
        <button type="button" class="btn" id="btnVerifyCode">Potrdi kodo in dokončaj registracijo</button>
      </div>
    </form>
    <div id="regError" class="error" style="display:none"></div>
    <div class="muted"><a href="/organizers.html">Nazaj na prijavo</a></div>
  </div>
  <script>
    function formatPhone(phone, countryCode) {
      let num = String(phone).replace(/\s|\-|\(|\)/g, '');
      if (num.startsWith('+')) return num;
      if (num.startsWith('00')) return '+' + num.slice(2);
      if (num.startsWith('0')) return countryCode + num.slice(1);
      return countryCode + num;
    }
    const btnSendCode = document.getElementById('btnSendCode');
    const btnVerifyCode = document.getElementById('btnVerifyCode');
    const codeSection = document.getElementById('codeSection');
    const regError = document.getElementById('regError');
    btnSendCode.addEventListener('click', async function() {
      regError.style.display = 'none';
      var email = document.getElementById('regEmail').value.trim();
      var pw1 = document.getElementById('regPassword').value;
      var pw2 = document.getElementById('regPassword2').value;
      var phone = document.getElementById('regPhone').value.trim();
      var countryCode = document.getElementById('regCountry').value;
      var method = document.getElementById('regMethod').value;
      var err = '';
      if (!email || !pw1 || !pw2 || !phone) err = 'Vnesite vse podatke.';
      else if (pw1.length < 6) err = 'Geslo mora imeti vsaj 6 znakov.';
      else if (pw1 !== pw2) err = 'Gesli se ne ujemata.';
      else if (!/^\d{6,}$/.test(phone.replace(/\D/g, ''))) err = 'Vnesite veljavno telefonsko številko.';
      if (err) {
        regError.textContent = err;
        regError.style.display = 'block';
        return;
      }
      var formattedPhone = formatPhone(phone, countryCode);
      // Pošlji zahtevo za kodo
      try {
        const res = await fetch('/.netlify/functions/send-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ method, email, phone: formattedPhone, countryCode })
        });
        const data = await res.json();
        if (data.ok && data.codeSent) {
          codeSection.style.display = 'block';
          btnSendCode.disabled = true;
        } else {
          regError.textContent = data.error || 'Napaka pri pošiljanju kode.';
          regError.style.display = 'block';
        }
      } catch (e) {
        regError.textContent = 'Napaka pri pošiljanju kode.';
        regError.style.display = 'block';
      }
    });

    btnVerifyCode.addEventListener('click', async function() {
      regError.style.display = 'none';
      var email = document.getElementById('regEmail').value.trim();
      var code = document.getElementById('regCode').value.trim();
      if (!code) {
        regError.textContent = 'Vnesite potrditveno kodo.';
        regError.style.display = 'block';
        return;
      }
      // Preveri kodo prek backend
      try {
        const res = await fetch('/.netlify/functions/send-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ method: 'verify', email, code })
        });
        const data = await res.json();
        if (data.ok && data.codeValid) {
          alert('Registracija uspešna!');
          window.location.href = '/organizers.html';
        } else {
          regError.textContent = data.error || 'Koda ni pravilna ali je potekla.';
          regError.style.display = 'block';
        }
      } catch (e) {
        regError.textContent = 'Napaka pri preverjanju kode.';
        regError.style.display = 'block';
      }
    });
  </script>
</body>
</html>
