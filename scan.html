<!doctype html>
<html lang="sl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NearGo ‚Äì Skeniraj QR kodo</title>
<script src="https://unpkg.com/html5-qrcode" defer></script>
<style>
  :root{ --bg:#f6fbfe; --card:#fff; --text:#0b1b2b; --muted:#5b6b7b; --border:#e6eef7; --brand:#0bbbd6; --shadow:0 12px 30px rgba(0,0,0,.06); }
  *{box-sizing:border-box}
  body{font:16px/1.5 system-ui, Arial;margin:0;background:var(--bg);color:var(--text)}
  .wrap{max-width:760px;margin:22px auto;padding:14px}
  .card{margin:auto;padding:16px;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);background:var(--card)}
  h2{margin:6px 0 2px;font-size:26px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,button{font:16px;padding:10px;border:1px solid var(--border);border-radius:10px}
  button{cursor:pointer}
  .btn{background:var(--brand);color:#fff;border:0;font-weight:800}
  .btn.link{background:#fff;color:var(--text);border:1px solid var(--border)}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef7fb;border:1px solid var(--border);font-weight:800}
  #reader{width:360px;max-width:100%;margin:12px auto;border-radius:14px;overflow:hidden;background:#000}
  .grow{flex:1}
  /* Mini header */
  .topbar{position:sticky; top:0; z-index:10; backdrop-filter:blur(6px);
    background: color-mix(in srgb, #ffffff 88%, transparent);
    border-bottom: 1px solid #e6eef7;}
  .topnav{max-width:1100px; margin:0 auto; padding:10px 14px; display:flex; align-items:center; gap:10px;}
  .brand-mini{display:flex; align-items:center; gap:10px; font-weight:900; font-size:18px; color:#0b1b2b; text-decoration:none}
  .brand-mini svg{width:26px; height:26px}
  .topnav .spacer{flex:1}
  .topbtn{display:inline-block; padding:8px 12px; border-radius:999px; font-weight:800; text-decoration:none;}
  .topbtn.link{background:#fff; color:#0b1b2b; border:1px solid #e6eef7}
  .topbtn.cta{background:#0bbbd6; color:#fff; border:0}
  .topbtn.back{ background:#fff; color:#0b1b2b; border:1px solid #e6eef7; }
</style>
</head>
<body>
  <!-- HEADER -->
  <div class="topbar">
    <div class="topnav">
      <a href="/" class="brand-mini" aria-label="NearGo">
        <svg viewBox="0 0 32 32" aria-hidden="true">
          <defs><radialGradient id="g1" cx="50%" cy="50%"><stop offset="0%" stop-color="#0bbbd6"/><stop offset="100%" stop-color="#7de3f0"/></radialGradient></defs>
          <circle cx="16" cy="16" r="12" fill="none" stroke="url(#g1)" stroke-width="2"/>
          <circle cx="16" cy="16" r="3.2" fill="#0bbbd6"/>
        </svg>
        NearGo
      </a>
      <span class="spacer"></span>
      <a href="/organizers.html" class="topbtn back" id="btnBackScan">Nazaj</a>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;gap:10px">
        <div class="badge" id="authBadge">Prijavljen (kljuƒç)</div>
        <div class="row">
          <button id="btnOpenStatsTop" class="btn link" title="Odpri analitiko">Analitika</button>
        </div>
      </div>

      <h2>Skeniraj QR kodo</h2>
      <div class="muted">Zaƒçni s skeniranjem in unovi vstopnico/kupon.</div>

      <div class="row" style="margin:10px 0">
        <button id="start" class="btn">üì∑ Zaƒçni skeniranje</button>
        <button id="stop" class="btn link">‚úñ Ustavi</button>
      </div>

      <div id="reader" aria-label="Kamera za skeniranje"></div>

      <div class="row" style="margin-top:8px">
        <input id="manual" class="grow" placeholder="prilepi token roƒçno">
        <button id="redeemBtn" class="btn">Vnovƒçi</button>
      </div>

      <hr style="margin:14px 0;border:none;border-top:1px solid var(--border)">

      <div class="row">
        <label>Dogodek ID:</label>
        <input id="eventId" placeholder="npr. 123456">
        <label>Scanner key:</label>
        <input id="key" placeholder="SCANNER_KEY">
        <button id="save" class="btn link">Shrani</button>
      </div>

      <p id="out" class="muted" style="margin-top:10px"></p>
    </div>
  </div>

<script>
const BASE = location.origin.replace(/\/$/,'');
const $ = (id)=>document.getElementById(id);

const keyInput   = $("key");
const eventInput = $("eventId");
const manual     = $("manual");
const out        = $("out");
const badge      = $("authBadge");

keyInput.value   = localStorage.getItem("scanner_key") || "";
eventInput.value = localStorage.getItem("event_id")    || "";

(function fromQuery(){
  try{
    const u = new URL(location.href);
    const k = u.searchParams.get("k");
    const ev= u.searchParams.get("eventId") || u.searchParams.get("eid");
    const st= u.searchParams.get("stats");
    if(k){ keyInput.value = k; localStorage.setItem("scanner_key", k); u.searchParams.delete("k"); }
    if(ev){ eventInput.value = ev; localStorage.setItem("event_id", ev); u.searchParams.delete("eventId"); u.searchParams.delete("eid"); }
    if(st){ localStorage.setItem("stats_token", st); u.searchParams.delete("stats"); }
    if(k||ev||st){ history.replaceState({}, "", u.pathname + (u.search?("?"+u.search):"")); }
  }catch{}
})();

function syncBadge(){
  const ok = !!keyInput.value.trim();
  badge.textContent = ok ? "Prijavljen (kljuƒç)" : "Ni kljuƒça";
  badge.style.background = ok ? "#e6fbf4" : "#fff3f3";
  badge.style.borderColor = ok ? "#b9ecd9" : "#f2c7c7";
}
syncBadge();

$("save").onclick = ()=>{
  localStorage.setItem("scanner_key", keyInput.value.trim());
  localStorage.setItem("event_id",    eventInput.value.trim());
  syncBadge();
  out.textContent = "Shranjeno.";
};

function openStats(){
  const stats = localStorage.getItem("stats_token") || "";
  const ev    = eventInput.value.trim();
  if(!stats){ out.textContent = "Manjka stats token (glej potrditveni mail)."; return; }
  const url = `${BASE}/org-stats.html?stats=${encodeURIComponent(stats)}${ev?`&eventId=${encodeURIComponent(ev)}`:''}`;
  location.href = url;
}
$("btnOpenStatsTop").onclick = openStats;

// Redeem
$("redeemBtn").onclick = ()=>{ if(manual.value.trim()) redeem(manual.value.trim()); };

async function redeem(token){
  const key = keyInput.value.trim(), ev = eventInput.value.trim();
  if(!key){ out.innerHTML = '<span style="color:#b00020">Manjka scanner key.</span>'; return; }
  const body = { token };
  if(ev) body.eventId = ev;
  try{
    const res = await fetch(`${BASE}/.netlify/functions/redeem`, {
      method:"POST",
      headers:{ "content-type":"application/json", "x-scanner-key": key },
      body: JSON.stringify(body)
    });
    const data = await res.json().catch(()=>({}));
    if(res.ok && data.ok){
      out.innerHTML = `‚úÖ Unovƒçeno ‚Äì status: <b>${data.status}</b>${data.alreadyRedeemed ? " (≈æe vnovƒçeno)" : ""}${data.redeemedAt ? " ‚Äì "+new Date(data.redeemedAt).toLocaleString() : ""}`;
    }else{
      out.innerHTML = `‚ùå <b>Napaka:</b> ${(data && (data.error||JSON.stringify(data))) || res.status}`;
    }
  }catch(e){
    out.textContent = "Napaka pri vnovƒçitvi.";
  }
}

// Kamera
let qr = null, camId = null;
$("start").onclick = async ()=>{
  if(!window.Html5Qrcode){ out.textContent="Komponenta za kamero ni nalo≈æena."; return; }
  try{
    qr = new Html5Qrcode("reader");
    const cams = await Html5Qrcode.getCameras();
    camId = cams?.[0]?.id;
    if(!camId){ out.textContent = "Kamera ni na voljo."; return; }
    await qr.start(camId, { fps:10, qrbox:{ width:250, height:250 } },
      (text)=>{ qr.pause(true); redeem(text.trim()); setTimeout(()=>qr.resume(), 1200); },
      ()=>{}
    );
  }catch{ out.textContent="Kamera ni dovoljena."; }
};
$("stop").onclick = async ()=>{ try{ await qr?.stop(); }catch{} };

// Pameten "Nazaj" (ƒçe je pri≈°el iz appa)
(function(){
  const b=document.getElementById('btnBackScan'); if(!b) return;
  b.addEventListener('click', function(e){
    const ref = document.referrer;
    if(ref && new URL(ref).origin === location.origin){ e.preventDefault(); history.back(); }
  });
})();
</script>
</body>
</html>
