<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NearGo ‚Äì Scani (admin)</title>
  <style>
    :root{ --bg:#f6fbfe; --card:#fff; --text:#0b1b2b; --muted:#5b6b7b; --border:#e3eef7; --brand:#0bbbd6; --shadow:0 12px 30px rgba(0,0,0,.06); }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:22px auto;padding:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:14px}
    h1{margin:6px 0 10px;font-size:22px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,button{font:15px;padding:10px;border-radius:10px;border:1px solid var(--border)}
    button{cursor:pointer}
    .btn{background:var(--brand);color:#fff;border:0;font-weight:800}
    .btn.link{background:#fff;color:var(--text);border:1px solid var(--border)}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    th{background:#f9fcff}
    .muted{color:var(--muted)}
    .kpis{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .kpi{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff;font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üìã Scani (admin)</h1>
      <div class="row">
        <input id="eventId" placeholder="eventId (bigint)">
        <input id="scannerEmail" placeholder="email skenerja">
        <input id="token" placeholder="token">
        <input id="from" type="datetime-local" title="Od">
        <input id="to" type="datetime-local" title="Do">
        <input id="limit" type="number" min="1" max="2000" value="200" style="width:100px" title="Limit">
        <button id="load" class="btn">Nalo≈æi</button>
        <button id="exportCsv" class="btn link">Izvozi CSV</button>
      </div>

      <div class="kpis">
        <div class="kpi">Skupaj: <span id="total">0</span></div>
        <div class="kpi">Enoliƒçni tokeni: <span id="unique">0</span></div>
      </div>

      <div class="muted" id="msg" style="margin-top:6px"></div>

      <table id="tbl">
        <thead>
          <tr>
            <th>ƒåas</th>
            <th>Dogodek</th>
            <th>Token</th>
            <th>Tip</th>
            <th>Kupec (email)</th>
            <th>Skener (email)</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="6" class="muted">Ni podatkov.</td></tr></tbody>
      </table>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const tblBody = $('#tbody'), msg = $('#msg');

    $('#load').onclick = load;
    $('#exportCsv').onclick = exportCsv;

    async function load(){
      msg.textContent = '';
      tblBody.innerHTML = `<tr><td colspan="6" class="muted">Nalagam‚Ä¶</td></tr>`;

      const q = new URLSearchParams({
        eventId: ($('#eventId').value||'').trim(),
        scannerEmail: ($('#scannerEmail').value||'').trim(),
        token: ($('#token').value||'').trim(),
        from: $('#from').value ? new Date($('#from').value).toISOString() : '',
        to:   $('#to').value   ? new Date($('#to').value).toISOString()   : '',
        limit: String(Math.max(1, Math.min(2000, Number($('#limit').value||200))))
      });

      try{
        const r = await fetch('/.netlify/functions/scans-list?'+q.toString(), { headers: { accept:'application/json' }});
        const data = await r.json().catch(()=> ({}));
        if (!r.ok || !data.ok) {
          tblBody.innerHTML = `<tr><td colspan="6" class="muted">Napaka pri nalaganju.</td></tr>`;
          msg.textContent = data?.error || `HTTP ${r.status}`;
          return;
        }
        const rows = data.items || [];
        if (!rows.length) {
          tblBody.innerHTML = `<tr><td colspan="6" class="muted">Ni podatkov.</td></tr>`;
        } else {
          tblBody.innerHTML = rows.map(x => `
            <tr>
              <td>${x.scanned_at ? new Date(x.scanned_at).toLocaleString() : ''}</td>
              <td>${(x.event_title||'‚Äî')}${x.event_city?(' ‚Ä¢ '+x.event_city):''}</td>
              <td>${x.token||''}</td>
              <td>${x.type||''}</td>
              <td>${x.customer_email||''}</td>
              <td>${x.scanner_email||''}</td>
            </tr>
          `).join('');
        }
        // KPI
        $('#total').textContent = rows.length;
        $('#unique').textContent = new Set(rows.map(r => r.token)).size;
      }catch(e){
        tblBody.innerHTML = `<tr><td colspan="6" class="muted">Napaka pri nalaganju.</td></tr>`;
        msg.textContent = String(e?.message || e);
      }
    }

    function exportCsv(){
      const rows = [...document.querySelectorAll('#tbody tr')].map(tr => [...tr.children].map(td => (td.textContent||'').replace(/\s+/g,' ').trim()));
      if (!rows.length || rows[0].length < 6) { alert('Ni podatkov za izvoz.'); return; }
      const head = ['ƒåas','Dogodek','Token','Tip','Kupec','Skener'];
      const all = [head, ...rows];
      const csv = all.map(r => r.map(cell => /[",;\n]/.test(cell) ? `"${cell.replace(/"/g,'""')}"`: cell).join(';')).join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'scans.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // auto-load ƒçe ima ?eventId= v URL
    (function auto(){
      const p = new URLSearchParams(location.search);
      if (p.get('eventId')) { $('#eventId').value = p.get('eventId'); }
      load();
    })();
  </script>
</body>
</html>
