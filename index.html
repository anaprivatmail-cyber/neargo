<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NearGo – najdi dogodke blizu</title>

  <!-- Tailwind (pre-built) za hiter, sodoben izgled -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet za zemljevid -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* drobne dodelave, ohranim tvojo barvo #0fbad6 kot primer */
    :root { --brand: #0fbad6; }
    .brand { color: var(--brand); }
    .btn { background: var(--brand); color:#fff; border-radius:14px; padding:.9rem 1.2rem; font-weight:600; }
    .btn-outline { border:2px solid var(--brand); color:var(--brand); background:#fff; border-radius:14px; padding:.8rem 1.2rem; font-weight:600; }
    .chip { border:1px solid #e5e7eb; border-radius:9999px; padding:.35rem .8rem; }
    .card { border:1px solid #eaeaea; border-radius:16px; overflow:hidden; background:#fff; }
    .carousel::-webkit-scrollbar{display:none}
  </style>
</head>
<body class="bg-white text-gray-900">
  <!-- NAV -->
  <header class="sticky top-0 bg-white/90 backdrop-blur z-50 border-b border-gray-100">
    <div class="max-w-6xl mx-auto px-4 flex items-center gap-3 h-16">
      <div class="flex items-center gap-2">
        <svg class="w-6 h-6 brand" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 100 20 10 10 0 000-20Zm0 3a7 7 0 110 14 7 7 0 010-14Zm0 2.25a4.75 4.75 0 100 9.5 4.75 4.75 0 000-9.5Z"/></svg>
        <span class="font-bold text-lg">NearGo</span>
      </div>

      <div class="ml-auto flex items-center gap-2">
        <!-- jezik -->
        <select id="lang" class="chip">
          <option value="sl" selected>SL</option>
          <option value="en">EN</option>
          <option value="de">DE</option>
          <option value="hr">HR</option>
          <option value="it">IT</option>
        </select>

        <a href="#provider" class="btn">Za organizatorje</a>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section class="bg-gradient-to-b from-white to-gray-50 border-b border-gray-100">
    <div class="max-w-6xl mx-auto px-4 py-10 md:py-14">
      <div class="grid md:grid-cols-2 gap-8 items-center">
        <div>
          <h1 class="text-4xl md:text-5xl font-extrabold leading-tight">
            Najdi <span class="brand">dogodke blizu</span> — koncerti, hrana, kultura, otroci &amp; več
          </h1>
          <p class="mt-4 text-lg text-gray-700">
            NearGo je hiter meta-iskalnik. Vtipkaj, izberi kraj ali radij in
            že izveš vse v tvojem jeziku.
          </p>

          <div class="mt-6 flex flex-wrap gap-3">
            <a href="#search" class="btn">Začni iskati</a>
            <a href="#provider" class="btn-outline">Objavi dogodek</a>
          </div>

          <div class="mt-5 flex items-center gap-2">
            <button id="smartFiltersBtn" class="chip">Pametni filtri</button>
            <button id="mapBtn" class="chip">Zemljevid</button>
          </div>
        </div>

        <!-- Vrtiljak izpostavljenih -->
        <div>
          <div class="card p-0">
            <div id="featuredCarousel" class="flex gap-4 overflow-x-auto carousel p-4">
              <!-- napolni v JS iz provider-list -->
              <!-- placeholder elementi -->
              <div class="min-w-[260px]">
                <img src="https://images.unsplash.com/photo-1514525253161-7a46d19cd819?q=80&w=1200&auto=format&fit=crop"
                     class="h-44 w-full object-cover rounded-xl" alt="Featured"/>
                <div class="mt-2">
                  <div class="font-semibold">Izpostavljen dogodek</div>
                  <div class="text-sm text-gray-600">Promocijsko mesto — rezerviraj v obrazcu</div>
                </div>
              </div>
            </div>
            <div class="border-t px-4 py-3 text-sm text-gray-500">
              Želiš izpostaviti dogodek? Označi “Izpostavljeno (7 dni)” v obrazcu (10 €).
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SEARCH -->
  <section id="search" class="max-w-6xl mx-auto px-4 py-10">
    <div class="card p-4 md:p-6">
      <div class="grid md:grid-cols-6 gap-4">
        <div class="md:col-span-2">
          <label class="text-sm font-medium">Kaj</label>
          <input id="q" class="w-full border rounded-xl px-4 py-3" placeholder="npr. Metallica, street food…" />
        </div>
        <div class="md:col-span-2">
          <label class="text-sm font-medium">Mesto/kraj</label>
          <input id="city" class="w-full border rounded-xl px-4 py-3" placeholder="" />
        </div>
        <div>
          <label class="text-sm font-medium">Radij (km)</label>
          <input id="radius" type="number" min="1" max="300" value="50" class="w-full border rounded-xl px-4 py-3"/>
        </div>
        <div class="flex items-end">
          <button id="searchBtn" class="btn w-full">Išči</button>
        </div>
      </div>
      <div class="mt-3 text-sm text-gray-500">
        Namig: pusti “Mesto/kraj” prazno in uporabi <button id="geoBtn" class="underline decoration-dotted">mojo lokacijo</button>.
      </div>
    </div>

    <!-- REZULTATI -->
    <div class="mt-8 grid md:grid-cols-3 gap-6">
      <div class="md:col-span-2 space-y-4" id="results"></div>
      <div class="card p-0 sticky top-24 h-[520px] overflow-hidden">
        <div id="map" class="h-full"></div>
      </div>
    </div>
  </section>

  <!-- PROVIDER FORM (SIDRO) -->
  <section id="provider" class="bg-gray-50 border-t border-gray-100">
    <div class="max-w-6xl mx-auto px-4 py-12">
      <h2 class="text-2xl font-bold mb-2">Za organizatorje</h2>
      <p class="text-gray-600 mb-6">Oddaj svoj dogodek. Možnost izpostavitve (7 dni) za 10 €.</p>

      <form id="provForm" class="card p-4 md:p-6 grid md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm font-medium">Naslov dogodka *</label>
          <input name="name" required class="w-full border rounded-xl px-4 py-3" />
        </div>
        <div>
          <label class="text-sm font-medium">Datum &amp; čas (začetek) *</label>
          <input name="start" required type="datetime-local" class="w-full border rounded-xl px-4 py-3" />
        </div>

        <div>
          <label class="text-sm font-medium">Mesto/kraj *</label>
          <input name="city" required class="w-full border rounded-xl px-4 py-3" />
        </div>
        <div>
          <label class="text-sm font-medium">Država (ISO) *</label>
          <input name="country" required placeholder="SI, AT, HR…" class="w-full border rounded-xl px-4 py-3" />
        </div>

        <div>
          <label class="text-sm font-medium">Lokacija (ime prizorišča)</label>
          <input name="venue" class="w-full border rounded-xl px-4 py-3" />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm font-medium">GPS (lat)</label>
            <input name="lat" class="w-full border rounded-xl px-4 py-3" />
          </div>
          <div>
            <label class="text-sm font-medium">GPS (lon)</label>
            <input name="lon" class="w-full border rounded-xl px-4 py-3" />
          </div>
          <div class="col-span-2 -mt-1">
            <button type="button" id="useMyLoc" class="chip">Uporabi mojo lokacijo</button>
          </div>
        </div>

        <div>
          <label class="text-sm font-medium">Slika (URL)</label>
          <input name="image" placeholder="https://…" class="w-full border rounded-xl px-4 py-3" />
        </div>
        <div>
          <label class="text-sm font-medium">Cena (min)</label>
          <input name="priceMin" type="number" step="0.01" class="w-full border rounded-xl px-4 py-3" />
        </div>

        <div class="md:col-span-2">
          <label class="text-sm font-medium">Povezava za nakup (URL)</label>
          <input name="buyUrl" placeholder="https://…" class="w-full border rounded-xl px-4 py-3" />
        </div>

        <div class="md:col-span-2">
          <label class="text-sm font-medium">Opis</label>
          <textarea name="description" rows="4" class="w-full border rounded-xl px-4 py-3"></textarea>
        </div>

        <div class="md:col-span-2 flex items-center gap-3">
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="featured" class="w-5 h-5">
            <span>Izpostavljeno (7 dni) – 10 €</span>
          </label>
          <span class="text-sm text-gray-500">(račun in plačilo prejmeš po potrditvi)</span>
        </div>

        <div class="md:col-span-2">
          <button class="btn">Objavi</button>
          <span id="provMsg" class="ml-3 text-sm"></span>
        </div>
      </form>
    </div>
  </section>

  <footer class="border-t border-gray-100">
    <div class="max-w-6xl mx-auto px-4 py-10 text-sm text-gray-500">
      © NearGo • Pripravljeno za več virov, affiliate in analitiko.
    </div>
  </footer>

  <script>
    // ====== POMOČNE ======
    const $ = (s, r = document) => r.querySelector(s);
    const $$ = (s, r = document) => [...r.querySelectorAll(s)];
    const langSel = $('#lang');

    // ====== MAPA ======
    let map, markersLayer;
    function initMap() {
      map = L.map('map', {zoomControl: true}).setView([46.05, 14.51], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }
    initMap();

    function addMarker(lat, lon, html) {
      if (!lat || !lon) return;
      L.marker([lat, lon]).addTo(markersLayer).bindPopup(html);
    }

    // ====== ISKANJE ======
    async function search() {
      const q = $('#q').value.trim();
      const city = $('#city').value.trim();
      const radius = $('#radius').value || '';
      const lang = langSel.value || 'sl';

      $('#results').innerHTML = '';
      markersLayer.clearLayers();

      const url = `/ .netlify/functions/tm-search?q=${encodeURIComponent(q)}&city=${encodeURIComponent(city)}&radius=${encodeURIComponent(radius)}&lang=${encodeURIComponent(lang)}`.replace(' / ', '/');

      try {
        const res = await fetch(url);
        const data = await res.json();

        // Ticketmaster
        const tm = (data.results || []);

        // Tvoji ponudniki
        const provRes = await fetch('/.netlify/functions/provider-list');
        const provData = await provRes.json();
        const providers = provData.results || [];

        // Združimo in sort po datumu
        const all = [...tm, ...providers].sort((a,b) => (new Date(a.start || a.startDate || 0)) - (new Date(b.start || b.startDate || 0)));

        if (!all.length) {
          $('#results').innerHTML = `<div class="text-gray-500">Ni rezultatov. Poizkusi z drugim mestom ali manjšim radijem.</div>`;
          return;
        }

        all.forEach(ev => {
          const img = (ev.images && ev.images[0]) || ev.image || '';
          const name = ev.name || '';
          const start = (ev.start && ev.start.slice(0,16).replace('T',' ')) || ev.startDate || '';
          const city = ev.venue?.city || ev.city || '';
          const venue = ev.venue?.name || ev.venue || '';
          const url = ev.url || ev.buyUrl || '#';
          const lat = ev.venue?.lat || ev.lat;
          const lon = ev.venue?.lon || ev.lon;

          const card = document.createElement('a');
          card.className = 'card block hover:shadow-md transition';
          card.href = url; card.target = '_blank'; card.rel = 'noopener';
          card.innerHTML = `
            ${img ? `<img src="${img}" class="w-full h-44 object-cover"/>` : ''}
            <div class="p-4">
              <div class="text-sm text-gray-500">${start || ''}</div>
              <div class="font-semibold text-lg">${name}</div>
              <div class="text-sm text-gray-600">${city}${venue ? ' • ' + venue : ''}</div>
            </div>`;
          $('#results').appendChild(card);

          addMarker(lat, lon, `<b>${name}</b><br>${start || ''}<br>${city}${venue ? ' • ' + venue : ''}`);
        });

        // Fit na marke
        const bounds = markersLayer.getLayers().map(m => m.getLatLng());
        if (bounds.length) map.fitBounds(bounds, {padding:[30,30]});
      } catch (e) {
        console.error(e);
        $('#results').innerHTML = `<div class="text-red-600">Napaka pri iskanju.</div>`;
      }
    }

    $('#searchBtn').addEventListener('click', search);
    $('#mapBtn').addEventListener('click', () => window.scrollTo({top: $('#map').getBoundingClientRect().top + window.scrollY - 90, behavior:'smooth'}));
    $('#smartFiltersBtn').addEventListener('click', () => alert('Pametni filtri kmalu: kategorije, za otroke, cena, indoor/outdoor …'));

    // Geolokacija
    $('#geoBtn').addEventListener('click', async () => {
      if (!navigator.geolocation) return alert('Geolokacija ni na voljo.');
      navigator.geolocation.getCurrentPosition(async pos => {
        const {latitude, longitude} = pos.coords;
        // prevede lat/lon v mesto (enostaven reverse z Nominatim)
        try {
          const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
          const j = await r.json();
          $('#city').value = j.address?.city || j.address?.town || j.address?.village || '';
        } catch {}
        search();
      }, () => alert('Lokacije ni mogoče pridobiti.'));
    });

    // ====== PROVIDER FORM ======
    $('#useMyLoc').addEventListener('click', () => {
      if (!navigator.geolocation) return alert('Geolokacija ni na voljo.');
      navigator.geolocation.getCurrentPosition(pos => {
        $('input[name="lat"]').value = pos.coords.latitude.toFixed(6);
        $('input[name="lon"]').value = pos.coords.longitude.toFixed(6);
      });
    });

    $('#provForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.currentTarget);
      const body = Object.fromEntries(fd.entries());
      body.featured = !!fd.get('featured');

      $('#provMsg').textContent = 'Pošiljanje…';
      try {
        const r = await fetch('/.netlify/functions/provider-submit', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if (j.ok) {
          $('#provMsg').textContent = 'Uspešno oddano! Po potrditvi bo objavljeno.';
          e.currentTarget.reset();
          // osveži vrtiljak
          loadFeatured();
        } else {
          $('#provMsg').textContent = 'Napaka: ' + (j.message || 'poskusite kasneje');
        }
      } catch(err) {
        $('#provMsg').textContent = 'Napaka pri pošiljanju.';
      }
    });

    // ====== VR TILJAK IZPOSTAVLJENIH ======
    async function loadFeatured() {
      try {
        const r = await fetch('/.netlify/functions/provider-list?featured=1');
        const j = await r.json();
        const list = j.results || [];
        const wrap = $('#featuredCarousel');
        wrap.innerHTML = '';
        (list.length ? list : []).forEach(ev => {
          const div = document.createElement('div');
          div.className = 'min-w-[260px]';
          div.innerHTML = `
            ${ev.image ? `<img src="${ev.image}" class="h-44 w-full object-cover rounded-xl" />` : ''}
            <div class="mt-2">
              <div class="font-semibold">${ev.name || ''}</div>
              <div class="text-sm text-gray-600">${(ev.city||'')}${ev.venue? ' • '+ev.venue:''}</div>
            </div>`;
          wrap.appendChild(div);
        });
        if (!list.length) {
          // pusti placeholder iz heroja
        }
      } catch {}
    }
    loadFeatured();
  </script>
</body>
</html>
