<!doctype html>
<html lang="sl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NearGo – Skener kuponov</title>
<script src="https://unpkg.com/html5-qrcode" defer></script>
<style>
  body{font:16px/1.5 system-ui, Arial;margin:20px}
  .card{max-width:720px;margin:auto;padding:16px;border:1px solid #eee;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.05)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,button{font:16px;padding:10px;border:1px solid #ccc;border-radius:10px}
  button{cursor:pointer}
  #reader{width:360px;margin:12px auto}
  .ok{color:#0a7d2a} .err{color:#b00020}
  code{font-family:ui-monospace,Menlo,monospace}
  .grow{flex:1}
</style>
</head>
<body>
<div class="card">
  <h2>Skener kuponov</h2>

  <div class="row">
    <label>Dogodek ID:</label>
    <input id="eventId" placeholder="npr. event-123">
    <label>Scanner key:</label>
    <input id="key" placeholder="vnesi SCANNER_KEY">
    <button id="save">Shrani</button>
  </div>

  <!-- NOVO: Stats token + gumb za analitiko -->
  <div class="row" style="margin-top:8px">
    <label>Stats token:</label>
    <input id="stats" class="grow" placeholder="prilepi stats-token (če ga imaš)">
    <button id="openStats" title="Odpri analitiko za ta dogodek" disabled>Odpri analitiko</button>
  </div>

  <div id="reader"></div>

  <div class="row">
    <input id="manual" class="grow" placeholder="prilepi token ročno">
    <button id="redeemBtn">Vnovči</button>
  </div>

  <p id="out"></p>
</div>

<script>
const BASE = location.origin;
const $ = (id)=>document.getElementById(id);
const keyInput   = $("key");
const eventInput = $("eventId");
const statsInput = $("stats");
const manual     = $("manual");
const out        = $("out");

// Prefill iz localStorage
keyInput.value   = localStorage.getItem("scanner_key") || "";
eventInput.value = localStorage.getItem("event_id")    || "";
statsInput.value = localStorage.getItem("stats_token") || "";

// Prefill iz URL parametrov (?k=...&eventId=...&stats=...)
(function fromQuery(){
  try{
    const u = new URL(location.href);
    const k = u.searchParams.get("k");
    const ev= u.searchParams.get("eventId") || u.searchParams.get("eid");
    const st= u.searchParams.get("stats");
    if(k){ keyInput.value = k; localStorage.setItem("scanner_key", k); u.searchParams.delete("k"); }
    if(ev){ eventInput.value = ev; localStorage.setItem("event_id", ev); u.searchParams.delete("eventId"); u.searchParams.delete("eid"); }
    if(st){ statsInput.value = st; localStorage.setItem("stats_token", st); u.searchParams.delete("stats"); }
    if(k || ev || st){ history.replaceState({}, "", u.pathname + (u.search?("?"+u.search):"")); }
  }catch{}
})();

// Enable/disable gumb za analitiko
function syncStatsBtn(){
  $("openStats").disabled = !(statsInput.value.trim() && eventInput.value.trim());
}
syncStatsBtn();

$("save").onclick = ()=>{
  localStorage.setItem("scanner_key", keyInput.value.trim());
  localStorage.setItem("event_id",    eventInput.value.trim());
  localStorage.setItem("stats_token", statsInput.value.trim());
  syncStatsBtn();
  out.textContent = "Shranjeno.";
};

// Odpri org-stats samo za ta dogodek
$("openStats").onclick = ()=>{
  const stats = statsInput.value.trim();
  const ev    = eventInput.value.trim();
  if(!stats || !ev){ out.innerHTML = '<span class="err">Manjka stats token ali eventId.</span>'; return; }
  const url = `${BASE}/org-stats.html?stats=${encodeURIComponent(stats)}&eventId=${encodeURIComponent(ev)}`;
  window.location.href = url; // ali: window.open(url, '_blank')
};

async function redeem(token){
  const key = keyInput.value.trim(), ev = eventInput.value.trim();
  if(!key || !ev){ out.innerHTML = '<span class="err">Manjka scanner key ali eventId.</span>'; return; }
  const res = await fetch(`${BASE}/.netlify/functions/redeem`, {
    method:"POST",
    headers:{ "content-type":"application/json", "x-scanner-key": key },
    body: JSON.stringify({ token, eventId: ev })
  });
  const data = await res.json().catch(()=>({}));
  if(res.ok && data.ok){
    out.innerHTML = `<span class="ok">OK</span> – status: <b>${data.status}</b>${data.alreadyRedeemed ? " (že vnovčeno)" : ""}${data.redeemedAt ? " – "+new Date(data.redeemedAt).toLocaleString() : ""}`;
  }else{
    out.innerHTML = `<span class="err">Napaka:</span> <code>${(data && (data.error||JSON.stringify(data))) || res.status}</code>`;
  }
}

$("redeemBtn").onclick = ()=>{ if(manual.value.trim()) redeem(manual.value.trim()); };

window.addEventListener("load", ()=>{
  if(!window.Html5Qrcode) return;
  const qr = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(cams=>{
    const id = cams?.[0]?.id;
    if(!id){ out.textContent = "Kamera ni na voljo."; return; }
    qr.start(id, { fps:10, qrbox:{ width:250, height:250 } },
      (text)=>{ qr.pause(true); redeem(text.trim()); setTimeout(()=>qr.resume(), 1500); },
      ()=>{}
    );
  }).catch(()=> out.textContent = "Kamera ni dovoljena.");
});
</script>
</body>
</html>
