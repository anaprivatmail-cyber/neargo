[build]
  publish = "."
  functions = "netlify/functions"

# ===== Redirects to serverless functions (API) =====

[[redirects]]
  from = "/api/search"
  to   = "/.netlify/functions/tm-search"
  status = 200
  force = true

[[redirects]]
  from = "/api/provider-submit"
  to   = "/.netlify/functions/provider-submit"
  status = 200
  force = true

[[redirects]]
  from = "/api/provider-upload"
  to   = "/.netlify/functions/provider-upload"
  status = 200
  force = true

[[redirects]]
  from = "/api/provider-list"
  to   = "/.netlify/functions/provider-list"
  status = 200
  force = true

# Stripe Checkout
[[redirects]]
  from = "/api/checkout"
  to   = "/.netlify/functions/checkout"
  status = 200
  force = true

# Redeem (QR unovčitev)
[[redirects]]
  from = "/api/redeem/*"
  to   = "/.netlify/functions/redeem/:splat"
  status = 200
  force = true

# Opcijsko – lažji URL za QR skener
[[redirects]]
  from = "/api/scan"
  to   = "/.netlify/functions/redeem"
  status = 200
  force = true

# Stripe webhook pod /api
[[redirects]]
  from = "/api/stripe-webhook"
  to   = "/.netlify/functions/stripe-webhook"
  status = 200
  force = true

# Opcijsko – light ping/analytics
[[redirects]]
  from = "/api/analytics"
  to   = "/.netlify/functions/analytics"
  status = 200
  force = true

# ===== Static asset caching =====
[[headers]]
  for = "/*.html"
  [headers.values]
    cache-control = "public, max-age=60, must-revalidate"

[[headers]]
  for = "/assets/*"
  [headers.values]
    cache-control = "public, max-age=31536000, immutable"

# ===== Security headers =====
[[headers]]
  for = "/*"
  [headers.values]
    x-content-type-options = "nosniff"
    x-frame-options = "SAMEORIGIN"
    referrer-policy = "strict-origin-when-cross-origin"
    # Omogoči kamero za PWA/Checker (QR skener)
    permissions-policy = "geolocation=(self), camera=(self)"
    Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"

# ===== CORS for functions =====
[[headers]]
  for = "/.netlify/functions/*"
  [headers.values]
    Access-Control-Allow-Origin  = "*"
    Access-Control-Allow-Methods = "GET, POST, OPTIONS"
    Access-Control-Allow-Headers = "Content-Type, Authorization"

# ===== SPA fallback =====
[[redirects]]
  from = "/*"
  to   = "/index.html"
  status = 200

# ===== Functions bundling =====
[functions]
  node_bundler = "esbuild"
  external_node_modules = ["@netlify/blobs", "@supabase/supabase-js", "busboy"]
