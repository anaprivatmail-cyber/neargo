<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>NearGo – Prijava…</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 28px; }
    .box { max-width: 520px; margin: 0 auto; border:1px solid #eee; border-radius:12px; padding:18px; }
    .muted{ color:#667; }
  </style>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://wqdfteajjcrzcniotvhh.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxZGZ0ZWFqamNyemNuaW90dmhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzNTU3MDMsImV4cCI6MjA3MTkzMTcwM30.0EFgeCpHcsSxsYQ2wZIQerLKXcAlvJjVNuQ0nJB2VFc";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    (async function run() {
      const href = window.location.href;
      const url  = new URL(href);

      // 1) PKCE: ?code=...
      const code = url.searchParams.get("code");
      if (code) {
        try { await supabase.auth.exchangeCodeForSession(href); }
        catch(e){ console.warn("exchangeCodeForSession:", e?.message||e); }
        finally { return go(); }
      }

      // 2) Hash: #access_token=...&refresh_token=...
      if (url.hash && (url.hash.includes("access_token") || url.hash.includes("provider_token"))) {
        const h = new URLSearchParams(url.hash.slice(1));
        const access_token  = h.get("access_token")  || h.get("provider_token");
        const refresh_token = h.get("refresh_token");
        if (access_token && refresh_token) {
          try { await supabase.auth.setSession({ access_token, refresh_token }); }
          catch(e){ console.warn("setSession:", e?.message||e); }
          finally { return go(); }
        }
      }

      // 3) token_hash: ?token_hash=...&type=signup|magiclink|recovery|email_change
      const token_hash = url.searchParams.get("token_hash");
      const type = url.searchParams.get("type");
      if (token_hash && type) {
        try { 
          await supabase.auth.verifyOtp({ type, token_hash });
          if (type === 'recovery') {
            // Za recovery, odpri form za novo geslo
            showPasswordResetForm();
            return;
          }
        }
        catch(e){ console.warn("verifyOtp:", e?.message||e); }
        finally { 
          if (type !== 'recovery') return go(); 
        }
      }

      // Če ni nič od naštetega → pojdi vseeno naprej (lahko je bila seja že postavljena).
      go();

      function showPasswordResetForm() {
        const returnTo = new URL(location.href).searchParams.get('return') || localStorage.getItem('post_login_return') || '/';
        document.body.innerHTML = `
          <div class="box">
            <h2>Nova nastavitev gesla</h2>
            <form id="resetForm" autocomplete="off">
              <input type="password" id="newPassword" placeholder="Novo geslo" required minlength="6" style="width:100%;padding:10px;margin:10px 0;border:1px solid #cfe1ee;border-radius:8px;">
              <input type="password" id="newPassword2" placeholder="Ponovi geslo" required minlength="6" style="width:100%;padding:10px;margin:6px 0 10px;border:1px solid #cfe1ee;border-radius:8px;">
              <div id="pwRules" style="font-size:13px;color:#555;margin:6px 0 10px;line-height:1.4">
                Zahteve: <b>min 6 znakov</b>, vsaj <b>ena velika črka</b> (A–Z) in <b>en poseben znak</b> (!@#$%^&*?-_).<br>
                <span id="pwStrength" style="display:block;margin-top:4px;">Moč: <span id="pwStrengthVal" style="font-weight:700">–</span></span>
              </div>
              <button type="submit" style="width:100%;padding:12px;background:#0bbbd6;color:#fff;border:none;border-radius:14px;font-weight:700;">Posodobi geslo</button>
            </form>
            <div id="resetMessage" style="margin-top:12px;font-size:14px;"></div>
          </div>
        `;

        function assess(str){
          let score=0; if(str.length>=6) score++; if(/[A-Z]/.test(str)) score++; if(/[!@#$%^&*?\-_]/.test(str)) score++; if(/[0-9]/.test(str)) score++; if(str.length>=10) score++;
          const labels=['Zelo šibko','Šibko','Ok','Dobro','Močno','Zelo močno'];
          return labels[Math.min(score,labels.length-1)];
        }
        const pw1=document.getElementById('newPassword');
        const pw2=document.getElementById('newPassword2');
        const pwStrengthVal=document.getElementById('pwStrengthVal');
        function updateStrength(){ pwStrengthVal.textContent=assess(pw1.value); }
        pw1.addEventListener('input', updateStrength); pw2.addEventListener('input', updateStrength); updateStrength();

        document.getElementById('resetForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const p1 = pw1.value, p2 = pw2.value; const msg = document.getElementById('resetMessage');
          // validation
          if(p1!==p2){ msg.textContent='Gesli se ne ujemata.'; msg.style.color='red'; return; }
          if(p1.length<6){ msg.textContent='Geslo mora imeti vsaj 6 znakov.'; msg.style.color='red'; return; }
          if(!/[A-Z]/.test(p1)){ msg.textContent='Manjka velika črka.'; msg.style.color='red'; return; }
          if(!/[!@#$%^&*?\-_]/.test(p1)){ msg.textContent='Manjka poseben znak.'; msg.style.color='red'; return; }
          msg.textContent='Shranjujem …'; msg.style.color='#0b4c68';
          try {
            const { error } = await supabase.auth.updateUser({ password: p1 });
            if(error) throw error;
            msg.textContent='Geslo posodobljeno ✅ Prijavljamo…'; msg.style.color='#0b8a62';
            // ensure session persists
            try { const s = await supabase.auth.getSession(); if(s?.data?.session){ localStorage.setItem('user_email', s.data.session.user.email||''); } } catch{}
            setTimeout(()=>{ window.location.replace(returnTo); }, 1300);
          } catch (err){ msg.textContent='Napaka: '+(err.message||err); msg.style.color='red'; }
        });
      }

      function go(){
        // Determine intended return target (persist from query/localStorage)
        const qReturn = new URL(location.href).searchParams.get('return');
        if(qReturn) localStorage.setItem('post_login_return', qReturn);
        const stored = localStorage.getItem('post_login_return');
        const target = stored || `${url.origin}/index.html`;
        // persist email for auto-login usage
        supabase.auth.getSession().then(s=>{ try{ if(s?.data?.session?.user?.email){ localStorage.setItem('user_email', s.data.session.user.email); } }catch{} });
        window.location.replace(target);
      }
    })();
  </script>
</head>
<body>
  <div class="box">
    <h2>Prijavljam …</h2>
    <p class="muted">Prosim počakaj trenutek, nalagamo prijavo.</p>
  </div>
</body>
</html>
