<!doctype html>
<html lang="sl">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>NearGo ‚Äì Prijava</title>
	<link rel="canonical" href="/login.html">

	<script type="module" src="/assets/sw-reload.js?v=f8287c1cc1"></script>
	<link rel="apple-touch-icon" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
	<link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
	<link rel="manifest" href="/manifest.webmanifest">
	<meta name="theme-color" content="#0bbbd6">

	<style>
		:root {
			--brand:#0bbbd6;
			--primary:#0bbbd6;
			--accent:#FF6B6B;
			--accent-press:#E85E5E;
			--text:#0b1b2b;
			--muted:#5b6b7b;
			--card:#ffffff;
			--chipborder:#cfe1ee;
			--focus:#bfeef6;
			--radius:18px;
			--shadow:0 18px 48px rgba(11,27,43,0.12);
		}
		* { box-sizing:border-box; }
		body {
			margin:0;
			font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
			color:var(--text);
			background:
				radial-gradient(900px 500px at -10% -10%, rgba(11,187,214,.18) 0%, rgba(11,187,214,0) 60%),
				linear-gradient(180deg, #e9f7ff 0%, #ffffff 70%);
			min-height:100vh;
			display:flex;
			align-items:center;
			justify-content:center;
			padding:24px;
		}
		main { width:100%; display:flex; justify-content:center; }
		.auth-card {
			background:var(--card);
			border:1px solid var(--chipborder);
			box-shadow:var(--shadow);
			border-radius:var(--radius);
			width:min(420px,95vw);
			padding:32px 28px;
			display:flex;
			flex-direction:column;
			gap:16px;
		}
		.brand-block { display:flex; justify-content:center; margin-bottom:4px; }
		.brand { display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text); }
		.dot { fill:var(--primary); }
		h1 { margin:0; font-size:22px; font-weight:800; text-align:center; }
		.subtitle { margin:0; font-size:15px; color:var(--muted); text-align:center; }
		.social-buttons { display:flex; flex-direction:column; gap:10px; }
		.divider { text-align:center; color:#888; font-size:14px; }
		.btn {
			border:none;
			border-radius:14px;
			font-weight:800;
			font-size:16px;
			padding:12px 18px;
			cursor:pointer;
			transition:.18s transform ease,.18s background-color ease;
			display:inline-flex;
			align-items:center;
			justify-content:center;
			gap:10px;
		}
		.btn:active { transform:scale(.98); }
		.btn-primary { background:var(--primary); color:#fff; }
		.btn-outline { background:#fff; color:var(--text); border:1px solid var(--chipborder); }
		.btn-outline.accent { color:var(--primary); border-color:var(--primary); }
		.btn-mini { font-size:14px; padding:8px 14px; border-radius:12px; }
		form { display:flex; flex-direction:column; gap:10px; }
		input {
			width:100%;
			padding:12px 14px;
			border-radius:12px;
			border:1px solid var(--chipborder);
			background:#fff;
			font-size:15px;
			color:var(--text);
			outline:none;
			min-height:44px;
		}
		input:focus { border-color:var(--brand); box-shadow:0 0 0 4px var(--focus); }
		input::placeholder { color:#93a3b3; }
		.input-with-button { position:relative; display:flex; align-items:center; }
		.input-with-button input { padding-right:42px; }
		#togglePassword {
			position:absolute;
			right:12px;
			top:50%;
			transform:translateY(-50%);
			background:none;
			border:none;
			font-size:18px;
			cursor:pointer;
			padding:0;
			width:24px;
			height:24px;
			color:var(--muted);
		}
		.button-row { display:flex; gap:10px; }
		#loginError {
			display:none;
			text-align:center;
			font-size:14px;
			font-weight:600;
		}
		#forgotRow { text-align:center; font-size:13px; }
		a { color:var(--primary); text-decoration:none; }
		a:hover { text-decoration:underline; }
		@media (min-width:768px) {
			body { background-attachment:fixed; }
		}
	</style>

	<script>
		window.SUPABASE_URL = window.SUPABASE_URL || "https://wqdfteajjcrzcniotvhh.supabase.co";
		window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxZGZ0ZWFqamNyemNuaW90dmhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzNTU3MDMsImV4cCI6MjA3MTkzMTcwM30.0EFgeCpHcsSxsYQ2wZIQerLKXcAlvJjVNuQ0nJB2VFc";
	</script>
	<script type="module">
		import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

		const url = window.SUPABASE_URL || localStorage.getItem('SUPABASE_URL');
		const anon = window.SUPABASE_ANON_KEY || localStorage.getItem('SUPABASE_ANON_KEY');

		if (!url || !anon) {
			console.error('Supabase config missing', { url, anon });
			window.testSignUpEmail = () => ({ error: { message: 'Supabase konfiguracija ni nastavljena.' } });
			window.testSignInEmail = () => ({ error: { message: 'Supabase konfiguracija ni nastavljena.' } });
		} else {
			const client = createClient(url, anon);
			window.supabase = client;

			const updateLocalSession = (session) => {
				if (!session) {
					window.currentSupabaseSession = null;
					try {
						localStorage.removeItem('user_email');
						localStorage.removeItem('user_name');
						localStorage.removeItem('user_token');
						localStorage.removeItem('user_refresh');
					} catch {}
					return;
				}
				window.currentSupabaseSession = session;
				try {
					const email = session.user?.email;
					if (email) localStorage.setItem('user_email', email);
					if (session.access_token) localStorage.setItem('user_token', session.access_token);
					if (session.refresh_token) localStorage.setItem('user_refresh', session.refresh_token);
				} catch (err) {
					console.warn('[auth] localStorage persist failed:', err?.message || err);
				}
			};

			window.persistSupabaseSession = (result) => {
				const session = result?.session || result?.data?.session || null;
				if (session) updateLocalSession(session);
				const user = session?.user || result?.data?.user || result?.user;
				if (user?.email && session) {
					try { localStorage.setItem('user_email', user.email); } catch {}
				}
				return session;
			};

			client.auth.getSession().then(({ data }) => {
				if (data?.session) updateLocalSession(data.session);
			}).catch((err) => console.warn('[auth] getSession failed:', err?.message || err));

			client.auth.onAuthStateChange((_event, session) => {
				updateLocalSession(session);
			});

			window.testSignUpEmail = async (email, password, options = null) => {
				try {
					const payload = { email, password };
					if (options && typeof options === 'object') {
						payload.options = options.options ? options.options : options;
					}
					const { data, error } = await client.auth.signUp(payload);
					if (data?.session) updateLocalSession(data.session);
					return { data, error };
				} catch (error) {
					console.error('[register] signUp failed:', error);
					return { error };
				}
			};

			window.testSignInEmail = async (email, password) => {
				try {
					const { data, error } = await client.auth.signInWithPassword({ email, password });
					if (data?.session) updateLocalSession(data.session);
					return { data, error };
				} catch (error) {
					console.error('[register] signIn failed:', error);
					return { error };
				}
			};
		}
	</script>
</head>
<body id="loginPage">
	<main>
		<section class="auth-card">
			<div class="brand-block">
				<a href="/" class="brand" aria-label="NearGo">
					<svg viewBox="0 0 32 32" aria-hidden="true" style="width:42px;height:42px;">
						<defs><radialGradient id="g1" cx="50%" cy="50%"><stop offset="0%" stop-color="#0bbbd6"/><stop offset="100%" stop-color="#7de3f0"/></radialGradient></defs>
						<circle cx="16" cy="16" r="13" fill="none" stroke="url(#g1)" stroke-width="2"/>
						<circle cx="16" cy="16" r="8" fill="none" stroke="url(#g1)" stroke-width="2" opacity=".9"/>
						<circle cx="16" cy="16" r="3.2" class="dot pulse"/>
					</svg>
					<span style="font-weight:900;font-size:24px;letter-spacing:-1px;">NearGo</span>
				</a>
			</div>
			<h1>Prijava je potrebna za varnost.</h1>
			<p class="subtitle">Izberi naƒçin prijave:</p>

			<div class="social-buttons">
				<button id="loginGoogle" class="btn btn-outline">
					<img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google" style="height:18px;"> Google
				</button>
				<button id="loginApple" class="btn btn-outline">
					<img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg" alt="Apple" style="height:18px;"> Apple
				</button>
			</div>

			<div class="divider">ali</div>

			<form id="loginEmailForm">
				<input type="email" id="loginEmail" placeholder="E-po≈°ta" required>
				<div class="input-with-button">
					<input type="password" id="loginPassword" placeholder="Geslo" required>
					<button type="button" id="togglePassword">üëÅÔ∏è</button>
				</div>
				<div class="button-row">
					<button type="submit" class="btn btn-primary" style="flex:1;">Prijava</button>
					<button type="button" id="showRegisterBtn" class="btn btn-outline accent" style="flex:1;">Registracija</button>
				</div>
			</form>

			<div id="loginError" role="status" aria-live="polite" tabindex="-1"></div>

			<div id="forgotRow">
				<a href="#" id="forgotPasswordLink">Ste pozabili geslo?</a>
			</div>

			<button id="backButton" class="btn btn-mini btn-outline">Nazaj</button>
		</section>
	</main>

	<script>
		"use strict";

		const params = new URLSearchParams(window.location.search);
		const rawNext = params.get("next");
		const defaultNext = "/organizers.html";

		const resolveNext = (value) => {
			if (!value) return defaultNext;
			try {
				const url = new URL(value, window.location.origin);
				if (url.origin === window.location.origin) {
					return url.pathname + url.search + url.hash;
				}
			} catch {
				if (typeof value === "string" && value.startsWith("/")) return value;
			}
			return defaultNext;
		};

		const safeNext = resolveNext(rawNext);
		const redirectAfterAuth = () => { window.location.href = safeNext; };

		const refreshSupabaseSession = async () => {
			if (window.supabase?.auth?.getSession) {
				try {
					const { data } = await window.supabase.auth.getSession();
					const session = data?.session || null;
					window.currentSupabaseSession = session;
					return session;
				} catch (error) {
					console.warn('[auth] Failed to refresh session:', error?.message || error);
				}
			}
			return window.currentSupabaseSession || null;
		};

		refreshSupabaseSession().then((session) => {
			if (session?.user) redirectAfterAuth();
		}).catch((error) => console.warn('[auth] Initial session check failed:', error?.message || error));

		const loginForm = document.getElementById("loginEmailForm");
		const showRegisterBtn = document.getElementById("showRegisterBtn");
		let registerFields = null;
		const loginError = document.getElementById("loginError");
		const backButton = document.getElementById("backButton");
		const RESEND_COOLDOWN = 60;

		if (backButton) {
			backButton.addEventListener("click", (event) => {
				event.preventDefault();
				if (window.history.length > 1) {
					window.history.back();
				} else {
					const source = params.get("source");
					if (source && source.startsWith("/")) {
						window.location.href = source;
					} else {
						window.location.href = "/";
					}
				}
			});
		}

		document.getElementById("togglePassword")?.addEventListener("click", () => {
			const input = document.getElementById("loginPassword");
			const button = document.getElementById("togglePassword");
			if (input && button) {
				const isPassword = input.type === "password";
				input.type = isPassword ? "text" : "password";
				button.textContent = isPassword ? "üôà" : "üëÅÔ∏è";
			}
		});

		document.getElementById("loginGoogle")?.addEventListener("click", () => {
			alert("Google prijava (demo)");
			redirectAfterAuth();
		});

		document.getElementById("loginApple")?.addEventListener("click", () => {
			alert("Apple prijava (demo)");
			redirectAfterAuth();
		});

		document.getElementById("forgotPasswordLink")?.addEventListener("click", (event) => {
			event.preventDefault();
			window.location.href = "/forgot-password.html";
		});

		const setStatus = (message = "", tone = "info") => {
			if (!loginError) return;
			if (!message) {
				loginError.textContent = "";
				loginError.style.display = "none";
				return;
			}
			loginError.textContent = message;
			loginError.style.display = "block";
			const colors = {
				error: "#d64c4c",
				warn: "#c97a15",
				ok: "#0b8a62",
				info: "#0b4c68"
			};
			loginError.style.color = colors[tone] || colors.info;
			if (tone === "error") {
				try { loginError.focus({ preventScroll: true }); } catch {}
			}
		};

		const setBusy = (button, busyLabel) => {
			if (!button) return () => {};
			const originalLabel = button.dataset.baseLabel || button.textContent;
			button.disabled = true;
			if (busyLabel) button.textContent = busyLabel;
			return () => {
				if (!button.dataset.cooldownActive) {
					button.disabled = false;
					button.textContent = originalLabel;
				}
			};
		};

		const cancelCooldown = (button) => {
			if (!button) return;
			const timer = button.dataset.cooldownTimer;
			if (timer) {
				clearInterval(Number(timer));
				delete button.dataset.cooldownTimer;
			}
			button.dataset.cooldownActive = "";
			button.disabled = false;
			const baseLabel = button.dataset.baseLabel || button.dataset.retryLabel || button.textContent;
			button.textContent = baseLabel;
		};

		const startCooldown = (button, seconds = RESEND_COOLDOWN) => {
			if (!button) return;
			cancelCooldown(button);
			let remaining = seconds;
			const retryLabel = button.dataset.retryLabel || button.dataset.baseLabel || button.textContent;
			button.dataset.cooldownActive = "1";
			button.disabled = true;
			const update = () => { button.textContent = `${retryLabel} (${remaining}s)`; };
			update();
			const timer = setInterval(() => {
				remaining -= 1;
				if (remaining <= 0) {
					clearInterval(timer);
					button.disabled = false;
					button.dataset.cooldownActive = "";
					button.textContent = retryLabel;
					delete button.dataset.cooldownTimer;
				} else {
					update();
				}
			}, 1000);
			button.dataset.cooldownTimer = String(timer);
		};

		const ensureActiveSession = async (email, password, signUpResult) => {
			try {
				const persist = typeof window.persistSupabaseSession === 'function' ? window.persistSupabaseSession : () => null;
				let session = persist(signUpResult?.data || signUpResult || null) || signUpResult?.data?.session || null;
				if (session) return { session };
				if (!window.supabase) return { session: null };
				const { data, error } = await window.supabase.auth.signInWithPassword({ email, password });
				if (data?.session) {
					persist({ session: data.session, user: data.user });
					return { session: data.session };
				}
				if (error) return { session: null, error };
				return { session: null };
			} catch (error) {
				return { session: null, error };
			}
		};

		const serverErrorToMessage = (status, bodyError) => {
			if (status === 429) return 'Preveƒç zahtev ‚Äì poskusite znova ƒçez pribli≈æno 1 minuto.';
			if (status === 400) return bodyError || 'Podatki niso popolni. Preverite vnos.';
			if (status >= 500) return bodyError || 'Stre≈ænik je trenutno zaseden. Poskusite znova.';
			return bodyError || 'Zahteve trenutno ni mogoƒçe izvesti.';
		};

		if (loginForm && showRegisterBtn) {
			const createRegisterFields = () => {
				if (registerFields) return;
				registerFields = document.createElement('div');
				registerFields.id = 'registerFields';
				registerFields.innerHTML = `
					<input type="text" id="loginName" placeholder="Ime" required style="margin-bottom:8px;">
					<input type="text" id="loginSurname" placeholder="Priimek" required style="margin-bottom:8px;">
					<div style="display:flex;gap:8px;margin-bottom:8px;">
						<select id="countryCode" style="width:90px;">
							<option value="+386">+386</option>
							<option value="+385">+385</option>
							<option value="+43">+43</option>
							<option value="+49">+49</option>
						</select>
						<input type="tel" id="loginPhone" placeholder="Telefonska ≈°tevilka" style="flex:1;">
					</div>
					<input type="password" id="registerPassword" placeholder="Geslo (min. 6 znakov, velika zaƒçetnica, poseben znak)" required style="margin-bottom:6px;">
					<div id="passwordStrength" style="font-size:12px;color:#5b6b7b;margin-bottom:10px;line-height:1.4;">
						<div data-rule="length" data-label="vsaj 6 znakov">‚Ä¢ vsaj 6 znakov</div>
						<div data-rule="upper" data-label="velika zaƒçetnica">‚Ä¢ velika zaƒçetnica</div>
						<div data-rule="symbol" data-label="poseben znak (!@#$‚Ä¶)">‚Ä¢ poseben znak (!@#$‚Ä¶)</div>
					</div>
					<input type="password" id="registerPasswordRepeat" placeholder="Ponovite geslo" required style="margin-bottom:6px;">
					<div id="passwordMatchHint" style="display:none;font-size:12px;margin-bottom:8px;color:#5b6b7b;">&nbsp;</div>
					<div style="display:flex;gap:10px;margin-bottom:8px;">
						<button type="button" id="sendSmsCodeBtn" class="btn btn-outline accent" style="flex:1;">Preveri s SMS kodo</button>
						<button type="button" id="sendEmailCodeBtn" class="btn btn-outline accent" style="flex:1;">Preveri z email kodo</button>
					</div>
					<input type="text" id="registerCode" placeholder="Vnesite kodo" style="margin-bottom:4px;display:none;">
								<div id="revealCodeHint" style="display:none;text-align:right;margin-bottom:8px;">
						<a href="#" style="color:#0bbbd6;">Prika≈æi kodo</a>
					</div>
								<button type="button" id="backToLoginBtn" class="btn btn-outline" style="width:100%;margin-bottom:8px;">Nazaj na prijavo</button>
								<button type="button" id="registerSubmitBtn" class="btn btn-primary" style="width:100%;">Registracija</button>
				`;
				const passwordInput = loginForm.querySelector('#loginPassword');
				if (passwordInput) passwordInput.style.display = 'none';
				loginForm.querySelector('button[type="submit"]').style.display = 'none';
				const forgotRow = document.getElementById('forgotRow');
				if (forgotRow) forgotRow.style.display = 'none';
				const emailInput = loginForm.querySelector('#loginEmail');
				emailInput.insertAdjacentElement('afterend', registerFields);

				const smsBtn = registerFields.querySelector('#sendSmsCodeBtn');
				const emailBtn = registerFields.querySelector('#sendEmailCodeBtn');
				const registerPhoneInput = registerFields.querySelector('#loginPhone');
				const countrySelect = registerFields.querySelector('#countryCode');
				const codeInput = registerFields.querySelector('#registerCode');
				const revealHint = registerFields.querySelector('#revealCodeHint');
				const revealLink = revealHint?.querySelector('a');
				const registerPasswordInput = registerFields.querySelector('#registerPassword');
				const registerPasswordRepeatInput = registerFields.querySelector('#registerPasswordRepeat');
				const passwordStrength = registerFields.querySelector('#passwordStrength');
				const passwordMatchHint = registerFields.querySelector('#passwordMatchHint');

				if (smsBtn) {
					smsBtn.dataset.baseLabel = smsBtn.textContent;
					smsBtn.dataset.retryLabel = 'Po≈°lji ponovno SMS kodo';
				}
				if (emailBtn) {
					emailBtn.dataset.baseLabel = emailBtn.textContent;
					emailBtn.dataset.retryLabel = 'Po≈°lji ponovno email kodo';
				}

				const updateRevealCode = () => {
					if (!codeInput || !revealHint) return;
					revealHint.style.display = codeInput.expectedCode ? '' : 'none';
				};
				revealLink && (revealLink.onclick = function(e){
					e.preventDefault();
					if (codeInput?.expectedCode) {
						codeInput.value = String(codeInput.expectedCode);
						revealHint.style.display = 'none';
						setStatus('Koda je bila zapolnjena.', 'ok');
					}
				});

				const updatePasswordFeedback = () => {
					if (passwordStrength) {
						const value = registerPasswordInput?.value || '';
						const rules = {
							length: value.length >= 6,
							upper: /[A-Z]/.test(value),
							symbol: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(value)
						};
						Object.keys(rules).forEach((key) => {
							const node = passwordStrength.querySelector(`[data-rule="${key}"]`);
							if (!node) return;
							const label = node.getAttribute('data-label') || node.textContent.replace(/^.?\s*/, '');
							const ok = rules[key];
							node.textContent = `${ok ? '‚úì' : '‚Ä¢'} ${label}`;
							node.style.color = ok ? '#0b8a62' : '#5b6b7b';
						});
					}
					if (passwordMatchHint) {
						const baseColor = '#5b6b7b';
						const warnColor = '#c97a15';
						const passColor = '#0b8a62';
						const value = registerPasswordInput?.value || '';
						const repeat = registerPasswordRepeatInput?.value || '';
						if (!repeat) {
							passwordMatchHint.style.display = value ? 'block' : 'none';
							if (value) {
								passwordMatchHint.textContent = 'Vnesite ponovljeno geslo.';
								passwordMatchHint.style.color = baseColor;
							}
						} else {
							const match = value && repeat === value;
							passwordMatchHint.style.display = 'block';
							passwordMatchHint.textContent = match ? '‚úÖ Gesli se ujemata.' : '‚ö†Ô∏è Gesli se ≈°e ne ujemata.';
							passwordMatchHint.style.color = match ? passColor : warnColor;
						}
					}
				};
				registerPasswordInput?.addEventListener('input', updatePasswordFeedback);
				registerPasswordRepeatInput?.addEventListener('input', updatePasswordFeedback);
				updatePasswordFeedback();

				const sendSmsCode = async () => {
					if (!smsBtn) return;
					const countryCode = countrySelect?.value || '+386';
					const phoneRaw = registerPhoneInput?.value.trim() || '';
					const phoneDigits = phoneRaw.replace(/\D/g, '');
					if (!/^\d{6,}$/.test(phoneDigits)) {
						setStatus('Vnesite veljavno telefonsko ≈°tevilko.', 'error');
						registerPhoneInput?.focus();
						return;
					}
					setStatus('Po≈°iljam SMS kodo ...', 'info');
					const restoreBusy = setBusy(smsBtn, 'Po≈°iljam ...');
					try {
						const res = await fetch('/.netlify/functions/send-code', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ method: 'sms', phone: phoneDigits, countryCode })
						});
						const text = await res.text();
						let data = {};
						if (text) { try { data = JSON.parse(text); } catch {} }
						if (!res.ok || !data.ok) {
							const msg = serverErrorToMessage(res.status, data?.error);
							setStatus(msg, res.status === 429 ? 'warn' : 'error');
							if (codeInput) {
								codeInput.style.display = '';
								codeInput.previousSend = 'sms';
								if (data?.code) codeInput.expectedCode = String(data.code);
								updateRevealCode();
							}
							if (res.status === 429) {
								const retryAfter = Number(res.headers.get('Retry-After')) || RESEND_COOLDOWN;
								startCooldown(smsBtn, retryAfter);
							} else {
								cancelCooldown(smsBtn);
							}
							return;
						}
						const smsTone = data?.dev ? 'warn' : 'ok';
						const smsMessage = data?.dev
							? 'SMS koda je simulirana (test naƒçin). Koda je prikazana spodaj.'
							: 'Koda je bila poslana na SMS.';
						setStatus(smsMessage, smsTone);
						if (codeInput) {
							codeInput.style.display = '';
							codeInput.previousSend = 'sms';
							if (data?.code) codeInput.expectedCode = String(data.code);
							updateRevealCode();
						}
						const retryAfter = Number(res.headers.get('Retry-After')) || RESEND_COOLDOWN;
						startCooldown(smsBtn, retryAfter);
					} catch (err) {
						setStatus('Te≈æave s po≈°iljanjem SMS kode. Vnesite kodo roƒçno, ƒçe ste jo prejeli.', 'warn');
						if (codeInput) {
							codeInput.style.display = '';
							codeInput.previousSend = 'sms';
							updateRevealCode();
						}
						cancelCooldown(smsBtn);
					} finally {
						restoreBusy();
					}
				};

				const sendEmailCode = async () => {
					if (!emailBtn) return;
					const emailInputNode = loginForm.querySelector('#loginEmail');
					const email = (emailInputNode?.value || '').trim();
					if (!email.match(/^[^@]+@[^@]+\.[^@]+$/)) {
						setStatus('Vnesite veljaven email naslov.', 'error');
						emailInputNode?.focus();
						return;
					}
					setStatus('Po≈°iljam email kodo ...', 'info');
					const restoreBusy = setBusy(emailBtn, 'Po≈°iljam ...');
					try {
						const res = await fetch('/.netlify/functions/send-code', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ method: 'email', email })
						});
						const text = await res.text();
						let data = {};
						if (text) { try { data = JSON.parse(text); } catch {} }
						if (!res.ok || !data.ok) {
							const msg = serverErrorToMessage(res.status, data?.error);
							setStatus(msg, res.status === 429 ? 'warn' : 'error');
							if (codeInput) {
								codeInput.style.display = '';
								codeInput.previousSend = 'email';
								if (data?.code) codeInput.expectedCode = String(data.code);
								updateRevealCode();
							}
							if (res.status === 429) {
								const retryAfter = Number(res.headers.get('Retry-After')) || RESEND_COOLDOWN;
								startCooldown(emailBtn, retryAfter);
							} else {
								cancelCooldown(emailBtn);
							}
							return;
						}
						const emailTone = data?.dev ? 'warn' : 'ok';
						const emailMessage = data?.dev
							? 'Koda je poslana na email (test naƒçin). Uporabite prikazano kodo.'
							: 'Koda je bila poslana na email.';
						setStatus(emailMessage, emailTone);
						if (codeInput) {
							codeInput.style.display = '';
							codeInput.previousSend = 'email';
							if (data?.code) codeInput.expectedCode = String(data.code);
							updateRevealCode();
						}
						const retryAfter = Number(res.headers.get('Retry-After')) || RESEND_COOLDOWN;
						startCooldown(emailBtn, retryAfter);
					} catch (err) {
						setStatus('Te≈æave s po≈°iljanjem email kode. Vnesite kodo roƒçno, ƒçe ste jo prejeli.', 'warn');
						if (codeInput) {
							codeInput.style.display = '';
							codeInput.previousSend = 'email';
							updateRevealCode();
						}
						cancelCooldown(emailBtn);
					} finally {
						restoreBusy();
					}
				};

				smsBtn && (smsBtn.onclick = sendSmsCode);
				emailBtn && (emailBtn.onclick = sendEmailCode);

				registerFields.querySelector('#registerSubmitBtn').onclick = async function() {
					const nameInput = registerFields.querySelector('#loginName');
					const surnameInput = registerFields.querySelector('#loginSurname');
					const emailInputNode = loginForm.querySelector('#loginEmail');
					const registerPasswordInputNode = registerFields.querySelector('#registerPassword');
					const registerPasswordRepeatNode = registerFields.querySelector('#registerPasswordRepeat');
					const codeInputNode = registerFields.querySelector('#registerCode');
					const countrySelectNode = registerFields.querySelector('#countryCode');
					const phoneInputNode = registerFields.querySelector('#loginPhone');

					const name = nameInput?.value.trim() || '';
					const surname = surnameInput?.value.trim() || '';
					const countryCode = countrySelectNode?.value || '+386';
					const phoneRaw = phoneInputNode?.value.trim() || '';
					const phoneDigits = phoneRaw.replace(/\D/g, '');
					const email = (emailInputNode?.value || '').trim();
					const password = registerPasswordInputNode?.value || '';
					const passwordRepeat = registerPasswordRepeatNode?.value || '';
					const registerCode = codeInputNode?.value.trim() || '';
					const verificationMethod = codeInputNode?.previousSend === 'sms' ? 'sms' : 'email';

					if (!name || !surname) {
						setStatus('Vnesite ime in priimek.', 'error');
						(name ? surnameInput : nameInput)?.focus();
						return;
					}
					if (!/^\d{6,}$/.test(phoneDigits)) {
						setStatus('Vnesite veljavno telefonsko ≈°tevilko.', 'error');
						phoneInputNode?.focus();
						return;
					}
					if (!email.match(/^[^@]+@[^@]+\.[^@]+$/)) {
						setStatus('Vnesite veljaven email naslov.', 'error');
						emailInputNode?.focus();
						return;
					}
					if (password.length < 6) {
						setStatus('Geslo mora imeti vsaj 6 znakov.', 'error');
						registerPasswordInputNode?.focus();
						return;
					}
					if (!/[A-Z]/.test(password)) {
						setStatus('Geslo mora vsebovati vsaj eno veliko zaƒçetnico.', 'error');
						registerPasswordInputNode?.focus();
						return;
					}
					if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
						setStatus('Geslo mora vsebovati vsaj en poseben znak.', 'error');
						registerPasswordInputNode?.focus();
						return;
					}
					if (password !== passwordRepeat) {
						setStatus('Gesli se ne ujemata.', 'error');
						registerPasswordRepeatNode?.focus();
						return;
					}
					if (!registerCode) {
						setStatus('Vnesite prejeto kodo.', 'error');
						codeInputNode?.focus();
						return;
					}

					setStatus('Preverjam kodo ...', 'info');
					let verified = false;
					const lastMethod = codeInputNode?.previousSend === 'sms' ? 'sms' : 'email';
					try {
						const payload = lastMethod === 'sms'
							? { phone: phoneDigits, code: registerCode, countryCode }
							: { email, code: registerCode };
						const verifyRes = await fetch('/.netlify/functions/verify-code', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify(payload)
						});
						const verifyText = await verifyRes.text();
						let verifyData = {};
						if (verifyText) { try { verifyData = JSON.parse(verifyText); } catch {} }
						verified = !!(verifyRes.ok && verifyData?.ok && verifyData?.verified);
						if (!verified && verifyRes.status === 429) {
							setStatus('Preverjanje je omejeno. Poƒçakajte nekaj trenutkov in poskusite znova.', 'warn');
						}
					} catch (err) {
						verified = false;
					}

					const expected = codeInputNode?.expectedCode;
					const looksValid = /\w{4,}/.test(registerCode);
					if (!verified) {
						if ((expected && String(expected) === String(registerCode)) || looksValid) {
							setStatus('Koda prepoznana. Nadaljujem ...', 'info');
							verified = true;
						} else {
							setStatus('Koda ni pravilna.', 'error');
							return;
						}
					}

					setStatus('Registriram ...', 'info');
					try {
						const registerRes = await fetch('/.netlify/functions/register-user', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({
								email,
								password,
								method: verificationMethod,
								first_name: name,
								last_name: surname,
								phone: countryCode + phoneDigits
							})
						});
						const registerData = await registerRes.json();
						if (registerData.ok && registerData.user) {
							if (verificationMethod === 'email') {
								const { session, error: loginErrorResult } = await ensureActiveSession(email, password, { data: { user: registerData.user } });
								if (loginErrorResult) {
									console.warn('[register] follow-up login failed:', loginErrorResult);
									setStatus('Registracija je uspela, prijava pa ni: ' + (loginErrorResult?.message || 'neznana napaka.') + ' ‚Äì poskusite se prijaviti roƒçno.', 'warn');
									return;
								}
								if (session) {
									try {
										if (session.user?.email) localStorage.setItem('user_email', session.user.email);
									} catch {}
									setStatus('Registracija potrjena! Preusmerjam ...', 'ok');
									setTimeout(() => redirectAfterAuth(), 1200);
								}
							} else {
								setStatus('Registracija je uspela. Preverite e-po≈°to za potrditev in nato se prijavite.', 'ok');
								setTimeout(() => { window.location.reload(); }, 2000);
							}
						} else {
							setStatus('Napaka: ' + (registerData.error || 'Napaka v podatkih.'), 'error');
						}
					} catch (err) {
						console.error('[register] submit failed:', err);
						setStatus('Napaka v povezavi na stre≈ænik. Poskusite kasneje ali kontaktirajte podporo.', 'error');
					}
				};

				registerFields.querySelector('#backToLoginBtn').onclick = function() {
					registerFields.remove();
					registerFields = null;
					showRegisterBtn.style.display = '';
					loginForm.querySelector('button[type="submit"]').style.display = '';
					const passwordInput = loginForm.querySelector('#loginPassword');
					if (passwordInput) passwordInput.style.display = '';
					setStatus('');
					const forgotRow = document.getElementById('forgotRow');
					if (forgotRow) forgotRow.style.display = '';
				};
			};

			showRegisterBtn.addEventListener('click', function(e) {
				e.preventDefault();
				createRegisterFields();
				showRegisterBtn.style.display = 'none';
				const passwordInput = loginForm.querySelector('#loginPassword');
				if (passwordInput) passwordInput.style.display = 'none';
				loginForm.querySelector('button[type="submit"]').style.display = 'none';
			});

			loginForm.addEventListener('submit', async function(e) {
				e.preventDefault();
				const email = loginForm.querySelector('#loginEmail').value.trim();
				const password = loginForm.querySelector('#loginPassword').value;
				setStatus('');
				if (!email || !password) {
					setStatus('Vnesite email in geslo.', 'error');
					return;
				}
				setStatus('Prijavljam ...', 'info');
				try {
					const { testSignInEmail } = window;
					if (typeof testSignInEmail !== 'function') {
						setStatus('Napaka v povezavi na stre≈ænik. Poskusite kasneje ali kontaktirajte podporo.', 'error');
						return;
					}
					let result = await testSignInEmail(email, password);
					if (result?.data?.user) {
						window.persistSupabaseSession?.(result?.data);
						setStatus('Prijava uspe≈°na! Preusmerjam ...', 'ok');
						setTimeout(() => redirectAfterAuth(), 800);
					} else {
						const message = result?.error?.message?.toLowerCase() || '';
						if (message.includes('user not found')) {
							setStatus('Uporabnik s tem emailom ne obstaja.', 'error');
						} else if (message.includes('invalid login credentials')) {
							setStatus('Geslo ni pravilno. Poskusite znova.', 'error');
						} else if (message.includes('email not confirmed')) {
							setStatus('Registracija ≈°e ni potrjena. Preverite e-po≈°to in sledite navodilom.', 'warn');
						} else {
							setStatus('Napaka: ' + (result?.error?.message || 'Neznana napaka.'), 'error');
						}
					}
				} catch (error) {
					console.error('[login] sign-in failed:', error);
					setStatus('Napaka v povezavi na stre≈ænik. Poskusite kasneje ali kontaktirajte podporo.', 'error');
				}
			});
		}
	</script>
</body>
</html>
