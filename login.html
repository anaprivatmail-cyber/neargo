<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hitra registracija / vpis</title>
  <link rel="stylesheet" href="assets/app.css">
</head>
<body>
  <div class="login-container">
    <h1>Prijava</h1>
    <form id="login-form">
      <input type="email" name="email" placeholder="E-po코ta" autocomplete="email" required>
      <input type="password" name="password" placeholder="Geslo" autocomplete="current-password" required>
      <div style="display:flex;gap:10px;margin-top:16px;">
        <button type="submit" id="loginBtn" style="flex:1;">Prijava</button>
        <button type="button" id="showRegisterBtn" style="flex:1;background:#fff;color:#0bbbd6;border:1px solid #0bbbd6;">Registracija</button>
      </div>
      <div id="login-message" style="color:#d64c4c;margin-top:8px;"></div>
      <div style="margin-top:14px;text-align:center;font-size:14px;">
        <a href="#" id="forgotPasswordLink" style="color:#0bbbd6;margin-right:10px">Pozabljeno geslo?</a>
      </div>
    </form>
    <div id="register-section" style="display:none;margin-top:28px;">
      <form id="register-form">
        <div style="display:flex;gap:10px;">
          <input type="text" name="firstName" placeholder="Ime" autocomplete="given-name" required style="flex:1;">
          <input type="text" name="lastName" placeholder="Priimek" autocomplete="family-name" required style="flex:1;">
        </div>
        <div style="margin-top:10px;display:flex;gap:10px;align-items:center;">
          <select name="countryCode" id="countryCodeSelect" style="width:110px;">
            <!-- EU + USA dr쬬ve z emoji zastavicami -->
            <option value="+386">游젏릖 +386 Slovenija</option>
            <option value="+385">游쇓릖 +385 Hrva코ka</option>
            <option value="+43">游뷣릖 +43 Avstrija</option>
            <option value="+49">游뾇릖 +49 Nem캜ija</option>
            <option value="+33">游游 +33 Francija</option>
            <option value="+39">游쉻릖 +39 Italija</option>
            <option value="+34">游쀯릖 +34 맗anija</option>
            <option value="+41">游뻟릖 +41 맜ica</option>
            <option value="+44">游섫릖 +44 UK</option>
            <option value="+31">游游 +31 Nizozemska</option>
            <option value="+32">游游 +32 Belgija</option>
            <option value="+420">游뻟릖 +420 캛e코ka</option>
            <option value="+421">游젏릖 +421 Slova코ka</option>
            <option value="+36">游쇓릖 +36 Mad쬬rska</option>
            <option value="+48">游왫릖 +48 Poljska</option>
            <option value="+40">游游 +40 Romunija</option>
            <option value="+372">游쀯릖 +372 Estonija</option>
            <option value="+371">游쐟릖 +371 Latvija</option>
            <option value="+370">游쐟릖 +370 Litva</option>
            <option value="+358">游游 +358 Finska</option>
            <option value="+47">游游 +47 Norve코ka</option>
            <option value="+45">游뾇릖 +45 Danska</option>
            <option value="+353">游쉻릖 +353 Irska</option>
            <option value="+357">游뻟릖 +357 Ciper</option>
            <option value="+356">游쓇릖 +356 Malta</option>
            <option value="+351">游왫릖 +351 Portugalska</option>
            <option value="+1">游쥟릖 +1 USA</option>
          </select>
          <input type="tel" name="phone" placeholder="Telefonska 코tevilka" autocomplete="tel" required style="flex:1;">
        </div>
        <input type="email" name="email" placeholder="E-po코ta" autocomplete="email" required style="margin-top:10px;">
        <input type="password" name="password" placeholder="Geslo (min. 6 znakov)" autocomplete="new-password" required style="margin-top:10px;">
        <div style="margin-top:10px;display:flex;gap:18px;">
          <button type="button" id="smsCodeBtn" class="code-method-btn selected" style="flex:1;border:1px solid #0bbbd6;color:#0bbbd6;background:#e9f7ff;font-weight:700;">Preveri s SMS kodo</button>
          <button type="button" id="emailCodeBtn" class="code-method-btn" style="flex:1;border:1px solid #cfe1ee;color:#5b6b7b;background:#fff;font-weight:700;">Preveri z email kodo</button>
        </div>
        <div id="register-code-row" style="margin-top:10px;display:none;">
          <input type="text" name="registerCode" placeholder="Vnesite kodo" style="width:140px;">
        </div>
        <button type="submit" id="registerBtn" style="margin-top:16px;width:100%;">Registracija</button>
        <div id="register-message" style="color:#d64c4c;margin-top:8px;"></div>
        <div style="margin-top:14px;text-align:center;font-size:14px;">
          <a href="#" id="backToLoginLink" style="color:#0bbbd6;">Nazaj na prijavo</a>
        </div>
      </form>
    </div>
  </div>
  <script src="assets/app-logic.js"></script>
  <script src="assets/supabase-client.js"></script>
  <script src="assets/utils.js"></script>
  <script>
  // LOGIN LOGIKA
    const loginForm = document.getElementById('login-form');
    const loginMsg = document.getElementById('login-message');
    const registerSection = document.getElementById('register-section');
    const registerLink = document.getElementById('registerLink');
    const forgotPasswordLink = document.getElementById('forgotPasswordLink');

    function getRedirectUrl() {
      const params = new URLSearchParams(window.location.search);
      const redirect = params.get('redirect');
      if (!redirect) return '/my.html';
      if (redirect === 'organizers') return '/organizers.html';
      if (redirect === 'premium') return '/premium.html';
      if (redirect === 'my') return '/my.html';
      if (redirect === 'scans') return '/scans.html';
      return '/my.html';
    }

    loginForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const email = loginForm.querySelector('input[name="email"]').value.trim();
      const password = loginForm.querySelector('input[name="password"]').value;
      loginMsg.textContent = '';
      if (!email || !password) {
        loginMsg.textContent = 'Vnesite email in geslo.';
        return;
      }
      loginMsg.textContent = 'Prijavljam ...';
      try {
        const { testSignInEmail } = window;
        let result = await testSignInEmail(email, password);
        if (result?.data?.user) {
          loginMsg.textContent = 'Prijava uspe코na!';
          window.location.href = getRedirectUrl();
        } else {
          loginMsg.textContent = 'Napaka: ' + (result?.error?.message || 'Uporabnik ne obstaja ali je geslo napa캜no.');
        }
      } catch (e) {
        loginMsg.textContent = 'Napaka: ' + e.message;
      }
    });

    // Gumb za prikaz registracije
    const showRegisterBtn = document.getElementById('showRegisterBtn');
    showRegisterBtn.addEventListener('click', function(e) {
      e.preventDefault();
      loginForm.style.display = 'none';
      registerSection.style.display = 'block';
      loginMsg.textContent = '';
    });

    forgotPasswordLink.addEventListener('click', function(e) {
      e.preventDefault();
      loginMsg.textContent = 'Za obnovitev gesla sledite navodilom v emailu.';
      // Lahko dodamo logiko za po코iljanje emaila za obnovitev gesla
    });

    // REGISTRACIJSKA LOGIKA
    // Google gumb
    document.addEventListener('DOMContentLoaded', function() {
      const googleBtn = document.getElementById('loginGoogle');
      if (googleBtn) {
        googleBtn.innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google" style="height:18px;vertical-align:middle;margin-right:8px"> Google';
      }
    });
    const registerForm = document.getElementById('register-form');
    const registerMsg = document.getElementById('register-message');
    const registerCodeRow = document.getElementById('register-code-row');
    const backToLoginLink = document.getElementById('backToLoginLink');
    backToLoginLink.addEventListener('click', function(e) {
      e.preventDefault();
      registerSection.style.display = 'none';
      loginForm.style.display = 'block';
      codeSent = false;
      registerCodeRow.style.display = 'none';
      registerMsg.textContent = '';
      loginMsg.textContent = '';
      registerForm.reset();
    });

  let codeSent = false;
  let codeMethod = 'sms';

    if (registerForm) {
      // Gumbi za izbiro metode kode
      const smsCodeBtn = document.getElementById('smsCodeBtn');
      const emailCodeBtn = document.getElementById('emailCodeBtn');
      smsCodeBtn.addEventListener('click', function() {
        codeMethod = 'sms';
        smsCodeBtn.classList.add('selected');
        smsCodeBtn.style.background = '#e9f7ff';
        smsCodeBtn.style.color = '#0bbbd6';
        smsCodeBtn.style.border = '1px solid #0bbbd6';
        emailCodeBtn.classList.remove('selected');
        emailCodeBtn.style.background = '#fff';
        emailCodeBtn.style.color = '#5b6b7b';
        emailCodeBtn.style.border = '1px solid #cfe1ee';
      });
      emailCodeBtn.addEventListener('click', function() {
        codeMethod = 'email';
        emailCodeBtn.classList.add('selected');
        emailCodeBtn.style.background = '#e9f7ff';
        emailCodeBtn.style.color = '#0bbbd6';
        emailCodeBtn.style.border = '1px solid #0bbbd6';
        smsCodeBtn.classList.remove('selected');
        smsCodeBtn.style.background = '#fff';
        smsCodeBtn.style.color = '#5b6b7b';
        smsCodeBtn.style.border = '1px solid #cfe1ee';
      });

      registerForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        registerMsg.textContent = '';
        const firstName = registerForm.firstName.value.trim();
        const lastName = registerForm.lastName.value.trim();
        const countryCode = registerForm.countryCode.value;
        const phone = registerForm.phone.value.trim();
        const email = registerForm.email.value.trim();
        const password = registerForm.password.value;
        const registerCode = registerForm.registerCode.value.trim();

        // Validacija
        if (!firstName || !lastName) {
          registerMsg.textContent = 'Vnesite ime in priimek.';
          return;
        }
        if (!/^\d{6,}$/.test(phone.replace(/\D/g, ''))) {
          registerMsg.textContent = 'Vnesite veljavno telefonsko 코tevilko.';
          return;
        }
        if (!email.match(/^[^@]+@[^@]+\.[^@]+$/)) {
          registerMsg.textContent = 'Vnesite veljaven email naslov.';
          return;
        }
        if (password.length < 6) {
          registerMsg.textContent = 'Geslo mora imeti vsaj 6 znakov.';
          return;
        }

        // Po코lji kodo, 캜e 코e ni bila poslana
        if (!codeSent) {
          registerMsg.textContent = 'Po코iljam kodo ...';
          let res;
          try {
            if (codeMethod === 'sms') {
              res = await fetch('/.netlify/functions/send-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ method: 'sms', phone, countryCode })
              });
            } else {
              res = await fetch('/.netlify/functions/send-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ method: 'email', email })
              });
            }
            const data = await res.json();
            if (data.ok && data.codeSent) {
              codeSent = true;
              registerMsg.textContent = 'Koda je bila poslana.';
              registerCodeRow.style.display = '';
              // Ozadje okenca za vpis kode
              registerCodeRow.style.background = '#e9f7ff';
              registerCodeRow.style.borderRadius = '10px';
              return;
            } else {
              registerMsg.textContent = 'Napaka pri po코iljanju kode.';
              return;
            }
          } catch (err) {
            registerMsg.textContent = 'Napaka: ' + err.message;
            return;
          }
        }

        // Preveri kodo
        if (!registerCode) {
          registerMsg.textContent = 'Vnesite prejeto kodo.';
          return;
        }
        registerMsg.textContent = 'Preverjam kodo ...';
        try {
          let verifyRes;
          if (codeMethod === 'sms') {
            verifyRes = await fetch('/.netlify/functions/verify-code', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ phone, code: registerCode, countryCode })
            });
          } else {
            verifyRes = await fetch('/.netlify/functions/verify-code', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, code: registerCode })
            });
          }
          const verifyData = await verifyRes.json();
          if (!verifyData.ok || !verifyData.verified) {
            registerMsg.textContent = 'Koda ni pravilna.';
            return;
          }
        } catch (err) {
          registerMsg.textContent = 'Napaka: ' + err.message;
          return;
        }

        // Registracija v Supabase
        registerMsg.textContent = 'Registriram ...';
        try {
          const { testSignUpEmail } = window;
          const result = await testSignUpEmail(email, password, {
            data: {
              first_name: firstName,
              last_name: lastName,
              phone: countryCode + phone
            }
          });
          if (result?.data?.user) {
            registerMsg.textContent = 'Registracija uspe코na!';
            setTimeout(() => {
              window.location.href = getRedirectUrl();
            }, 800);
          } else {
            registerMsg.textContent = 'Napaka: ' + (result?.error?.message || 'Neznana napaka.');
          }
        } catch (err) {
          registerMsg.textContent = 'Napaka: ' + err.message;
        }
      });
    }
  </script>
</body>
</html>
