<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NearGo – Koledar terminov (ponudnik)</title>

  <link rel="icon" href="/icon-192.png">
  <meta name="theme-color" content="#0bbbd6">

  <style>
    :root{
      --brand:#0bbbd6; --text:#0b1b2b; --muted:#5b6b7b; --card:#fff;
      --chip:#fff; --chipborder:#cfe1ee; --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:16px; --primary:#0bbbd6; --focus:#bfeef6; --ok:#11a67a; --bad:#d64c4c;
      --bg: linear-gradient(180deg, #e9f7ff 0%, #ffffff 70%);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text); background: var(--bg);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    a{color:inherit; text-decoration:none}
    .wrap{ max-width:1100px; margin:0 auto; padding:14px; }

    header{position:sticky; top:0; z-index:10; backdrop-filter:blur(6px);
      background:color-mix(in srgb, var(--card) 88%, transparent); box-shadow:0 4px 16px rgba(0,0,0,.05);}
    .nav{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 14px; }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; font-size:18px}
    .brand svg{width:24px; height:24px}
    .btn{background:var(--primary); color:#fff; border:none; padding:10px 14px; border-radius:12px; font-weight:900; cursor:pointer}
    .btn.link{background:#fff; color:#000; border:1px solid var(--chipborder)}
    .btn.mini{padding:8px 12px; font-size:13px}
    .btn.danger{ background:#cf3c3c }
    .pill{border:1px solid var(--chipborder); background:var(--chip); border-radius:999px; height:34px; display:flex; align-items:center; padding:0 10px; font-weight:800; font-size:14px}
    .card{background:var(--card); box-shadow:var(--shadow); border-radius:var(--radius); border:1px solid var(--chipborder); padding:14px}
    .title{font-weight:900; margin-bottom:8px}
    .muted{color:var(--muted)}

    .grid{ display:grid; grid-template-columns: 320px 1fr; gap:14px; }
    @media(max-width:920px){ .grid{ grid-template-columns: 1fr; } }

    /* Koledar */
    .cal{ background:var(--card); border:1px solid var(--chipborder); border-radius:14px; overflow:hidden }
    .cal-head{ display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-bottom:1px solid var(--chipborder); }
    .cal-head .when{ font-weight:900 }
    .cal-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; padding:10px }
    .dow{ text-align:center; font-weight:900; color:var(--muted); font-size:12px }
    .day{ border:1px solid var(--chipborder); border-radius:10px; min-height:44px; padding:6px; cursor:pointer; display:flex; justify-content:space-between; align-items:flex-start; flex-direction:column; gap:6px; }
    .day.inactive{ opacity:.45 }
    .day.selected{ outline:3px solid var(--focus); border-color:var(--brand); }
    .day .num{ font-weight:900; font-size:13px }
    .day .caps{ font-size:11px; color:var(--muted) }

    /* Forme */
    label{display:flex; flex-direction:column; gap:6px; font-weight:800; font-size:13px}
    input,select,textarea{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--chipborder); background:var(--card); color:var(--text); outline:none; min-height:40px; font-size:15px; }
    input:focus,select:focus,textarea:focus{border-color:var(--brand); box-shadow:0 0 0 4px var(--focus)}
    .row{display:grid; grid-template-columns:1fr; gap:12px}
    .row--2{ grid-template-columns:1fr 1fr; }
    .row--3{ grid-template-columns:1fr 1fr 1fr; }
    @media(max-width:720px){ .row--2,.row--3{ grid-template-columns:1fr; } }

    /* Majhni radio/checkbox (usklajeno z index.html) */
    label.inline, .inline label{ display:inline-flex; align-items:center; gap:8px; font-weight:800; font-size:13px; line-height:1; flex-direction:row; }
    input[type="checkbox"]{
      -webkit-appearance:none; appearance:none; width:14px; height:14px; margin:0; position:relative;
      border:2px solid #a9c3d6; border-radius:4px; background:#fff; outline:none; display:inline-block; box-sizing:content-box; padding:0; min-height:0 !important;
    }
    input[type="checkbox"]::after{
      content:""; position:absolute; left:3px; top:-1px; width:6px; height:10px; border-right:3px solid var(--primary); border-bottom:3px solid var(--primary);
      transform:rotate(45deg); opacity:0; transition:opacity .12s;
    }
    input[type="checkbox"]:checked{ border-color:var(--primary) }
    input[type="checkbox"]:checked::after{ opacity:1 }
    input[type="radio"]{
      -webkit-appearance:none; appearance:none; width:14px; height:14px; margin:0; position:relative;
      border:2px solid #a9c3d6; border-radius:50%; background:#fff; outline:none; display:inline-block; box-sizing:content-box; padding:0; min-height:0 !important;
    }
    input[type="radio"]::after{
      content:""; position:absolute; left:3px; top:3px; width:6px; height:6px; background:var(--primary); border-radius:50%; opacity:0; transition:opacity .12s;
    }
    input[type="radio"]:checked{ border-color:var(--primary) }
    input[type="radio"]:checked::after{ opacity:1 }

    /* Seznami slotov/rezervacij */
    .slot{ border:1px solid var(--chipborder); border-radius:12px; padding:8px 10px; display:flex; flex-direction:column; gap:6px; }
    .slot.full{ background:#fff1f1; border-color:#ffdcdc }
    .slot .meta{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .slot .meta .cap{ font-size:12px; color:var(--muted) }
    .slot .acts{ display:flex; gap:8px; flex-wrap:wrap }
    .res{ border-top:1px dashed var(--chipborder); padding-top:8px; margin-top:6px }
    .res .line{ display:flex; gap:10px; align-items:center; justify-content:space-between; padding:6px 0 }
    .res .name{ font-weight:800 }
    .res .small{ color:var(--muted); font-size:12px }
    .tabs{ display:flex; gap:6px; margin:6px 0 8px }
    .tab{ border:1px solid var(--chipborder); background:var(--chip); border-radius:999px; padding:8px 14px; font-weight:800; cursor:pointer }
    .tab.active{ background:var(--primary); color:#fff; border-color:#fff }

    /* Toast */
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:12px; z-index:1002; display:none; padding:10px 14px; border-radius:12px; font-weight:800 }
    .toast.ok{ background:#e6fbf5; color:#05614d; border:1px solid #baf0df }
    .toast.bad{ background:#ffeaea; color:#7a1b1b; border:1px solid #ffd1d1 }
  </style>
</head>
<body>
  <header>
    <div class="nav wrap">
      <div class="brand">
        <svg viewBox="0 0 32 32" aria-hidden="true">
          <defs><radialGradient id="g1" cx="50%" cy="50%"><stop offset="0%" stop-color="#0bbbd6"/><stop offset="100%" stop-color="#7de3f0"/></radialGradient></defs>
          <circle cx="16" cy="16" r="13" fill="none" stroke="url(#g1)" stroke-width="2"/>
          <circle cx="16" cy="16" r="8"  fill="none" stroke="url(#g1)" stroke-width="2" opacity=".9"/>
          <circle cx="16" cy="16" r="3.2" fill="#0b1b2b"/>
        </svg>
        NearGo – koledar terminov
      </div>
      <div>
        <a class="btn link" href="/index.html">Nazaj</a>
      </div>
    </div>
  </header>

  <div class="wrap">
    <section class="card" id="intro">
      <div class="title">Poveži koledar s svojim vnosom</div>
      <p class="muted" style="margin-top:6px">
        Odpri koledar prek povezave iz potrditvenega e‑maila (samodejno izpolnjeno), ali ročno prilepi <b>Token</b> in <b>Key</b>.
      </p>
      <div class="row row--3" style="margin-top:8px">
        <label>Token
          <input id="inToken" placeholder="npr. 24‑bajtni žeton">
        </label>
        <label>Key
          <input id="inKey" placeholder="npr. submissions/2024-09-10-...json">
        </label>
        <div style="display:flex; align-items:flex-end; gap:8px">
          <button class="btn" id="btnConnect">Poveži</button>
          <button class="btn link" id="btnLoadLocal">Naloži iz brskalnika</button>
        </div>
      </div>
    </section>

    <section class="grid" id="main" style="display:none">
      <!-- Levo: koledar in dodajanje -->
      <div class="col">
        <div class="card">
          <div class="title" id="svcTitle">Storitev</div>

          <div class="cal">
            <div class="cal-head">
              <div class="when"><span id="mName">–</span> <span id="yNum">–</span></div>
              <div style="display:flex; gap:6px">
                <button class="btn mini link" id="mPrev">←</button>
                <button class="btn mini link" id="mToday">Danes</button>
                <button class="btn mini link" id="mNext">→</button>
              </div>
            </div>
            <div class="cal-grid" id="dow">
              <div class="dow">Po</div><div class="dow">To</div><div class="dow">Sr</div><div class="dow">Če</div><div class="dow">Pe</div><div class="dow">So</div><div class="dow">Ne</div>
            </div>
            <div class="cal-grid" id="calDays"></div>
          </div>

          <div class="row row--3" style="margin-top:10px">
            <label>Začetek
              <input id="slotStartTime" type="time" value="09:00">
            </label>
            <label>Trajanje
              <select id="slotDur">
                <option value="15">15 min</option>
                <option value="30" selected>30 min</option>
                <option value="45">45 min</option>
                <option value="60">60 min</option>
                <option value="90">90 min</option>
                <option value="120">120 min</option>
              </select>
            </label>
            <label>Kapaciteta
              <input id="slotCap" type="number" min="1" step="1" value="1">
            </label>
          </div>
          <div class="row row--2">
            <div class="inline">
              <label class="inline"><input type="checkbox" id="repeatHourly"> <span>Več zaporednih terminov</span></label>
            </div>
            <div id="repeatWrap" style="display:none">
              <label>Koliko terminov
                <input id="repeatCount" type="number" min="2" max="12" step="1" value="2">
              </label>
            </div>
          </div>

          <div class="inline" style="margin-top:6px">
            <button class="btn" id="btnAddSlots">+ Dodaj proste termine za izbrane dneve</button>
            <button class="btn link" id="btnClearSel">Počisti izbor dni</button>
          </div>
          <div class="muted" style="margin-top:6px; font-size:12px">Klikni po koledarju za izbor več dni (modra obroba).</div>
        </div>
      </div>

      <!-- Desno: zavihek Termini / Rezervacije -->
      <div class="col">
        <div class="card">
          <div class="title">Upravljanje</div>
          <div class="tabs">
            <button class="tab active" data-tab="slots">Termini</button>
            <button class="tab" data-tab="bookings">Rezervacije</button>
          </div>

          <!-- Termini -->
          <div id="tab-slots">
            <div class="row" id="slotsList"></div>
          </div>

          <!-- Rezervacije -->
          <div id="tab-bookings" style="display:none">
            <div class="row row--2">
              <input id="findBooking" placeholder="Išči po imenu, tel, e‑pošti">
              <div style="display:flex; gap:8px; align-items:center">
                <button class="btn link" id="btnExportCsv">Izvozi CSV</button>
                <span class="muted" id="bkCount">0</span>
              </div>
            </div>
            <div class="row" id="bookingsList" style="margin-top:6px"></div>
          </div>
        </div>

        <div class="inline" style="display:flex; gap:8px; margin-top:8px">
          <button class="btn" id="btnSave">Shrani</button>
          <span id="saveNote" class="muted"></span>
        </div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <script>
(function(){
  "use strict";
  /* ===== Helpers ===== */
  const $=s=>document.querySelector(s);
  const el=(t,c)=>{const n=document.createElement(t); if(c) n.className=c; return n;};
  const qs=o=>new URLSearchParams(o).toString();
  const showToast=(msg,ok=true)=>{ const t=$("#toast"); t.textContent=msg; t.className="toast "+(ok?"ok":"bad"); t.style.display="flex"; setTimeout(()=>t.style.display="none",3000); };
  const uid=()=>crypto.getRandomValues(new Uint32Array(2)).join("");
  const pad2=n=>String(n).padStart(2,"0");
  const toISO=(d,y,m,day,hh,mm)=> new Date(y,m,day,hh,mm,0).toISOString();
  const fmtDate=(iso)=>{ const d=new Date(iso); const D=new Intl.DateTimeFormat("sl-SI",{day:"2-digit",month:"2-digit"}); return D.format(d); };
  const fmtTime=(iso)=>{ const d=new Date(iso); const T=new Intl.DateTimeFormat("sl-SI",{hour:"2-digit",minute:"2-digit"}); return T.format(d); };
  const deepClone=(o)=>JSON.parse(JSON.stringify(o||null));

  /* ===== Global state ===== */
  let TOKEN=null, KEY=null, ITEM=null;      // ITEM = provider entry (service)
  let SLOTS=[];                              // normalized slots array
  let month = new Date().getMonth();
  let year  = new Date().getFullYear();
  let selectedDays=new Set();                // set of YYYY-MM-DD

  /* ===== Init from URL/local ===== */
  (function initCreds(){
    const u=new URL(location.href);
    TOKEN = u.searchParams.get("token") || null;
    KEY   = u.searchParams.get("key")   || null;
    if(TOKEN && KEY){ $("#inToken").value=TOKEN; $("#inKey").value=KEY; connect(); }
  })();

  $("#btnConnect")?.addEventListener("click",()=>{
    TOKEN=$("#inToken").value.trim(); KEY=$("#inKey").value.trim();
    if(!TOKEN || !KEY){ showToast("Vnesi Token in Key.", false); return; }
    connect();
  },{passive:true});
  $("#btnLoadLocal")?.addEventListener("click",()=>{
    try{
      const saved=JSON.parse(localStorage.getItem("neargo_calendar_last")||"{}");
      $("#inToken").value=saved.token||""; $("#inKey").value=saved.key||"";
      if(saved.token && saved.key){ TOKEN=saved.token; KEY=saved.key; connect(); }
    }catch{}
  },{passive:true});

  /* ===== API ===== */
  async function apiLoad(){
    const url=`/api/provider-edit?${qs({token:TOKEN, key:KEY})}`;
    const r=await fetch(url).then(x=>x.json()).catch(()=>null);
    if(!r || !r.ok) throw new Error(r?.error||"Bremenitev ni uspela");
    return r.item;
  }
  async function apiSave(patch){
    const r=await fetch("/api/provider-update",{method:"POST",headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ token:TOKEN, key:KEY, patch })}).then(x=>x.json()).catch(()=>null);
    if(!r || !r.ok) throw new Error(r?.error||"Shranjevanje ni uspelo");
    return true;
  }

  /* ===== Connect (load) ===== */
  async function connect(){
    $("#intro").style.display="none";
    $("#main").style.display="block";
    try{
      localStorage.setItem("neargo_calendar_last", JSON.stringify({token:TOKEN,key:KEY}));
    }catch{}
    $("#saveNote").textContent="Nalagam…";
    ITEM = await apiLoad();
    if(!ITEM || (ITEM.type!=="service" && !ITEM.service)){
      $("#svcTitle").textContent="Vnos ni storitev – dodajanje koledarja je namenjeno storitvam.";
    }else{
      $("#svcTitle").textContent = (ITEM.eventName || ITEM.name || "Storitev");
    }
    // normaliziraj slots
    const raw = deepClone(ITEM?.service?.slots || []);
    SLOTS = raw.map(n=>normalizeSlot(n));
    renderMonth(); renderSlots(); renderBookings();
    $("#saveNote").textContent="Naloženo.";
    showToast("Povezano ✔", true);
  }

  /* ===== Slot normalize & quota ===== */
  function normalizeSlot(s){
    const x = Object.assign({ id:uid(), start:null, end:null, capacity:1, locked:false, bookings:[] }, s||{});
    const cap = Math.max(1, Number(x.capacity||1));
    const used = Array.isArray(x.bookings) ? x.bookings.length : 0;
    const quota = x.locked ? 0 : Math.max(0, cap - used);
    x.capacity = cap; x.quota = quota;
    return x;
  }

  /* ===== Calendar render ===== */
  const MONTHS=["Januar","Februar","Marec","April","Maj","Junij","Julij","Avgust","September","Oktober","November","December"];
  function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
  function dowOf(y,m,day){ return (new Date(y,m,day).getDay()+6)%7; } // 0=Mon
  function ymd(y,m,d){ return `${y}-${pad2(m+1)}-${pad2(d)}`; }

  function renderMonth(){
    $("#mName").textContent=MONTHS[month]; $("#yNum").textContent=year;
    const box=$("#calDays"); box.innerHTML="";
    const n=daysInMonth(year,month);
    const firstDow=dowOf(year,month,1);
    // prazni do ponedeljka
    for(let i=0;i<firstDow;i++){ const ph=el("div"); box.appendChild(ph); }
    for(let d=1; d<=n; d++){
      const cell=el("div","day"); const key=ymd(year,month,d);
      const inPast = new Date(year,month,d,23,59,59) < new Date(); // mino
      if(inPast) cell.classList.add("inactive");
      if(selectedDays.has(key)) cell.classList.add("selected");
      const capsToday = SLOTS.filter(s => (new Date(s.start)).toDateString() === (new Date(year,month,d)).toDateString())
                             .reduce((a,s)=>a + (s.quota||0), 0);
      cell.innerHTML = `<div class="num">${d}</div>
                        <div class="caps">${capsToday ? ('prosta: '+capsToday) : ''}</div>`;
      cell.addEventListener("click",()=>{
        if(selectedDays.has(key)) selectedDays.delete(key); else selectedDays.add(key);
        renderMonth();
      });
      box.appendChild(cell);
    }
  }
  $("#mPrev").addEventListener("click",()=>{ month--; if(month<0){ month=11; year--; } renderMonth(); },{passive:true});
  $("#mNext").addEventListener("click",()=>{ month++; if(month>11){ month=0; year++; } renderMonth(); },{passive:true});
  $("#mToday").addEventListener("click",()=>{ const t=new Date(); month=t.getMonth(); year=t.getFullYear(); renderMonth(); },{passive:true});
  $("#btnClearSel").addEventListener("click",()=>{ selectedDays.clear(); renderMonth(); },{passive:true});

  /* ===== Add slots ===== */
  $("#repeatHourly").addEventListener("change", e=>{
    $("#repeatWrap").style.display = e.target.checked ? "block":"none";
  },{passive:true});

  $("#btnAddSlots").addEventListener("click", ()=>{
    if(!selectedDays.size){ showToast("Najprej izberi vsaj en dan v koledarju.", false); return; }
    const [hh,mm] = ($("#slotStartTime").value||"09:00").split(":").map(Number);
    const durMin  = Number($("#slotDur").value||30);
    const cap     = Math.max(1, Number($("#slotCap").value||1));
    const repeat  = $("#repeatHourly").checked ? Math.max(2, Math.min(12, Number($("#repeatCount").value||2))) : 1;

    const days=[...selectedDays].sort();
    for(const d of days){
      const [Y,M,D] = d.split("-").map(Number);
      let startISO = toISO(0,Y, M-1, D, hh, mm);
      for(let i=0;i<repeat;i++){
        const st = new Date(startISO);
        const en = new Date(st.getTime() + durMin*60000);
        const slot = normalizeSlot({ id: 's-'+uid(), start: st.toISOString(), end: en.toISOString(), capacity: cap, bookings: [], locked:false });
        SLOTS.push(slot);
        startISO = en.toISOString(); // naslednji začne po prejšnjem
      }
    }
    selectedDays.clear();
    renderMonth(); renderSlots(); autoSaveNote();
    showToast("Dodano ✔", true);
  },{passive:true});

  /* ===== Render slots list ===== */
  function renderSlots(){
    const box=$("#slotsList"); box.innerHTML="";
    if(!SLOTS.length){ box.innerHTML='<div class="muted">Ni terminov. Dodaj proste termine na levi.</div>'; return; }

    // Razvrsti po datumu
    const list = deepClone(SLOTS).sort((a,b)=> new Date(a.start) - new Date(b.start));

    // Skupine po dnevu
    let lastDay=null, group=el("div","row");
    list.forEach(s=>{
      const day = (new Date(s.start)).toDateString();
      if(day !== lastDay){
        const h=el("div","title"); h.textContent = fmtDate(s.start);
        box.appendChild(h); group=el("div","row"); box.appendChild(group); lastDay=day;
      }
      group.appendChild(slotCard(s));
    });
  }

  function slotCard(s){
    const node=el("div","slot"+(s.quota<=0?" full":""));
    const t=`${fmtTime(s.start)} – ${fmtTime(s.end)}`;
    const capText = s.locked ? "zaklenjeno" : `prosta ${s.quota}/${s.capacity}`;

    node.innerHTML = `
      <div class="meta">
        <b>${t}</b>
        <span class="cap">${capText}</span>
      </div>
      <div class="acts">
        <button class="btn mini link" data-edit="${s.id}">Uredi</button>
        <button class="btn mini link" data-book="${s.id}">Dodaj rezervacijo</button>
        <button class="btn mini link" data-lock="${s.id}">${s.locked?"Odkleni":"Zakleni"}</button>
        <button class="btn mini danger" data-del="${s.id}">Odstrani</button>
      </div>
      ${ renderBookingsInline(s) }
    `;

    // Handlers
    node.querySelector(`[data-edit="${s.id}"]`)?.addEventListener("click",()=>editSlotDialog(s.id),{passive:true});
    node.querySelector(`[data-book="${s.id}"]`)?.addEventListener("click",()=>addBookingDialog(s.id),{passive:true});
    node.querySelector(`[data-lock="${s.id}"]`)?.addEventListener("click",()=>toggleLock(s.id),{passive:true});
    node.querySelector(`[data-del="${s.id}"]`) ?.addEventListener("click",()=>delSlot(s.id),{passive:true});
    return node;
  }

  function renderBookingsInline(s){
    const list = Array.isArray(s.bookings)? s.bookings : [];
    if(!list.length) return `<div class="res small">Ni rezervacij.</div>`;
    const rows = list.map(b=>`
      <div class="line">
        <div>
          <div class="name">${(b.name||"")+" "+(b.surname||"")}</div>
          <div class="small">${b.phone||""}${(b.phone&&b.email)?" · ":""}${b.email||""}${b.note?` · ${b.note}`:""}</div>
        </div>
        <div class="small">${new Date(b.createdAt||Date.now()).toLocaleString('sl-SI')}</div>
      </div>`).join("");
    return `<div class="res">${rows}</div>`;
  }

  function toggleLock(id){
    const s=SLOTS.find(x=>x.id===id); if(!s) return;
    s.locked = !s.locked;
    normalizeInto(s);
    renderMonth(); renderSlots(); autoSaveNote();
  }

  function delSlot(id){
    if(!confirm("Odstranim termin?")) return;
    SLOTS = SLOTS.filter(x=>x.id!==id);
    renderMonth(); renderSlots(); autoSaveNote();
  }

  function editSlotDialog(id){
    const s=SLOTS.find(x=>x.id===id); if(!s) return;
    const start=new Date(s.start); const end=new Date(s.end);
    const durMin = Math.max(5, Math.round((end-start)/60000));
    const wrapper=el("div","card");
    wrapper.innerHTML=`
      <div class="title">Uredi termin</div>
      <div class="row row--3">
        <label>Začetek (ura)
          <input id="edTime" type="time" value="${pad2(start.getHours())}:${pad2(start.getMinutes())}">
        </label>
        <label>Trajanje (min)
          <input id="edDur" type="number" min="5" step="5" value="${durMin}">
        </label>
        <label>Kapaciteta
          <input id="edCap" type="number" min="1" step="1" value="${s.capacity}">
        </label>
      </div>
      <div class="inline" style="margin-top:8px">
        <button class="btn mini" id="edOk">Shrani</button>
        <button class="btn mini link" id="edCancel">Prekliči</button>
      </div>`;
    const box = dialogBox(wrapper);
    wrapper.querySelector("#edCancel").addEventListener("click",()=>box.remove(),{passive:true});
    wrapper.querySelector("#edOk").addEventListener("click",()=>{
      const [hh,mm]=($("#edTime").value||"09:00").split(":").map(Number);
      const d = new Date(start); d.setHours(hh,mm,0,0);
      const dur = Math.max(5, Number($("#edDur").value||durMin));
      const end = new Date(d.getTime()+dur*60000);
      s.start = d.toISOString(); s.end = end.toISOString();
      s.capacity = Math.max(1, Number($("#edCap").value||1));
      normalizeInto(s);
      box.remove(); renderMonth(); renderSlots(); autoSaveNote();
    },{passive:true});
  }

  function addBookingDialog(id){
    const s=SLOTS.find(x=>x.id===id); if(!s) return;
    const wrapper=el("div","card");
    wrapper.innerHTML=`
      <div class="title">Dodaj rezervacijo (${fmtDate(s.start)} ${fmtTime(s.start)})</div>
      <div class="row row--2">
        <input id="bkName" placeholder="Ime">
        <input id="bkSurname" placeholder="Priimek">
      </div>
      <div class="row row--2">
        <input id="bkPhone" placeholder="Telefon">
        <input id="bkEmail" type="email" placeholder="E‑pošta (opcijsko)">
      </div>
      <div class="row">
        <input id="bkNote" placeholder="Opomba (opcijsko)">
      </div>
      <div class="inline" style="margin-top:8px">
        <button class="btn mini" id="bkOk" ${s.quota<=0?'disabled':''}>Dodaj</button>
        <button class="btn mini link" id="bkCancel">Prekliči</button>
        ${s.quota<=0?'<span class="muted">Ni prostih mest.</span>':''}
      </div>`;
    const box = dialogBox(wrapper);
    wrapper.querySelector("#bkCancel").addEventListener("click",()=>box.remove(),{passive:true});
    wrapper.querySelector("#bkOk").addEventListener("click",()=>{
      const b={
        id: 'b-'+uid(),
        name: ($("#bkName").value||"").trim(),
        surname: ($("#bkSurname").value||"").trim(),
        phone: ($("#bkPhone").value||"").trim(),
        email: ($("#bkEmail").value||"").trim(),
        note: ($("#bkNote").value||"").trim(),
        createdAt: new Date().toISOString()
      };
      if(!b.name && !b.surname){ showToast("Vpiši vsaj ime ali priimek.", false); return; }
      s.bookings = s.bookings || [];
      s.bookings.push(b);
      normalizeInto(s);
      box.remove(); renderMonth(); renderSlots(); renderBookings(); autoSaveNote();
    },{passive:true});
  }

  function normalizeInto(s){
    const n = normalizeSlot(s);
    Object.assign(s, n);
  }

  /* ===== Bookings tab ===== */
  function allBookings(){
    const rows=[];
    SLOTS.forEach(s=>{
      (s.bookings||[]).forEach(b=>{
        rows.push({
          slotId:s.id, date:fmtDate(s.start), start:fmtTime(s.start), end:fmtTime(s.end),
          name:(b.name||"")+" "+(b.surname||""), phone:b.phone||"", email:b.email||"", note:b.note||"",
          createdAt:new Date(b.createdAt||Date.now()).toLocaleString('sl-SI')
        });
      });
    });
    return rows.sort((a,b)=> a.date.localeCompare(b.date) || a.start.localeCompare(b.start));
  }

  function renderBookings(){
    const list = allBookings();
    const host=$("#bookingsList"); const info=$("#bkCount"); host.innerHTML="";
    info.textContent = `${list.length} rezervacij`;
    if(!list.length){ host.innerHTML='<div class="muted">Ni rezervacij.</div>'; return; }

    const q=($("#findBooking").value||"").trim().toLowerCase();
    const rows = q ? list.filter(r => Object.values(r).some(v=>String(v).toLowerCase().includes(q))) : list;

    rows.forEach(r=>{
      const line=el("div","slot");
      line.innerHTML = `
        <div class="meta">
          <b>${r.date} ${r.start}–${r.end}</b>
          <span class="cap">${r.name}</span>
        </div>
        <div class="res small">${r.phone || ""}${(r.phone&&r.email)?' · ':''}${r.email||""}${r.note?` · ${r.note}`:""} · ${r.createdAt}</div>
      `;
      host.appendChild(line);
    });
  }
  $("#findBooking").addEventListener("input",()=>renderBookings(),{passive:true});
  $("#btnExportCsv").addEventListener("click",()=>{
    const rows = allBookings();
    if(!rows.length){ showToast("Ni podatkov za izvoz.", false); return; }
    const head = "slotId;datum;od;do;ime;telefon;email;opomba;vneseno\n";
    const body = rows.map(r=>[r.slotId,r.date,r.start,r.end,r.name,r.phone,r.email,r.note,r.createdAt]
                      .map(v=>String(v).replace(/;/g,',')).join(";")).join("\n");
    const blob=new Blob([head+body],{type:"text/csv;charset=utf-8"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="rezervacije.csv";
    document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0);
  },{passive:true});

  /* ===== Tabs ===== */
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click",()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const id=t.dataset.tab;
      $("#tab-slots").style.display = id==="slots" ? "block":"none";
      $("#tab-bookings").style.display = id==="bookings" ? "block":"none";
    },{passive:true});
  });

  /* ===== Save ===== */
  function sanitizeForSave(){
    // vedno izračunaj quota iz capacity/bookings/locked
    return SLOTS.map(s=>{
      const cap = Math.max(1, Number(s.capacity||1));
      const used = Array.isArray(s.bookings) ? s.bookings.length : 0;
      const quota = s.locked ? 0 : Math.max(0, cap - used);
      return { id:s.id, start:s.start, end:s.end, capacity:cap, quota, locked:!!s.locked, bookings: deepClone(s.bookings||[]) };
    });
  }
  function autoSaveNote(){ $("#saveNote").textContent="Neshranjene spremembe…"; }
  $("#btnSave").addEventListener("click", saveAll, {passive:true});
  async function saveAll(){
    try{
      $("#btnSave").disabled=true; $("#saveNote").textContent="Shranjujem…";
      const slots = sanitizeForSave();
      const patch = { service: Object.assign({}, ITEM?.service||{}, { slots }) };
      await apiSave(patch);
      ITEM.service = Object.assign({}, ITEM?.service||{}, { slots });
      $("#saveNote").textContent="Shranjeno ✔";
      showToast("Shranjeno ✔", true);
    }catch(e){
      $("#saveNote").textContent="Napaka pri shranjevanju";
      showToast(e?.message||"Napaka pri shranjevanju", false);
    }finally{
      $("#btnSave").disabled=false;
    }
  }

  /* ===== Minimal dialog (inline) ===== */
  function dialogBox(content){
    const overlay=el("div"); overlay.style.position="fixed"; overlay.style.inset=0; overlay.style.background="rgba(0,0,0,.35)";
    overlay.style.zIndex=1000; overlay.style.display="flex"; overlay.style.alignItems="center"; overlay.style.justifyContent="center";
    const box=el("div","card"); box.style.width="min(720px, 92vw)"; box.appendChild(content);
    overlay.appendChild(box); document.body.appendChild(overlay);
    overlay.addEventListener("click",(e)=>{ if(e.target===overlay) overlay.remove(); },{passive:true});
    return overlay;
  }
})();
  </script>
</body>
</html>
