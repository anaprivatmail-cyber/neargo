[build]
  publish = "."
  functions = "netlify/functions"
  command = "npm run build"

[build.environment]
  NODE_VERSION = "20"

# ===== Redirects to serverless functions (API) =====

[[redirects]]
  from = "/api/search"
  to   = "/.netlify/functions/tm-search"
  status = 200
  force = true

[[redirects]]
  from = "/api/provider-submit"
  to   = "/.netlify/functions/provider-submit"
  status = 200
  force = true

[[redirects]]
  from = "/api/provider-upload"
  to   = "/.netlify/functions/provider-upload"
  status = 200
  force = true

[[redirects]]
  from = "/api/provider-list"
  to   = "/.netlify/functions/provider-list"
  status = 200
  force = true

# Urejanje in posodobitev dogodka (za link TUKAJ)
[[redirects]]
  from = "/api/provider-edit"
  to   = "/.netlify/functions/provider-edit"
  status = 200
  force = true

[[redirects]]
  from = "/api/provider-update"
  to   = "/.netlify/functions/provider-update"
  status = 200
  force = true

# Stripe Checkout
[[redirects]]
  from = "/api/checkout"
  to   = "/.netlify/functions/checkout"
  status = 200
  force = true

# Redeem (QR unovčitev) – kuponi
[[redirects]]
  from = "/api/redeem/*"
  to   = "/.netlify/functions/redeem/:splat"
  status = 200
  force = true

# Enostaven API za skeniranje (če ga kličeš iz appa)
[[redirects]]
  from = "/api/checker"
  to   = "/.netlify/functions/scan"
  status = 200
  force = true

# Stripe webhook pod /api
[[redirects]]
  from = "/api/stripe-webhook"
  to   = "/.netlify/functions/stripe-webhook"
  status = 200
  force = true

# Lep URL za vstopnice (če ga uporabljaš)
[[redirects]]
  from = "/api/ticket-redeem"
  to   = "/.netlify/functions/ticket-redeem"
  status = 200
  force = true

# Light ping/analytics (opcijsko)
[[redirects]]
  from = "/api/analytics"
  to   = "/.netlify/functions/analytics"
  status = 200
  force = true

# === NOVO: posrednik za QR-kodo in kratek URL ===
[[redirects]]
  from = "/api/redirect-qr"
  to   = "/.netlify/functions/redirect-qr"
  status = 200
  force = true

[[redirects]]
  from = "/r/:token"
  to   = "/.netlify/functions/ticket-redeem?token=:token"
  status = 200
  force = true

# === NOVO: lookup za nakupe (dodaj v "Moje") ===
[[redirects]]
  from = "/api/purchase-lookup"
  to   = "/.netlify/functions/purchase-lookup"
  status = 200
  force = true

# === GEO WORKER: ročni klic prek /api ===
[[redirects]]
  from = "/api/geo-worker"
  to   = "/.netlify/functions/geo-worker"
  status = 200
  force = true

# Early notify API (single-offer trigger) and cron runner
[[redirects]]
  from = "/api/early-notify-offer"
  to   = "/.netlify/functions/early-notify-offer"
  status = 200
  force = true

[[redirects]]
  from = "/api/early-notify"
  to   = "/.netlify/functions/early-notify"
  status = 200
  force = true

[[redirects]]
  from = "/api/early-inbox"
  to   = "/.netlify/functions/early-inbox"
  status = 200
  force = true

[[redirects]]
  from = "/api/early-notify-count"
  to   = "/.netlify/functions/early-notify-count"
  status = 200
  force = true

# Strict early-access gated offers (server-side filtering)
[[redirects]]
  from = "/api/offers-early"
  to   = "/.netlify/functions/offers-early"
  status = 200
  force = true

# My API (profile info / premium flag)
[[redirects]]
  from = "/api/my"
  to   = "/.netlify/functions/my"
  status = 200
  force = true

# ===== Static asset caching =====
[[headers]]
  for = "/*.html"
  [headers.values]
    cache-control = "public, max-age=60, must-revalidate"

[[headers]]
  for = "/assets/*"
  [headers.values]
    # Asset filenames now include a content hash via query (?v=sha1) so we can cache aggressively.
    cache-control = "public, max-age=31536000, immutable"

# ===== Security headers =====
[[headers]]
  for = "/*"
  [headers.values]
    x-content-type-options = "nosniff"
    x-frame-options = "SAMEORIGIN"
    referrer-policy = "strict-origin-when-cross-origin"
    permissions-policy = "geolocation=(self), camera=(self)"
    Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"

# ===== CORS for functions =====
[[headers]]
  for = "/.netlify/functions/*"
  [headers.values]
    Access-Control-Allow-Origin  = "*"
    Access-Control-Allow-Methods = "GET, POST, OPTIONS"
    Access-Control-Allow-Headers = "Content-Type, Authorization, x-scanner-key"

# ===== SPA fallback =====
[[redirects]]
  from = "/*"
  to   = "/index.html"
  status = 200

# ===== Functions bundling (global) =====
[functions]
  node_bundler = "esbuild"
  external_node_modules = ["@netlify/blobs", "@supabase/supabase-js", "busboy"]
  included_files = [
    "providers/**",
    "netlify/functions/fonts/**"
  ]

[functions."ticket-redeem"]
  node_bundler = "none"

# === GEO WORKER: urnik (na vsakih 10 minut)
[functions."geo-worker"]
  schedule = "*/10 * * * *"

# Run early-notify every minute to hit the precise 15-minute window
[functions."early-notify"]
  schedule = "*/1 * * * *"
