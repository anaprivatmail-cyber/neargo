<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NearGo – najdi dogodke blizu</title>
  <link rel="preconnect" href="https://unpkg.com" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />

  <!-- Leaflet (OSM) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --brand: #0bbbd6;
      --bg1: #e6f7ff; /* nežno modra */
      --bg2: #ffffff; /* v belo */
      --text: #0b1b2b;
      --muted: #5b6b7b;
      --card: #ffffff;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    body {
      margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 50%);
    }
    header {
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:12px 16px; position:sticky; top:0; z-index:10; backdrop-filter: blur(6px);
      background: rgba(255,255,255,.6);
      border-bottom:1px solid rgba(0,0,0,.05);
    }
    .brand { display:flex; align-items:center; gap:10px; font-weight:700; }
    .dot { width:12px; height:12px; border-radius:50%; background:var(--brand); box-shadow:0 0 0 6px rgba(11,187,214,.25); }
    .lang { border:1px solid #dbe5ef; border-radius:999px; padding:6px 10px; background:#fff; }
    .cta { background:var(--brand); color:#fff; border:none; padding:10px 16px; border-radius:999px; font-weight:700; box-shadow:var(--shadow); }
    .ghost { background:#fff; color:var(--text); border:1px solid #dbe5ef; }
    main { padding: 32px 16px 80px; max-width:1000px; margin:0 auto; }
    .hero h1 { font-size:clamp(28px, 6vw, 54px); line-height:1.15; margin:12px 0; }
    .hero p { color:var(--muted); font-size:18px; }
    .chips { display:flex; gap:12px; flex-wrap:wrap; margin:18px 0 6px; }
    .chip { border:1px solid #cfe1ee; border-radius:999px; padding:8px 12px; background:#fff; color:var(--muted); box-shadow: var(--shadow); }

    .cards { display:grid; grid-template-columns:1fr; gap:18px; margin-top:18px; }
    @media(min-width:700px){ .cards { grid-template-columns:1.2fr .8fr; } }

    .card { background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; }
    .title { font-weight:700; margin-bottom:6px; }
    .muted { color:var(--muted); }

    .form-row { display:grid; grid-template-columns:1fr; gap:10px; }
    @media(min-width:700px){ .form-row { grid-template-columns:1fr 1fr 1fr; } }
    input, select, textarea {
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid #dbe5ef; background:#fff; outline:none;
    }
    textarea { min-height:120px; resize:vertical; }
    .btn { padding:12px 16px; border-radius:12px; border:none; background:var(--brand); color:#fff; font-weight:700; }
    .btn.secondary { background:#111; color:#fff; }
    .btn.linkish { background:#fff; color:var(--text); border:1px solid #dbe5ef; }

    .results { display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px; }
    @media(min-width:800px){ .results { grid-template-columns:1fr 1fr; } }
    .event { background:#fff; border-radius:14px; padding:12px; display:flex; gap:12px; border:1px solid #e5edf5; }
    .event img { width:96px; height:96px; object-fit:cover; border-radius:10px; }

    .tabs { display:flex; gap:10px; margin-top:16px; }
    .tab { padding:10px 12px; border-radius:999px; border:1px solid #dbe5ef; background:#fff; cursor:pointer; }
    .tab.active { background:var(--brand); color:#fff; border-color:var(--brand); }

    #map { height:360px; border-radius:14px; overflow:hidden; border:1px solid #e5edf5; }

    .carousel { display:flex; gap:12px; overflow:auto; scroll-snap-type:x mandatory; padding-bottom:8px; }
    .carousel .spot {
      flex: 0 0 280px; scroll-snap-align:start; background:#fff; border:1px solid #e5edf5; border-radius:16px; overflow:hidden;
    }
    .carousel .spot img { width:100%; height:160px; object-fit:cover; display:block; }
    .price { font-weight:700; color:#0a7; }
    footer { text-align:center; color:var(--muted); margin-top:48px; font-size:14px; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span class="dot"></span> NearGo
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <select id="lang" class="lang">
        <option value="sl" selected>SL</option>
        <option value="en">EN</option>
        <option value="de">DE</option>
      </select>
      <button class="cta" id="btnOrganizers">Objavi dogodek</button>
    </div>
  </header>

  <main>
    <!-- Hero -->
    <section class="hero card">
      <h1>Najdi <span style="color:var(--brand);">dogodke blizu</span> — koncerti, hrana, kultura, otroci & več</h1>
      <p>NearGo je hiter meta-iskalnik. Vtipkaj, izberi kraj ali radij in dobiš vse v tvojem jeziku.</p>
      <div class="chips">
        <button class="chip" id="btnStart">Začni iskati</button>
        <button class="chip" id="btnMap">Zemljevid</button>
        <button class="chip" id="btnFilters">Pametni filtri</button>
      </div>
    </section>

    <div class="cards">
      <!-- Iskanje -->
      <section class="card" id="searchCard">
        <div class="title">Iskanje</div>
        <div class="form-row">
          <input id="q" placeholder="npr. Metallica, street food…" />
          <input id="city" placeholder="Mesto/kraj" />
          <input id="radius" type="number" min="1" max="300" value="50" placeholder="Radij (km)" />
        </div>
        <div class="form-row">
          <select id="category">
            <option value="">Vse kategorije</option>
            <option>Koncert</option><option>Hrana</option><option>Kultura</option><option>Otroci</option>
          </select>
          <button class="btn" id="btnSearch">Išči</button>
          <button class="btn linkish" id="btnUseLocation">Uporabi mojo lokacijo</button>
        </div>

        <!-- Rezultati -->
        <div class="tabs" id="tabs" hidden>
          <div class="tab active" data-tab="list">Seznam</div>
          <div class="tab" data-tab="map">Zemljevid</div>
        </div>

        <div id="results" class="results"></div>
        <div id="pagination" style="display:flex; gap:8px; margin-top:10px;"></div>
      </section>

      <!-- Organizatorji (Objava) -->
      <section class="card" id="orgCard">
        <div class="title">Objavi dogodek</div>
        <p class="muted">Objava je brezplačna. Po želji lahko označiš <b>Izpostavljeno (7 dni) – 10 €</b>.</p>
        <div class="form-row">
          <input id="orgName" placeholder="Ime organizatorja" />
          <input id="orgEmail" placeholder="E-pošta za potrditev" />
          <input id="eventName" placeholder="Naslov dogodka" />
        </div>
        <div class="form-row">
          <input id="venue" placeholder="Lokacija (ime prizorišča)" />
          <input id="city2" placeholder="Mesto/kraj" />
          <input id="country" placeholder="Država (ISO) – npr. SI, AT" />
        </div>
        <div class="form-row">
          <input id="start" type="datetime-local" />
          <input id="url" placeholder="Povezava za več info / nakup (če obstaja)" />
          <input id="price" type="number" min="0" step="0.01" placeholder="Cena od (€)" />
        </div>
        <div class="form-row">
          <textarea id="desc" placeholder="Opis dogodka"></textarea>
        </div>
        <div class="form-row">
          <input id="image" type="file" accept="image/*" />
          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="featured" /> Izpostavljeno (7 dni) – 10 €
          </label>
          <button class="btn secondary" id="btnSubmitEvent">Objavi</button>
        </div>
        <div id="orgMsg" class="muted" style="margin-top:8px;"></div>
      </section>
    </div>

    <!-- Izpostavljeni vrtiljak -->
    <section class="card" style="margin-top:18px;">
      <div class="title">Izpostavljeno</div>
      <div class="carousel" id="carousel">
        <div class="spot"><img src="https://images.unsplash.com/photo-1483412033650-1015ddeb83d1?w=1200" alt=""><div style="padding:12px;"><b>Street Food Weekend</b><div class="muted">Ljubljana</div></div></div>
        <div class="spot"><img src="https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=1200" alt=""><div style="padding:12px;"><b>Open Air Concert</b><div class="muted">Dunaj</div></div></div>
        <div class="spot"><img src="https://images.unsplash.com/photo-1515162305280-9d5f88b92e15?w=1200" alt=""><div style="padding:12px;"><b>Kids Fair</b><div class="muted">Gradec</div></div></div>
      </div>
    </section>

    <!-- Zemljevid -->
    <section class="card" style="margin-top:18px;">
      <div class="title">Zemljevid</div>
      <div id="map"></div>
    </section>

    <footer>© NearGo • Pripravljeno za več virov, affiliate in analitiko.</footer>
  </main>

  <script>
    const $ = (s) => document.querySelector(s);

    // UI: preklopi med sekcijama
    const orgCard = $("#orgCard");
    const searchCard = $("#searchCard");
    $("#btnOrganizers").onclick = () => {
      orgCard.scrollIntoView({ behavior: "smooth", block: "start" });
    };
    $("#btnStart").onclick = () => searchCard.scrollIntoView({ behavior: "smooth", block: "start" });
    $("#btnFilters").onclick = () => alert("Pametni filtri kmalu: kategorije, za otroke, cena, indoor/outdoor …");
    $("#btnMap").onclick = () => document.querySelector("#map").scrollIntoView({ behavior: "smooth" });

    // Leaflet map
    const map = L.map("map").setView([46.05, 14.51], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "© OSM" }).addTo(map);
    let markers = [];

    function addMarkers(items) {
      markers.forEach((m) => m.remove());
      markers = [];
      items.forEach((e) => {
        if (e.venue?.lat && e.venue?.lon) {
          const m = L.marker([e.venue.lat, e.venue.lon]).addTo(map).bindPopup(`<b>${e.name}</b><br>${e.venue.address || ""}`);
          markers.push(m);
        }
      });
      if (items.some((e) => e.venue?.lat && e.venue?.lon)) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.2));
      }
    }

    // Iskanje
    let currentPage = 0;
    async function doSearch(page = 0) {
      currentPage = page;

      const q = $("#q").value.trim();
      const city = $("#city").value.trim();
      const radius = $("#radius").value.trim() || "50";
      const lang = $("#lang").value || "sl";

      const url = `/api/search?q=${encodeURIComponent(q)}&city=${encodeURIComponent(city)}&radius=${radius}&lang=${lang}&page=${page}`;
      const res = await fetch(url);
      const data = await res.json();

      if (!data.ok) { showError("Napaka pri iskanju."); return; }

      const items = data.results || [];
      $("#tabs").hidden = items.length === 0;

      const box = $("#results");
      box.innerHTML = "";
      items.forEach((e) => {
        const img = (e.images && e.images[0]) || "https://images.unsplash.com/photo-1515162305280-9d5f88b92e15?w=600";
        const d = document.createElement("div");
        d.className = "event";
        d.innerHTML = `
          <img src="${img}" alt="">
          <div>
            <div><b>${e.name}</b></div>
            <div class="muted">${e.venue?.address || ""}</div>
            <div class="muted">${new Date(e.start || Date.now()).toLocaleString()}</div>
            <div style="margin-top:8px; display:flex; gap:8px;">
              <a class="btn linkish" href="${e.url || "#"}" target="_blank" rel="noopener">Več</a>
              <button class="btn buy" data-name="${encodeURIComponent(e.name)}">Kupi vstopnico</button>
            </div>
          </div>
        `;
        box.appendChild(d);
      });

      addMarkers(items);
      renderPagination(data.query?.page || 0);
      attachBuyHandlers();
    }

    function renderPagination(page) {
      const wrap = $("#pagination");
      wrap.innerHTML = "";
      const prev = document.createElement("button");
      prev.className = "btn linkish"; prev.textContent = "Nazaj";
      prev.disabled = page <= 0;
      prev.onclick = () => doSearch(page - 1);
      const next = document.createElement("button");
      next.className = "btn linkish"; next.textContent = "Naprej";
      next.onclick = () => doSearch(page + 1);
      wrap.append(prev, next);
    }

    function showError(msg) {
      const box = $("#results"); box.innerHTML = `<div class="muted">${msg}</div>`;
    }

    $("#btnSearch").onclick = () => doSearch(0);
    $("#btnUseLocation").onclick = () => {
      navigator.geolocation.getCurrentPosition((pos) => {
        const { latitude, longitude } = pos.coords;
        $("#city").value = ""; // pustimo prazno, ker uporabljamo koordinate
        doSearch(0, (window._latlon = `${latitude.toFixed(5)},${longitude.toFixed(5)}`));
      }, () => alert("Lokacije ni bilo mogoče pridobiti."));
    };

    // Stripe Checkout (placeholder – deluje, ko dodaš STRIPE ključ)
    function attachBuyHandlers() {
      document.querySelectorAll(".buy").forEach((btn) => {
        btn.onclick = async () => {
          const name = decodeURIComponent(btn.dataset.name || "Ticket");
          const customerEmail = prompt("Vnesi e-pošto za prejem vstopnice:");
          if (!customerEmail) return;

          const payload = {
            customerEmail,
            lineItems: [{ name, description: "NearGo ticket", amount: 1000, currency: "eur", quantity: 1 }],
            successUrl: location.origin + "/#success",
            cancelUrl: location.origin + "/#cancel"
          };
          const res = await fetch("/api/checkout", { method: "POST", headers: { "content-type": "application/json" }, body: JSON.stringify(payload) });
          const data = await res.json();
          if (data.ok && data.url) location.href = data.url;
          else alert(data.error || "Stripe ni nastavljen. (Dodaj STRIPE_SECRET_KEY.)");
        };
      });
    }

    // Objavi dogodek (pošlji e-pošto)
    $("#btnSubmitEvent").onclick = async () => {
      const organizerEmail = $("#orgEmail").value.trim();
      const payload = {
        organizer: $("#orgName").value.trim(),
        organizerEmail,
        eventName: $("#eventName").value.trim(),
        venue: $("#venue").value.trim(),
        city: $("#city2").value.trim(),
        country: $("#country").value.trim(),
        start: $("#start").value,
        url: $("#url").value.trim(),
        price: $("#price").value ? Number($("#price").value) : null,
        description: $("#desc").value.trim(),
        featured: $("#featured").checked,
      };

      // slika: samo kot info (za zdaj jo pošljemo v email-u, shranjevanje dodamo kasneje z blob storage)
      const file = $("#image").files?.[0];
      if (file) {
        payload.imageName = file.name;
      }

      $("#orgMsg").textContent = "Pošiljam…";
      const res = await fetch("/api/provider-submit", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (data.ok) {
        $("#orgMsg").textContent = "Prijava sprejeta – poslali smo potrditveni email.";
      } else {
        $("#orgMsg").textContent = "Napaka: " + (data.error || "neznano");
      }
    };

    // Inicialno stanje
    doSearch(0);
  </script>
</body>
</html>
