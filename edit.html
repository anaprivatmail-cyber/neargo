<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Uredi ponudbo – NearGo</title>
  <script type="module" src="/assets/categories.js"></script>
  <style>
    :root{ --bg:#f6fbfe; --card:#fff; --text:#0b1b2b; --muted:#5b6b7b; --border:#e3eef7; --brand:#0bbbd6; --shadow:0 12px 30px rgba(0,0,0,.06);}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:22px auto;padding:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    h1{margin:6px 0 10px;font-size:22px}
    label{display:block;margin:10px 0 6px;font-weight:800}
    input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);font:15px/1.4}
    textarea{min-height:120px}
    .row{display:grid;gap:10px;grid-template-columns:1fr}
    @media(min-width:700px){ .row-2{grid-template-columns:1fr 1fr} .row-3{grid-template-columns:1fr 1fr 1fr} }
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer}
    .btn.link{background:#fff;color:var(--text);border:1px solid var(--border)}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Uredi dogodek</h1>
      <div id="msg" class="muted"></div>

      <div class="row row-3">
        <div>
          <label>Naslov</label>
          <input id="eventName">
        </div>
        <div>
          <label>Prizorišče</label>
          <input id="venue">
        </div>
        <div>
          <label>Mesto/kraj</label>
          <input id="city">
        </div>
      </div>

      <div class="row row-3">
        <div>
          <label>Začetek</label>
          <input id="start" type="datetime-local">
        </div>
        <div>
          <label>Konec</label>
          <input id="end" type="datetime-local">
        </div>
        <div>
          <label>Kategorija</label>
          <div class="inline" style="display:flex;gap:8px;align-items:center;margin:6px 0 8px">
            <button type="button" id="typeEvent" class="btn link" style="padding:6px 10px;border-radius:999px;font-weight:800">Dogodek</button>
            <button type="button" id="typeService" class="btn link" style="padding:6px 10px;border-radius:999px;font-weight:800">Storitev</button>
          </div>
          <div id="editCategoryChips" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px"></div>
          <div id="editSubcategoryWrap" style="display:none;margin-top:8px">
            <label style="font-weight:700;font-size:13px">Podkategorija (neobvezno)</label>
            <select id="subcategory" style="min-height:40px;border-radius:12px;border:1px solid var(--border);background:#fff;padding:8px 12px;font-size:14px">
              <option value="">Podkategorija (neobvezno)</option>
            </select>
          </div>
          <input type="hidden" id="entryType" value="event">
          <input type="hidden" id="category">
          <script>
          (function(){
            let wrapEl, catInput, subSel, subWrap, entryTypeInput, btnEvent, btnService;
            const normList = (list)=> Array.isArray(list)? list.filter(c=>c&&c.key).map(c=>({key:c.key,label:c.label||c.key,emoji:c.emoji||'✨', sub:Array.isArray(c.sub)?c.sub.map(s=>({key:s.key,label:s.label})):[]})) : [];
            function sourceFor(mode){
              const pub=window.NearGoCategories, boot=window.NearGoCategoryBootstrap, src=window.NearGoCategorySource;
              const pick=(x)=> (x && Array.isArray(x[mode]) && x[mode].length) ? normList(x[mode]) : null;
              return pick(pub) || pick(boot) || pick(src) || [];
            }
            function setType(mode){
              entryTypeInput.value = (mode==='services')?'service':'event';
              btnEvent.classList.toggle('active', mode==='events');
              btnService.classList.toggle('active', mode==='services');
              renderChips(mode);
            }
            function toggleLabel(node,show){ const l=node.querySelector('.cat-label'); if(!l) return; if(show) l.style.display='inline'; else if(!node.classList.contains('active')) l.style.display='none'; }
            function buildChip(cat){
              const chip=document.createElement('button'); chip.className='chip cat'; chip.type='button'; chip.dataset.cat=cat.key;
              const icon=document.createElement('span'); icon.className='cat-icon'; icon.textContent=cat.emoji||'✨';
              const lbl=document.createElement('span'); lbl.className='cat-label'; lbl.textContent=cat.label||cat.key; lbl.style.display='none';
              chip.append(icon,lbl);
              chip.addEventListener('mouseenter', ()=>toggleLabel(chip,true));
              chip.addEventListener('mouseleave', ()=>toggleLabel(chip,false));
              chip.addEventListener('touchstart', ()=>toggleLabel(chip,true));
              chip.addEventListener('touchend', ()=>toggleLabel(chip,false));
              chip.addEventListener('click', ()=> setActive(cat.key));
              return chip;
            }
            let currentMode='events', currentList=[];
            function populateSubs(catKey){
              if(!subSel||!subWrap) return;
              const utils=window.NearGoCategoryUtils; let subs = utils?.getSubcategories ? (utils.getSubcategories(currentMode, catKey)||[]) : [];
              if(!subs.length){ const found=currentList.find(c=>c.key===catKey); subs = Array.isArray(found?.sub) ? found.sub : []; }
              subSel.innerHTML='';
              const ph=document.createElement('option'); ph.value=''; ph.textContent='Podkategorija (neobvezno)'; subSel.appendChild(ph);
              subs.forEach(s=>{ const o=document.createElement('option'); o.value=s.key; o.textContent=s.label; subSel.appendChild(o); });
              const has = subs.length>0; subWrap.style.display = has? 'block':'none'; subSel.disabled = !has;
            }
            function setActive(key){
              wrapEl.querySelectorAll('.cat').forEach(btn=>{ const m=(btn.dataset.cat===key); btn.classList.toggle('active', m); toggleLabel(btn, m); });
              catInput.value = key;
              populateSubs(key);
            }
            function renderChips(mode){
              currentMode = mode; wrapEl.innerHTML=''; currentList = sourceFor(mode);
              currentList.forEach(cat => wrapEl.appendChild(buildChip(cat)));
              const initial = catInput.value || (currentList[0]?.key||'');
              if(initial) setActive(initial);
            }
            function init(){
              wrapEl=document.getElementById('editCategoryChips');
              catInput=document.getElementById('category');
              subSel=document.getElementById('subcategory');
              subWrap=document.getElementById('editSubcategoryWrap');
              entryTypeInput=document.getElementById('entryType');
              btnEvent=document.getElementById('typeEvent');
              btnService=document.getElementById('typeService');
              if(!wrapEl||!catInput||!btnEvent||!btnService) return;
              btnEvent.addEventListener('click', ()=>setType('events'));
              btnService.addEventListener('click', ()=>setType('services'));
              // default to event; real type will override after load()
              setType('events');
            }
            if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init, {once:true}); else init();
            document.addEventListener('neargo:categories-ready', ()=>renderChips(currentMode));
            // expose for loader to set active category
            window.NearGoEditCategoryChips = { setActive };
          })();
          </script>
        </div>
      </div>

      <div class="row row-2">
        <div>
          <label>Povezava (več info / zunanji nakup)</label>
          <input id="url">
        </div>
        <div>
          <label>Tip ponudbe</label>
          <select id="offerType">
            <option value="none">(brez plačila)</option>
            <option value="ticket">Vstopnice (NearGo)</option>
            <option value="coupon">Kupon (NearGo)</option>
          </select>
        </div>
      </div>

      <div class="row row-2">
        <div>
          <label>Cena (glavna)</label>
          <input id="price" type="number" step="0.01" min="0">
        </div>
        <div>
          <label>Izpostavi (7 dni)</label>
          <select id="featured"><option value="false">Ne</option><option value="true">Da</option></select>
        </div>
      </div>

      <div>
        <label>Opis</label>
        <textarea id="description" maxlength="800"></textarea>
        <div class="muted" id="descCount">0 / 800</div>
      </div>

      <div class="actions">
        <button id="save" class="btn">Shrani spremembe</button>
        <a id="back" class="btn link" href="/">Nazaj na domov</a>
      </div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const msg = $("#msg");
    const qs = new URLSearchParams(location.search);
    const token = qs.get("token")||"";
    const key   = qs.get("key")||""; // opcijsko: če pride v linku, je hitrejše

    if(!token){ msg.textContent="Manjka edit token."; }

    // števec opis
    const ta=$("#description"), dc=$("#descCount");
    const upd=()=>{ const n=(ta.value||"").length; dc.textContent=`${n} / 800`; if(n>800) ta.value=ta.value.slice(0,800); };
    ["input","change"].forEach(ev=>ta.addEventListener(ev,upd));

    // naloži
    (async function load(){
      try{
        const url = "/.netlify/functions/provider-edit?action=load&token="+encodeURIComponent(token)+(key?("&key="+encodeURIComponent(key)):"");
        const r = await fetch(url);
    const data = await r.json().catch(()=>({}));
        if(!r.ok || !data.ok){ msg.textContent = data.error || "Napaka pri nalaganju."; return; }

  const e = data.item||{};
        $("#eventName").value = e.eventName||"";
        $("#venue").value     = e.venue||"";
        $("#city").value      = e.city||e.city2||"";
        $("#start").value     = e.start ? new Date(e.start).toISOString().slice(0,16) : "";
        $("#end").value       = e.end   ? new Date(e.end).toISOString().slice(0,16)   : "";
    $("#entryType").value = (e.entryType||e.type)==='service' ? 'service' : 'event';
    // set type buttons and render cats accordingly
    if ((e.entryType||e.type)==='service') document.getElementById('typeService').click(); else document.getElementById('typeEvent').click();
    $("#category").value  = e.category||"";
    window.NearGoEditCategoryChips?.setActive(e.category || "");
    if (document.getElementById('subcategory')) document.getElementById('subcategory').value = e.subcategory||e.subCategory||"";
        $("#url").value       = e.url||"";
        $("#offerType").value = e.offerType||e.saleType||"none";
        $("#price").value     = (e.price!=null? e.price : "");
        $("#featured").value  = String(!!e.featured);
        $("#description").value = e.description||"";
        upd();
      }catch(e){
        msg.textContent="Napaka pri nalaganju.";
      }
    })();

    // shrani
    $("#save").onclick = async ()=>{
      const body = {
        token, key,
        updates:{
          eventName: $("#eventName").value.trim(),
          venue:     $("#venue").value.trim(),
          city:      $("#city").value.trim(),
          start:     $("#start").value ? new Date($("#start").value).toISOString() : null,
          end:       $("#end").value   ? new Date($("#end").value).toISOString()   : null,
          entryType: $("#entryType").value,
          category:  $("#category").value,
          subcategory: (document.getElementById('subcategory')?.value || ""),
          url:       $("#url").value.trim(),
          offerType: $("#offerType").value,
          price:     $("#price").value === "" ? null : Number($("#price").value),
          featured:  $("#featured").value === "true",
          description: $("#description").value.trim()
        }
      };
      msg.textContent="Shranjujem…";
      try{
        const r = await fetch("/.netlify/functions/provider-edit", { method:"POST", headers:{ "content-type":"application/json" }, body:JSON.stringify(body) });
        const data = await r.json().catch(()=>({}));
        if(!r.ok || !data.ok){ msg.textContent = "Napaka: "+(data.error||""); return; }
        msg.textContent="✅ Shranjeno.";
      }catch(e){ msg.textContent="Napaka pri shranjevanju."; }
    };
  </script>
</body>
</html>
