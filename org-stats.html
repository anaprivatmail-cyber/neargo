<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NearGo ‚Äì Statistika dogodka</title>
  <script type="module" src="/assets/sw-reload.js"></script>
  <style>
    :root{
      --bg:#f6fbfe; --card:#fff; --text:#0b1b2b; --muted:#5b6b7b; --border:#e6eef7;
      --brand:#0bbbd6; --brand2:#089ab1; --ok:#107a46; --warn:#d77b00; --shadow:0 12px 30px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}

    /* Header */
    .topbar{position:sticky; top:0; z-index:10; backdrop-filter:blur(6px);
      background: color-mix(in srgb, #ffffff 88%, transparent);
      border-bottom: 1px solid var(--border);}
    .topnav{max-width:1100px; margin:0 auto; padding:10px 14px; display:flex; align-items:center; gap:10px;}
    .brand-mini{display:flex; align-items:center; gap:10px; font-weight:900; font-size:18px; color:var(--text); text-decoration:none}
    .brand-mini svg{width:26px; height:26px}
    .topnav .spacer{flex:1}
    .topbtn{display:inline-block; padding:8px 12px; border-radius:999px; font-weight:800; text-decoration:none;}
    .topbtn.back{background:#fff; color:#0b1b2b; border:1px solid #e6eef7}

    .wrap{max-width:980px;margin:24px auto;padding:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    h1{margin:6px 0 10px;font-size:22px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,input[type=text],button{padding:10px 12px;border:1px solid var(--border);border-radius:10px;font:16px/1.4 inherit}
    button{cursor:pointer}
    .btn{border:none;border-radius:10px;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;font-weight:800;padding:10px 14px}
    .btn.link{background:#fff;color:var(--text);border:1px solid var(--border)}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    .kpi{border:1px solid var(--border);border-radius:14px;padding:14px;background:#fff}
    .kpi b{font-size:22px}
    .grid{margin-top:12px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#f8fcff}
    .badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-weight:800;font-size:12px;background:#fff;margin-right:6px}
    .warn{color:var(--warn)}
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="topbar">
    <div class="topnav">
      <a href="/" class="brand-mini" aria-label="NearGo">
        <svg viewBox="0 0 32 32" aria-hidden="true">
          <defs>
            <radialGradient id="g1" cx="50%" cy="50%">
              <stop offset="0%" stop-color="#0bbbd6"/><stop offset="100%" stop-color="#7de3f0"/>
            </radialGradient>
          </defs>
          <circle cx="16" cy="16" r="12" fill="none" stroke="url(#g1)" stroke-width="2"/>
          <circle cx="16" cy="16" r="3.2" fill="#0bbbd6"/>
        </svg>
        NearGo
      </a>
      <span class="spacer"></span>
      <a href="/organizers.html" class="topbtn back" id="btnBackStats">Nazaj</a>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h1>üìà Statistika prodaje / unovƒçitev</h1>
          <div class="muted" id="subtitle"></div>
        </div>
        <div class="row" id="controls">
          <!-- profil (stats): samo Osve≈æi; skener: select eventId + Osve≈æi -->
        </div>
      </div>

      <div id="meta" style="margin-top:10px"></div>

      <div class="kpis">
        <div class="kpi"><div class="muted">Prodano (issued + redeemed)</div><b id="sold">‚Äì</b></div>
        <div class="kpi"><div class="muted">Unovƒçeno</div><b id="redeemed">‚Äì</b></div>
        <div class="kpi"><div class="muted">Zadnja prodaja</div><b id="lastSale">‚Äì</b></div>
      </div>

      <div class="grid" style="margin-top:12px">
        <table>
          <thead><tr><th>Tip</th><th>Prodano</th><th>Unovƒçeno</th></tr></thead>
          <tbody id="byType"><tr><td colspan="3" class="muted" style="padding:14px">Ni podatkov.</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const qs = new URLSearchParams(location.search);
    const statsToken = (qs.get('stats')||'').trim();
    const fmtDT = s => s ? new Date(s).toLocaleString() : '‚Äì';

    // Vzemi eventId iz URL (ƒçe obstaja)
    const initialEid = (qs.get('eventId')||qs.get('eid')||'').trim();

    // Sprejmi ?k= (scanner key) in odstrani iz URL
    (function applyScannerKeyFromQuery(){
      try{
        const u = new URL(location.href);
        const k = u.searchParams.get('k');
        if(k){
          localStorage.setItem('scanner_key', k);
          u.searchParams.delete('k');
          history.replaceState({}, '', u.pathname + (u.search?('?'+u.search):''));
        }
      }catch{}
    })();

    // UI glede na naƒçin
    (function setupUI(){
      const controls = $('#controls');
      const subtitle = $('#subtitle');
      if (statsToken){
        // PROFIL (organizator)
        subtitle.textContent = 'Povzetek tvojega dogodka.';
        controls.innerHTML = `<button class="btn" id="btnRefresh">Osve≈æi</button>`;
      } else {
        // SKENER naƒçin (brez stats): desni seznam eventId + Osve≈æi
        subtitle.textContent = 'Povzetek (po ≈æelji omeji≈° z eventId).';
        controls.innerHTML = `
          <select id="eventIdSel" title="Izberi dogodek (eventId)" style="min-width:220px"></select>
          <button class="btn" id="btnRefresh">Osve≈æi</button>
        `;
      }
    })();

    // üö´ ƒåistilec starih tabov
    (function antiLegacyTabs(){
      const kill = () => {
        const ctr = document.getElementById('controls');
        if (!ctr) return;
        ctr.querySelectorAll('*').forEach(el => {
          const t = (el.textContent || '').trim().toLowerCase();
          if (t === 'dogodek' || t === 'povzetek' || t === 'kopiraj povezavo') el.remove();
        });
      };
      kill();
      const mo = new MutationObserver(kill);
      mo.observe(document.body, { childList:true, subtree:true });
    })();

    function buildSalesUrl(){
      const p = new URLSearchParams();
      if (statsToken) p.set('stats', statsToken);
      const sel = $('#eventIdSel');
      const eid = sel ? (sel.value||'').trim() : (initialEid||'');
      if (eid) p.set('eventId', eid);
      return '/.netlify/functions/sales' + (p.toString() ? ('?' + p.toString()) : '');
    }

    function maybeFillEventList(list){
      const sel = $('#eventIdSel');
      if (!sel) return;
      const ids = Array.isArray(list) ? list.filter(Boolean) : [];
      if (!ids.length && !initialEid){ sel.style.display='none'; return; }
      if (initialEid && !ids.includes(initialEid)) ids.unshift(initialEid);
      sel.innerHTML = ids.map(id=>`<option value="${id}">${id}</option>`).join('');
      if (initialEid) sel.value = initialEid;
      sel.addEventListener('change', ()=> load());
    }

    async function load(){
      const headers = {};
      const hasStats = !!statsToken;

      if (!hasStats){
        const key = (localStorage.getItem('scanner_key')||'').trim();
        if (!key){
          $('#meta').innerHTML =
            '<span class="badge warn">Manjka stats ≈æeton</span> '+
            '<span class="badge">Ni skener kljuƒça</span>';
          setKPIs({sold:null, redeemed:null, lastSale:null}); setByType({});
          return;
        }
        headers['x-scanner-key'] = key;
      }

      const url = buildSalesUrl();

      try{
        const r = await fetch(url, { headers });
        const data = await r.json();
        if(!data.ok){ throw new Error(data.error||'Napaka'); }
        maybeFillEventList(data.eventIds || []);
        const ev = data.event || null;
        $('#meta').innerHTML = ev
          ? `<span class="badge">Dogodek</span>${ev?.title?('<b>'+ev.title+'</b> ‚Ä¢ '):''}${ev?.city||''}${ev?.start?' ‚Ä¢ '+fmtDT(ev.start):''}`
          : `<span class="badge">Dogodek</span> Povzetek`;
        setKPIs(data);
        setByType(data.byType || {});
      }catch(e){
        $('#meta').innerHTML = `<span class="badge warn">Napaka</span> ${e?.message||e}`;
        setKPIs({sold:null, redeemed:null, lastSale:null}); setByType({});
      }
    }

    function setKPIs({sold, redeemed, lastSale}){
      $('#sold').textContent     = Number.isFinite(+sold)     ? sold     : '‚Äì';
      $('#redeemed').textContent = Number.isFinite(+redeemed) ? redeemed : '‚Äì';
      $('#lastSale').textContent = lastSale ? fmtDT(lastSale) : '‚Äì';
    }

    function setByType(byType){
      const tb = $('#byType'); tb.innerHTML='';
      const kinds = Object.keys(byType||{});
      if(!kinds.length){ tb.innerHTML = '<tr><td colspan="3" class="muted" style="padding:14px">Ni podatkov.</td></tr>'; return; }
      tb.innerHTML = kinds.map(k=>{
        const g = byType[k]||{};
        return `<tr><td>${k==='ticket'?'Vstopnice':'Kuponi'}</td><td>${g.sold??0}</td><td>${g.redeemed??0}</td></tr>`;
      }).join('');
    }

    document.addEventListener('click', (e)=>{
      if (e.target?.id === 'btnRefresh'){ load(); }
    });

    load();

    (function(){
      const b=document.getElementById('btnBackStats'); if(!b) return;
      b.addEventListener('click', function(e){
        const ref = document.referrer;
        if(ref && new URL(ref).origin === location.origin){ e.preventDefault(); history.back(); }
      });
    })();
  </script>
</body>
</html>
