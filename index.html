<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NearGo – najdi dogodke in storitve blizu</title>
  <!-- PWA -->
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0bbbd6">
  <!-- Leaflet -->
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root{
      --brand:#0bbbd6; --text:#0b1b2b; --muted:#5b6b7b; --card:#fff;
      --chip:#fff; --chipborder:#cfe1ee; --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:16px; --primary:#0bbbd6; --focus:#bfeef6; --gap:16px;
      --ok:#11a67a; --bad:#d64c4c;
    }
    body.dark{--text:#e8f0f8; --muted:#b8c3cf; --card:#0f1f30; --chip:#102437; --chipborder:#19324a; --focus:#123956}
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at -10% -10%, rgba(11,187,214,.25) 0%, rgba(11,187,214,0) 60%),
        linear-gradient(180deg, #e9f7ff 0%, #ffffff 70%);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; line-height:1.25;
    }
    a{ color:inherit; text-decoration:none }

    /* HEADER */
    header{position:sticky; top:0; z-index:30; backdrop-filter:blur(6px); background:color-mix(in srgb, var(--card) 88%, transparent); box-shadow:0 4px 16px rgba(0,0,0,.05);}
    .nav{ max-width:1100px; margin:0 auto; padding:8px 14px 10px; display:flex; flex-direction:column; gap:6px; }
    .nav-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .row0{ justify-content:center }
    .row1{ justify-content:space-between }
    .row2{ justify-content:flex-start; gap:10px }

    .brand{ display:flex; align-items:center; gap:10px; font-weight:900; font-size:20px }
    .brand svg{width:26px; height:26px}
    @keyframes slowPulse{0%{transform:scale(1);opacity:1}50%{transform:scale(1.07);opacity:.95}100%{transform:scale(1);opacity:1}}
    .pulse{animation:slowPulse 2.8s ease-in-out infinite; transform-origin:center}

    .pill{border:1px solid var(--chipborder); background:var(--chip); border-radius:999px; height:34px; display:flex; align-items:center; padding:0 10px; font-weight:800; font-size:14px; color:inherit; position:relative; cursor:pointer}
    .btn{background:var(--primary); color:#fff; border:none; padding:12px 18px; border-radius:14px; font-weight:900; cursor:pointer; font-size:16px}
    .btn.mini{padding:8px 12px; font-size:13px; border-radius:12px}
    .btn.link{background:#fff; color:#000; border:1px solid var(--chipborder)}
    .btn.link.active{background:var(--primary); color:#fff; border-color:transparent}
    .cta{background:var(--primary); color:#fff; border:none; padding:8px 14px; border-radius:999px; font-weight:800; box-shadow:var(--shadow); height:34px; display:flex; align-items:center}

    /* Za ponudnike – rahlo izpostavljen */
    .btn-outline{ background:#fff; color:var(--text); border:1.5px solid var(--brand); border-radius:999px; padding:8px 14px; font-weight:800; height:34px; display:flex; align-items:center; box-shadow:0 2px 8px rgba(11,187,214,.12) }

    .mode{ border:1px solid var(--chipborder); background:var(--chip); border-radius:999px; padding:6px 10px; font-weight:900; cursor:pointer; user-select:none }
    .mode.active{ background:var(--primary); color:#fff; border-color:transparent }

    /* LANG */
    #lang{ display:none !important }
    .pill.lang{ position:relative }
    .lang-menu{
      position:absolute; top:calc(100% + 6px); left:0;
      background:var(--card); border:1px solid var(--chipborder); border-radius:12px; box-shadow:var(--shadow);
      padding:6px; display:none; z-index:10000; max-height:60vh; overflow:auto; min-width:64px;
    }
    .lang-menu button{display:block; width:100%; text-align:left; border:none; background:transparent; padding:8px 8px; border-radius:10px; font-weight:800; cursor:pointer;}
    .lang-menu button:hover{background:rgba(11,187,214,.08)}

    /* LAYOUT */
    main{max-width:1100px; margin:0 auto; padding:12px 14px 64px}
    main > section{margin-top:14px}
    .card{background:var(--card); box-shadow:var(--shadow); border-radius:var(--radius); padding:16px; border:1px solid var(--chipborder)}
    .title{font-weight:900; margin-bottom:10px}
    .muted{color:var(--muted)}

    /* HERO */
    .hero h1{margin:0 0 6px 0}
    .hero p{margin:0 0 10px 0}

    /* SEARCH HEAD */
    #searchPanel > .title{
      background:linear-gradient(90deg, rgba(11,187,214,.22), rgba(11,187,214,.06) 70%, transparent 100%);
      border-radius:12px; padding:8px 10px; margin-bottom:6px; display:flex; align-items:center; justify-content:space-between; gap:10px;
    }

    .chips{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .chip{border:1px solid var(--chipborder); border-radius:999px; padding:10px 14px; background:var(--chip); color:var(--muted); font-weight:700; cursor:pointer}
    .chip.active{ background:var(--primary); color:#fff; border-color:#fff; }

    label{display:flex; flex-direction:column; gap:6px; font-weight:800; font-size:13px}
    input,select,textarea{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--chipborder); background:var(--card); color:var(--text); outline:none; min-height:40px; font-size:15px; }
    input[type="datetime-local"]{ min-width:0; width:100%; }
    textarea{min-height:120px}
    input:focus,select:focus,textarea:focus{border-color:var(--brand); box-shadow:0 0 0 4px var(--focus)}
    input::placeholder, textarea::placeholder{color:#93a3b3}

    input:-webkit-autofill, select:-webkit-autofill, textarea:-webkit-autofill{
      -webkit-text-fill-color: var(--text) !important;
      box-shadow: 0 0 0px 1000px var(--card) inset !important;
      transition: background-color 99999s ease-in-out 0s;
    }

    /* RANGE */
    .range-line{display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px}
    input[type=range]{accent-color:#7cdbe9; height:28px; width:100%}

    .row{display:grid; grid-template-columns:1fr; gap:var(--gap)}
    .row + .row{margin-top:var(--gap)}
    @media(min-width:760px){ .row--3{grid-template-columns:repeat(3,1fr)} .row--2{grid-template-columns:repeat(2,1fr)} }
    .always-two{ display:grid; grid-template-columns:repeat(2,1fr); gap:6px; }
    .always-two input{ min-width:0; }

    /* Karusel + kartice */
    .carousel{display:flex; gap:10px; overflow:auto; scroll-snap-type:x mandatory; padding-bottom:6px; margin-top:6px}
    .carousel .spot{ flex:0 0 85%; min-width:260px; scroll-snap-align:start; }
    .spot{background:var(--card); border:1px solid var(--chipborder); border-radius:14px; overflow:hidden; margin-bottom:10px}
    .spot img{width:100%; height:160px; object-fit:cover; display:block}
    .spot .meta{padding:10px}
    .spot .more-text{ margin-top:6px; color:var(--muted) }

    .panel{display:none} .panel.show{display:block}

    .file-wrap{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    input[type="file"]::file-selector-button{padding:.35rem .6rem; border-radius:10px; border:1px solid var(--chipborder); background:var(--chip); cursor:pointer}
    .file-name{font-size:14px; color:var(--muted); white-space:normal; word-break:break-word; max-width:100%}
    .euro{display:flex; align-items:center; gap:8px}

    .buy{display:flex; align-items:center; gap:10px; margin-top:10px; flex-wrap:wrap }
    .value-chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--chipborder); background:var(--chip); border-radius:999px; font-weight:800; font-size:12px; white-space:nowrap; }

    /* Toast */
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:12px; z-index:1002; display:none; padding:10px 14px; border-radius:12px; font-weight:800 }
    .toast.ok{ background:#e6fbf5; color:#05614d; border:1px solid #baf0df }
    .toast.bad{ background:#ffeaea; color:#7a1b1b; border:1px solid #ffd1d1 }

    /* “Moje” značka */
    .badge{ display:inline-flex; align-items:center; justify-content:center; min-width:18px; height:18px; padding:0 6px; font-size:12px; border-radius:999px; background:#0bbbd6; color:#fff; font-weight:900; }

    /* Modal */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:2000}
    .modal .box{background:var(--card); width:min(920px,92vw); border-radius:16px; border:1px solid var(--chipborder); box-shadow:var(--shadow); overflow:hidden}
    .modal .bar{display:flex; align-items:center; justify-content:space-between; padding:8px 12px; border-bottom:1px solid var(--chipborder); font-weight:900}
    .modal .content{padding:10px}
    .modal .row2{display:flex; gap:10px; align-items:center; margin:8px 0}
    .modal input[type="search"]{flex:1}

    label.inline, .inline label{ display:inline-flex; align-items:center; gap:8px; font-weight:800; font-size:13px; line-height:1; flex-direction:row; }
    input[type="checkbox"]{
      -webkit-appearance:none; appearance:none; width:14px; height:14px; margin:0; position:relative;
      border:2px solid #a9c3d6; border-radius:4px; background:#fff; outline:none; display:inline-block; box-sizing:content-box; padding:0; min-height:0 !important;
    }
    input[type="checkbox"]::after{
      content:""; position:absolute; left:3px; top:-1px; width:6px; height:10px;
      border-right:3px solid var(--primary); border-bottom:3px solid var(--primary);
      transform:rotate(45deg); opacity:0; transition:opacity .12s;
    }
    input[type="checkbox"]:checked{ border-color:var(--primary) }
    input[type="checkbox"]:checked::after{ opacity:1 }

    input[type="radio"]{
      -webkit-appearance:none; appearance:none; width:14px; height:14px; margin:0; position:relative;
      border:2px solid #a9c3d6; border-radius:50%; background:#fff; outline:none; display:inline-block; box-sizing:content-box; padding:0; min-height:0 !important;
    }
    input[type="radio"]::after{
      content:""; position:absolute; left:3px; top:3px; width:6px; height:6px; background:var(--primary); border-radius:50%; opacity:0; transition:opacity .12s;
    }
    input[type="radio"]:checked{ border-color:var(--primary) }
    input[type="radio"]:checked::after{ opacity:1 }

    .panel{ scroll-margin-top: 120px; }

    .radius-handle{ background:#0bbbd6; border:2px solid #fff; border-radius:50%; width:16px; height:16px; box-shadow:0 0 0 2px rgba(11,187,214,.4) }
    .leaflet-div-icon.radius-handle{ background:#0bbbd6; border-radius:50%; border:2px solid #fff; width:16px!important; height:16px!important; box-shadow:0 0 0 2px rgba(11,187,214,.4) }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <!-- ROW 0 -->
      <div class="nav-row row0">
        <div class="brand" aria-label="NearGo">
          <svg viewBox="0 0 32 32" aria-hidden="true">
            <defs><radialGradient id="g1" cx="50%" cy="50%"><stop offset="0%" stop-color="#0bbbd6"/><stop offset="100%" stop-color="#7de3f0"/></radialGradient></defs>
            <circle cx="16" cy="16" r="13" class="ring" fill="none" stroke="url(#g1)" stroke-width="2"/>
            <circle cx="16" cy="16" r="8" class="ring" fill="none" stroke="url(#g1)" stroke-width="2" opacity=".9"/>
            <circle cx="16" cy="16" r="3.2" class="dot pulse"/>
          </svg>
          NearGo
        </div>
      </div>

      <!-- ROW 1 -->
      <div class="nav-row row1">
        <div class="left" style="display:flex;gap:10px;align-items:center">
          <div id="btnThemeToggle" class="pill" title="Preklopi temo"><span id="themeIcon">🌙</span></div>
          <div class="pill lang" id="langWrap">
            <span class="label"><span id="langLabel">SL</span><span class="chev">▼</span></span>
            <select id="lang" aria-label="Jezik"></select>
            <div class="lang-menu" id="langMenu"></div>
          </div>
        </div>
        <div class="right">
          <a class="btn-outline" id="btnProvidersTop" href="#orgHub">Za ponudnike</a>
        </div>
      </div>

      <!-- ROW 2 -->
      <div class="nav-row row2">
        <button class="mode active" data-mode="events">Dogodki</button>
        <button class="mode" data-mode="services">Storitve</button>
        <a class="pill" id="btnPremiumTop" href="#premiumPanel">Premium</a>
        <a class="pill" id="btnMine" href="/my.html" title="Moje vstopnice & kuponi">Moje <span id="pointsBadge" class="badge" style="margin-left:6px;display:none">0</span></a>
      </div>
    </div>
  </header>

  <main>
    <!-- HERO -->
    <section class="hero card" id="hero">
      <h1 id="heroHeadline">Najdi <span id="heroNoun" style="color:var(--brand)">dogodke blizu</span> — koncerti, hrana, kultura, otroci &amp; več</h1>
      <p id="heroLead">Vtipkaj, izberi kraj ali radij in dobiš <span id="heroNoun2">dogodke</span> v izbrani okolici — kupi vstopnico ali kupon, dodaj v koledar, povabi prijatelje.</p>
      <div class="chips">
        <button class="btn" id="btnStart">Začni z iskanjem</button>
      </div>
    </section>

    <!-- Izpostavljeno -->
    <section class="card" id="featuredCard">
      <div class="title" style="display:flex;justify-content:space-between;align-items:center">
        <span id="featTitle">Izpostavljeno v tvoji bližini</span>
        <div class="muted" style="font-size:12px">Samodejno vrtenje • potegni levo/desno</div>
      </div>
      <div class="carousel" id="carousel"></div>
    </section>

    <!-- Iskanje -->
    <section class="card" id="searchPanel">
      <div class="title"><span id="searchTitle">Iskanje</span></div>

      <div class="inline" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:6px">
        <button class="btn link" id="btnPickOnMap">Izberi lokacijo na zemljevidu</button>
        <button class="btn link" id="btnUseLocation"><span class="txt">Uporabi mojo trenutno lokacijo</span></button>
      </div>

      <label>Oddaljenost od trenutne lokacije
        <div class="range-line">
          <input id="radius" type="range" min="5" max="400" step="5" value="30">
          <span id="radiusLbl">30 km</span>
        </div>
      </label>

      <div class="row row--1">
        <label>Kje <input id="city" placeholder="Mesto/kraj ali 'lat, lon'"></label>
      </div>

      <label id="cityRadiusWrap" style="display:none">Oddaljenost od izbranega kraja
        <div class="range-line">
          <input id="radiusCity" type="range" min="5" max="400" step="5" value="30">
          <span id="radiusCityLbl">30 km</span>
        </div>
      </label>

      <!-- Hitri datumi -->
      <div class="inline" id="quickDates" style="display:flex;gap:6px;flex-wrap:wrap;align-items:flex-end;margin-top:6px">
        <button class="btn mini link quickDate" data-mode="today" type="button">Danes</button>
        <button class="btn mini link quickDate" data-mode="weekend" type="button">Ta vikend</button>
        <button class="btn mini link quickDate" data-mode="7" type="button">7 dni</button>
        <button class="btn mini link quickDate" data-mode="30" type="button">30 dni</button>
      </div>

      <!-- Od/Do -->
      <div class="row always-two" id="dateRangeRow" style="margin-top:6px">
        <label>Od <input id="dateFrom" type="date"></label>
        <label>Do <input id="dateTo" type="date"></label>
      </div>

      <div class="row row--1" style="margin-top:6px">
        <label>Kaj <input id="q" placeholder="npr. Metallica, street food, frizer…"></label>
      </div>

      <!-- Kategorije -->
      <div class="chips" id="cats" style="margin-top:8px" role="tablist" aria-label="Kategorije"></div>

      <div style="margin-top:6px" id="freeOnlyWrap">
        <label class="inline" style="gap:8px; align-items:center">
          <input type="checkbox" id="freeOnly">
          <span>Samo brezplačni</span>
        </label>
      </div>

      <div class="inline" style="margin-top:6px">
        <button class="btn link" id="btnClear">Počisti filtre</button>
      </div>

      <!-- Zemljevid rezultatov -->
      <div class="inline" style="margin-top:8px">
        <button class="btn link" id="btnToggleResultsMap">Pokaži zemljevid rezultatov</button>
      </div>
      <div id="mapSearchWrap" style="margin-top:8px; display:none; position:relative">
        <div id="mapSearch" style="height:360px; border-radius:12px; border:1px solid var(--chipborder)"></div>
      </div>

      <div id="results" style="margin-top:8px"></div>
      <div id="pagination" style="display:flex; gap:8px; margin-top:8px"></div>
    </section>

    <!-- Zemljevid (zgornji) -->
    <section class="card panel" id="mapPanel" style="display:none">
      <div class="title" style="display:flex; align-items:center; justify-content:space-between">
        <span>Zemljevid</span>
        <button class="btn mini link" id="btnCloseMap">Zapri zemljevid</button>
      </div>
      <div id="map" style="height:360px"></div>
      <div id="mapDetail" style="margin-top:10px"></div>
    </section>

    <!-- PONUDNIKI HUB -->
    <section class="card panel" id="orgHub" style="display:none">
      <div class="title">Za ponudnike</div>
      <p class="muted">Objava je brezplačna. NearGo pomaga povečevati prodajo, zapolniti prazne termine in povečati doseg.</p>
      <div class="inline" style="display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn" id="hubPublish">Objavi dogodek/storitev</button>
        <a class="btn link" id="hubScan" href="/scan.html">Skeniraj QR</a>
        <a class="btn link" id="hubStats" href="/org-stats.html">Analitika</a>
        <a class="btn link" id="hubCalendar" href="/calendar.html">Koledar</a>
        <button class="btn link" id="hubBoost">Boost izpostavitev</button>
        <button class="btn link" id="hubPlans">Paketi (Grow/Pro)</button>
      </div>
    </section>

    <!-- PAKETI -->
    <section class="card panel" id="plansPanel" style="display:none">
      <div class="title" style="display:flex;justify-content:space-between;align-items:center">
        <span>Paketi za ponudnike</span>
        <button class="btn mini link" id="btnClosePlans">Zapri</button>
      </div>
      <div class="row row--2">
        <div class="card">
          <div class="title" style="margin:0">Grow</div>
          <div class="muted" style="font-size:13px;margin-top:-6px">Za začetek rasti</div>
          <ul class="muted" style="margin:6px 0 0 18px; line-height:1.6">
            <li>1 aktivna izpostavitev (7 dni)</li>
            <li>Osnovna analitika (ogledi, klikni → nakup)</li>
            <li>Sinhronizacija koledarja</li>
            <li>Podpora v 24 h</li>
          </ul>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <div class="value-chip">mesečno</div>
            <button class="btn" data-start-plan="grow">Aktiviraj Grow</button>
          </div>
        </div>
        <div class="card">
          <div class="title" style="margin:0">Pro</div>
          <div class="muted" style="font-size:13px;margin-top:-6px">Za zahtevne ekipe</div>
          <ul class="muted" style="margin:6px 0 0 18px; line-height:1.6">
            <li>3 aktivne izpostavitve (7 dni)</li>
            <li>Napredna analitika + izvoz</li>
            <li>API integracije in prioritetna podpora</li>
            <li>Upravljanje ekipe (več uporabnikov)</li>
          </ul>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <div class="value-chip">mesečno</div>
            <button class="btn" data-start-plan="pro">Aktiviraj Pro</button>
          </div>
        </div>
      </div>
      <!-- Nov vnos: e-pošta za račun (pošilja se v backend za Stripe račun) -->
      <div class="row" style="margin-top:10px">
        <input id="providerBillingEmail" type="email" placeholder="E‑pošta za račun (za pakete)">
      </div>
      <p class="muted" style="margin-top:8px">Cene se lahko razlikujejo glede na državo in davek.</p>
    </section>

    <!-- OBRAZEC: Dogodek / Storitev -->
    <section class="card panel" id="orgPanel" style="display:none">
      <div class="title">Objavi dogodek ali storitev</div>
      <p class="muted"><b>Objava je brezplačna.</b> Dodatno lahko izbereš plačljive <a href="#plans" id="linkPlansInline">pakete</a> za analitiko, izpostavitve in sinhronizacijo koledarja (Grow/Pro).</p>

      <!-- Tip vnosa -->
      <div class="row row--3">
        <label>Tip vnosa *
          <select id="entryType" required>
            <option value="event" selected>Dogodek</option>
            <option value="service">Storitev</option>
          </select>
        </label>
        <input id="orgName" placeholder="Ime organizatorja / ponudnika *" required>
        <input id="orgFullName" placeholder="Ime in priimek (kontaktna oseba) *" required>
      </div>

      <div class="row row--3">
        <input id="orgEmail" type="email" placeholder="E-pošta za potrditev *" required>
        <input id="eventName" placeholder="Naslov (dogodek ali storitev) *" required>
        <input id="venue" placeholder="Lokacija (ime prizorišča ali salona) *" required>
      </div>

      <div class="row row--3">
        <select id="country" required>
          <option value="">Država (izberi) *</option>
          <option value="SI" selected>Slovenija (SI)</option><option value="AT">Avstrija (AT)</option>
          <option value="HR">Hrvaška (HR)</option><option value="IT">Italija (IT)</option>
          <option value="HU">Madžarska (HU)</option><option value="DE">Nemčija (DE)</option>
          <option value="FR">Francija (FR)</option><option value="GB">Združeno kraljestvo (GB)</option>
          <option value="US">ZDA (US)</option>
        </select>
        <!-- Za dogodke obvezno; za storitve skrito -->
        <label id="startWrap">Začetek * <input id="start" type="datetime-local"></label>
        <label id="endWrap">Končanje * <input id="end" type="datetime-local"></label>
      </div>

      <div class="row row--3">
        <input id="city2" placeholder="Mesto/kraj *" required>
        <input id="url" placeholder="Povezava za več info / nakup (če obstaja)">
        <label>Kategorija (glede na tip) *
          <select id="category" required></select>
        </label>
      </div>

      <!-- STORITVE -->
      <div class="card" id="svcBlock" style="display:none; margin-top:8px">
        <div class="title" style="margin:0">Storitve – razpoložljivost & kupon</div>

        <div class="row">
          <label class="inline"><input type="radio" name="svcAvail" value="call" checked> <span style="margin-top:10px">Pokliči za rezervacijo</span></label>
          <label class="inline"><input type="radio" name="svcAvail" value="calendar"> <span style="margin-top:10px">Koledar terminov</span></label>
        </div>

        <div id="svcCallRow" class="row row--2" style="margin-top:12px">
          <input id="svcPhone" placeholder="Telefon za rezervacije (npr. +386 40 000 000)">
          <div></div>
        </div>

        <div id="svcCalendarRow" class="row" style="display:none; margin-top:12px">
          <a class="btn mini link" href="/calendar.html" target="_blank">Odpri koledar</a>
        </div>

        <div class="row row--2" style="margin-top:8px">
          <label>Tip cenika (opcijsko)
            <select id="svcPriceType">
              <option value="RATECARD" selected>Po ceniku (zunanji cenik)</option>
              <option value="FIXED">Fiksna cena</option>
              <option value="FREE">Brezplačno</option>
            </select>
          </label>
          <input id="svcRateUrl" placeholder="Povezava na cenik (opcijsko)">
        </div>
        <div class="row row--2" id="svcFixedRow" style="display:none">
          <div class="euro"><input id="svcFixedPrice" type="number" min="0" step="0.01" placeholder="Cena (v €)"><span>€</span></div>
          <div></div>
        </div>

        <!-- Kupon (obvezno ali FREE storitev) -->
        <div class="row" id="svcCouponCfg" style="margin-top:6px">
          <div class="title" style="margin:0">Kupon</div>
          <div class="row row--3">
            <label>Tip kupona
              <select id="couponKind">
                <option value="PERCENT" selected>% popusta</option>
                <option value="VALUE">Vrednost v €</option>
                <option value="FREEBIE">Konkretno (npr. 2 za 1 / gratis)</option>
              </select>
            </label>
            <label id="lblPercent">% popusta
              <input id="couponPercent" type="number" min="1" max="100" step="1" placeholder="npr. 20">
            </label>
            <label id="lblValue" style="display:none">Vrednost (€)
              <input id="couponValue" type="number" min="0.1" step="0.01" placeholder="npr. 5.00">
            </label>
            <label id="lblFreebie" style="display:none">Konkretno (opis)
              <input id="couponFreebie" placeholder="npr. 2 za 1, gratis kosilo …">
            </label>
          </div>
        </div>
      </div>

      <!-- TIP PONUDBE – samo za dogodke -->
      <div class="row row--2" id="offerRow">
        <label>Tip ponudbe
          <select id="offerType">
            <option value="none" selected>Brez plačila</option>
            <option value="ticket">Vstopnice – prodaja prek NearGo</option>
            <option value="coupon">Kupon – unovčljiv prek NearGo</option>
          </select>
        </label>
        <div class="euro" id="priceWrap">
          <input id="price" type="number" min="0" step="0.01" placeholder="Cena (ena cena)">
          <span>€</span>
        </div>
      </div>

      <!-- Kupon za DOGODEK -->
      <div class="row" id="evtCouponBlock" style="display:none">
        <div class="title" style="margin:0">Kupon</div>
        <div class="row row--3" style="margin-top:6px">
          <label>Tip kupona
            <select id="evtCouponKind" name="couponKind">
              <option value="">(izberi)</option>
              <option value="PERCENT">Popust v %</option>
              <option value="VALUE">Vrednost v €</option>
              <option value="FREEBIE">Konkretno (gratis)</option>
            </select>
          </label>
          <label id="evtLblPercent" style="display:none">% popusta
            <input id="evtCouponPercent" name="couponPercentOff" type="number" min="1" max="100" step="1" placeholder="npr. 20">
          </label>
          <label id="evtLblValue"   style="display:none">Vrednost (€)
            <input id="evtCouponValue" name="couponValueEur" type="number" min="0.1" step="0.01" placeholder="npr. 5.00">
          </label>
          <label id="evtLblFreebie" style="display:none">Konkretno (opis)
            <input id="evtCouponFreebie" name="couponFreebieLabel" placeholder="npr. 2 za 1 …">
          </label>
        </div>
      </div>

      <!-- VSTOPNICE (dogodki) -->
      <div class="row" id="ticketPricesBlock" style="display:none">
        <div class="title" style="margin:0">Cenik vstopnic</div>
        <div id="ticketStepList" class="row" style="margin-top:6px"></div>
        <button class="btn mini link" id="btnAddTicketPrice" type="button" style="margin-top:6px">+ Dodaj ceno</button>
      </div>

      <div class="row row--2">
        <input id="stock" type="number" min="0" step="1" placeholder="Zaloga (št. kosov)" required>
        <input id="maxPerOrder" type="number" min="1" step="1" placeholder="Max na naročilo">
      </div>
      <div class="row">
        <div class="file-wrap">
          <input id="image" type="file" accept="image/*">
          <span id="fileName" class="file-name">Fotografija ni izbrana</span>
          <img id="imgPreview" alt="" style="display:none;width:56px;height:56px;border-radius:8px;border:1px solid var(--chipborder);object-fit:cover">
        </div>
      </div>
      <div class="inline" style="margin-top:6px">
        <label class="inline" style="gap:8px; align-items:center">
          <input type="checkbox" id="featured">
          <span>Izpostavi (7 dni)</span>
        </label>
        <span id="featMsg" class="muted" style="margin-left:8px"></span>
        <a href="#plans" id="featPlansLink" class="muted" style="margin-left:8px; text-decoration:underline">pakete</a>
      </div>
      <div class="row" style="margin-top:8px">
        <textarea id="desc" placeholder="Opis *" maxlength="800" required></textarea>
        <div class="muted" id="descCount" style="font-size:12px; text-align:right">0 / 800</div>
      </div>
      <div class="inline" style="margin-top:6px">
        <label class="inline" style="gap:8px; align-items:center">
          <input type="checkbox" id="agreeFees">
          <span>Strinjam se s <a href="#provider-terms" id="showProviderTerms">Pogoji za plačljive ponudbe</a>.</span>
        </label>
      </div>
      <div style="margin-top:10px">
        <button class="btn" id="btnSubmitEvent">Objavi</button>
        <span id="orgMsg" class="muted" style="margin-left:10px"></span>
      </div>
    </section>

    <!-- PREMIUM -->
    <section class="card panel" id="premiumPanel" style="display:none">
      <div class="title" style="display:flex;justify-content:space-between;align-items:center">
        <span>Premium</span>
        <button class="btn mini link" id="btnClosePremium">Zapri</button>
      </div>
      <div class="row">
        <p><b>Premium = 5 € / mesec</b></p>
        <ul style="margin:0 0 0 18px; color:var(--muted); line-height:1.6">
          <li><b>Brezplačni kuponi</b> (izdaja 0 € namesto 2 €).</li>
          <li><b>Prednostna obvestila</b> o novih ponudbah v bližini (tudi pred javno objavo).</li>
          <li><b>Ekskluzivne akcije</b> in “happy hour” termini storitev.</li>
        </ul>
        <!-- Nov vnos: e-pošta za račun -->
        <div class="row" style="margin-top:6px">
          <input id="billingEmail" type="email" placeholder="E‑pošta za račun (Premium)">
        </div>
        <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button class="btn" id="btnGoPremium">Naroči Premium</button>
          <button class="btn link" id="btnEarlyNotify">Vključi predčasna obvestila</button>
          <span class="muted" id="premMsg" style="margin-left:10px"></span>
        </div>
      </div>
    </section>

    <!-- Zakaj NearGo (uporabniki) -->
    <section class="card" id="benefitsUser">
      <div class="title">Zakaj NearGo?</div>
      <ul class="benefits" style="margin:8px 0 0 18px; color:var(--muted); line-height:1.6">
        <li><b>Prihranki s kuponi</b> — ekskluzivni popusti pri dogodkih in storitvah.</li>
        <li><b>Brezplačne promocijske ponudbe</b> (omejen čas) — odkrij top akcije v bližini.</li>
        <li><b>Zbiraj točke</b> z ocenami in deljenji ter jih unovči za ugodnosti.</li>
        <li><b>Vse blizu tebe</b> — geolokacijsko iskanje, zemljevid, hitri filtri.</li>
        <li><b>Dodaj v koledar</b> in <b>povabi prijatelje</b> z enim klikom.</li>
      </ul>
    </section>

    <!-- Zakaj NearGo (ponudniki) -->
    <section class="card panel" id="benefitsOrg" style="display:none">
      <div class="title">Zakaj NearGo za ponudnike?</div>
      <ul class="benefits" style="margin:8px 0 0 18px; color:var(--muted); line-height:1.6">
        <li><b>Povečanje prodaje</b> z večjo vidnostjo in lokalnimi priporočili.</li>
        <li><b>Zapolnitev praznih terminov</b> z akcijami in “happy hour” ponudbami.</li>
        <li><b>Promocija</b> z izpostavitvami in priporočili v bližini.</li>
        <li><b>Analitika</b> ogledov, konverzij, unovčitev kuponov.</li>
        <li><b>QR skeniranje</b> vstopnic in kuponov za hitro validacijo.</li>
      </ul>
    </section>

    <!-- Pogoji -->
    <section class="card panel" id="providerTermsPanel" style="display:none">
      <div class="title" style="display:flex;justify-content:space-between;align-items:center">
        <span>Pogoji za plačljive ponudbe</span>
        <button class="btn mini link" id="closeProviderTerms">Zapri</button>
      </div>
      <div class="muted" style="font-size:14px; line-height:1.55">
        <p><b>1.</b> Organizator/ponudnik jamči za točnost cen, razpoložljivost in zakonitost ponudbe. NearGo je posrednik za izdajo vstopnic/kuponov.</p>
        <p><b>2.</b> Plačila vstopnic/kuponov se obdelajo prek Stripe; račun in QR-koda sta poslana na e-pošto kupca.</p>
        <p><b>3.</b> Naročnine in promovirane izpostavitve se izvajajo prek Apple/Google plačilnih sistemov (IAP) v nativnih aplikacijah.</p>
        <p><b>4.</b> Vračila, spremembe in odpovedi ureja organizator po zakonodaji; stroški procesiranja se ne vračajo, razen če zakon določa drugače.</p>
        <p><b>5.</b> NearGo si pridržuje pravico do začasne skritosti ali odstranitve ob sumu zlorabe.</p>
        <p><b>6.</b> Kontakt: <a href="mailto:info@getneargo.com">info@getneargo.com</a>.</p>
      </div>
    </section>

    <!-- Footer -->
    <footer class="legal" style="text-align:center; color:var(--muted); margin-top:18px; font-size:14px">
      © NearGo • <a href="/terms.html#terms">Pogoji uporabe</a> • <a href="/terms.html#privacy">Zasebnost</a> •
      <a href="mailto:info@getneargo.com">info@getneargo.com</a>
    </footer>
  </main>

  <!-- Map picker modal -->
  <div class="modal" id="pickModal" role="dialog" aria-modal="true" aria-label="Izberi lokacijo">
    <div class="box">
      <div class="bar">
        <span>Izberi lokacijo za iskanje</span>
        <button class="btn mini link" id="pickClose">Zapri</button>
      </div>
      <div class="content">
        <div class="row2">
          <input id="pickSearch" type="search" placeholder="npr. Celje, Ljubljana, Vienna …">
          <button class="btn mini link" id="pickUseGPS">📍 Moja lokacija</button>
        </div>
        <div id="pickMap" style="height:360px; border:1px solid var(--chipborder); border-radius:12px"></div>
        <div class="muted" style="font-size:12px;margin:6px 0">Povleci sredinsko ikono za premik • Povleci okrogel ročaj za polmer</div>
        <div class="row2">
          <button class="btn mini link" id="pickMinus">−</button>
          <div class="muted" id="pickRadiusLbl" style="flex:1;text-align:center">Polmer: — km</div>
          <button class="btn mini link" id="pickPlus">+</button>
          <button class="btn" id="pickApply">Uporabi</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Slot picker -->
  <div class="modal" id="slotModal" role="dialog" aria-modal="true" aria-label="Izberi termin">
    <div class="box">
      <div class="bar">
        <span>Izberi termin</span>
        <button class="btn mini link" id="slotClose">Zapri</button>
      </div>
      <div class="content">
        <div id="slotList" class="row"></div>
        <div class="row2" style="display:flex;gap:10px;align-items:center;margin-top:6px">
          <button class="btn mini link" id="slotCancel">Prekliči</button>
          <button class="btn" id="slotConfirm" disabled>Nadaljuj</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cookie banner -->
  <div id="cookieBanner" class="card" style="position:fixed;bottom:12px;left:12px;right:12px;z-index:1001;display:none;padding:12px;border-radius:12px;border:1px solid var(--chipborder);background:var(--card);box-shadow:var(--shadow)">
    <p style="margin:0 0 6px 0;font-size:14px;line-height:1.4">
      Ta aplikacija uporablja le nujne piškotke (seja, jezik, tema). Aplikacija uporablja <b>lokacijo</b> (GPS) in po potrebi <b>kamero</b> (QR skeniranje) – obe le z vašo privolitvijo.
    </p>
    <button class="btn mini" id="cookieAccept">Razumem</button>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
/* ===== Helperji: nič optional chaining, nič nullish ===== */
(function(){
  window._toast = function(msg, ok){
    var t=document.getElementById('toast'); if(!t) return;
    t.textContent=msg; t.className='toast '+(ok===false?'bad':'ok'); t.style.display='flex';
    setTimeout(function(){ t.style.display='none'; }, 4000);
  };
  window.onerror = function(m){ try{window._toast('Napaka: '+m,false);}catch(e){} };
})();

function $(s){ return document.querySelector(s); }
function $all(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }
function el(tag, cls){ var x=document.createElement(tag); if(cls) x.className=cls; return x; }
function qs(o){ return new URLSearchParams(o).toString(); }
function euro(v){ return Number.isFinite(+v) ? new Intl.NumberFormat('sl-SI',{style:'currency',currency:'EUR'}).format(+v) : ''; }
function debounce(fn,ms){ var t; ms=ms||350; return function(){ var a=arguments; clearTimeout(t); t=setTimeout(function(){ fn.apply(null,a); },ms); }; }
function headerH(){ var h=document.querySelector('header'); return (h && h.getBoundingClientRect ? h.getBoundingClientRect().height : 64); }
function clamp(n,min,max){ return Math.min(Math.max(n,min),max); }
function firstDefined(){ for(var i=0;i<arguments.length;i++){ if(arguments[i]!==undefined && arguments[i]!==null) return arguments[i]; } return undefined; }
function isExternalAPI(e){
  var u=(e && e.url ? String(e.url) : '').toLowerCase();
  return (u.indexOf('ticketmaster')>-1 || u.indexOf('eventbrite')>-1);
}

/* Stabilen ID + register */
var ITEMS_BY_ID = new Map();
function hashId(e){
  if(e && e.id){ return ('ev-'+String(e.id).replace(/[^a-z0-9]/gi,'')); }
  var nm=(e && (e.name||e.title) ? (e.name||e.title) : '').toLowerCase().replace(/[^a-z0-9]/g,'');
  var st=(e && e.start ? String(e.start) : '').replace(/[^0-9]/g,'');
  return ('ev-'+(nm+'-'+st)).slice(0,64);
}

/* ===== STATE ===== */
var GEO=null, currentPage=0, PAGE_SIZE=10, lastResults=[];
var mapSearch=null, markersSearch=[];
var topMap=null, topMarkers=[];
var pickMap=null, pickMarker=null, pickEdgeMarker=null, pickCircle=null, pickRadius=30, pickRadiusM=30000;
var ACTIVE_MODE='events';
var IS_PREMIUM=false; var PROVIDER_PLAN='free';

/* ===== Datumi ===== */
function parseDateAny(v){
  if(!v) return NaN; if(v instanceof Date) return +v;
  var t=Date.parse(v); if(!Number.isNaN(t)) return t;
  var s=String(v).trim();
  var m=s.match(/^(\d{1,2})[.\-/ ](\d{1,2})[.\-/ ](\d{2,4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if(m){ var d=m[1], mo=m[2], y=m[3], h=m[4]||'00', mi=m[5]||'00', se=m[6]||'00'; if(y.length===2) y='20'+y; return +new Date(+y,+mo-1,+d,+h,+mi,+se); }
  return NaN;
}
function getEndTs(e){
  if(e && (e.type==="service" || e.entryType==="service")){
    var slots=(e.service && e.service.slots) ? e.service.slots : [];
    var future=slots.map(function(s){ return parseDateAny(firstDefined(s.end,s.start)); })
                    .filter(function(t){ return Number.isFinite(t) && t>=Date.now(); });
    if(future.length) return Math.max.apply(Math,future);
    return NaN;
  }
  var c=firstDefined(e.end,e.until,e.endsAt,e.ends_at,e.finish,e.stop,e.endDate,e.end_time,e.start);
  var t=parseDateAny(c); return Number.isFinite(t)?t:NaN;
}
function formatDateRange(start,end){
  if(!start) return "";
  var s=new Date(start); if(Number.isNaN(+s)) return "";
  var day = new Intl.DateTimeFormat("sl-SI",{weekday:"short"}).format(s);
  var D  = new Intl.DateTimeFormat("sl-SI",{day:"2-digit",month:"2-digit",year:"numeric"});
  var T  = new Intl.DateTimeFormat("sl-SI",{hour:"2-digit",minute:"2-digit"});
  if(end){
    var e=new Date(end); if(!Number.isNaN(+e)){
      return (s.toDateString()==e.toDateString())
        ? (day+", "+D.format(s)+" • "+T.format(s)+"–"+T.format(e))
        : (day+", "+D.format(s)+" • "+T.format(s)+" — "+D.format(e)+" • "+T.format(e));
    }
  }
  return day+", "+D.format(s)+" • "+T.format(s);
}
/* Koledar: GCal ali ICS */
function addToCalendar(e){
  var title=(e.title||e.name||'NearGo'); var start=e.start; var end=e.end; var loc=(e.venue && e.venue.address)||'';
  if(!start){ window._toast('Ni datuma za koledar.', false); return; }
  function dt(d){ return new Date(d).toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z$/,'Z'); }
  var gcal="https://calendar.google.com/calendar/render?action=TEMPLATE&text="+encodeURIComponent(title)+"&dates="+dt(start)+"/"+(end?dt(end):"")+"&location="+encodeURIComponent(loc)+"&sf=true&output=xml";
  var isAndroid = /Android/i.test(navigator.userAgent);
  if(isAndroid){ window.open(gcal,'_blank'); return; }
  var ics="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//NearGo//sl\nBEGIN:VEVENT\nSUMMARY:"+title+"\nDTSTART:"+dt(start)+"\n"+(end?("DTEND:"+dt(end)+"\n"):"")+"LOCATION:"+loc+"\nEND:VEVENT\nEND:VCALENDAR".replace(/\n/g,"\r\n");
  var blob=new Blob([ics],{type:"text/calendar"}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(title||'NearGo')+'.ics'; document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(a.href); a.remove();},0);
}

/* ===== Tema ===== */
(function(){
  var btn=$("#btnThemeToggle"), icon=(btn?btn.querySelector('#themeIcon'):null);
  function apply(mode){
    if(mode==='dark') document.body.classList.add('dark'); else document.body.classList.remove('dark');
    try{ localStorage.setItem('theme',mode); }catch(e){}
    if(icon) icon.textContent=(mode==='dark'?'☀️':'🌙');
  }
  var init; try{ init = localStorage.getItem('theme')||'light'; }catch(e){ init='light'; }
  apply(init);
  if(btn) btn.addEventListener('click',function(){ apply(document.body.classList.contains('dark')?'light':'dark'); });
})();

/* ===== Jeziki ===== */
(function(){
  var wrap=$("#langWrap"), menu=$("#langMenu"), hidden=$("#lang"), label=$("#langLabel");
  var SUP=[["sl","SL"],["en","EN"],["de","DE"],["hr","HR"],["it","IT"],["hu","HU"],["fr","FR"],["es","ES"],["pt","PT"],["nl","NL"],["pl","PL"],["cs","CS"],["sk","SK"],["ro","RO"],["bg","BG"],["sr","SR"],["bs","BS"],["uk","UK"]];
  if(menu && !menu.children.length){ menu.innerHTML=SUP.map(function(p){return '<button type="button" data-val="'+p[0]+'">'+p[1]+'</button>';}).join(""); }
  if(hidden && !hidden.children.length){ hidden.innerHTML=SUP.map(function(p,i){return '<option value="'+p[0]+'" '+(i===0?'selected':'')+'>'+p[1]+'</option>';}).join(""); }
  var pref=(navigator.language||"sl").slice(0,2).toLowerCase();
  try{ var init=localStorage.getItem('lang')||SUP.filter(function(p){return p[0]===pref;}).map(function(p){return p[0];})[0]||'sl'; if(hidden) hidden.value=init; if(label) label.textContent=init.toUpperCase(); }catch(e){}
  var open=false; function setOpen(s){ open = (typeof s!=='undefined')?s:(!open); if(menu) menu.style.display=open?"block":"none"; }
  if(wrap) wrap.addEventListener("click",function(e){ if(!e.target.closest(".lang-menu")){ e.stopPropagation(); setOpen(); }});
  document.addEventListener("click",function(e){ if(wrap && !wrap.contains(e.target)) setOpen(false); });
  if(menu) menu.addEventListener("click",function(e){
    var b=e.target.closest && e.target.closest("button[data-val]"); if(!b) return;
    if(hidden) hidden.value=b.getAttribute('data-val'); if(label) label.textContent=b.textContent;
    try{ localStorage.setItem("lang", b.getAttribute('data-val')); }catch(err){}
    if(hidden) hidden.dispatchEvent(new Event("change",{bubbles:true})); setOpen(false);
  });
})();

/* ===== Toast hash ===== */
(function(){
  if(location.hash==="#success"){ window._toast("✅ Uspešno – potrdilo poslano na e-pošto.", true); history.replaceState(null,"",location.pathname+location.search); }
  if(location.hash==="#cancel"){ window._toast("Plačilo preklicano. ❌", false); history.replaceState(null,"",location.pathname+location.search); }
})();

/* ===== Paneli ===== */
function scrollToEl(node){ var y=node.getBoundingClientRect().top + window.pageYOffset - (headerH()+12); window.scrollTo({top:y, behavior:"smooth"}); }
function hideAllPanels(){
  ["mapPanel","orgPanel","providerTermsPanel","orgHub","premiumPanel","benefitsOrg","plansPanel"].forEach(function(pid){
    var n=document.getElementById(pid); if(n){ n.classList.remove("show"); n.style.display="none"; }
  });
  var bu=$("#benefitsUser"), bo=$("#benefitsOrg"); if(bu) bu.style.display="block"; if(bo) bo.style.display="none";
}
function showPanel(id){
  hideAllPanels();
  if(id==="orgHub" || id==="orgPanel"){ var bu=$("#benefitsUser"), bo=$("#benefitsOrg"); if(bu) bu.style.display="none"; if(bo) bo.style.display="block"; }
  var e=document.getElementById(id); if(!e) return; e.classList.add("show"); e.style.display="block"; scrollToEl(e);
}

/* Vezava gumbov – brez optional chaining */
(function bindStaticButtons(){
  var b;
  b=$("#btnStart"); if(b) b.addEventListener("click",function(){ var sp=$("#searchPanel"); if(sp) scrollToEl(sp); });
  b=$("#btnProvidersTop"); if(b) b.addEventListener("click",function(e){ e.preventDefault(); showPanel('orgHub'); });
  b=$("#hubPublish"); if(b) b.addEventListener("click",function(){ showPanel('orgPanel'); });
  b=$("#btnPremiumTop"); if(b) b.addEventListener("click",function(e){ e.preventDefault(); showPanel('premiumPanel'); });
  b=$("#btnClosePremium"); if(b) b.addEventListener("click",function(){ var h=$("#hero"); if(h) scrollToEl(h); });
  b=$("#btnCloseMap"); if(b) b.addEventListener("click",function(){ var sp=$("#searchPanel"); if(sp) scrollToEl(sp); });
  b=$("#showProviderTerms"); if(b) b.addEventListener("click",function(e){ e.preventDefault(); showPanel('providerTermsPanel'); });
  b=$("#closeProviderTerms"); if(b) b.addEventListener("click",function(e){ e.preventDefault(); showPanel('orgPanel'); });
  b=$("#hubPlans"); if(b) b.addEventListener("click",function(){ showPanel('plansPanel'); });
  b=$("#btnClosePlans"); if(b) b.addEventListener("click",function(){ showPanel('orgHub'); });
  b=$("#linkPlansInline"); if(b) b.addEventListener("click",function(e){ e.preventDefault(); showPanel('plansPanel'); });
  b=$("#featPlansLink"); if(b) b.addEventListener("click",function(e){ e.preventDefault(); showPanel('plansPanel'); });

  var sp=$("#searchPanel"); if(sp) sp.addEventListener("click",function(){ hideAllPanels(); });
})();

/* Lokacijski gumbi */
function setLocButtonsActive(which){
  var a=$("#btnPickOnMap"), b=$("#btnUseLocation");
  if(a) a.classList.toggle("active", which==='pick');
  if(b) b.classList.toggle("active", which==='gps');
}

/* Drsniki */
var radius=$("#radius"), radiusLbl=$("#radiusLbl"),
    radiusCity=$("#radiusCity"), radiusCityLbl=$("#radiusCityLbl"),
    cityInput=$("#city");
if(radius) radius.addEventListener('input',function(){ if(radiusLbl) radiusLbl.textContent=String(radius.value)+' km'; });
if(radiusCity) radiusCity.addEventListener('input',function(){ if(radiusCityLbl) radiusCityLbl.textContent=String(radiusCity.value)+' km'; });

/* Geolokacija */
var btnUseLoc=$("#btnUseLocation");
if(btnUseLoc) btnUseLoc.addEventListener("click", function(){
  try{
    navigator.geolocation.getCurrentPosition(function(pos){
      GEO = { lat: pos.coords.latitude, lon: pos.coords.longitude };
      var t=btnUseLoc.querySelector('.txt'); if(t) t.textContent="Uporabljam tvojo lokacijo ✓";
      var w=$("#cityRadiusWrap"); if(w) w.style.display='none';
      if(radiusLbl && radius) radiusLbl.textContent = String(radius.value)+' km';
      setLocButtonsActive('gps');
      doSearch(0);
    }, function(){ window._toast("Lokacije ni bilo mogoče pridobiti.", false); }, {enableHighAccuracy:true,timeout:15000});
  }catch(e){}
});

/* ======= Map picker ======= */
var btnPick=$("#btnPickOnMap"); if(btnPick) btnPick.addEventListener("click", function(){ var m=$("#pickModal"); if(m) m.style.display="flex"; setTimeout(initPickMap,50); setLocButtonsActive('pick'); });
var pickClose=$("#pickClose"); if(pickClose) pickClose.addEventListener("click", function(){ var m=$("#pickModal"); if(m) m.style.display="none"; });
var pickUseGPS=$("#pickUseGPS"); if(pickUseGPS) pickUseGPS.addEventListener("click", function(){
  try{ navigator.geolocation.getCurrentPosition(function(pos){
    var p=[pos.coords.latitude, pos.coords.longitude];
    if (!pickMap) return;
    pickMap.setView(p, 12);
    if (pickMarker) pickMarker.setLatLng(p); else pickMarker=L.marker(p,{draggable:true}).addTo(pickMap);
    refreshPickOverlay();
  }, function(){}); }catch(e){}
});
var pickMinus=$("#pickMinus"); if(pickMinus) pickMinus.addEventListener("click", function(){ pickRadius = clamp(pickRadius-5, 5, 400); pickRadiusM=pickRadius*1000; var l=$("#pickRadiusLbl"); if(l) l.textContent='Polmer: '+pickRadius+' km'; refreshPickOverlay(); });
var pickPlus=$("#pickPlus"); if(pickPlus) pickPlus.addEventListener("click", function(){ pickRadius = clamp(pickRadius+5, 5, 400); pickRadiusM=pickRadius*1000; var l=$("#pickRadiusLbl"); if(l) l.textContent='Polmer: '+pickRadius+' km'; refreshPickOverlay(); });
var pickApply=$("#pickApply"); if(pickApply) pickApply.addEventListener("click", function(){
  if(!pickMarker){ window._toast("Klikni na zemljevid, da označiš točko.", false); return; }
  var ll = pickMarker.getLatLng();
  GEO = { lat: ll.lat, lon: ll.lng };
  if(cityInput) cityInput.value = ll.lat.toFixed(4)+", "+ll.lng.toFixed(4);
  if(radiusCity){ radiusCity.value = Math.round(pickRadius); if(radiusCityLbl) radiusCityLbl.textContent=String(pickRadius)+' km'; }
  var m=$("#pickModal"); if(m) m.style.display="none";
  doSearch(0);
});
function initPickMap(){
  if (pickMap) return;
  pickMap = L.map('pickMap').setView([46.0569,14.5058], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap' }).addTo(pickMap);
  pickMap.on('click', function(e){
    if(pickMarker) pickMarker.setLatLng(e.latlng);
    else pickMarker = L.marker(e.latlng,{draggable:true}).addTo(pickMap);
    refreshPickOverlay();
  });
  var l=$("#pickRadiusLbl"); if(l) l.textContent='Polmer: '+pickRadius+' km';
  refreshPickOverlay();
}
function refreshPickOverlay(){
  if(!pickMap) return;
  var center = pickMarker ? pickMarker.getLatLng() : pickMap.getCenter();
  if (pickCircle) pickCircle.remove();
  pickCircle = L.circle(center, { radius: pickRadiusM, color:'#0bbbd6', fillOpacity:0.06 }).addTo(pickMap);
  if (pickEdgeMarker) pickEdgeMarker.remove();
  var east = L.latLng(center.lat, center.lng + 0.3);
  pickEdgeMarker = L.marker(east, { draggable:true, icon: L.divIcon({ className:'radius-handle' }) }).addTo(pickMap);
  if(pickMarker && pickMarker.on) pickMarker.on('drag', function(e){ pickCircle.setLatLng(e.target.getLatLng()); var c=e.target.getLatLng(); var east=L.latLng(c.lat, c.lng+0.3); pickEdgeMarker.setLatLng(east); });
  pickEdgeMarker.on('drag', function(e){
    var r = pickMap.distance(pickCircle.getLatLng(), e.target.getLatLng());
    pickRadiusM = clamp(r, 1000, 400000);
    pickRadius = Math.round(pickRadiusM/1000);
    pickCircle.setRadius(pickRadiusM);
    var l=$("#pickRadiusLbl"); if(l) l.textContent='Polmer: '+pickRadius+' km';
  });
}

/* Hitri datumi */
(function quickDates(){
  var btns = $all('.quickDate'); if(!btns.length) return;
  var from = $('#dateFrom'), to = $('#dateTo');
  function fmt(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0'); }
  function setRange(mode){
    var now=new Date(); var a=new Date(now), b=new Date(now);
    if (mode==='today'){ a.setHours(0,0,0,0); b.setHours(23,59,59,999); }
    else if (mode==='weekend'){
      var day=now.getDay(); var sat=new Date(now); sat.setDate(now.getDate() + ((6 - (day||7)) % 7));
      var sun=new Date(sat); sun.setDate(sat.getDate()+1);
      a=new Date(sat.getFullYear(), sat.getMonth(), sat.getDate()); b=new Date(sun.getFullYear(), sun.getMonth(), sun.getDate(), 23,59,59,999);
    } else if (!isNaN(Number(mode))) { a=new Date(); b=new Date(); b.setDate(b.getDate()+Number(mode)); }
    if(from) from.value=fmt(a); if(to) to.value=fmt(b);
  }
  btns.forEach(function(b){
    b.addEventListener('click', function(){
      btns.forEach(function(x){ x.classList.remove('active'); });
      b.classList.add('active');
      setRange(b.getAttribute('data-mode')||'today');
      doSearch(0);
    });
  });
})();

/* Kategorije (za iskalnik) */
var CATS_EVENTS = ["Vse","Koncerti","Hrana & pijača","Družina/otroci","Šport","Kultura","Sejmi","Ostalo"];
var CATS_SERVS  = ["Vse","Lepota","Zdravje","Wellness","Šport & fit","Učenje","Servis","Ostalo"];
function renderCats(){
  var elc = $("#cats"); if (!elc) return; elc.innerHTML='';
  var list = (ACTIVE_MODE==='events'?CATS_EVENTS:CATS_SERVS);
  list.forEach(function(name, idx){
    var b = el('button','chip'); b.textContent=name; if(idx===0) b.classList.add('active');
    b.addEventListener('click', function(){ $all('#cats .chip').forEach(function(c){c.classList.remove('active');}); b.classList.add('active'); doSearch(0); });
    elc.appendChild(b);
  });
}
$all('.mode').forEach(function(btn){
  btn.addEventListener('click', function(){
    $all('.mode').forEach(function(x){x.classList.remove('active');}); btn.classList.add('active');
    ACTIVE_MODE = btn.getAttribute('data-mode');
    var noun = ACTIVE_MODE==='services' ? 'storitve' : 'dogodke';
    var n1=$("#heroNoun"), n2=$("#heroNoun2"); if(n1) n1.textContent = noun+" blizu"; if(n2) n2.textContent = noun;
    var ft=$("#featTitle"); if(ft) ft.textContent = ACTIVE_MODE==='services' ? "Izpostavljene storitve v tvoji bližini" : "Izpostavljeno v tvoji bližini";
    renderCats(); showPanel('searchPanel'); doSearch(0); loadFeatured();
  });
});
renderCats();

/* ==== Normalizacija (lokalni + zunanji) ==== */
function normalizeVenue(v){
  if(!v || typeof v!=='object'){ v={}; }
  var lat = firstDefined(v.lat, v.latitude, (v.latlng?v.latlng.lat:undefined), (v.geo?v.geo.lat:undefined), (v.coords?v.coords.lat:undefined), v.y);
  var lon = firstDefined(v.lon, v.lng, v.longitude, (v.latlng?v.latlng.lng:undefined), (v.geo?v.geo.lon:undefined), (v.coords?v.coords.lon:undefined), v.x);
  return { address: firstDefined(v.address, v.place, v.addr, v.street, ''), lat: (lat!=null?+lat:null), lon: (lon!=null?+lon:null) };
}
function normalizeLocal(x){
  var venue = normalizeVenue(x.venue||x.location||{ lat:x.lat, lon:(firstDefined(x.lon,x.lng)), address:firstDefined(x.address,x.addr,x.place) });
  return {
    id: x.id || x._id || hashId(x),
    title: x.title || x.name || x.eventName || '',
    name:  x.name  || x.title || '',
    start: firstDefined(x.start,x.startsAt,x.start_time,x.date,''),
    end:   firstDefined(x.end,x.until,x.end_time,x.finish,''),
    venue: venue,
    images: x.images || (x.image?[x.image]:[]),
    url: x.url || '',
    offerType: firstDefined(x.offerType,x.saleType,(x.type==='coupon'?'coupon':(Number(x.price||0)>0?'ticket':'none'))),
    price: Number(x.price||0) || null,
    type: x.type || x.entryType || 'event',
    description: x.description || x.desc || '',
    ticketPrices: x.ticketPrices || x.prices || [],
    couponKind: x.couponKind, couponPercentOff: x.couponPercentOff, couponValueEur:x.couponValueEur, couponFreebieLabel:x.couponFreebieLabel,
    featured: !!x.featured
  };
}
function normalizeExt(x){
  var venue = normalizeVenue(x.venue||x);
  return {
    id: x.id || hashId(x),
    title: x.title || x.name || '',
    name: x.name || x.title || '',
    start: firstDefined(x.start,x.date,x.datetime,''),
    end: firstDefined(x.end,x.until,''),
    venue: venue,
    images: x.images || (x.image?[x.image]:[]),
    url: x.url || '',
    offerType: x.offerType || (Number(x.price||0)>0?'ticket':'none'),
    price: Number(x.price||0) || null,
    type: 'event',
    description: x.description || x.desc || ''
  };
}
function isFuture(e){ var end=getEndTs(e); return Number.isFinite(end)? end>=Date.now() : true; }
function mergeNoDup(a,b){
  var seen=new Set(), out=[];
  function key(e){ return ((e.title||e.name||'').toLowerCase().trim()+'::'+String(e.start||'').slice(0,10)); }
  [].concat(a||[],b||[]).forEach(function(e){ var k=key(e); if(seen.has(k)) return; seen.add(k); out.push(e); });
  return out;
}

/* ---- Kartice ---- */
function offerChipText(e){
  if ((e.offerType||e.type)==='coupon'){
    if (IS_PREMIUM) return "Kupon: 0 € (Premium)";
    if (e.couponKind==='PERCENT' && Number(e.couponPercentOff)) return "Kupon: -"+e.couponPercentOff+"%";
    if (e.couponKind==='VALUE'   && Number(e.couponValueEur))   return "Kupon: "+euro(e.couponValueEur);
    if (e.couponKind==='FREEBIE' && e.couponFreebieLabel)       return "Kupon: "+e.couponFreebieLabel;
    return 'Kupon';
  }
  if ((e.offerType||e.type)==='ticket'){
    return Number(e.price||0)>0 ? ("Vstopnica: "+euro(e.price)) : 'Vstopnica';
  }
  return '';
}
function calendarButtonHTML(id){
  return '<button class="btn mini link" data-ical="'+id+'">Dodaj v koledar</button>';
}
function cardActionBar(e){
  var id = hashId(e);
  var chip = offerChipText(e);
  var where=(e.venue&&e.venue.address)||'';
  var btns = [
    calendarButtonHTML(id),
    '<button class="btn mini link" data-share="'+id+'">Povabi še nekoga</button>',
    (where && e.venue && e.venue.lat && e.venue.lon) ? '<button class="btn mini link" data-map="'+id+'">Zemljevid</button>' : ''
  ].filter(function(x){return !!x;}).join(' ');
  return '<div class="buy">'+(chip?('<span class="value-chip">'+chip+'</span>'):'')+btns+'</div>';
}
function renderCard(e){
  var id = hashId(e); ITEMS_BY_ID.set(id, e);
  var img  = (e.images && e.images[0]) || 'https://picsum.photos/800/400?blur=2';
  var title= e.title || e.name || '';
  var where=(e.venue&&e.venue.address)||'';
  var when = formatDateRange(e.start, e.end);
  var more = (e.description||'').trim();
  var buyRows = '';

  if (isExternalAPI(e)){
    buyRows += '<div class="buy"><span class="value-chip">'+(offerChipText(e)||'Več informacij')+'</span>'+
               '<a class="btn mini" href="'+(e.url||'#')+'" target="_blank" rel="noopener">Kupi vstopnico</a>'+
               '<a class="btn mini link" href="'+(e.url||'#')+'" target="_blank" rel="noopener">Več</a></div>';
  } else if ((e.offerType||e.type)==='ticket'){
    var tps = (Array.isArray(e.ticketPrices) && e.ticketPrices.length) ? e.ticketPrices : ((Number(e.price||0)>0) ? [{label:'Osnovna', price:+e.price}] : []);
    tps.forEach(function(tp){
      buyRows += '<div class="buy"><span class="value-chip">'+euro(tp.price||0)+'</span> <button class="btn mini" data-buy="'+id+'" data-price="'+tp.price+'" data-label="'+(tp.label||'Vstopnica')+'">Kupi vstopnico — '+(tp.label||'Vstopnica')+'</button></div>';
    });
  } else if ((e.offerType||e.type)==='coupon'){
    buyRows += '<div class="buy"><span class="value-chip">'+offerChipText(e)+'</span> <button class="btn mini" data-buy="'+id+'" data-kind="coupon">Kupi kupon</button></div>';
  }

  var wrap = el('div','spot'); wrap.id='card-'+id;
  wrap.innerHTML =
    '<img src="'+img+'" alt="">'+
    '<div class="meta">'+
      '<div style="font-weight:900">'+title+'</div>'+
      '<div class="muted" style="margin-top:4px">'+(where?('<a href="https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(where)+'" target="_blank" rel="noopener">📍 '+where+'</a>'):'')+'</div>'+
      '<div class="muted" style="margin-top:4px">'+when+'</div>'+
      '<div class="buy" style="margin-top:8px"><button class="btn mini link" data-more="'+id+'">Več ▾</button> <button class="btn mini link" data-less="'+id+'" style="display:none">Skrij ▴</button></div>'+
      (more ? ('<div class="more-text" id="more-'+id+'" style="display:none;margin-top:6px">'+more+(isExternalAPI(e)?(' <a href="'+e.url+'" target="_blank" rel="noopener">[odpri vir]</a>'):'')+'</div>') : '')+
      cardActionBar(e)+
      buyRows+
    '</div>';
  return wrap;
}

/* ==== IZPOSTAVLJENO ==== */
async function loadFeatured(){
  try{
    var car = $("#carousel"); if(!car) return; car.innerHTML='';
    var latlon = GEO ? (GEO.lat+","+GEO.lon) : '';
    var r1=null; try{ r1 = await fetch('/.netlify/functions/provider-list?featured=1'+(latlon?('&latlon='+encodeURIComponent(latlon)+'&radiuskm=120'):'')+'&limit=100').then(function(r){return r.json();}); }catch(e){}
    var items = (r1 && r1.results) ? r1.results.map(normalizeLocal).filter(isFuture) : [];

    if ((!items || items.length < 10) && ACTIVE_MODE==='events'){
      var ex=null; try{ ex=await fetch('/api/search?limit=40'+(latlon?('&lat='+GEO.lat+'&lon='+GEO.lon+'&radius=120'):'')).then(function(r){return r.json();}); }catch(e){}
      var ext = (ex && ex.results) ? ex.results.map(normalizeExt).filter(isFuture) : [];
      items = mergeNoDup(items||[], ext);
    }
    if (ACTIVE_MODE==='services' && (!items || items.length<10)){
      var near=null; try{ near=await fetch('/.netlify/functions/provider-list?type=service'+(latlon?('&latlon='+encodeURIComponent(latlon)+'&radiuskm=120'):'')+'&limit=40').then(function(r){return r.json();}); }catch(e){}
      var svc = (near && near.results) ? near.results.map(normalizeLocal).filter(function(e){return e.type==='service';}) : [];
      items = mergeNoDup(items||[], svc);
    }

    items = (items||[]).slice(0,12);
    items.forEach(function(e){ car.appendChild(renderCard(e)); });

    var rafId=0;
    function loop(){
      var step = 2;
      if ((car.scrollLeft + car.clientWidth + step) >= car.scrollWidth){
        car.scrollTo({left:0, behavior:'auto'});
      } else {
        car.scrollBy({left:step, behavior:'auto'});
      }
      rafId = requestAnimationFrame(loop);
    }
    cancelAnimationFrame(rafId); rafId = requestAnimationFrame(loop);
    car.addEventListener('mouseenter', function(){ cancelAnimationFrame(rafId); });
    car.addEventListener('mouseleave', function(){ cancelAnimationFrame(rafId); rafId=requestAnimationFrame(loop); });

    car.addEventListener('click', commonCardClicks);
  }catch(err){}
}

/* ==== ISKANJE ==== */
var btnClear=$("#btnClear");
if(btnClear) btnClear.addEventListener('click', function(){
  ['q','city','dateFrom','dateTo'].forEach(function(id){ var n=document.getElementById(id); if(n) n.value=''; });
  var fo=$('#freeOnly'); if(fo) fo.checked=false;
  var crw=$('#cityRadiusWrap'); if(crw) crw.style.display='none';
  if (pickCircle){ try{ pickCircle.remove(); }catch(e){}; pickCircle=null; }
  $all('#cats .chip').forEach(function(c,i){ c.classList.toggle('active', i===0); });
  $all('.quickDate').forEach(function(b){ b.classList.remove('active'); });
  if (mapSearch){
    markersSearch.forEach(function(m){ m.remove(); }); markersSearch=[];
    var w=$("#mapSearchWrap"); if(w) w.style.display='none';
    var bt=$("#btnToggleResultsMap"); if(bt) bt.textContent='Pokaži zemljevid rezultatov';
  }
  GEO=null;
  if(radius){ radius.value=30; if(radiusLbl) radiusLbl.textContent='30 km'; }
  doSearch(0);
});

async function doSearch(page){
  try{
    currentPage = page||0;
    var qel=$('#q'), fo=$('#freeOnly'), catEl=$('#cats .chip.active'), df=$('#dateFrom'), dt=$('#dateTo');
    var q = qel && qel.value ? qel.value.trim().toLowerCase() : '';
    var freeOnly = !!(fo && fo.checked);
    var cat = catEl ? catEl.textContent : 'Vse';
    var dfv = (df && df.value) ? df.value : ''; var dtv = (dt && dt.value) ? dt.value : '';

    var center = GEO ? { lat:GEO.lat, lon:GEO.lon, r: (radius ? +radius.value : 30) } : null;
    var ci=$('#city'), rci=$('#radiusCity');
    if (ci && ci.value.trim()){
      var m = ci.value.trim().match(/^(-?\d+(\.\d+)?),\s*(-?\d+(\.\d+)?)/);
      var rr = rci ? (+rci.value||30) : 30;
      if (m) center = { lat:+m[1], lon:+m[3], r: rr };
      var wrap=$('#cityRadiusWrap'); if(wrap) wrap.style.display='block';
    }
    if (pickCircle){
      var c = pickCircle.getLatLng(); center = { lat:c.lat, lon:c.lng, r: Math.round((pickCircle.getRadius()||pickRadiusM)/1000) };
    }

    var p = new URLSearchParams(); if(center){ p.set('latlon', center.lat+','+center.lon); p.set('radiuskm', String(center.r)); }
    if (ACTIVE_MODE==='services') p.set('type','service');
    var local=null; try{ local=await fetch('/.netlify/functions/provider-list?'+p.toString()).then(function(r){return r.json();}); }catch(e){}
    var items = (local && local.results) ? local.results.map(normalizeLocal).filter(isFuture) : [];

    items = items.filter(function(e){
      var txt = ((e.title||e.name||'')+' '+(e.description||'')+' '+(e.category||'')).toLowerCase();
      var okQ = q ? (txt.indexOf(q)>-1) : true;
      var okC = (cat==='Vse') ? true : (txt.indexOf(cat.toLowerCase())>-1);
      var okF = !freeOnly || Number(e.price||0)===0 || (e.offerType==='coupon');
      var tsS = dfv ? (parseDateAny(e.start) >= parseDateAny(dfv)) : true;
      var tsE = dtv ? ((parseDateAny(firstDefined(e.end,e.start)) <= (parseDateAny(dtv)+24*3600*1000-1))) : true;
      var okMode = (ACTIVE_MODE==='events' ? (e.type!=='service') : (e.type==='service' || e.entryType==='service'));
      return okQ && okC && okF && tsS && tsE && okMode;
    });

    if (ACTIVE_MODE==='events' && (!items || items.length < 10)){
      var p2 = new URLSearchParams(); if(center){ p2.set('lat', center.lat); p2.set('lon', center.lon); p2.set('radius', center.r); } if(q) p2.set('q', q);
      var ex=null; try{ ex=await fetch('/api/search?limit=60&'+p2.toString()).then(function(r){return r.json();}); }catch(e){}
      var ext = (ex && ex.results) ? ex.results.map(normalizeExt).filter(isFuture) : [];
      items = mergeNoDup(items||[], ext);
    }

    lastResults = items.slice();
    renderResultsPage(0);
  }catch(err){ window._toast('Iskanje ni uspelo.', false); }
}

/* Zemljevid rezultatov toggle */
var btnResMap=$("#btnToggleResultsMap");
if(btnResMap) btnResMap.addEventListener("click",function(){
  var w=$("#mapSearchWrap"); if(!w) return;
  var show = (w.style.display==='none' || !w.style.display);
  w.style.display = show ? 'block' : 'none';
  btnResMap.textContent = show ? "Skrij zemljevid rezultatov" : "Pokaži zemljevid rezultatov";
  if (show && !mapSearch){
    mapSearch = L.map('mapSearch').setView([46.0569,14.5058], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap' }).addTo(mapSearch);
    setTimeout(fitSearchMarkers, 200);
  } else if (show){ setTimeout(fitSearchMarkers, 200); }
});

function renderResultsPage(page){
  currentPage = page||0;
  var list = $("#results"); if(!list) return; list.innerHTML='';
  var start = currentPage * PAGE_SIZE;
  var slice = lastResults.slice(start, start+PAGE_SIZE);

  if (!slice.length){
    list.innerHTML = '<div class="muted">Ni rezultatov.</div>';
    markersSearch.forEach(function(m){ m.remove(); }); markersSearch=[];
    renderPager(); return;
  }

  markersSearch.forEach(function(m){ m.remove(); }); markersSearch=[];
  slice.forEach(function(e){
    list.appendChild(renderCard(e));
    if (mapSearch && e.venue && e.venue.lat && e.venue.lon){
      var id = hashId(e);
      var extLink = isExternalAPI(e) && e.url ? '<br><a href="'+e.url+'" target="_blank" rel="noopener">Odpri dogodek (vir)</a>' : '';
      var m = L.marker([e.venue.lat, e.venue.lon]).addTo(mapSearch)
        .bindPopup('<b>'+(e.title||e.name)+'</b><br>'+((e.venue&&e.venue.address)||'')+'<br>'+formatDateRange(e.start,e.end)+'<br><a href="#card-'+id+'" data-scroll-id="'+id+'">Prikaži kartico</a>'+extLink);
      markersSearch.push(m);
    }
  });

  list.addEventListener('click', commonCardClicks);
  if (mapSearch){
    mapSearch.off('popupopen');
    mapSearch.on('popupopen', function(e){
      var node = e && e.popup ? e.popup._contentNode : null;
      var a = node ? node.querySelector('[data-scroll-id]') : null;
      if (a){ a.addEventListener('click',function(ev){
        ev.preventDefault();
        var id=a.getAttribute('data-scroll-id'); var elc=document.getElementById('card-'+id);
        if(elc){ elc.scrollIntoView({behavior:'smooth',block:'center'}); elc.style.boxShadow='0 0 0 3px rgba(11,187,214,.4) inset'; setTimeout(function(){elc.style.boxShadow='';},1200); }
      }); }
    });
  }

  renderPager(); fitSearchMarkers();
}
function renderPager(){
  var host=$("#pagination"); if(!host) return; host.innerHTML='';
  if (!lastResults.length) return;
  var pages = Math.ceil(lastResults.length / PAGE_SIZE);
  var prev = el('button','btn mini link'); prev.textContent='⟵ Nazaj'; prev.disabled = currentPage<=0;
  prev.addEventListener('click', function(){ renderResultsPage(Math.max(currentPage-1,0)); });
  var next = el('button','btn mini link'); next.textContent='Naprej ⟶'; next.disabled = currentPage>=pages-1;
  next.addEventListener('click', function(){ renderResultsPage(Math.min(currentPage+1,pages-1)); });
  var info = el('div','muted'); info.style.alignSelf='center'; info.textContent = (currentPage+1)+' / '+pages+' • '+lastResults.length+' rezultatov';
  host.appendChild(prev); host.appendChild(info); host.appendChild(next);
}
function fitSearchMarkers(){
  if (!mapSearch || !markersSearch.length) return;
  var g = new L.featureGroup(markersSearch);
  try{ mapSearch.fitBounds(g.getBounds().pad(0.25)); }catch(e){}
}
function showMapFor(e){
  showPanel('mapPanel');
  setTimeout(function(){
    if (!topMap){
      topMap = L.map('map').setView([46.0569,14.5058], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap' }).addTo(topMap);
    }
    topMarkers.forEach(function(m){ m.remove(); }); topMarkers=[];
    if (e && e.venue && e.venue.lat && e.venue.lon){
      var m = L.marker([e.venue.lat, e.venue.lon]).addTo(topMap)
        .bindPopup('<b>'+(e.title||e.name)+'</b><br>'+((e.venue&&e.venue.address)||'')+'<br>'+formatDateRange(e.start,e.end));
      topMarkers.push(m);
      topMap.setView([e.venue.lat, e.venue.lon], 13);
      try{ m.openPopup(); }catch(err){}
    }
  },50);
}

/* SKUPNI handler za klike po karticah */
function commonCardClicks(ev){
  var t=ev.target;

  var more = t.closest ? t.closest('[data-more]') : null;
  if (more){ var id=more.getAttribute('data-more'); var box=document.getElementById('more-'+id); var less=document.querySelector('[data-less="'+id+'"]'); if(box){ box.style.display='block'; more.style.display='none'; if(less) less.style.display='inline-block'; } return; }

  var less = t.closest ? t.closest('[data-less]') : null;
  if (less){ var id2=less.getAttribute('data-less'); var box2=document.getElementById('more-'+id2); var more2=document.querySelector('[data-more="'+id2+'"]'); if(box2){ box2.style.display='none'; less.style.display='none'; if(more2) more2.style.display='inline-block'; } return; }

  var share = t.closest ? t.closest('[data-share]') : null;
  if (share){ var e=ITEMS_BY_ID.get(share.getAttribute('data-share')); if(e){ var text=(e.title||e.name||'')+' — '+formatDateRange(e.start,e.end); var url=location.origin+'/#card-'+hashId(e); if(navigator.share){ navigator.share({title:'NearGo',text:text,url:url}).catch(function(){}); } else { var mail='mailto:?subject='+encodeURIComponent('Poglej: '+(e.title||e.name||''))+'&body='+encodeURIComponent(text+'\n\n'+url); location.href=mail; } } return; }

  var ics = t.closest ? t.closest('[data-ical]') : null;
  if (ics){ var e2=ITEMS_BY_ID.get(ics.getAttribute('data-ical')); if(e2) addToCalendar(e2); return; }

  var mapb= t.closest ? t.closest('[data-map]') : null;
  if (mapb){ var ee=ITEMS_BY_ID.get(mapb.getAttribute('data-map')); if(ee) showMapFor(ee); return; }

  var buy = t.closest ? t.closest('[data-buy]') : null;
  if (buy){ handleBuy(buy.getAttribute('data-buy'), buy.getAttribute('data-price'), buy.getAttribute('data-label'), buy.getAttribute('data-kind')); return; }
}

/* NAKUP (Stripe/IAP) */
async function tryEndpoints(primaryUrl, primaryInit){
  var urls=[].slice.call(arguments); urls=urls.slice(0); // all args
  var init = primaryInit;
  var list=[urls[0]];
  if(urls.length>2){ list=list.concat(urls.slice(2)); }
  for (var i=0;i<list.length;i++){
    var u=list[i];
    try{
      var r = await fetch(u, init); var j=null; try{ j=await r.json(); }catch(e){}
      if(j && (j.url || j.ok)) return j;
    }catch(e){}
  }
  return null;
}
function isLikelyNativeApp(){
  // heuristika: webview/Capacitor/standalone
  var ua = navigator.userAgent||'';
  var standalone = window.matchMedia && window.matchMedia('(display-mode: standalone)').matches;
  var iosStandalone = (window.navigator && window.navigator.standalone) ? true : false;
  var webview = (ua.indexOf('wv)')>-1 || ua.indexOf('; wv')>-1 || ua.indexOf('Crosswalk')>-1);
  var cap = (window.Capacitor || ua.indexOf('NearGoApp')>-1);
  return (!!cap) || standalone || iosStandalone || webview;
}
async function handleBuy(id, price, label, kind){
  var e = ITEMS_BY_ID.get(id); if (!e) return;

  if (isExternalAPI(e) && e.url){ window.open(e.url,'_blank','noopener'); return; }

  var isCoupon = (kind==='coupon') || ((e.offerType||e.type)==='coupon');
  var metadata = {
    type: isCoupon ? 'coupon' : 'ticket',
    event_id: e.id || '',
    event_title: e.title || e.name || '',
    event_start_iso: e.start || '',
    event_venue: (e.venue&&e.venue.address)||'',
    image_url: (e.images && e.images[0]) || '',
    source: 'neargo'
  };

  try{
    // Premium kupon – brezplačno
    if (isCoupon && IS_PREMIUM){
      var rFree = await tryEndpoints('/api/issue-coupon', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ metadata:metadata, free:true }) }, '/.netlify/functions/issue-coupon');
      if (rFree && rFree.ok){ window._toast('Kupon izdan (Premium). Preveri e‑pošto.', true); return; }
      window._toast('Premium kupon je brezplačen – pošiljanje bo omogočil backend.', true); return;
    }

    if (isCoupon){
      var body = { type:'coupon', metadata:metadata };
      var r = await tryEndpoints('/api/checkout', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body) }, '/.netlify/functions/checkout','/.netlify/functions/stripe-checkout');
      if (r && r.url) location.href = r.url; else window._toast('Plačilo (kupon) ni pripravljeno.', false);
    } else {
      var amount = price ? Number(price) : Number(e.price||0);
      var lineItems = amount>0 ? [{ name: (label||'Vstopnica'), amount: amount, quantity: 1, currency:'eur' }] : [];
      var r2 = await tryEndpoints('/api/checkout', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ lineItems:lineItems, metadata:metadata }) }, '/.netlify/functions/checkout','/.netlify/functions/stripe-checkout');
      if (r2 && r2.url) location.href = r2.url; else window._toast('Plačilo (vstopnica) ni pripravljeno.', false);
    }
  }catch(err){ window._toast('Napaka pri pripravi plačila.', false); }
}

/* ======== ZA PONUDNIKE – kategorije ======== */
var FORM_CATS = {
  event: ["Koncerti","Hrana & pijača","Družina/otroci","Šport","Kultura","Sejmi","Ostalo"],
  service: ["Lepota","Zdravje","Wellness","Šport & fit","Učenje","Servis","Ostalo"]
};
function refreshCategories(){
  var sel=$('#category'); var entry=$('#entryType'); if(!sel||!entry) return;
  var list = FORM_CATS[ entry.value==='service' ? 'service' : 'event' ];
  sel.innerHTML = list.map(function(x){return '<option value="'+x+'">'+x+'</option>';}).join('');
}

/* ======== ZA PONUDNIKE – obrazec ======== */
(function formOrg(){
  var entry    = $('#entryType');
  var offerSel = $('#offerType');
  var stockInp = $('#stock');
  var desc     = $('#desc'); var descCnt = $('#descCount');

  if(desc) desc.addEventListener('input', function(){ if(descCnt) descCnt.textContent = String(desc.value.length)+' / 800'; });

  function syncServiceBlock(){
    var isService = entry && entry.value === 'service';
    var sb = $('#svcBlock'), sw = $('#startWrap'), ew = $('#endWrap'), orow=$('#offerRow');
    if (sb) sb.style.display = isService ? '' : 'none';
    if (sw) sw.style.display = isService ? 'none' : '';
    if (ew) ew.style.display = isService ? 'none' : '';
    if (orow) orow.style.display = isService ? 'none' : '';
    if (stockInp) { if (isService) stockInp.removeAttribute('required'); else stockInp.setAttribute('required','required'); }
    refreshCategories();
  }
  if(entry) entry.addEventListener('change', syncServiceBlock); syncServiceBlock();

  var pt=$('#svcPriceType');
  if(pt) pt.addEventListener('change', function(){ var r=$('#svcFixedRow'); if(r) r.style.display = (pt.value==='FIXED' ? '' : 'none'); });

  (function serviceAvailabilityUI(){
    var radios = $all('input[name="svcAvail"]');
    var callRow = $('#svcCallRow'), calRow = $('#svcCalendarRow'), phone = $('#svcPhone');
    function refresh(){
      var val='call'; for(var i=0;i<radios.length;i++){ if(radios[i].checked){ val=radios[i].value; break; } }
      var isCall = (val === 'call');
      if (callRow) callRow.style.display = isCall ? '' : 'none';
      if (calRow)  calRow.style.display  = !isCall ? '' : 'none';
      if (phone) { if (isCall) phone.required=true; else phone.required=false; }
    }
    radios.forEach(function(r){ r.addEventListener('change', refresh); });
    refresh();
  })();

  function syncEventCoupon(){
    var show = (entry && entry.value==='event' && offerSel && offerSel.value==='coupon');
    var b=$('#evtCouponBlock'); if (b) b.style.display = show ? '' : 'none';
  }
  if(offerSel) offerSel.addEventListener('change', syncEventCoupon);
  if(entry) entry.addEventListener('change', syncEventCoupon); syncEventCoupon();

  (function bindSvcCouponToggle(){
    var kind=$('#couponKind'), p=$('#couponPercent'), v=$('#couponValue'), f=$('#couponFreebie');
    var lP=$('#lblPercent'),  lV=$('#lblValue'),      lF=$('#lblFreebie');
    function toggle(){
      if(lP) lP.style.display='none'; if(lV) lV.style.display='none'; if(lF) lF.style.display='none';
      if(p) p.required=false; if(v) v.required=false; if(f) f.required=false;
      if (!kind) return;
      if (kind.value==='PERCENT'){ if(lP) lP.style.display='block'; if(p) p.required=true; }
      if (kind.value==='VALUE'){   if(lV) lV.style.display='block'; if(v) v.required=true; }
      if (kind.value==='FREEBIE'){ if(lF) lF.style.display='block'; if(f) f.required=true; }
    }
    if(kind) kind.addEventListener('change', toggle); toggle();
  })();

  (function bindEvtCouponToggle(){
    var kind=$('#evtCouponKind'), p=$('#evtCouponPercent'), v=$('#evtCouponValue'), f=$('#evtCouponFreebie');
    var lP=$('#evtLblPercent'),  lV=$('#evtLblValue'),      lF=$('#evtLblFreebie');
    function toggle(){
      if(lP) lP.style.display='none'; if(lV) lV.style.display='none'; if(lF) lF.style.display='none';
      if(p) p.required=false; if(v) v.required=false; if(f) f.required=false;
      if (!kind) return;
      if (kind.value==='PERCENT'){ if(lP) lP.style.display='block'; if(p) p.required=true; }
      if (kind.value==='VALUE'){   if(lV) lV.style.display='block'; if(v) v.required=true; }
      if (kind.value==='FREEBIE'){ if(lF) lF.style.display='block'; if(f) f.required=true; }
    }
    if(kind) kind.addEventListener('change', toggle); toggle();
  })();

  var addTp=$('#btnAddTicketPrice');
  if(addTp) addTp.addEventListener('click', function(){
    var host = $('#ticketStepList'); if(!host) return; var row = el('div','always-two');
    row.innerHTML = '<input class="tp-label" placeholder="Naziv (npr. Osnovna)">'+
                    '<div class="euro"><input class="tp-price" type="number" min="0" step="0.01" placeholder="Cena"><span>€</span></div>';
    host.appendChild(row);
  });
  function syncTicketBlock(){
    var isTicket = (offerSel && offerSel.value==='ticket');
    var isCoupon = (offerSel && offerSel.value==='coupon');
    var tb=$('#ticketPricesBlock'), pw=$('#priceWrap'), eb=$('#evtCouponBlock');
    if (tb) tb.style.display = isTicket ? '' : 'none';
    if (pw) pw.style.display = isTicket ? '' : 'none';
    if (eb) eb.style.display = isCoupon ? '' : 'none';
  }
  if(offerSel) offerSel.addEventListener('change', syncTicketBlock); syncTicketBlock();

  // Predogled slike
  (function imagePreview(){
    var inp=$('#image'), name=$('#fileName'), prev=$('#imgPreview');
    if(!inp) return;
    inp.addEventListener('change', function(){
      var f = inp.files && inp.files[0];
      if(name) name.textContent = f ? f.name : 'Fotografija ni izbrana';
      if (f){ if(prev){ prev.src = URL.createObjectURL(f); prev.style.display='block'; } }
      else { if(prev){ prev.removeAttribute('src'); prev.style.display='none'; } }
    });
  })();

  // Featured -> paket
  var featured=$('#featured');
  if(featured) featured.addEventListener('change', async function(){
    if (!featured.checked) return;
    try{
      var s = await fetch('/api/iap/status').then(function(r){return r.json();});
      PROVIDER_PLAN = (s && s.providerPlan) ? s.providerPlan : 'free';
    }catch(e){ PROVIDER_PLAN='free'; }
    if (PROVIDER_PLAN==='free'){
      var fm=$('#featMsg'); if(fm) fm.textContent='Za izpostavitev potrebuješ paket Grow/Pro.';
      var go = confirm('Za izpostavitve je potreben paket (Grow/Pro). Želiš nadgraditi?');
      if (go){ showPanel('plansPanel'); }
      featured.checked=false;
    }else{
      var fm2=$('#featMsg'); if(fm2) fm2.textContent='Izpostavljena objava bo aktivirana po potrditvi.';
    }
  });

  var btnSubmit=$('#btnSubmitEvent');
  if(btnSubmit) btnSubmit.addEventListener('click', submitProvider);

  async function submitProvider(){
    var agree=$('#agreeFees'); if(agree && !agree.checked){ window._toast('Potrdi pogoje za plačljive ponudbe.', false); return; }
    var payload = collectForm(); if (!payload) return;

    // upload slike (če je)
    var imagePublicUrl=null; var imgInp=$('#image'); var f = imgInp && imgInp.files ? imgInp.files[0] : null;
    if (f){
      var fd=new FormData(); fd.append('file', f);
      try{
        var up=await fetch('/api/provider-upload',{method:'POST',body:fd}).then(function(r){return r.json();});
        if (up && up.ok && up.publicUrl) imagePublicUrl=up.publicUrl;
      }catch(e){}
    }
    if (imagePublicUrl) payload.imagePublicUrl = imagePublicUrl;

    // Osnovna cena med ticketPrices (če je potrebno)
    if (payload.entryType==='event' && payload.offerType==='ticket' && Number(payload.price||0)>0){
      payload.ticketPrices = Array.isArray(payload.ticketPrices) ? payload.ticketPrices.slice() : [];
      var base = Number(payload.price||0);
      var has = payload.ticketPrices.some(function(tp){return Number(tp.price)===base;});
      if (!has) payload.ticketPrices.unshift({ label:'Osnovna', price: base });
    }

    try{
      var r = await fetch('/api/provider-submit', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload) });
      var j = null; try{ j=await r.json(); }catch(e){}
      if (r.ok && j && j.ok){
        window._toast('✅ Oddaja uspešna. Potrditev je na e-pošti.', true);
        var m=$('#orgMsg'); if(m){ m.textContent='Oddaja uspešna – potrditev je na e-pošti.'; setTimeout(function(){m.textContent='';},3500); }
      }else{
        window._toast('Napaka: '+((j&&j.error) || r.statusText), false);
      }
    }catch(e){ window._toast('Napaka pri pošiljanju.', false); }
  }

  function collectForm(){
    var entry=$('#entryType'), org=$('#orgName'), ofn=$('#orgFullName'), mail=$('#orgEmail'),
        name=$('#eventName'), venue=$('#venue'), country=$('#country'), city=$('#city2'), url=$('#url'), desc=$('#desc'), cat=$('#category');
    var type = entry ? entry.value : 'event';
    var orgV=org?org.value.trim():'', ofnV=ofn?ofn.value.trim():'', mailV=mail?mail.value.trim():'',
        nameV=name?name.value.trim():'', venV=venue?venue.value.trim():'', cntV=country?country.value:'', cityV=city?city.value.trim():'', urlV=url?url.value.trim():'', descV=desc?desc.value.trim():'';
    if (!orgV || !ofnV || !mailV || !nameV || !venV || !cntV || !cityV || !descV){ window._toast('Izpolni polja z *', false); return null; }

    var offerSel=$('#offerType'); var offerType = type==='event' ? (offerSel?offerSel.value:'none') : 'coupon';
    var feat=$('#featured'); var featured = !!(feat && feat.checked);

    var payload = {
      entryType: type, type:type, organizer:orgV, organizerFullName:ofnV, organizerEmail:mailV,
      eventName:nameV, venue:venV, country:cntV, city2:cityV, url:urlV, description:descV,
      offerType:offerType, saleType:offerType, featured:featured,
      category: (cat?cat.value:'')
    };

    if (type==='event'){
      var st=$('#start'), en=$('#end'); payload.start = st?st.value:''; payload.end = en?en.value:'';
      if (offerType==='ticket'){
        var base = Number((($('#price')||{}).value)||0); if (base>0) payload.price=base;
        var rows=$all('#ticketStepList .always-two');
        var tps=[]; rows.forEach(function(r){
          var lbl=r.querySelector('.tp-label'), pr=r.querySelector('.tp-price');
          var p=Number(pr && pr.value ? pr.value : 0); if (p>0) tps.push({label:(lbl && lbl.value?lbl.value:'Vstopnica'), price:p});
        });
        if (tps.length) payload.ticketPrices=tps;
        var stc=$('#stock'); payload.stock=stc?stc.value:'';
      }
      if (offerType==='coupon'){
        var k=$('#evtCouponKind'); payload.couponKind = k?k.value:'';
        if (payload.couponKind==='PERCENT') payload.couponPercentOff = Number((($('#evtCouponPercent')||{}).value)||0);
        if (payload.couponKind==='VALUE')   payload.couponValueEur   = Number((($('#evtCouponValue')||{}).value)||0);
        if (payload.couponKind==='FREEBIE') payload.couponFreebieLabel= (($('#evtCouponFreebie')||{}).value||'').trim();
        var stc2=$('#stock'); payload.stock=stc2?stc2.value:'';
      }
    } else {
      var radios = $all('input[name="svcAvail"]'); var val='call'; for(var i=0;i<radios.length;i++){ if(radios[i].checked){ val=radios[i].value; break; } }
      var service = { availability: (val==='calendar'?'scheduled':'unlimited') };
      var phone=$('#svcPhone'); if (val==='call' && phone) service.phone=phone.value.trim();

      var pt=$('#svcPriceType');
      if (pt && pt.value==='FIXED'){ var fp=$('#svcFixedPrice'); service.price = Number((fp && fp.value)?fp.value:0); }
      else if (pt && pt.value==='RATECARD'){ var ru=$('#svcRateUrl'); if(ru && ru.value.trim()) service.rateUrl = ru.value.trim(); }
      else if (pt && pt.value==='FREE'){ service.free = true; }

      if (!service.free){
        var kind=$('#couponKind'); var kindV = kind?kind.value:'';
        if (!kindV){ window._toast('Pri storitvi izberi tip kupona ali označi "Brezplačno".', false); return null; }
        payload.couponKind = kindV;
        if (kindV==='PERCENT') payload.couponPercentOff = Number((($('#couponPercent')||{}).value)||0);
        if (kindV==='VALUE')   payload.couponValueEur   = Number((($('#couponValue')||{}).value)||0);
        if (kindV==='FREEBIE') payload.couponFreebieLabel= (($('#couponFreebie')||{}).value||'').trim();
      }
      payload.service = service;
      var stc3=$('#stock'); if(stc3 && stc3.value!=='') payload.stock = stc3.value;
    }
    return payload;
  }
})();

/* BOOST & PREMIUM + PAKETI */
var hubBoost=$("#hubBoost"); if(hubBoost) hubBoost.addEventListener('click', async function(){
  try{ var r = await fetch('/api/iap/boost-start', { method:'POST' }).then(function(r){return r.json();}); if (r && r.url) location.href=r.url; else window._toast('Boost ni na voljo.', false); }catch(e){ window._toast('Boost ni na voljo.', false); }
});

/* Premium nakup: IAP (native) ali Stripe (desktop) + račun na e‑pošto */
var btnGoPremium=$("#btnGoPremium");
if(btnGoPremium) btnGoPremium.addEventListener('click', async function(){
  var email = ($('#billingEmail') && $('#billingEmail').value) ? $('#billingEmail').value.trim() : '';
  var native = isLikelyNativeApp();
  try{
    if(native){
      var r1 = await fetch('/api/iap/start', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ product:'premium', email:email||null }) }).then(function(r){return r.json();});
      if (r1 && r1.ok){ window._toast('Odpri nakupe v aplikaciji …', true); } else if (r1 && r1.url){ location.href=r1.url; } else { window._toast('Nakup v aplikaciji trenutno ni na voljo.', false); }
    } else {
      var r2 = await fetch('/api/stripe/start', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ product:'premium', email:email||null, kind:'subscription' }) }).then(function(r){return r.json();});
      if (r2 && r2.url) location.href=r2.url; else window._toast('Stripe nakup ni na voljo.', false);
    }
  }catch(e){ window._toast('Napaka pri zagonu nakupa Premium.', false); }
});

/* Predčasna obvestila */
var btnEarly=$("#btnEarlyNotify");
if(btnEarly) btnEarly.addEventListener('click', async function(){
  var ok = confirm('Predčasna obvestila so na voljo v Premium. Vklopim (ali nadgradim)?'); if (!ok) return;
  try{ localStorage.setItem('ng_early_notify','1'); }catch(e){}
  var payload = { type:'early_notify_optin', lat: (GEO?GEO.lat:null), lon: (GEO?GEO.lon:null) };
  try{ fetch('/api/analytics', { method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(payload) }); }catch(e){}
  window._toast('Predčasna obvestila vključena (Premium).', true);
});

/* Nakup paketov – IAP (native) ali Stripe (desktop) + račun na e‑pošto */
var plansPanel=$("#plansPanel");
if(plansPanel) plansPanel.addEventListener('click', async function(e){
  var b = e.target.closest ? e.target.closest('[data-start-plan]') : null; if (!b) return;
  var plan = b.getAttribute('data-start-plan');
  var email=($('#providerBillingEmail') && $('#providerBillingEmail').value) ? $('#providerBillingEmail').value.trim() : '';
  var native=isLikelyNativeApp();
  try{
    if(native){
      var j = await fetch('/api/iap/provider-start?plan='+encodeURIComponent(plan), { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ email:email||null }) }).then(function(r){return r.json();});
      if (j && j.ok){ window._toast('Odpri nakupe v aplikaciji …', true); } else if (j && j.url){ location.href=j.url; } else { window._toast('Nakup paketa (IAP) ni na voljo.', false); }
    } else {
      var s = await fetch('/api/stripe/start', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ product:'provider_'+plan, email:email||null, kind:'subscription' }) }).then(function(r){return r.json();});
      if (s && s.url) location.href=s.url; else window._toast('Nakup paketa (Stripe) ni na voljo.', false);
    }
  }catch(err){ window._toast('Napaka pri zagonu nakupa paketa.', false); }
});

/* “Moje” značka */
(function updateMineBadge(){
  var badge = $('#pointsBadge'); if (!badge) return;
  try{
    var savedEmail = localStorage.getItem('user_email') || '';
    if (!savedEmail) return;
    fetch('/api/purchase-lookup?email='+encodeURIComponent(savedEmail))
      .then(function(r){return r.json();})
      .then(function(j){
        var arr = (j && (j.items || j.results)) ? (j.items || j.results) : [];
        var n = arr.length || 0;
        if (n>0){ badge.style.display='inline-block'; badge.textContent = String(n); }
      }).catch(function(){});
  }catch(e){}
})();

/* PREMIUM status */
(async function detectPremium(){
  try{ var s = await fetch('/api/iap/status').then(function(r){return r.json();}); IS_PREMIUM = !!(s && (s.premium===true || s.tier==='premium')); }catch(e){ IS_PREMIUM=false; }
})();

/* Mini točke */
(function pointsLite(){
  var badge = $('#pointsBadge'); if (!badge) return;
  function add(k){
    try{
      var v = Number(localStorage.getItem('ng_points')||0) + k;
      localStorage.setItem('ng_points', v);
      badge.style.display='inline-block'; badge.textContent=String(v);
    }catch(e){}
  }
  var car=$('#carousel'); if(car) car.addEventListener('click', function(e){ if (e.target.closest && e.target.closest('.spot')) add(1); });
  var res=$('#results'); if(res) res.addEventListener('click', function(e){ if (e.target.closest && e.target.closest('.spot')) add(1); });
})();

/* Start */
loadFeatured();
doSearch(0);
  </script>
</body>
</html>
