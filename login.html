<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hitra registracija / vpis</title>
  <link rel="stylesheet" href="assets/app.css">
</head>
<body>
  <div class="login-container">
    <h1>Prijava</h1>
    <form id="login-form">
      <input type="email" name="email" placeholder="E-pošta" autocomplete="email" required>
      <input type="password" name="password" placeholder="Geslo" autocomplete="current-password" required>
      <button type="submit" id="loginBtn">Prijava</button>
      <div id="login-message" style="color:#d64c4c;margin-top:8px;"></div>
      <div style="margin-top:14px;text-align:center;font-size:14px;">
        <a href="#" id="forgotPasswordLink" style="color:#0bbbd6;margin-right:10px">Pozabljeno geslo?</a>
        <span>ali</span>
        <a href="#" id="registerLink" style="color:#0bbbd6;margin-left:10px">Še niste registrirani?</a>
      </div>
    </form>
    <div id="register-section" style="display:none;margin-top:28px;">
      <form id="register-form">
        <div style="display:flex;gap:10px;">
          <input type="text" name="firstName" placeholder="Ime" autocomplete="given-name" required style="flex:1;">
          <input type="text" name="lastName" placeholder="Priimek" autocomplete="family-name" required style="flex:1;">
        </div>
        <div style="margin-top:10px;display:flex;gap:10px;">
          <select name="countryCode" style="width:90px;">
            <option value="+386">+386</option>
            <option value="+385">+385</option>
            <option value="+43">+43</option>
            <option value="+49">+49</option>
          </select>
          <input type="tel" name="phone" placeholder="Telefonska številka" autocomplete="tel" required style="flex:1;">
        </div>
        <input type="email" name="email" placeholder="E-pošta" autocomplete="email" required style="margin-top:10px;">
        <input type="password" name="password" placeholder="Geslo (min. 6 znakov)" autocomplete="new-password" required style="margin-top:10px;">
        <div style="margin-top:10px;">
          <label><input type="radio" name="codeMethod" value="sms" checked> Preveri s SMS kodo</label>
          <label style="margin-left:18px;"><input type="radio" name="codeMethod" value="email"> Preveri z email kodo</label>
        </div>
        <div id="register-code-row" style="margin-top:10px;display:none;">
          <input type="text" name="registerCode" placeholder="Vnesite kodo" style="width:140px;">
        </div>
        <button type="submit" id="registerBtn" style="margin-top:16px;width:100%;">Registracija</button>
        <div id="register-message" style="color:#d64c4c;margin-top:8px;"></div>
        <div style="margin-top:14px;text-align:center;font-size:14px;">
          <a href="#" id="backToLoginLink" style="color:#0bbbd6;">Nazaj na prijavo</a>
        </div>
      </form>
    </div>
  </div>
  <script src="assets/app-logic.js"></script>
  <script src="assets/supabase-client.js"></script>
  <script src="assets/utils.js"></script>
  <script>
    // LOGIN LOGIKA
    const loginForm = document.getElementById('login-form');
    const loginMsg = document.getElementById('login-message');
    const registerSection = document.getElementById('register-section');
    const registerLink = document.getElementById('registerLink');
    const forgotPasswordLink = document.getElementById('forgotPasswordLink');

    function getRedirectUrl() {
      const params = new URLSearchParams(window.location.search);
      const redirect = params.get('redirect');
      if (!redirect) return '/my.html';
      if (redirect === 'organizers') return '/organizers.html';
      if (redirect === 'premium') return '/premium.html';
      if (redirect === 'my') return '/my.html';
      if (redirect === 'scans') return '/scans.html';
      return '/my.html';
    }

    loginForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const email = loginForm.querySelector('input[name="email"]').value.trim();
      const password = loginForm.querySelector('input[name="password"]').value;
      loginMsg.textContent = '';
      if (!email || !password) {
        loginMsg.textContent = 'Vnesite email in geslo.';
        return;
      }
      loginMsg.textContent = 'Prijavljam ...';
      try {
        const { testSignInEmail } = window;
        let result = await testSignInEmail(email, password);
        if (result?.data?.user) {
          loginMsg.textContent = 'Prijava uspešna!';
          window.location.href = getRedirectUrl();
        } else {
          loginMsg.textContent = 'Napaka: ' + (result?.error?.message || 'Uporabnik ne obstaja ali je geslo napačno.');
        }
      } catch (e) {
        loginMsg.textContent = 'Napaka: ' + e.message;
      }
    });

    registerLink.addEventListener('click', function(e) {
      e.preventDefault();
      loginForm.style.display = 'none';
      registerSection.style.display = 'block';
      // Tukaj bo prikazan razširjen obrazec za registracijo v drugi fazi
    });

    forgotPasswordLink.addEventListener('click', function(e) {
      e.preventDefault();
      loginMsg.textContent = 'Za obnovitev gesla sledite navodilom v emailu.';
      // Lahko dodamo logiko za pošiljanje emaila za obnovitev gesla
    });

    // REGISTRACIJSKA LOGIKA
    const registerForm = document.getElementById('register-form');
    const registerMsg = document.getElementById('register-message');
    const registerCodeRow = document.getElementById('register-code-row');
    const backToLoginLink = document.getElementById('backToLoginLink');

    let codeSent = false;
    let codeMethod = 'sms';

    if (registerForm) {
      registerForm.codeMethod = registerForm.querySelectorAll('input[name="codeMethod"]');
      registerForm.codeMethod.forEach(radio => {
        radio.addEventListener('change', function() {
          codeMethod = this.value;
        });
      });

      registerForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        registerMsg.textContent = '';
        const firstName = registerForm.firstName.value.trim();
        const lastName = registerForm.lastName.value.trim();
        const countryCode = registerForm.countryCode.value;
        const phone = registerForm.phone.value.trim();
        const email = registerForm.email.value.trim();
        const password = registerForm.password.value;
        const registerCode = registerForm.registerCode.value.trim();

        // Validacija
        if (!firstName || !lastName) {
          registerMsg.textContent = 'Vnesite ime in priimek.';
          return;
        }
        if (!/^\d{6,}$/.test(phone.replace(/\D/g, ''))) {
          registerMsg.textContent = 'Vnesite veljavno telefonsko številko.';
          return;
        }
        if (!email.match(/^[^@]+@[^@]+\.[^@]+$/)) {
          registerMsg.textContent = 'Vnesite veljaven email naslov.';
          return;
        }
        if (password.length < 6) {
          registerMsg.textContent = 'Geslo mora imeti vsaj 6 znakov.';
          return;
        }

        // Pošlji kodo, če še ni bila poslana
        if (!codeSent) {
          registerMsg.textContent = 'Pošiljam kodo ...';
          let res;
          try {
            if (codeMethod === 'sms') {
              res = await fetch('/.netlify/functions/send-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ method: 'sms', phone, countryCode })
              });
            } else {
              res = await fetch('/.netlify/functions/send-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ method: 'email', email })
              });
            }
            const data = await res.json();
            if (data.ok && data.codeSent) {
              codeSent = true;
              registerMsg.textContent = 'Koda je bila poslana.';
              registerCodeRow.style.display = '';
              return;
            } else {
              registerMsg.textContent = 'Napaka pri pošiljanju kode.';
              return;
            }
          } catch (err) {
            registerMsg.textContent = 'Napaka: ' + err.message;
            return;
          }
        }

        // Preveri kodo
        if (!registerCode) {
          registerMsg.textContent = 'Vnesite prejeto kodo.';
          return;
        }
        registerMsg.textContent = 'Preverjam kodo ...';
        try {
          let verifyRes;
          if (codeMethod === 'sms') {
            verifyRes = await fetch('/.netlify/functions/verify-code', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ phone, code: registerCode, countryCode })
            });
          } else {
            verifyRes = await fetch('/.netlify/functions/verify-code', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, code: registerCode })
            });
          }
          const verifyData = await verifyRes.json();
          if (!verifyData.ok || !verifyData.verified) {
            registerMsg.textContent = 'Koda ni pravilna.';
            return;
          }
        } catch (err) {
          registerMsg.textContent = 'Napaka: ' + err.message;
          return;
        }

        // Registracija v Supabase
        registerMsg.textContent = 'Registriram ...';
        try {
          const { testSignUpEmail } = window;
          const result = await testSignUpEmail(email, password, {
            data: {
              first_name: firstName,
              last_name: lastName,
              phone: countryCode + phone
            }
          });
          if (result?.data?.user) {
            registerMsg.textContent = 'Registracija uspešna!';
            setTimeout(() => {
              window.location.href = getRedirectUrl();
            }, 800);
          } else {
            registerMsg.textContent = 'Napaka: ' + (result?.error?.message || 'Neznana napaka.');
          }
        } catch (err) {
          registerMsg.textContent = 'Napaka: ' + err.message;
        }
      });

      backToLoginLink.addEventListener('click', function(e) {
        e.preventDefault();
        registerSection.style.display = 'none';
        loginForm.style.display = 'block';
        codeSent = false;
        registerCodeRow.style.display = 'none';
        registerMsg.textContent = '';
        registerForm.reset();
      });
    }
  </script>
</body>
</html>
