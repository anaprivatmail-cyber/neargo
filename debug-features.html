<!doctype html>
<html lang="sl">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>NearGo â€“ Diagnostika</title>
	<style>
		:root{ --bg:#f6fbfe; --card:#fff; --text:#0b1b2b; --muted:#5b6b7b; --brand:#0bbbd6; --ok:#0a7c2f; --bad:#b00020; --border:#e3eef7; --shadow:0 12px 30px rgba(0,0,0,.06); }
		*{box-sizing:border-box}
		body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
		.wrap{max-width:900px;margin:22px auto;padding:14px}
		.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
		h1{margin:6px 0 10px;font-size:22px}
		.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
		.btn{background:var(--brand);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer}
		.btn.link{background:#fff;color:var(--text);border:1px solid var(--border)}
		.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-weight:800}
		.ok{color:var(--ok);font-weight:800}
		.bad{color:var(--bad);font-weight:800}
		pre{background:#f9fcff;border:1px solid var(--border);border-radius:12px;padding:12px;overflow:auto}
		.section{margin:12px 0}
	</style>
	<script>
		const __VER = '2025-11-11-1'; // cache-bust za assets
		async function getSession(){
			try{
				if(!window.supabase){ const mod = await import('/assets/supabase-client.js?v='+encodeURIComponent(__VER)); window.supabase = mod.supabase; }
				const { data } = await window.supabase.auth.getSession();
				return data?.session || null;
			}catch(e){ return null; }
		}
		async function load(){
			const out = document.getElementById('out');
			const envBox = document.getElementById('env');
			const me = document.getElementById('me');
			const authDiag = document.getElementById('authDiag');
			const mineBox = document.getElementById('mine');
			const sess = await getSession();
			me.textContent = sess?.user?.email ? ('Prijavljen kot: '+sess.user.email) : 'Nisi prijavljen.';
			if(window.supabase){
				try{
					const userRes = await window.supabase.auth.getUser();
					const user = userRes?.data?.user || null;
					const diag = {
						client: !!window.supabase,
						session: !!sess,
						userId: user?.id || null,
						email: user?.email || sess?.user?.email || null,
						tokenLast8: sess?.access_token ? sess.access_token.slice(-8) : null,
						storedEmail: localStorage.getItem('user_email') || null,
						storedAccess: (localStorage.getItem('user_token')||'').slice(0,16) ? (localStorage.getItem('user_token')||'').slice(-8) : null,
						storageKeys: Object.keys(localStorage).filter(k=>/^user_/.test(k))
					};
					authDiag.textContent = JSON.stringify(diag, null, 2);
				}catch(e){ authDiag.textContent = 'Napaka pri auth diagnostiki: '+(e.message||e); }
			}else{
				authDiag.textContent = 'Supabase client NI naloÅ¾en (CDN blokiran?).';
			}
			try{
				const r = await fetch('/api/check-env');
				const j = await r.json().catch(()=>({}));
				envBox.textContent = JSON.stringify(j, null, 2);
			}catch(e){ envBox.textContent='Napaka pri preverjanju okolja: '+(e?.message||e); }
			document.getElementById('btnFree').onclick = issueFree;
			document.getElementById('btnMy').onclick = loadMine;
			document.getElementById('btnRefreshAuth').onclick = async ()=>{
				const s = await getSession();
				me.textContent = s?.user?.email ? ('Prijavljen kot: '+s.user.email) : 'Nisi prijavljen.';
				if(window.supabase && window.supabase.auth?.getSession){
					try{
						const userRes = await window.supabase.auth.getUser();
						const user = userRes?.data?.user || null;
						const diag = {
							client: !!window.supabase,
							session: !!s,
							userId: user?.id || null,
							email: user?.email || s?.user?.email || null,
							tokenLast8: s?.access_token ? s.access_token.slice(-8) : null,
							storedEmail: localStorage.getItem('user_email') || null,
							storedAccess: (localStorage.getItem('user_token')||'').slice(0,16) ? (localStorage.getItem('user_token')||'').slice(-8) : null,
							storageKeys: Object.keys(localStorage).filter(k=>/^user_/.test(k))
						};
						authDiag.textContent = JSON.stringify(diag, null, 2);
					}catch(e){ authDiag.textContent = 'Napaka pri auth diagnostiki: '+(e.message||e); }
				}
			};
			document.getElementById('btnWho').onclick = async ()=>{
				const who = document.getElementById('whoDiag');
				who.textContent = 'KliÄemâ€¦';
				const cur = await getSession();
				if(!cur?.access_token){ who.textContent = 'Ni seje â€“ prijava potrebna.'; return; }
				try{
					const r = await fetch('/api/whoami', {
						method:'GET', headers: { 'Authorization': 'Bearer '+cur.access_token }
					});
					const j = await r.json().catch(()=>({}));
					who.textContent = JSON.stringify(j, null, 2);
				}catch(e){ who.textContent = 'Napaka: '+(e?.message||e); }
			};
			async function loadMine(){
				mineBox.textContent='Nalagamâ€¦';
				let headers = {};
				const cur = await getSession();
				if(cur?.access_token) headers['Authorization']='Bearer '+cur.access_token;
				try{
					const r = await fetch('/api/my', { headers });
					const j = await r.json().catch(()=>({}));
					mineBox.textContent = JSON.stringify(j, null, 2);
				}catch(e){ mineBox.textContent='Napaka: '+(e?.message||e); }
			}
			async function issueFree(){
				const btn = document.getElementById('btnFree'); btn.disabled=true;
				try{
					const cur = await getSession();
					if(!cur?.user?.email){ alert('Prijava potrebna.'); btn.disabled=false; return; }
					const headers={'Content-Type':'application/json'};
					if(cur?.access_token) headers['Authorization']='Bearer '+cur.access_token;
					const body = { email: cur.user.email, event_title: 'Test kupon', display_benefit: 'Test â€“ brezplaÄno' };
					const r = await fetch('/api/free-coupon', { method:'POST', headers, body: JSON.stringify(body) });
					const j = await r.json().catch(()=>({}));
					out.textContent = JSON.stringify(j, null, 2);
					if(j && j.ok){ alert('âœ… Test kupon izdan. Preveri e-poÅ¡to in â€œMojeâ€.'); }
					else { alert('âŒ Napaka pri izdaji: '+(j?.error||'')); }
				}catch(e){ alert('âŒ Napaka: '+(e?.message||e)); }
				finally{ btn.disabled=false; }
			}
		}
		window.addEventListener('DOMContentLoaded', load);
	</script>
	<script>
		// minimal toast (optional)
	</script>
</head>
<body>
	<div class="wrap">
		<div class="card">
			<h1>Diagnostika NearGo</h1>
			<div class="section"><span id="me" class="pill">Preverjam prijavoâ€¦</span></div>
			<div class="section">
				<button id="btnFree" class="btn">âœ‰ PoÅ¡lji test kupon (brezplaÄni)</button>
				<button id="btnMy" class="btn link">ğŸ“¥ NaloÅ¾i â€œMojeâ€</button>
				<button id="btnRefreshAuth" class="btn link">ğŸ”„ OsveÅ¾i prijavo</button>
				<button id="btnWho" class="btn link">ğŸ†” StreÅ¾nik â€œwhoamiâ€</button>
				<a class="btn link" href="/my.html" target="_blank" rel="noopener">Odpri â€œMojeâ€</a>
			</div>
      <div class="section">
        <div class="pill">E-poÅ¡ta â€“ test</div>
        <div class="row" style="margin:8px 0">
          <input id="emailTestTo" placeholder="email prejemnika" style="padding:8px 12px;border-radius:10px;border:1px solid var(--border);min-width:240px">
          <button id="btnEmailDiag" class="btn link">ğŸ” Preveri nastavitve</button>
          <button id="btnEmailSend" class="btn">ğŸ“§ PoÅ¡lji test</button>
        </div>
        <pre id="emailTestOut">(prazno)</pre>
      </div>
			<div class="section">
				<div class="pill">Okolje</div>
				<pre id="env">Nalagamâ€¦</pre>
			</div>
			<div class="section">
				<div class="pill">Prijava (diag)</div>
				<pre id="authDiag">Nalagamâ€¦</pre>
			</div>
			<div class="section">
				<div class="pill">Whoami (streÅ¾nik)</div>
				<pre id="whoDiag">(prazno)</pre>
			</div>
			<div class="section">
				<div class="pill">Zadnji rezultat</div>
				<pre id="out">(prazno)</pre>
			</div>
			<div class="section">
				<div class="pill">Moje (API odgovor)</div>
				<pre id="mine">(prazno)</pre>
			</div>
		</div>
	</div>

	<script>
	// Email test handlers
	(function(){
		function show(out, obj){ out.textContent = typeof obj==='string'?obj:JSON.stringify(obj,null,2); }
		const out = document.getElementById('emailTestOut');
		const toEl = document.getElementById('emailTestTo');
		const btnDiag = document.getElementById('btnEmailDiag');
		const btnSend = document.getElementById('btnEmailSend');
		if(btnDiag){ btnDiag.onclick = async function(){
			try{ const r = await fetch('/api/test-email'); const j = await r.json().catch(()=>({})); show(out, j); }
			catch(e){ show(out, 'Napaka pri diagnostiki: '+(e?.message||e)); }
		}; }
		if(btnSend){ btnSend.onclick = async function(){
			const to = (toEl && toEl.value || '').trim(); if(!to){ alert('Vnesi email prejemnika.'); return; }
			btnSend.disabled=true; try{
				const r = await fetch('/api/test-email?send=1&to='+encodeURIComponent(to));
				const j = await r.json().catch(()=>({})); show(out, j);
				if(j && j.ok){ alert('âœ… Testno sporoÄilo poslano (provider: '+(j.provider||'?')+').'); }
				else { alert('âŒ PoÅ¡iljanje ni uspelo: '+(j?.error||'')); }
			}catch(e){ show(out, 'Napaka: '+(e?.message||e)); }
			finally{ btnSend.disabled=false; }
		}; }
	})();
	</script>
</body>
</html>

