<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>getneargo ‚Äì Checker</title>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin: 16px; }
    .card { border:1px solid #eee; border-radius:12px; padding:16px; margin:12px 0; }
    button { padding:10px 14px; border-radius:8px; border:1px solid #ddd; cursor:pointer; }
    #video { width:100%; max-width:480px; border-radius:12px; background:#000; }
    .ok { color:#0a7c2f } .bad { color:#b00020 }
    input { padding:10px; border:1px solid #ddd; border-radius:8px; width:100%; max-width:380px; }
  </style>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    import { BrowserMultiFormatReader } from "https://esm.sh/@zxing/browser";

    // üîπ Supabase
    const SUPABASE_URL = "https://wqdfteajjcrzcniotvhh.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxZGZ0ZWFqamNyemNuaW90dmhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzNTU3MDMsImV4cCI6MjA3MTkzMTcwM30.0EFgeCpHcsSxsYQ2wZIQerLKXcAlvJjVNuQ0nJB2VFc";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const S = { session: null, scanner: null, scanning: false };

    // ---------- INIT: poskusi vse naƒçine prijave iz URL-ja ----------
    async function init() {
      const href = window.location.href;
      const url  = new URL(href);

      // a) PKCE varianta: ?code=...
      const code = url.searchParams.get("code");
      if (code) {
        try {
          await supabase.auth.exchangeCodeForSession(href);
        } catch (e) {
          console.warn("exchangeCodeForSession:", e);
        } finally {
          history.replaceState(null, "", url.origin + url.pathname + url.search.replace(/(^\?v=\d+)?$/,""));
        }
      }

      // b) Hash varianta: #access_token=...&refresh_token=...
      if (url.hash && (url.hash.includes("access_token") || url.hash.includes("provider_token"))) {
        const h = new URLSearchParams(url.hash.slice(1));
        const access_token  = h.get("access_token")  || h.get("provider_token");
        const refresh_token = h.get("refresh_token");
        if (access_token && refresh_token) {
          try {
            await supabase.auth.setSession({ access_token, refresh_token });
          } catch (e) {
            console.warn("setSession:", e);
          } finally {
            history.replaceState(null, "", url.origin + url.pathname + url.search.replace(/(^\?v=\d+)?$/,""));
          }
        }
      }

      // trenutna seja
      const { data: { session } } = await supabase.auth.getSession();
      S.session = session;

      supabase.auth.onAuthStateChange((_e, s) => {
        S.session = s?.session || null;
        render();
      });

      render();
    }

    // ---------- MAGIC LINK ----------
    async function signIn() {
      const email = document.getElementById("email").value.trim();
      if (!email) return alert("Vnesi e-po≈°to.");

      // cache-buster v queryju (posodobi ≈°tevilko v=4, ƒçe bo treba)
      const search = location.search || "?v=4";
      const redirectTo = `${location.origin}${location.pathname}${search}`;

      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: redirectTo }
      });
      alert(error ? "Napaka: " + error.message : "Poslali smo prijavno povezavo na e-po≈°to.");
    }

    // ---------- QR skeniranje ----------
    async function startScan() {
      if (S.scanning) return;
      S.scanning = true;
      const video = document.getElementById("video");
      video.setAttribute("playsinline", "");
      video.setAttribute("muted", "");
      video.muted = true;

      const reader = new BrowserMultiFormatReader();
      S.scanner = reader;
      try {
        await reader.decodeFromVideoDevice(undefined, video, async (res) => {
          if (!res) return;
          let token = (res.getText() || "").trim();
          const m = token.match(/\/r\/([a-z0-9-]{10,})/i);
          if (m) token = m[1];
          await redeem(token);
          stopScan();
        });
      } catch {
        alert("Kamera ni na voljo ali dovoljenje zavrnjeno.");
        stopScan();
      }
    }
    function stopScan() {
      if (S.scanner) { S.scanner.reset(); S.scanner = null; }
      S.scanning = false;
    }

    // ---------- Redeem ----------
    async function redeem(token) {
      token = (token || "").trim();
      if (!token) return alert("Manjka token.");
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.access_token) return alert("Najprej se prijavi.");

      const res = await fetch(`/api/redeem/${encodeURIComponent(token)}`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${session.access_token}` }
      });
      const json = await res.json();
      const out = document.getElementById("result");
      if (json.ok) {
        out.innerHTML = `<div class="card">
          <h3 class="ok">VELJAVNO ‚úî</h3>
          <p>${json.type === "coupon" ? "Kupon" : "Vstopnica"}${json.display_benefit ? " ‚Äì " + escapeHtml(json.display_benefit) : ""}</p>
          <p>Kupƒçeva e-po≈°ta: ${escapeHtml(json.customer_email || "-")}</p>
          <p>ƒåas unovƒçitve: ${new Date(json.redeemed_at).toLocaleString()}</p>
        </div>`;
      } else {
        out.innerHTML = `<div class="card"><h3 class="bad">NEVELJAVNO ‚úñ</h3><p>${escapeHtml(json.reason || "Napaka")}</p></div>`;
      }
    }

    // ---------- UI ----------
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
      }[c]));
    }
    function render() {
      const app = document.getElementById("app");
      if (!S.session) {
        app.innerHTML = `<div class="card">
          <h2>Prijava za ponudnike</h2>
          <input id="email" type="email" placeholder="tvoj@email" />
          <button onclick="signIn()">Po≈°lji prijavno povezavo</button>
        </div>`;
      } else {
        app.innerHTML = `
          <div class="card"><strong>Prijavljen:</strong> ${S.session.user.email}</div>
          <div class="card">
            <button onclick="startScan()">Zaƒçni skeniranje</button>
            <button onclick="stopScan()">Ustavi</button>
            <video id="video" playsinline muted></video>
          </div>
          <div class="card">
            <input id="manual" placeholder="Roƒçni vnos tokena (ƒçe QR ne dela)" />
            <button onclick="redeem(document.getElementById('manual').value)">Unovƒçi</button>
          </div>
          <div id="result"></div>`;
      }
      window.signIn = signIn;
      window.startScan = startScan;
      window.stopScan = stopScan;
    }

    init();
  </script>
</head>
<body>
  <h1>getneargo ‚Äì Checker</h1>
  <div id="app"></div>
</body>
</html>
