<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8">
  <title>Premium NearGo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="assets/app.css">
  <script src="assets/boot-utils.js"></script>
  <script type="module" src="assets/categories.js"></script>
</head>
<body>
  <header style="background:linear-gradient(90deg,#e9f7ff 55%,#0bbbd6 100%);padding:14px 0 10px;box-shadow:0 2px 12px rgba(11,187,214,.08);margin-bottom:10px;">
    <div style="max-width:940px;margin:0 auto;display:flex;align-items:center;gap:22px;padding:0 18px;">
      <a href="/" style="font-size:1.7em;font-weight:900;color:#0bbbd6;text-decoration:none;letter-spacing:-1px;">NearGo</a>
      <nav class="nav" style="display:flex;align-items:center;gap:12px;margin-left:auto;">
        <a href="/my.html" class="pill" style="font-weight:700;color:#0b1b2b;">Moje</a>
        <a href="/premium.html" class="pill" style="font-weight:700;color:#0bbbd6;">Premium</a>
      </nav>
    </div>
  </header>

  <!-- HERO / BENEFITS -->
  <div style="max-width:440px;margin:24px auto 18px;padding:30px 26px 32px;background:linear-gradient(120deg,#e9f7ff 60%,#f6fff9 100%);border-radius:28px;box-shadow:0 8px 34px rgba(11,187,214,.16);text-align:center;">
    <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Premium ikona" style="width:70px;height:70px;margin-bottom:18px;filter:drop-shadow(0 2px 8px rgba(11,187,214,.45));">
    <h1 style="font-size:2em;margin:0 0 6px;color:#0bbbd6;letter-spacing:-0.5px;">Premium NearGo</h1>
    <p style="margin:0 0 18px;font-weight:650;color:#0b1b2b;font-size:1.05em;">HitrejÅ¡i dostop do novih dogodkov in veÄ ugodnosti pri kuponih.</p>
    <ul style="text-align:left;margin:0 auto 22px;padding:0;list-style:none;max-width:320px;font-size:0.98em;line-height:1.55;">
      <li style="display:flex;gap:8px;margin-bottom:10px;"><span>â°</span><span><b style="color:#0bbbd6">15 min predÄasna obvestila</b> pred javno objavo dogodkov.</span></li>
      <li style="display:flex;gap:8px;margin-bottom:10px;"><span>ğŸŸï¸</span><span><b style="color:#0bbbd6">Kuponi brez 2 â‚¬ provizije</b> (navadni uporabnik plaÄa 2 â‚¬).</span></li>
      <li style="display:flex;gap:8px;margin-bottom:10px;"><span>ğŸ””</span><span>Personalizirane <b style="color:#0bbbd6">predhodne kategorije</b> (izbira spodaj).</span></li>
      <li style="display:flex;gap:8px;margin-bottom:10px;"><span>ğŸ’¬</span><span><b style="color:#0bbbd6">Prioritetna pomoÄ & povratne informacije</b>.</span></li>
      <li style="display:flex;gap:8px;margin-bottom:4px;"><span>ğŸ†</span><span>Nagrade & obÄasni brezplaÄni kupon preseneÄenja.</span></li>
    </ul>
    <div id="premiumActionWrap">
      <button id="btnBuyPremium" class="btn" style="background:linear-gradient(90deg,#0bbbd6,#11a67a);color:#fff;font-weight:900;font-size:1.05em;padding:12px 30px;border:none;border-radius:999px;cursor:pointer;box-shadow:0 4px 18px rgba(11,187,214,.30);">
        Aktiviraj Premium <span id="premiumPriceLabel" style="display:inline-block;margin-left:8px;font-weight:800;background:rgba(255,255,255,.18);padding:4px 10px;border-radius:999px;font-size:0.8em;">â€¦</span>
      </button>
  <div id="premiumStatus" role="status" aria-live="polite" style="display:none;margin-top:10px;font-weight:800;color:#11a67a;">Premium aktivno ğŸ‰ <span id="premiumUntil" style="font-weight:600;color:#0b1b2b;font-size:0.85em;margin-left:6px;"></span></div>
      <div id="premiumLoginNeeded" style="display:none;margin-top:10px;font-weight:700;color:#d64c4c;">Za nakup se prijavite.</div>
  <div id="premiumManage" style="display:none;margin-top:8px;font-size:12px;color:#0b1b2b;">Upravljanje naroÄnine na <a href="/account/account.html#subscription" style="color:#0bbbd6;font-weight:700;">raÄunu</a>.</div>
    </div>
    <div style="margin-top:14px;font-size:12px;color:#5b6b7b;">MeseÄna naroÄnina â€“ prekineÅ¡ lahko kadarkoli.</div>
    <div style="margin-top:8px;font-size:12px;color:#5b6b7b;">Navadni kupon: 2,00 â‚¬ provizije â€¢ Premium kupon: 0,00 â‚¬</div>
  </div>

  <!-- EARLY NOTIFY CONFIG (shown only if Premium) -->
  <section id="earlyNotifySection" style="max-width:460px;margin:0 auto 32px;display:none;">
    <h2 style="margin:0 0 10px;font-size:1.25em;letter-spacing:-0.5px;color:#0b1b2b;">Moje predÄasne kategorije</h2>
    <p style="margin:0 0 12px;font-size:0.9em;color:#5b6b7b;">Izberite kaj vas zanima. Obvestila prejmete pribliÅ¾no <b>15 minut</b> pred odprtjem javnosti.</p>
    <form id="earlyNotifyForm" style="background:var(--card,#fff);padding:16px 14px;border:1px solid var(--chipborder,#cfe1ee);border-radius:18px;">
      <div id="earlyNotifyCategoryList" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;"></div>
      <label style="display:block;font-size:13px;font-weight:600;margin-bottom:8px;">Lokacija (kraj):
        <input type="text" name="location" id="earlyNotifyLocation" placeholder="npr. Ljubljana" style="margin-top:4px;width:100%;padding:8px 12px;border:1px solid var(--chipborder,#cfe1ee);border-radius:12px;">
      </label>
      <label style="display:block;font-size:13px;font-weight:600;margin-bottom:8px;">Radij (km):
        <input type="number" name="radius" id="earlyNotifyRadius" min="1" max="400" value="30" style="margin-top:4px;width:100%;padding:8px 12px;border:1px solid var(--chipborder,#cfe1ee);border-radius:12px;max-width:120px;">
      </label>
      <button type="submit" class="btn mini" style="margin-top:4px;">Shrani nastavitve</button>
      <div id="earlyNotifyConfirmation" style="display:none;color:#11a67a;font-weight:700;margin-top:10px;font-size:13px;"></div>
    </form>
  </section>

  <!-- FAQ / INFO -->
  <section style="max-width:460px;margin:0 auto 60px;font-size:0.85em;color:#5b6b7b;line-height:1.5;">
    <h2 style="font-size:1.15em;margin:0 0 8px;color:#0b1b2b;">Pogosta vpraÅ¡anja</h2>
    <details style="margin-bottom:10px;">
      <summary style="cursor:pointer;font-weight:700;color:#0b1b2b;">Kako prejmem obvestila prej?</summary>
      <div style="margin-top:6px;">Po aktivaciji izbereÅ¡ kategorije zgoraj. Obvestilo poÅ¡ljemo ~15 minut pred javnim zagonom.</div>
    </details>
    <details style="margin-bottom:10px;">
      <summary style="cursor:pointer;font-weight:700;color:#0b1b2b;">Kaj pomeni brez provizije za kupon?</summary>
      <div style="margin-top:6px;">Navadni uporabnik plaÄa 2 â‚¬ za kupon. Premium uporabnik dobi kupon brez te provizije â€“ prihrani vsakiÄ.</div>
    </details>
    <details style="margin-bottom:10px;">
      <summary style="cursor:pointer;font-weight:700;color:#0b1b2b;">Ali lahko prekliÄem?</summary>
      <div style="margin-top:6px;">Da. NaroÄnino lahko prekineÅ¡ kadarkoli. Dostop ostane aktiven do konca plaÄanega obdobja.</div>
    </details>
  </section>

  <script type="module" src="assets/js/app.js"></script>
  <script>
  // DinamiÄna cena
  (async function(){
    try {
      const r = await fetch('/api/public-config').then(x=>x.json());
      if(r && r.premiumPriceCents){
        const euros = (r.premiumPriceCents/100).toFixed(2).replace('.', ',');
        const lbl = document.getElementById('premiumPriceLabel');
        if(lbl) lbl.textContent = euros + ' â‚¬';
      }
    } catch(e){
      const lbl = document.getElementById('premiumPriceLabel');
      if(lbl) lbl.textContent = '5,00 â‚¬';
    }
  })();

  function isLoggedIn(){
    return !!localStorage.getItem('user_email') || !!localStorage.getItem('user_token');
  }

  async function fetchPremiumMeta(){
    const email = localStorage.getItem('user_email');
    if(!email) return null;
    try{
      const r = await fetch(`/api/my?email=${encodeURIComponent(email)}`).then(x=>x.json());
      if(r && r.ok){
        if(r.premium){ window.IS_PREMIUM = true; }
        return { premium: !!r.premium, until: r.premium_until };
      }
    }catch(e){}
    return null;
  }

  function fmtDate(d){
    try{ if(!d) return ''; const dt = new Date(d); if(!dt || isNaN(dt.getTime())) return ''; return dt.toLocaleDateString('sl-SI', { day:'2-digit', month:'2-digit', year:'numeric'}); }catch{return ''}
  }

  async function updatePremiumUI(){
    const wrap = document.getElementById('premiumActionWrap');
    const btn = document.getElementById('btnBuyPremium');
    const loginMsg = document.getElementById('premiumLoginNeeded');
    const status = document.getElementById('premiumStatus');
    const early = document.getElementById('earlyNotifySection');
    const manage = document.getElementById('premiumManage');
    const untilEl = document.getElementById('premiumUntil');
    // If we don't yet know premium flag, attempt to fetch once (cheap)
    if(typeof window.IS_PREMIUM === 'undefined' || window.IS_PREMIUM === false){
      const meta = await fetchPremiumMeta();
      if(meta && meta.premium){
        window.IS_PREMIUM = true;
        if(untilEl && meta.until){ untilEl.textContent = '(do ' + fmtDate(meta.until) + ')'; }
      } else if(untilEl) { untilEl.textContent=''; }
    }
    const active = (typeof window.IS_PREMIUM !== 'undefined' && window.IS_PREMIUM === true);
    if(active){
      if(btn) btn.style.display = 'none';
      if(status){ status.style.display = 'block'; }
      if(loginMsg) loginMsg.style.display = 'none';
      if(early) early.style.display = 'block';
      if(manage) manage.style.display = 'block';
    } else {
      if(early) early.style.display = 'none';
      if(isLoggedIn()){
        if(btn) btn.style.display = 'inline-block';
        if(loginMsg) loginMsg.style.display = 'none';
        if(manage) manage.style.display = 'none';
      } else {
        if(btn) btn.style.display = 'none';
        if(loginMsg) loginMsg.style.display = 'block';
        if(manage) manage.style.display = 'none';
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    updatePremiumUI();
    const btn = document.getElementById('btnBuyPremium');
    if(btn){
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        if(!isLoggedIn()){
          window.location.href = '/login.html?next=/premium.html';
          return;
        }
        btn.disabled = true; btn.textContent = 'Poteka â€¦';
        try{
          const payload = { type: 'premium', successUrl: `${location.origin}/premium.html#success`, cancelUrl: `${location.origin}/premium.html#cancel` };
          const r = await fetch('/api/checkout',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }).then(x=>x.json());
          if(r && r.ok && r.url){ location.href = r.url; return; }
          alert('Nakup ni uspel. Poskusite znova.');
        }catch(err){ alert('Napaka pri nakupu.'); }
        btn.disabled = false; btn.textContent = 'Aktiviraj Premium';
      });
    }
  });
  // Refresh after potential async global update (e.g. after login redirect)
  setTimeout(()=>updatePremiumUI(), 1400);
  setTimeout(()=>updatePremiumUI(), 4000);
  </script>
</body>
</html>
