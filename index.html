<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NearGo ‚Äì najdi dogodke in storitve blizu</title>
  <!-- PWA -->
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0bbbd6">
  <!-- Leaflet -->
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root{
      --brand:#0bbbd6; --text:#0b1b2b; --muted:#5b6b7b; --card:#fff;
      --chip:#fff; --chipborder:#cfe1ee; --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:16px; --primary:#0bbbd6; --focus:#bfeef6; --gap:16px;
      --ok:#11a67a; --bad:#d64c4c;
    }
    body.dark{--text:#e8f0f8; --muted:#b8c3cf; --card:#0f1f30; --chip:#102437; --chipborder:#19324a; --focus:#123956}
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at -10% -10%, rgba(11,187,214,.25) 0%, rgba(11,187,214,0) 60%),
        linear-gradient(180deg, #e9f7ff 0%, #ffffff 70%);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; line-height:1.25;
    }
    a{ color:inherit; text-decoration:none }

    /* HEADER (3 vrstice) */
    header{position:sticky; top:0; z-index:30; backdrop-filter:blur(6px); background:color-mix(in srgb, var(--card) 88%, transparent); box-shadow:0 4px 16px rgba(0,0,0,.05);}
    .nav{ max-width:1100px; margin:0 auto; padding:8px 14px 10px; display:flex; flex-direction:column; gap:6px; }
    .nav-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .row0{ justify-content:center }
    .row1{ justify-content:space-between }
    .row2{ justify-content:flex-start; gap:10px }

    .brand{ display:flex; align-items:center; gap:10px; font-weight:900; font-size:20px }
    .brand svg{width:26px; height:26px}
    @keyframes slowPulse{0%{transform:scale(1);opacity:1}50%{transform:scale(1.07);opacity:.95}100%{transform:scale(1);opacity:1}}
    .pulse{animation:slowPulse 2.8s ease-in-out infinite; transform-origin:center}

    .pill{border:1px solid var(--chipborder); background:var(--chip); border-radius:999px; height:34px; display:flex; align-items:center; padding:0 10px; font-weight:800; font-size:14px; color:inherit; position:relative; cursor:pointer}
    .btn{background:var(--primary); color:#fff; border:none; padding:12px 18px; border-radius:14px; font-weight:900; cursor:pointer; font-size:16px}
    .btn.mini{padding:8px 12px; font-size:13px; border-radius:12px}
    .btn.link{background:#fff; color:#000; border:1px solid var(--chipborder)}
    .btn.link.active{background:var(--primary); color:#fff; border-color:transparent}
    .cta{background:var(--primary); color:#fff; border:none; padding:8px 14px; border-radius:999px; font-weight:800; box-shadow:var(--shadow); height:34px; display:flex; align-items:center}

    /* Za ponudnike ‚Äì rahlo izpostavljen */
    .btn-outline{ background:#fff; color:var(--text); border:1.5px solid var(--brand); border-radius:999px; padding:8px 14px; font-weight:800; height:34px; display:flex; align-items:center; box-shadow:0 2px 8px rgba(11,187,214,.12) }

    .mode{ border:1px solid var(--chipborder); background:var(--chip); border-radius:999px; padding:6px 10px; font-weight:900; cursor:pointer; user-select:none }
    .mode.active{ background:var(--primary); color:#fff; border-color:transparent }

    /* LANG */
    #lang{ display:none !important }
    .pill.lang{ position:relative }
    .lang-menu{
      position:absolute; top:calc(100% + 6px); left:0;
      background:var(--card); border:1px solid var(--chipborder); border-radius:12px; box-shadow:var(--shadow);
      padding:6px; display:none; z-index:10000; max-height:60vh; overflow:auto; min-width:64px;
    }
    .lang-menu button{display:block; width:100%; text-align:left; border:none; background:transparent; padding:8px 8px; border-radius:10px; font-weight:800; cursor:pointer;}
    .lang-menu button:hover{background:rgba(11,187,214,.08)}

    /* LAYOUT */
    main{max-width:1100px; margin:0 auto; padding:12px 14px 64px}
    main > section{margin-top:14px}
    .card{background:var(--card); box-shadow:var(--shadow); border-radius:var(--radius); padding:16px; border:1px solid var(--chipborder)}
    .title{font-weight:900; margin-bottom:10px}
    .muted{color:var(--muted)}

    /* HERO */
    .hero h1{margin:0 0 6px 0}
    .hero p{margin:0 0 10px 0}

    /* SEARCH HEAD */
    #searchPanel > .title{
      background:linear-gradient(90deg, rgba(11,187,214,.22), rgba(11,187,214,.06) 70%, transparent 100%);
      border-radius:12px; padding:8px 10px; margin-bottom:6px; display:flex; align-items:center; justify-content:space-between; gap:10px;
    }

    .chips{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .chip{border:1px solid var(--chipborder); border-radius:999px; padding:10px 14px; background:var(--chip); color:var(--muted); font-weight:700; cursor:pointer}
    .chip.active{ background:var(--primary); color:#fff; border-color:#fff; }

    label{display:flex; flex-direction:column; gap:6px; font-weight:800; font-size:13px}
    input,select,textarea{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--chipborder); background:var(--card); color:var(--text); outline:none; min-height:40px; font-size:15px; }
    input[type="datetime-local"]{ min-width:0; width:100%; }
    textarea{min-height:120px}
    input:focus,select:focus,textarea:focus{border-color:var(--brand); box-shadow:0 0 0 4px var(--focus)}
    input::placeholder, textarea::placeholder{color:#93a3b3}

    input:-webkit-autofill, select:-webkit-autofill, textarea:-webkit-autofill{
      -webkit-text-fill-color: var(--text) !important;
      box-shadow: 0 0 0px 1000px var(--card) inset !important;
      transition: background-color 99999s ease-in-out 0s;
    }

    /* RANGE */
    .range-line{display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px}
    input[type=range]{accent-color:#7cdbe9; height:28px; width:100%}

    .row{display:grid; grid-template-columns:1fr; gap:var(--gap)}
    .row + .row{margin-top:var(--gap)}
    @media(min-width:760px){ .row--3{grid-template-columns:repeat(3,1fr)} .row--2{grid-template-columns:repeat(2,1fr)} }
    .always-two{ display:grid; grid-template-columns:repeat(2,1fr); gap:6px; }
    .always-two input{ min-width:0; }

    /* Karusel + kartice */
    .carousel{display:flex; gap:10px; overflow:auto; scroll-snap-type:x mandatory; padding-bottom:6px; margin-top:6px}
    .carousel .spot{ flex:0 0 85%; min-width:260px; scroll-snap-align:start; }
    .spot{background:var(--card); border:1px solid var(--chipborder); border-radius:14px; overflow:hidden; margin-bottom:10px}
    .spot img{width:100%; height:160px; object-fit:cover; display:block}
    .spot .meta{padding:10px}
    .spot .more-text{ margin-top:6px; color:var(--muted) }

    .panel{display:none} .panel.show{display:block}

    .file-wrap{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    input[type="file"]::file-selector-button{padding:.35rem .6rem; border-radius:10px; border:1px solid var(--chipborder); background:var(--chip); cursor:pointer}
    .file-name{font-size:14px; color:var(--muted); white-space:normal; word-break:break-word; max-width:100%}
    .euro{display:flex; align-items:center; gap:8px}

    .buy{display:flex; align-items:center; gap:10px; margin-top:10px; flex-wrap:nowrap }
    .value-chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--chipborder); background:var(--chip); border-radius:999px; font-weight:800; font-size:12px; white-space:nowrap; }

    /* Toast */
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:12px; z-index:1002; display:none; padding:10px 14px; border-radius:12px; font-weight:800 }
    .toast.ok{ background:#e6fbf5; color:#05614d; border:1px solid #baf0df }
    .toast.bad{ background:#ffeaea; color:#7a1b1b; border:1px solid #ffd1d1 }

    /* ‚ÄúMoje‚Äù znaƒçka */
    .badge{ display:inline-flex; align-items:center; justify-content:center; min-width:18px; height:18px; padding:0 6px; font-size:12px; border-radius:999px; background:#0bbbd6; color:#fff; font-weight:900; }

    /* Modal */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:2000}
    .modal .box{background:var(--card); width:min(920px,92vw); border-radius:16px; border:1px solid var(--chipborder); box-shadow:var(--shadow); overflow:hidden}
    .modal .bar{display:flex; align-items:center; justify-content:space-between; padding:8px 12px; border-bottom:1px solid var(--chipborder); font-weight:900}
    .modal .content{padding:10px}
    .modal .row2{display:flex; gap:10px; align-items:center; margin:8px 0}
    .modal input[type="search"]{flex:1}

    /* Checkbox / Radio */
    label.inline, .inline label{ display:inline-flex; align-items:center; gap:8px; font-weight:800; font-size:13px; line-height:1; flex-direction:row; }
    input[type="checkbox"]{
      -webkit-appearance:none; appearance:none; width:14px; height:14px; margin:0; position:relative;
      border:2px solid #a9c3d6; border-radius:4px; background:#fff; outline:none; display:inline-block; box-sizing:content-box; padding:0; min-height:0 !important;
    }
    input[type="checkbox"]::after{
      content:""; position:absolute; left:3px; top:-1px; width:6px; height:10px;
      border-right:3px solid var(--primary); border-bottom:3px solid var(--primary);
      transform:rotate(45deg); opacity:0; transition:opacity .12s;
    }
    input[type="checkbox"]:checked{ border-color:var(--primary) }
    input[type="checkbox"]:checked::after{ opacity:1 }

    input[type="radio"]{
      -webkit-appearance:none; appearance:none; width:14px; height:14px; margin:0; position:relative;
      border:2px solid #a9c3d6; border-radius:50%; background:#fff; outline:none; display:inline-block; box-sizing:content-box; padding:0; min-height:0 !important;
    }
    input[type="radio"]::after{
      content:""; position:absolute; left:3px; top:3px; width:6px; height:6px; background:var(--primary); border-radius:50%; opacity:0; transition:opacity .12s;
    }
    input[type="radio"]:checked{ border-color:var(--primary) }
    input[type="radio"]:checked::after{ opacity:1 }

    /* Scroll offset */
    .panel{ scroll-margin-top: 120px; }

    /* Roƒçaj za polmer (map pick) */
    .radius-handle{ background:#0bbbd6; border:2px solid #fff; border-radius:50%; width:16px; height:16px; box-shadow:0 0 0 2px rgba(11,187,214,.4) }
    .leaflet-div-icon.radius-handle{ background:#0bbbd6; border-radius:50%; border:2px solid #fff; width:16px!important; height:16px!important; box-shadow:0 0 0 2px rgba(11,187,214,.4) }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <!-- ROW 0 -->
      <div class="nav-row row0">
        <div class="brand" aria-label="NearGo">
          <svg viewBox="0 0 32 32" aria-hidden="true">
            <defs><radialGradient id="g1" cx="50%" cy="50%"><stop offset="0%" stop-color="#0bbbd6"/><stop offset="100%" stop-color="#7de3f0"/></radialGradient></defs>
            <circle cx="16" cy="16" r="13" class="ring" fill="none" stroke="url(#g1)" stroke-width="2"/>
            <circle cx="16" cy="16" r="8" class="ring" fill="none" stroke="url(#g1)" stroke-width="2" opacity=".9"/>
            <circle cx="16" cy="16" r="3.2" class="dot pulse"/>
          </svg>
          NearGo
        </div>
      </div>

      <!-- ROW 1 -->
      <div class="nav-row row1">
        <div class="left" style="display:flex;gap:10px;align-items:center">
          <div id="btnThemeToggle" class="pill" title="Preklopi temo"><span id="themeIcon">üåô</span></div>
          <div class="pill lang" id="langWrap">
            <span class="label"><span id="langLabel">SL</span><span class="chev">‚ñº</span></span>
            <select id="lang" aria-label="Jezik"></select>
            <div class="lang-menu" id="langMenu"></div>
          </div>
        </div>
        <div class="right">
          <a class="btn-outline" id="btnProvidersTop" href="#orgHub">Za ponudnike</a>
        </div>
      </div>

      <!-- ROW 2 -->
      <div class="nav-row row2">
        <button class="mode active" data-mode="events">Dogodki</button>
        <button class="mode" data-mode="services">Storitve</button>
        <a class="pill" id="btnPremiumTop" href="#premiumPanel">Premium</a>
        <a class="pill" id="btnMine" href="/my.html" title="Moje vstopnice & kuponi">Moje <span id="pointsBadge" class="badge" style="margin-left:6px;display:none">0</span></a>
      </div>
    </div>
  </header>

  <main>
    <!-- HERO -->
    <section class="hero card" id="hero">
      <h1 id="heroHeadline">Najdi <span style="color:var(--brand)">dogodke blizu</span> ‚Äî koncerti, hrana, kultura, otroci &amp; veƒç</h1>
      <p id="heroLead">Vtipkaj, izberi kraj ali radij in dobi≈° dogodke v izbrani okolici ‚Äî kupi vstopnico ali kupon, dodaj v koledar, povabi prijatelje.</p>
      <div class="chips">
        <button class="btn" id="btnStart">Zaƒçni z iskanjem</button>
      </div>
    </section>

    <!-- Izpostavljeno -->
    <section class="card" id="featuredCard">
      <div class="title" style="display:flex;justify-content:space-between;align-items:center">
        <span>Izpostavljeno v tvoji bli≈æini</span>
        <div class="muted" style="font-size:12px">Samodejno vrtenje ‚Ä¢ potegni levo/desno</div>
      </div>
      <div class="carousel" id="carousel"></div>
    </section>

    <!-- Iskanje -->
    <section class="card" id="searchPanel">
      <div class="title"><span id="searchTitle">Iskanje</span></div>

      <div class="inline" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:6px">
        <button class="btn link" id="btnPickOnMap">Izberi lokacijo na zemljevidu</button>
        <button class="btn link" id="btnUseLocation"><span class="txt">Uporabi mojo trenutno lokacijo</span></button>
      </div>

      <label>Oddaljenost od trenutne lokacije
        <div class="range-line">
          <input id="radius" type="range" min="5" max="400" step="5" value="30">
          <span id="radiusLbl">30 km</span>
        </div>
      </label>

      <div class="row row--1">
        <label>Kje <input id="city" placeholder="Mesto/kraj ali 'lat, lon'"></label>
      </div>

      <label id="cityRadiusWrap" style="display:none">Oddaljenost od izbranega kraja
        <div class="range-line">
          <input id="radiusCity" type="range" min="5" max="400" step="5" value="30">
          <span id="radiusCityLbl">30 km</span>
        </div>
      </label>

      <!-- Hitri datumi -->
      <div class="inline" id="quickDates" style="display:flex;gap:6px;flex-wrap:wrap;align-items:flex-end;margin-top:6px">
        <button class="btn mini link quickDate" data-mode="today" type="button">Danes</button>
        <button class="btn mini link quickDate" data-mode="weekend" type="button">Ta vikend</button>
        <button class="btn mini link quickDate" data-mode="7" type="button">7 dni</button>
        <button class="btn mini link quickDate" data-mode="30" type="button">30 dni</button>
      </div>

      <!-- Od/Do -->
      <div class="row always-two" id="dateRangeRow" style="margin-top:6px">
        <label>Od <input id="dateFrom" type="date"></label>
        <label>Do <input id="dateTo" type="date"></label>
      </div>

      <div class="row row--1" style="margin-top:6px">
        <label>Kaj <input id="q" placeholder="npr. Metallica, street food, frizer‚Ä¶"></label>
      </div>

      <!-- Kategorije -->
      <div class="chips" id="cats" style="margin-top:8px" role="tablist" aria-label="Kategorije"></div>

      <div style="margin-top:6px" id="freeOnlyWrap">
        <label class="inline" style="gap:8px; align-items:center">
          <input type="checkbox" id="freeOnly">
          <span>Samo brezplaƒçni</span>
        </label>
      </div>

      <div class="inline" style="margin-top:6px">
        <button class="btn link" id="btnClear">Poƒçisti filtre</button>
      </div>

      <!-- Zemljevid rezultatov -->
      <div class="inline" style="margin-top:8px">
        <button class="btn link" id="btnToggleResultsMap">Poka≈æi zemljevid rezultatov</button>
      </div>
      <div id="mapSearchWrap" style="margin-top:8px; display:none; position:relative">
        <div id="mapSearch" style="height:360px; border-radius:12px; border:1px solid var(--chipborder)"></div>
      </div>

      <div id="results" style="margin-top:8px"></div>
      <div id="pagination" style="display:flex; gap:8px; margin-top:8px"></div>
    </section>

    <!-- Zemljevid (zgornji) ‚Äì prikaz posameznega rezultata -->
    <section class="card panel" id="mapPanel" style="display:none">
      <div class="title" style="display:flex; align-items:center; justify-content:space-between">
        <span>Zemljevid</span>
        <button class="btn mini link" id="btnCloseMap">Zapri zemljevid</button>
      </div>
      <div id="map" style="height:360px"></div>
      <div id="mapDetail" style="margin-top:10px"></div>
    </section>

    <!-- PONUDNIKI HUB -->
    <section class="card panel" id="orgHub" style="display:none">
      <div class="title">Za ponudnike</div>
      <p class="muted">Objava je brezplaƒçna. NearGo pomaga poveƒçevati prodajo, zapolniti prazne termine in poveƒçati doseg.</p>
      <div class="inline" style="display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn" id="hubPublish">Objavi dogodek/storitev</button>
        <a class="btn link" id="hubScan" href="/scan.html">Skeniraj QR</a>
        <a class="btn link" id="hubStats" href="/org-stats.html">Analitika</a>
        <a class="btn link" id="hubCalendar" href="/calendar.html">Koledar</a>
        <button class="btn link" id="hubBoost">Boost izpostavitev</button>
        <button class="btn link" id="hubPlans">Paketi (Grow/Pro)</button>
      </div>
    </section>

    <!-- PAKETI ZA PONUDNIKE -->
    <section class="card panel" id="plansPanel" style="display:none">
      <div class="title" style="display:flex;justify-content:space-between;align-items:center">
        <span>Paketi za ponudnike</span>
        <button class="btn mini link" id="btnClosePlans">Zapri</button>
      </div>
      <div class="row row--2">
        <div class="card" style="border:1px solid var(--chipborder);">
          <div class="title" style="margin:0">Grow</div>
          <div class="muted" style="font-size:13px;margin-top:-6px">Za zaƒçetek rasti</div>
          <ul class="muted" style="margin:6px 0 0 18px; line-height:1.6">
            <li>1 aktivna izpostavitev (7 dni)</li>
            <li>Osnovna analitika (ogledi, klikni ‚Üí nakup)</li>
            <li>Sinhronizacija koledarja</li>
            <li>Podpora v 24 h</li>
          </ul>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <div class="value-chip">meseƒçno</div>
            <button class="btn" data-start-plan="grow">Aktiviraj Grow</button>
          </div>
        </div>
        <div class="card" style="border:1px solid var(--chipborder);">
          <div class="title" style="margin:0">Pro</div>
          <div class="muted" style="font-size:13px;margin-top:-6px">Za zahtevne ekipe</div>
          <ul class="muted" style="margin:6px 0 0 18px; line-height:1.6">
            <li>3 aktivne izpostavitve (7 dni)</li>
            <li>Napredna analitika + izvoz</li>
            <li>API integracije in prioritetna podpora</li>
            <li>Upravljanje ekipe (veƒç uporabnikov)</li>
          </ul>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <div class="value-chip">meseƒçno</div>
            <button class="btn" data-start-plan="pro">Aktiviraj Pro</button>
          </div>
        </div>
      </div>
      <p class="muted" style="margin-top:8px">Aktivacija poteka prek Stripe (splet) ali IAP (mobilne aplikacije). Cene se lahko razlikujejo glede na dr≈æavo/davek.</p>
    </section>

    <!-- OBRAZEC: Dogodek / Storitev -->
    <section class="card panel" id="orgPanel" style="display:none">
      <div class="title">Objavi dogodek ali storitev</div>
      <p class="muted"><b>Objava je brezplaƒçna.</b> Dodatno lahko izbere≈° plaƒçljive <a href="#plans" id="linkPlansInline">pakete</a> za analitiko, izpostavitve in sinhronizacijo koledarja (Grow/Pro).</p>

      <!-- Tip vnosa -->
      <div class="row row--3">
        <label>Tip vnosa *
          <select id="entryType" required>
            <option value="event" selected>Dogodek</option>
            <option value="service">Storitev</option>
          </select>
        </label>
        <input id="orgName" placeholder="Ime organizatorja / ponudnika *" required>
        <input id="orgFullName" placeholder="Ime in priimek (kontaktna oseba) *" required>
      </div>

      <div class="row row--3">
        <input id="orgEmail" type="email" placeholder="E-po≈°ta za potrditev *" required>
        <input id="eventName" placeholder="Naslov (dogodek ali storitev) *" required>
        <input id="venue" placeholder="Lokacija (ime prizori≈°ƒça ali salona) *" required>
      </div>

      <div class="row row--3">
        <select id="country" required>
          <option value="">Dr≈æava (izberi) *</option>
          <option value="SI" selected>Slovenija (SI)</option><option value="AT">Avstrija (AT)</option>
          <option value="HR">Hrva≈°ka (HR)</option><option value="IT">Italija (IT)</option>
          <option value="HU">Mad≈æarska (HU)</option><option value="DE">Nemƒçija (DE)</option>
          <option value="FR">Francija (FR)</option><option value="GB">Zdru≈æeno kraljestvo (GB)</option>
          <option value="US">ZDA (US)</option>
        </select>
        <!-- Za dogodke obvezno; za storitve skrito -->
        <label id="startWrap">Zaƒçetek * <input id="start" type="datetime-local"></label>
        <label id="endWrap">Konƒçanje * <input id="end" type="datetime-local"></label>
      </div>

      <div class="row row--3">
        <input id="city2" placeholder="Mesto/kraj *" required>
        <input id="url" placeholder="Povezava za veƒç info / nakup (ƒçe obstaja)">
        <label>Kategorija (glede na tip) *
          <select id="category" required></select>
        </label>
      </div>

      <!-- STORITVE -->
      <div class="card" id="svcBlock" style="display:none; margin-top:8px">
        <div class="title" style="margin:0">Storitve ‚Äì razpolo≈æljivost & kupon</div>

        <div class="row">
          <label class="inline"><input type="radio" name="svcAvail" value="call" checked> <span style="margin-top:6px">Pokliƒçi za rezervacijo</span></label>
          <label class="inline"><input type="radio" name="svcAvail" value="calendar"> <span style="margin-top:6px">Koledar terminov</span></label>
        </div>

        <div id="svcCallRow" class="row row--2" style="margin-top:10px">
          <input id="svcPhone" placeholder="Telefon za rezervacije (npr. +386 40 000 000)">
          <div></div>
        </div>

        <div id="svcCalendarRow" class="row" style="display:none; margin-top:10px">
          <a class="btn mini link" href="/calendar.html" target="_blank">Odpri koledar</a>
        </div>

        <div class="row row--2" style="margin-top:8px">
          <label>Tip cenika (opcijsko)
            <select id="svcPriceType">
              <option value="RATECARD" selected>Po ceniku (zunanji cenik)</option>
              <option value="FIXED">Fiksna cena</option>
              <option value="FREE">Brezplaƒçno</option>
            </select>
          </label>
          <input id="svcRateUrl" placeholder="Povezava na cenik (opcijsko)">
        </div>
        <div class="row row--2" id="svcFixedRow" style="display:none">
          <div class="euro"><input id="svcFixedPrice" type="number" min="0" step="0.01" placeholder="Cena (v ‚Ç¨)"><span>‚Ç¨</span></div>
          <div></div>
        </div>

        <!-- Kupon pri storitvi -->
        <div class="row" id="svcCouponCfg" style="margin-top:6px">
          <div class="title" style="margin:0">Kupon</div>
          <div class="row row--3">
            <label>Tip kupona
              <select id="couponKind">
                <option value="PERCENT" selected>% popusta</option>
                <option value="VALUE">Vrednost v ‚Ç¨</option>
                <option value="FREEBIE">Konkretno (npr. 2 za 1 / gratis)</option>
              </select>
            </label>
            <label id="lblPercent">% popusta
              <input id="couponPercent" type="number" min="1" max="100" step="1" placeholder="npr. 20">
            </label>
            <label id="lblValue" style="display:none">Vrednost (‚Ç¨)
              <input id="couponValue" type="number" min="0.1" step="0.01" placeholder="npr. 5.00">
            </label>
            <label id="lblFreebie" style="display:none">Konkretno (opis)
              <input id="couponFreebie" placeholder="npr. 2 za 1, gratis kosilo ‚Ä¶">
            </label>
          </div>
        </div>
      </div>

      <!-- TIP PONUDBE ‚Äì samo za dogodke -->
      <div class="row row--2" id="offerRow">
        <label>Tip ponudbe
          <select id="offerType">
            <option value="none" selected>Brez plaƒçila</option>
            <option value="ticket">Vstopnice ‚Äì prodaja prek NearGo</option>
            <option value="coupon">Kupon ‚Äì unovƒçljiv prek NearGo</option>
          </select>
        </label>
        <div class="euro" id="priceWrap">
          <input id="price" type="number" min="0" step="0.01" placeholder="Cena (ena cena)">
          <span>‚Ç¨</span>
        </div>
      </div>

      <!-- Kupon za DOGODEK -->
      <div class="row" id="evtCouponBlock" style="display:none">
        <div class="title" style="margin:0">Kupon</div>
        <div class="row row--3" style="margin-top:6px">
          <label>Tip kupona
            <select id="evtCouponKind" name="couponKind">
              <option value="">(izberi)</option>
              <option value="PERCENT">Popust v %</option>
              <option value="VALUE">Vrednost v ‚Ç¨</option>
              <option value="FREEBIE">Konkretno (gratis)</option>
            </select>
          </label>
          <label id="evtLblPercent" style="display:none">% popusta
            <input id="evtCouponPercent" name="couponPercentOff" type="number" min="1" max="100" step="1" placeholder="npr. 20">
          </label>
          <label id="evtLblValue"   style="display:none">Vrednost (‚Ç¨)
            <input id="evtCouponValue" name="couponValueEur" type="number" min="0.1" step="0.01" placeholder="npr. 5.00">
          </label>
          <label id="evtLblFreebie" style="display:none">Konkretno (opis)
            <input id="evtCouponFreebie" name="couponFreebieLabel" placeholder="npr. 2 za 1 ‚Ä¶">
          </label>
        </div>
      </div>

      <!-- VSTOPNICE (dogodki) -->
      <div class="row" id="ticketPricesBlock" style="display:none">
        <div class="title" style="margin:0">Cenik vstopnic</div>
        <div id="ticketStepList" class="row" style="margin-top:6px"></div>
        <button class="btn mini link" id="btnAddTicketPrice" type="button" style="margin-top:6px">+ Dodaj ceno</button>
      </div>

      <div class="row row--2">
        <input id="stock" type="number" min="0" step="1" placeholder="Zaloga (≈°t. kosov)" required>
        <input id="maxPerOrder" type="number" min="1" step="1" placeholder="Max na naroƒçilo">
      </div>
      <div class="row">
        <div class="file-wrap">
          <input id="image" type="file" accept="image/*">
          <span id="fileName" class="file-name">Fotografija ni izbrana</span>
          <img id="imgPreview" alt="" style="display:none;width:56px;height:56px;border-radius:8px;border:1px solid var(--chipborder);object-fit:cover">
        </div>
      </div>
      <div class="inline" style="margin-top:6px">
        <label class="inline" style="gap:8px; align-items:center">
          <input type="checkbox" id="featured">
          <span>Izpostavi (7 dni)</span>
        </label>
        <span id="featMsg" class="muted" style="margin-left:8px"></span>
        <a href="#plans" id="featPlansLink" class="muted" style="margin-left:8px; text-decoration:underline">paketi</a>
      </div>
      <div class="row" style="margin-top:8px">
        <textarea id="desc" placeholder="Opis *" maxlength="800" required></textarea>
        <div class="muted" id="descCount" style="font-size:12px; text-align:right">0 / 800</div>
      </div>
      <div class="inline" style="margin-top:6px">
        <label class="inline" style="gap:8px; align-items:center">
          <input type="checkbox" id="agreeFees">
          <span>Strinjam se s <a href="#provider-terms" id="showProviderTerms">Pogoji za plaƒçljive ponudbe</a>.</span>
        </label>
      </div>
      <div style="margin-top:10px">
        <button class="btn" id="btnSubmitEvent">Objavi</button>
        <span id="orgMsg" class="muted" style="margin-left:10px"></span>
      </div>
    </section>

    <!-- PREMIUM -->
    <section class="card panel" id="premiumPanel" style="display:none">
      <div class="title" style="display:flex;justify-content:space-between;align-items:center">
        <span>Premium</span>
        <button class="btn mini link" id="btnClosePremium">Zapri</button>
      </div>
      <div class="row">
        <p><b>Premium = 5 ‚Ç¨ / mesec</b></p>
        <ul style="margin:0 0 0 18px; color:var(--muted); line-height:1.6">
          <li><b>Brezplaƒçni kuponi</b> (izdaja 0 ‚Ç¨ namesto 2 ‚Ç¨).</li>
          <li><b>Prednostna obvestila</b> o novih ponudbah v bli≈æini (tudi pred javno objavo).</li>
          <li><b>Ekskluzivne akcije</b> in ‚Äúhappy hour‚Äù termini storitev.</li>
        </ul>
        <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button class="btn" id="btnGoPremium">Naroƒçi Premium</button>
          <button class="btn link" id="btnEarlyNotify">Vkljuƒçi predƒçasna obvestila</button>
          <span class="muted" id="premMsg" style="margin-left:10px"></span>
        </div>
      </div>
    </section>

    <!-- Zakaj NearGo (uporabniki) -->
    <section class="card" id="benefitsUser">
      <div class="title">Zakaj NearGo?</div>
      <ul class="benefits" style="margin:8px 0 0 18px; color:var(--muted); line-height:1.6">
        <li><b>Prihranki s kuponi</b> ‚Äî ekskluzivni popusti pri dogodkih in storitvah.</li>
        <li><b>Brezplaƒçne promocijske ponudbe</b> (omejen ƒças) ‚Äî odkrij top akcije v bli≈æini.</li>
        <li><b>Zbiraj toƒçke</b> z ocenami in deljenji ter jih unovƒçi za ugodnosti.</li>
        <li><b>Vse blizu tebe</b> ‚Äî geolokacijsko iskanje, zemljevid, hitri filtri.</li>
        <li><b>Dodaj v koledar</b> in <b>povabi prijatelje</b> z enim klikom.</li>
      </ul>
    </section>

    <!-- Zakaj NearGo (ponudniki) -->
    <section class="card panel" id="benefitsOrg" style="display:none">
      <div class="title">Zakaj NearGo za ponudnike?</div>
      <ul class="benefits" style="margin:8px 0 0 18px; color:var(--muted); line-height:1.6">
        <li><b>Poveƒçanje prodaje</b> z veƒçjo vidnostjo in lokalnimi priporoƒçili.</li>
        <li><b>Zapolnitev praznih terminov</b> z akcijami in ‚Äúhappy hour‚Äù ponudbami.</li>
        <li><b>Promocija</b> z izpostavitvami in priporoƒçili v bli≈æini.</li>
        <li><b>Analitika</b> ogledov, konverzij, unovƒçitev kuponov.</li>
        <li><b>QR skeniranje</b> vstopnic in kuponov za hitro validacijo.</li>
      </ul>
    </section>

    <!-- Pogoji -->
    <section class="card panel" id="providerTermsPanel" style="display:none">
      <div class="title" style="display:flex;justify-content:space-between;align-items:center">
        <span>Pogoji za plaƒçljive ponudbe</span>
        <button class="btn mini link" id="closeProviderTerms">Zapri</button>
      </div>
      <div class="muted" style="font-size:14px; line-height:1.55">
        <p><b>1.</b> Organizator/ponudnik jamƒçi za toƒçnost cen, razpolo≈æljivost in zakonitost ponudbe. NearGo je posrednik za izdajo vstopnic/kuponov.</p>
        <p><b>2.</b> Plaƒçila vstopnic/kuponov se obdelajo prek Stripe; raƒçun in QR-koda sta poslana na e-po≈°to kupca.</p>
        <p><b>3.</b> Naroƒçnine in promovirane izpostavitve se izvajajo prek Apple/Google plaƒçilnih sistemov (IAP) v nativnih aplikacijah.</p>
        <p><b>4.</b> Vraƒçila, spremembe in odpovedi ureja organizator po zakonodaji; stro≈°ki procesiranja se ne vraƒçajo, razen ƒçe zakon doloƒça drugaƒçe.</p>
        <p><b>5.</b> NearGo si pridr≈æuje pravico do zaƒçasne skritosti ali odstranitve ob sumu zlorabe.</p>
        <p><b>6.</b> Kontakt: <a href="mailto:info@getneargo.com">info@getneargo.com</a>.</p>
      </div>
    </section>

    <!-- Footer -->
    <footer class="legal" style="text-align:center; color:var(--muted); margin-top:18px; font-size:14px">
      ¬© NearGo ‚Ä¢ <a href="/terms.html#terms">Pogoji uporabe</a> ‚Ä¢ <a href="/terms.html#privacy">Zasebnost</a> ‚Ä¢
      <a href="mailto:info@getneargo.com">info@getneargo.com</a>
    </footer>
  </main>

  <!-- Map picker modal (z interaktivnim krogom) -->
  <div class="modal" id="pickModal" role="dialog" aria-modal="true" aria-label="Izberi lokacijo">
    <div class="box">
      <div class="bar">
        <span>Izberi lokacijo za iskanje</span>
        <button class="btn mini link" id="pickClose">Zapri</button>
      </div>
      <div class="content">
        <div class="row2">
          <input id="pickSearch" type="search" placeholder="npr. Celje, Ljubljana, Vienna ‚Ä¶">
          <button class="btn mini link" id="pickUseGPS">üìç Moja lokacija</button>
        </div>
        <div id="pickMap" style="height:360px; border:1px solid var(--chipborder); border-radius:12px"></div>
        <div class="muted" style="font-size:12px;margin:6px 0">Povleci sredinsko ikono za premik ‚Ä¢ Povleci okrogel roƒçaj za polmer</div>
        <div class="row2">
          <button class="btn mini link" id="pickMinus">‚àí</button>
          <div class="muted" id="pickRadiusLbl" style="flex:1;text-align:center">Polmer: ‚Äî km</div>
          <button class="btn mini link" id="pickPlus">+</button>
          <button class="btn" id="pickApply">Uporabi</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Slot picker -->
  <div class="modal" id="slotModal" role="dialog" aria-modal="true" aria-label="Izberi termin">
    <div class="box">
      <div class="bar">
        <span>Izberi termin</span>
        <button class="btn mini link" id="slotClose">Zapri</button>
      </div>
      <div class="content">
        <div id="slotList" class="row"></div>
        <div class="row2" style="display:flex;gap:10px;align-items:center;margin-top:6px">
          <button class="btn mini link" id="slotCancel">Prekliƒçi</button>
          <button class="btn" id="slotConfirm" disabled>Nadaljuj</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cookie banner -->
  <div id="cookieBanner" class="card" style="position:fixed;bottom:12px;left:12px;right:12px;z-index:1001;display:none;padding:12px;border-radius:12px;border:1px solid var(--chipborder);background:var(--card);box-shadow:var(--shadow)">
    <p style="margin:0 0 6px 0;font-size:14px;line-height:1.4">
      Ta aplikacija uporablja le nujne pi≈°kotke (seja, jezik, tema). Aplikacija uporablja <b>lokacijo</b> (GPS) in po potrebi <b>kamero</b> (QR skeniranje) ‚Äì obe le z va≈°o privolitvijo.
    </p>
    <button class="btn mini" id="cookieAccept">Razumem</button>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
/* ===== GLOBAL SAFE-GUARDS ===== */
(function(){
  window._toast = function(msg, ok){
    var t = document.getElementById('toast'); if(!t) return;
    t.textContent = msg;
    t.className = 'toast ' + (ok===false ? 'bad' : 'ok');
    t.style.display = 'flex';
    setTimeout(function(){ t.style.display='none'; }, 4000);
  };
  window.onerror = function(message){ try { window._toast('Napaka: ' + message, false); } catch(e){} };
})();

/* ===== UTIL ===== */
function $ (s){ return document.querySelector(s); }
function $$ (s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }
function el(t,c){ var x=document.createElement(t); if(c) x.className=c; return x; }
function eu(v){ return isFinite(+v)? new Intl.NumberFormat('sl-SI',{style:'currency',currency:'EUR'}).format(+v) : ''; }
function qs(o){ return new URLSearchParams(o).toString(); }
function debounce(fn,ms){ var t; return function(){ clearTimeout(t); var a=arguments; t=setTimeout(function(){ fn.apply(null,a); }, ms||350); }; }
function downloadFile(name,content,type){ var blob=new Blob([content],{type:type||"text/calendar"}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(a.href); a.remove();},0); }
function headerH(){ var h=document.querySelector('header'); return h ? h.getBoundingClientRect().height : 64; }
function clamp(n,min,max){ return Math.min(Math.max(n,min),max); }
function isExternalAPI(e){ var u=((e&&e.url)||'').toLowerCase(); return u.indexOf('ticketmaster')>=0 || u.indexOf('eventbrite')>=0; }

/* Stabilen ID + register */
var ITEMS_BY_ID = new Map();
function hashId(e){
  if (e.id) return 'ev-' + String(e.id).replace(/[^a-z0-9]/gi,'');
  var t = (e.name||e.title||'').toLowerCase().replace(/[^a-z0-9]/g,'');
  var s = String(e.start||'').replace(/[^0-9]/g,'');
  return ('ev-'+t+'-'+s).slice(0,64);
}

/* ===== STATE ===== */
var GEO=null, currentPage=0, PAGE_SIZE=10, lastResults=[];
var mapSearch=null, markersSearch=[];
var topMap=null, topMarkers=[];
var ACTIVE_MODE='events'; // 'events' | 'services'
var IS_PREMIUM=false; var PROVIDER_PLAN='free';

/* ===== Datumi ===== */
function parseDateAny(v){
  if(!v) return NaN; if(v instanceof Date) return +v;
  var t=Date.parse(v); if(!isNaN(t)) return t;
  var s=String(v).trim();
  var m=s.match(/^(\d{1,2})[.\-/ ](\d{1,2})[.\-/ ](\d{2,4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if(m){ var d=m[1], mo=m[2], y=m[3], h=m[4]||'00', mi=m[5]||'00', se=m[6]||'00'; if(y.length===2)y='20'+y; return +new Date(+y,+mo-1,+d,+h,+mi,+se); }
  return NaN;
}
function getEndTs(e){
  if(e.type==="service" || e.entryType==="service"){
    var slots=(e.service&&e.service.slots)||[];
    var future=slots.map(function(s){return parseDateAny(s.end||s.start);}).filter(function(t){return isFinite(t)&&t>=Date.now();});
    if(future.length) return Math.max.apply(Math,future);
    return NaN;
  }
  var c=e.end||e.until||e.endsAt||e.ends_at||e.finish||e.stop||e.endDate||e.end_time||e.start;
  var t=parseDateAny(c); return isFinite(t)?t:NaN;
}
function formatDateRange(start,end){
  if(!start) return ""; var s=new Date(start); if(isNaN(+s)) return "";
  var D=new Intl.DateTimeFormat("sl-SI",{day:"2-digit",month:"2-digit",year:"numeric"});
  var T=new Intl.DateTimeFormat("sl-SI",{hour:"2-digit",minute:"2-digit"});
  if(end){ var e=new Date(end); if(!isNaN(+e)) return (s.toDateString()==e.toDateString())? (D.format(s)+" "+T.format(s)+"‚Äì"+T.format(e)) : (D.format(s)+" "+T.format(s)+" ‚Äî "+D.format(e)+" "+T.format(e)); }
  return D.format(s)+" "+T.format(s);
}
function addToCalendar(opts){
  if(!opts || !opts.start) return;
  function dt(s){ return new Date(s).toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z$/,'Z'); }
  var ics="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//NearGo//sl\nBEGIN:VEVENT\nSUMMARY:"+ (opts.title||'') +"\nDTSTART:"+dt(opts.start)+"\n"+(opts.end?("DTEND:"+dt(opts.end)+"\n"):"")+"LOCATION:"+(opts.loc||'')+"\nEND:VEVENT\nEND:VCALENDAR";
  downloadFile((opts.title||'NearGo')+'.ics', ics.replace(/\n/g,"\r\n"));
}

/* ===== Tema ===== */
(function(){
  var btn=$("#btnThemeToggle"), icon= btn ? btn.querySelector('#themeIcon') : null;
  function apply(mode){ document.body.classList.toggle('dark', mode==='dark'); try{localStorage.setItem('theme',mode);}catch(e){}; if(icon) icon.textContent = (mode==='dark'?'‚òÄÔ∏è':'üåô'); }
  try{ apply(localStorage.getItem('theme')||'light'); }catch(e){ apply('light'); }
  if (btn) btn.addEventListener('click', function(){ apply(document.body.classList.contains('dark')?'light':'dark'); }, false);
})();

/* ===== Jeziki ===== */
(function(){
  var wrap=$("#langWrap"), menu=$("#langMenu"), hidden=$("#lang"), label=$("#langLabel");
  var SUP=[["sl","SL"],["en","EN"],["de","DE"],["hr","HR"],["it","IT"],["hu","HU"],["fr","FR"],["es","ES"],["pt","PT"],["nl","NL"],["pl","PL"],["cs","CS"],["sk","SK"],["ro","RO"],["bg","BG"],["sr","SR"],["bs","BS"],["uk","UK"]];
  if(menu && !menu.children.length){ menu.innerHTML=SUP.map(function(p){return '<button type="button" data-val="'+p[0]+'">'+p[1]+'</button>';}).join(""); }
  if(hidden && !hidden.children.length){ hidden.innerHTML=SUP.map(function(p,i){return '<option value="'+p[0]+'" '+(i===0?'selected':'')+'>'+p[1]+'</option>';}).join(""); }
  var pref=(navigator.language||"sl").slice(0,2).toLowerCase();
  try{
    var init=localStorage.getItem('lang'); if(!init){ for(var i=0;i<SUP.length;i++){ if(SUP[i][0]===pref){ init=pref; break; } } }
    if(!init) init='sl'; if(hidden) hidden.value=init; if(label) label.textContent=init.toUpperCase();
  }catch(e){}
  var open=false; function setOpen(s){ open=(typeof s!=='undefined')?s:!open; if(menu) menu.style.display=open?"block":"none"; }
  if (wrap) wrap.addEventListener("click",function(e){ if(!e.target.closest || !e.target.closest(".lang-menu")){ e.stopPropagation(); setOpen(); } }, false);
  document.addEventListener("click",function(e){ if(!wrap || !wrap.contains(e.target)) setOpen(false); }, false);
  if (menu) menu.addEventListener("click",function(e){
    var b=e.target.closest ? e.target.closest("button[data-val]") : null; if(!b) return;
    if(hidden) hidden.value=b.getAttribute('data-val'); if(label) label.textContent=b.textContent;
    try{ localStorage.setItem("lang", b.getAttribute('data-val')); }catch(err){}
    if (hidden) hidden.dispatchEvent(new Event("change",{bubbles:true})); setOpen(false);
  }, false);
})();

/* ===== Toast hash ===== */
(function(){
  if(location.hash==="#success"){ window._toast("‚úÖ Uspe≈°no ‚Äì potrdilo poslano na e-po≈°to.", true); history.replaceState(null,"",location.pathname+location.search); }
  if(location.hash==="#cancel"){ window._toast("Plaƒçilo preklicano. ‚ùå", false); history.replaceState(null,"",location.pathname+location.search); }
})();

/* ===== Paneli ===== */
function scrollToEl(node){
  var y=node.getBoundingClientRect().top + window.pageYOffset - (headerH()+12);
  window.scrollTo({top:y, behavior:"smooth"});
}
function hideAllPanels(){
  ['mapPanel','orgPanel','providerTermsPanel','orgHub','premiumPanel','benefitsOrg','plansPanel'].forEach(function(pid){
    var n=$("#"+pid); if(n){ n.classList.remove("show"); n.style.display="none"; }
  });
  var bu=$("#benefitsUser"), bo=$("#benefitsOrg"); if(bu) bu.style.display="block"; if(bo) bo.style.display="none";
}
function showPanel(id){
  hideAllPanels();
  if(id==="orgHub" || id==="orgPanel"){ var bu=$("#benefitsUser"), bo=$("#benefitsOrg"); if(bu) bu.style.display="none"; if(bo) bo.style.display="block"; }
  var e=$("#"+id); if(!e) return; e.classList.add("show"); e.style.display="block"; scrollToEl(e);
}
(function wireHeaderButtons(){
  var b;
  b=$("#btnStart"); if(b) b.addEventListener("click",function(){ var p=$("#searchPanel"); if(p) scrollToEl(p); }, false);
  b=$("#btnProvidersTop"); if(b) b.addEventListener("click",function(ev){ ev.preventDefault(); showPanel('orgHub'); }, false);
  b=$("#hubPublish"); if(b) b.addEventListener("click",function(){ showPanel('orgPanel'); }, false);
  b=$("#btnPremiumTop"); if(b) b.addEventListener("click",function(ev){ ev.preventDefault(); showPanel('premiumPanel'); }, false);
  b=$("#btnClosePremium"); if(b) b.addEventListener("click",function(){ var hero=$("#hero"); if(hero) scrollToEl(hero); }, false);
  b=$("#btnCloseMap"); if(b) b.addEventListener("click",function(){ var sp=$("#searchPanel"); if(sp) scrollToEl(sp); }, false);
  b=$("#showProviderTerms"); if(b) b.addEventListener("click",function(ev){ ev.preventDefault(); showPanel('providerTermsPanel'); }, false);
  b=$("#closeProviderTerms"); if(b) b.addEventListener("click",function(ev){ ev.preventDefault(); showPanel('orgPanel'); }, false);
  b=$("#hubPlans"); if(b) b.addEventListener("click",function(){ showPanel('plansPanel'); }, false);
  b=$("#btnClosePlans"); if(b) b.addEventListener("click",function(){ showPanel('orgHub'); }, false);
  b=$("#linkPlansInline"); if(b) b.addEventListener("click",function(ev){ ev.preventDefault(); showPanel('plansPanel'); }, false);
  b=$("#featPlansLink"); if(b) b.addEventListener("click",function(ev){ ev.preventDefault(); showPanel('plansPanel'); }, false);
})();

/* Lokacijski gumbi */
function setLocButtonsActive(which){
  var a=$("#btnPickOnMap"), b=$("#btnUseLocation");
  if (a) a.classList.toggle("active", which==='pick');
  if (b) b.classList.toggle("active", which==='gps');
}

/* Drsniki */
var radius=$("#radius"), radiusLbl=$("#radiusLbl"),
    radiusCity=$("#radiusCity"), radiusCityLbl=$("#radiusCityLbl"),
    cityInput=$("#city");
function formatKm(n){ return String(n)+" km"; }
if (radius) radius.addEventListener('input',function(){ radiusLbl.textContent=formatKm(radius.value); }, false);
if (radiusCity) radiusCity.addEventListener('input',function(){ radiusCityLbl.textContent=formatKm(radiusCity.value); }, false);

/* Geolokacija */
var btnUseLoc=$("#btnUseLocation");
if (btnUseLoc) btnUseLoc.addEventListener("click", function(){
  try{
    navigator.geolocation.getCurrentPosition(function(pos){
      GEO = { lat: pos.coords.latitude, lon: pos.coords.longitude };
      var txt=$("#btnUseLocation .txt"); if(txt) txt.textContent="Uporabljam tvojo lokacijo ‚úì";
      var cr=$("#cityRadiusWrap"); if(cr) cr.style.display='none';
      if(radiusLbl) radiusLbl.textContent = formatKm(radius.value);
      setLocButtonsActive('gps');
      doSearch(0);
    }, function(){ window._toast("Lokacije ni bilo mogoƒçe pridobiti.", false); }, {enableHighAccuracy:true,timeout:15000});
  }catch(e){}
}, false);

/* ======= Map picker z interaktivnim krogom ======= */
var pickMap=null, pickMarker=null, pickEdgeMarker=null, pickCircle=null, pickRadius=30, pickRadiusM=30000;
var btnPick=$("#btnPickOnMap");
if (btnPick) btnPick.addEventListener("click", function(){
  var m=$("#pickModal"); if(m){ m.style.display="flex"; setTimeout(initPickMap,50); setLocButtonsActive('pick'); }
}, false);
var bpc=$("#pickClose"); if(bpc) bpc.addEventListener("click", function(){ var m=$("#pickModal"); if(m) m.style.display="none"; }, false);
var bpGPS=$("#pickUseGPS"); if(bpGPS) bpGPS.addEventListener("click", function(){
  try{
    navigator.geolocation.getCurrentPosition(function(pos){
      var p=[pos.coords.latitude, pos.coords.longitude];
      if (!pickMap) return;
      pickMap.setView(p, 12);
      if (pickMarker) pickMarker.setLatLng(p); else pickMarker=L.marker(p,{draggable:true}).addTo(pickMap);
      refreshPickOverlay();
    }, function(){});
  }catch(e){}
}, false);
var bpm=$("#pickMinus"); if(bpm) bpm.addEventListener("click", function(){ pickRadius = clamp(pickRadius-5, 5, 400); pickRadiusM=pickRadius*1000; var l=$("#pickRadiusLbl"); if(l) l.textContent="Polmer: "+pickRadius+" km"; refreshPickOverlay(); }, false);
var bpp=$("#pickPlus");  if(bpp) bpp.addEventListener("click", function(){ pickRadius = clamp(pickRadius+5, 5, 400); pickRadiusM=pickRadius*1000; var l=$("#pickRadiusLbl"); if(l) l.textContent="Polmer: "+pickRadius+" km"; refreshPickOverlay(); }, false);
var bpa=$("#pickApply"); if(bpa) bpa.addEventListener("click", function(){
  if(!pickMarker){ window._toast("Klikni na zemljevid, da oznaƒçi≈° toƒçko.", false); return; }
  var ll = pickMarker.getLatLng();
  GEO = { lat: ll.lat, lon: ll.lng };
  if(cityInput) cityInput.value = ll.lat.toFixed(4)+", "+ll.lng.toFixed(4);
  if(radiusCity){ radiusCity.value = Math.round(pickRadius); radiusCityLbl.textContent=formatKm(pickRadius); }
  var pm=$("#pickModal"); if(pm) pm.style.display="none";
  doSearch(0);
}, false);

function initPickMap(){
  if (pickMap) return;
  pickMap = L.map('pickMap').setView([46.0569,14.5058], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap' }).addTo(pickMap);
  pickMap.on('click', function(e){
    if(pickMarker) pickMarker.setLatLng(e.latlng);
    else pickMarker = L.marker(e.latlng,{draggable:true}).addTo(pickMap);
    refreshPickOverlay();
  });
  var l=$("#pickRadiusLbl"); if(l) l.textContent="Polmer: "+pickRadius+" km";
  refreshPickOverlay();
}
function refreshPickOverlay(){
  if(!pickMap) return;
  var center = pickMarker ? pickMarker.getLatLng() : pickMap.getCenter();
  if (pickCircle) pickCircle.remove();
  pickCircle = L.circle(center, { radius: pickRadiusM, color:'#0bbbd6', fillOpacity:0.06 }).addTo(pickMap);
  if (pickEdgeMarker) pickEdgeMarker.remove();
  var east = L.latLng(center.lat, center.lng + 0.3);
  pickEdgeMarker = L.marker(east, { draggable:true, icon: L.divIcon({ className:'radius-handle' }) }).addTo(pickMap);

  if (pickMarker){
    pickMarker.on('drag', function(e){ pickCircle.setLatLng(e.target.getLatLng()); var c=e.target.getLatLng(); var east=L.latLng(c.lat, c.lng+0.3); pickEdgeMarker.setLatLng(east); });
    pickMarker.on('dragend', function(){});
  }
  pickEdgeMarker.on('drag', function(e){
    var r = pickMap.distance(pickCircle.getLatLng(), e.target.getLatLng());
    pickRadiusM = clamp(r, 1000, 400000);
    pickRadius = Math.round(pickRadiusM/1000);
    pickCircle.setRadius(pickRadiusM);
    var l=$("#pickRadiusLbl"); if(l) l.textContent="Polmer: "+pickRadius+" km";
  });
}

/* Hitri datumi */
(function quickDates(){
  var btns = $$('.quickDate'); if(!btns.length) return;
  var from = $('#dateFrom'), to = $('#dateTo');
  function fmt(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0'); }
  function setRange(mode){
    var now=new Date(), a=new Date(now), b=new Date(now);
    if (mode==='today'){ a.setHours(0,0,0,0); b.setHours(23,59,59,999); }
    else if (mode==='weekend'){
      var day=now.getDay(); var sat=new Date(now); sat.setDate(now.getDate() + ((6 - (day||7)) % 7));
      var sun=new Date(sat); sun.setDate(sat.getDate()+1);
      a=new Date(sat.getFullYear(), sat.getMonth(), sat.getDate());
      b=new Date(sun.getFullYear(), sun.getMonth(), sun.getDate(), 23,59,59,999);
    } else if (!isNaN(Number(mode))) { a=new Date(); b=new Date(); b.setDate(b.getDate()+Number(mode)); }
    if(from) from.value=fmt(a); if(to) to.value=fmt(b);
  }
  btns.forEach(function(b){
    b.addEventListener('click', function(){
      btns.forEach(function(x){ x.classList.remove('active'); });
      b.classList.add('active');
      setRange(b.getAttribute('data-mode')||'today');
      doSearch(0);
    }, false);
  });
})();

/* Kategorije (za iskalnik) */
var CATS_EVENTS = ["Vse","Koncerti","Hrana & pijaƒça","Dru≈æina/otroci","≈†port","Kultura","Sejmi","Ostalo"];
var CATS_SERVS  = ["Vse","Lepota","Zdravje","Wellness","≈†port & fit","Uƒçenje","Servis","Ostalo"];
function renderCats(){
  var elc = $("#cats"); if (!elc) return; elc.innerHTML='';
  var list = (ACTIVE_MODE==='events'?CATS_EVENTS:CATS_SERVS);
  list.forEach(function(name, idx){
    var b = el('button','chip'); b.textContent=name; if(idx===0) b.classList.add('active');
    b.addEventListener('click', function(){
      $$('#cats .chip').forEach(function(c){c.classList.remove('active');}); b.classList.add('active'); doSearch(0);
    }, false);
    elc.appendChild(b);
  });
}
$$('.mode').forEach(function(btn){
  btn.addEventListener('click', function(){
    $$('.mode').forEach(function(x){x.classList.remove('active');});
    btn.classList.add('active');
    ACTIVE_MODE = btn.getAttribute('data-mode');
    renderCats();
    showPanel('searchPanel');
    doSearch(0);
  }, false);
});
renderCats();

/* ==== POMO≈ΩNO: normalizacija in kartice ==== */
function isFuture(e){ var end=getEndTs(e); return isFinite(end)? end>=Date.now() : true; }
function normalizeExt(x){
  return {
    id: x.id || hashId(x),
    title: x.title || x.name || '',
    name: x.name || x.title || '',
    start: x.start || x.date || '',
    end:   x.end || x.until || '',
    venue: { address: (x.venue && x.venue.address) || x.place || '', lat: (x.venue && x.venue.lat) || x.lat || null, lon: (x.venue && x.venue.lon) || x.lon || null },
    images: x.images || (x.image?[x.image]:[]),
    url: x.url || '',
    offerType: x.offerType || (x.type==='coupon'?'coupon':(Number(x.price||0)>0?'ticket':'none')),
    price: Number(x.price||0) || null,
    type: x.type || 'event',
    description: x.description || x.desc || '',
    ticketPrices: x.ticketPrices || [],
    couponKind: x.couponKind, couponPercentOff: x.couponPercentOff, couponValueEur:x.couponValueEur, couponFreebieLabel:x.couponFreebieLabel
  };
}
function offerChipText(e){
  if ((e.offerType||e.type)==='coupon'){
    if (IS_PREMIUM) return "Kupon: 0 ‚Ç¨ (Premium)";
    if (e.couponKind==='PERCENT' && Number(e.couponPercentOff)) return "Kupon: -"+e.couponPercentOff+"%";
    if (e.couponKind==='VALUE'   && Number(e.couponValueEur))   return "Kupon: "+eu(e.couponValueEur);
    if (e.couponKind==='FREEBIE' && e.couponFreebieLabel)       return "Kupon: "+e.couponFreebieLabel;
    return 'Kupon';
  }
  if ((e.offerType||e.type)==='ticket'){
    return Number(e.price||0)>0 ? ("Vstopnica: "+eu(e.price)) : 'Vstopnica';
  }
  return '';
}
function cardActionBar(e){
  var id = hashId(e);
  var chip = offerChipText(e);
  var where=(e.venue&&e.venue.address)||'';
  var when = formatDateRange(e.start, e.end);
  var btns = '';
  btns += '<button class="btn mini link" data-ical="'+id+'">Dodaj v koledar</button>';
  btns += '<button class="btn mini link" data-share="'+id+'">Povabi ≈°e nekoga</button>';
  btns += where && e.venue.lat && e.venue.lon ? '<button class="btn mini link" data-map="'+id+'">Zemljevid</button>' : '';
  return '<div class="buy">'+(chip?'<span class="value-chip">'+chip+'</span>':'')+btns+'</div>';
}
function renderCard(e){
  var id = hashId(e); ITEMS_BY_ID.set(id, e);
  var img  = (e.images && e.images[0]) || 'https://picsum.photos/800/400?blur=2';
  var title= e.title || e.name || '';
  var where=(e.venue&&e.venue.address)||'';
  var when = formatDateRange(e.start, e.end);
  var more = (e.description||'').trim();
  var buyRows = '';

  if (isExternalAPI(e)){
    // Zunanji vir: odprimo njihovo stran
    buyRows += '<div class="buy"><span class="value-chip">'+(offerChipText(e)||'Veƒç informacij')+'</span> '+
               '<a class="btn mini" href="'+(e.url||'#')+'" target="_blank">Kupi vstopnico</a></div>';
  } else if ((e.offerType||e.type)==='ticket'){
    var tps = Array.isArray(e.ticketPrices)&&e.ticketPrices.length? e.ticketPrices : (Number(e.price||0)>0 ? [{label:'Osnovna', price:+e.price}] : []);
    for (var i=0;i<tps.length;i++){
      var tp=tps[i]; var label=(tp.label||'Vstopnica'); var p=Number(tp.price||0);
      buyRows += '<div class="buy"><span class="value-chip">'+eu(p)+'</span> <button class="btn mini" data-buy="'+id+'" data-price="'+p+'" data-label="'+label+'">Kupi vstopnico ‚Äî '+label+'</button></div>';
    }
  } else if ((e.offerType||e.type)==='coupon'){
    buyRows += '<div class="buy"><span class="value-chip">'+offerChipText(e)+'</span> <button class="btn mini" data-buy="'+id+'" data-kind="coupon">Kupi kupon</button></div>';
  }

  var wrap = el('div','spot'); wrap.id='card-'+id;
  wrap.innerHTML =
    '<img src="'+img+'" alt="">'+
    '<div class="meta">'+
      '<div style="font-weight:900">'+title+'</div>'+
      '<div class="muted" style="margin-top:4px">'+(where?('<a href="https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(where)+'" target="_blank">üìç '+where+'</a>'):'')+'</div>'+
      '<div class="muted" style="margin-top:4px">'+when+'</div>'+
      '<div class="buy" style="margin-top:8px"><button class="btn mini link" data-more="'+id+'">Veƒç ‚ñæ</button> <button class="btn mini link" data-less="'+id+'" style="display:none">Skrij ‚ñ¥</button></div>'+
      (more ? '<div class="more-text" id="more-'+id+'" style="display:none;margin-top:6px">'+more+(isExternalAPI(e)?(' <a href="'+e.url+'" target="_blank">[odpri vir]</a>'):'')+'</div>' : '')+
      cardActionBar(e)+
      (buyRows? buyRows : '')+
    '</div>';
  return wrap;
}

/* ==== IZPOSTAVLJENO ==== */
async function loadFeatured(){
  try{
    var car = $("#carousel"); if(!car) return; car.innerHTML='';
    var latlon = GEO ? (GEO.lat+","+GEO.lon) : '';
    var r1=null; try{ r1 = await fetch('/.netlify/functions/provider-list?featured=1'+(latlon?('&latlon='+encodeURIComponent(latlon)+'&radiuskm=120'):'')+'&limit=100').then(function(r){return r.json();}); }catch(e){}
    var items = (r1 && r1.results) ? r1.results.filter(isFuture) : [];

    if (!items || items.length < 10){
      var ex=null; try{ ex=await fetch('/api/search?limit=40'+(latlon?('&lat='+GEO.lat+'&lon='+GEO.lon+'&radius=120'):'')).then(function(r){return r.json();}); }catch(e){}
      var ext = (ex && ex.results) ? ex.results.map(normalizeExt).filter(isFuture) : [];
      items = mergeNoDup(items||[], ext);
    }
    items = (items||[]).slice(0,12);
    items.forEach(function(e){ car.appendChild(renderCard(e)); });

    var autoplay = setInterval(function(){
      car.scrollBy({left:car.clientWidth*0.85, behavior:'smooth'});
      if(car.scrollLeft + car.clientWidth >= car.scrollWidth-5) car.scrollTo({left:0,behavior:'smooth'});
    }, 4500);
    car.addEventListener('mouseenter', function(){ clearInterval(autoplay); }, false);
    car.addEventListener('mouseleave', function(){
      clearInterval(autoplay);
      autoplay = setInterval(function(){
        car.scrollBy({left:car.clientWidth*0.85, behavior:'smooth'});
        if(car.scrollLeft + car.clientWidth >= car.scrollWidth-5) car.scrollTo({left:0,behavior:'smooth'});
      }, 4500);
    }, false);

    car.addEventListener('click', commonCardClicks, false);
  }catch(err){ /* tiho */ }
}
function mergeNoDup(a,b){
  var seen={}, out=[];
  function key(e){ return ((e.title||e.name||'').toLowerCase().trim()+'::'+String(e.start||'').slice(0,10)); }
  [].concat(a||[],b||[]).forEach(function(e){ var k=key(e); if(seen[k]) return; seen[k]=1; out.push(e); });
  return out;
}

/* ==== ISKANJE ==== */
var btnClear=$("#btnClear");
if (btnClear) btnClear.addEventListener('click', function(){
  var q=$('#q'), ci=$('#city'), df=$('#dateFrom'), dt=$('#dateTo'), fo=$('#freeOnly');
  if(q) q.value=''; if(ci) ci.value=''; if(df) df.value=''; if(dt) dt.value=''; if(fo) fo.checked=false;
  var cr=$("#cityRadiusWrap"); if(cr) cr.style.display='none';
  $$('#cats .chip').forEach(function(c,i){ c.classList.toggle('active', i===0); });
  doSearch(0);
}, false);

async function doSearch(page){
  try{
    currentPage = page||0;
    var qel=$('#q'), fo=$('#freeOnly'), catEl=$('#cats .chip.active'), df=$('#dateFrom'), dt=$('#dateTo');
    var q = qel ? qel.value.trim().toLowerCase() : '';
    var freeOnly = fo ? !!fo.checked : false;
    var cat = catEl ? catEl.textContent : 'Vse';
    var dfv = df ? df.value : ''; var dtv = dt ? dt.value : '';

    var center = GEO ? { lat:GEO.lat, lon:GEO.lon, r: (radius? +radius.value : 30) } : null;
    var ci=$('#city'), rci=$('#radiusCity');
    if (ci && ci.value.trim()){
      var m = ci.value.trim().match(/^(-?\d+(\.\d+)?),\s*(-?\d+(\.\d+)?)/);
      var rr = rci ? (+rci.value||30) : 30;
      if (m) center = { lat:+m[1], lon:+m[3], r: rr };
    }
    // ƒåe je v modalu pickCircle, ga upo≈°tevamo
    if (pickCircle){
      var c = pickCircle.getLatLng(); center = { lat:c.lat, lon:c.lng, r: Math.round((pickCircle.getRadius()||pickRadiusM)/1000) };
    }

    // 1) Na≈°i vpisi
    var p = new URLSearchParams(); if(center){ p.set('latlon', center.lat+','+center.lon); p.set('radiuskm', String(center.r)); }
    var local=null; try{ local=await fetch('/.netlify/functions/provider-list?'+p.toString()).then(function(r){return r.json();}); }catch(e){}
    var items = (local && local.results) ? local.results.filter(isFuture) : [];

    // Filtri
    items = items.filter(function(e){
      var txt = ((e.title||e.name||'')+' '+(e.description||e.desc||'')+' '+(e.category||'')).toLowerCase();
      var okQ = q ? txt.indexOf(q)>=0 : true;
      var okC = (cat==='Vse') ? true : (txt.indexOf(cat.toLowerCase())>=0);
      var okF = !freeOnly || Number(e.price||0)===0 || (e.offerType==='coupon');
      var tsS = dfv ? parseDateAny(e.start) >= parseDateAny(dfv) : true;
      var tsE = dtv ? ((parseDateAny(e.end||e.start) <= (parseDateAny(dtv)+24*3600*1000-1))) : true;
      var okMode = (ACTIVE_MODE==='events' ? (e.type!=='service') : (e.type==='service' || e.entryType==='service'));
      return okQ && okC && okF && tsS && tsE && okMode;
    });

    // 2) Veliki appi (fallback) ‚Äî samo za dogodke
    if (ACTIVE_MODE==='events' && (!items || items.length < 10)){
      var p2 = new URLSearchParams(); if(center){ p2.set('lat', center.lat); p2.set('lon', center.lon); p2.set('radius', center.r); } if(q) p2.set('q', q);
      var ex=null; try{ ex=await fetch('/api/search?limit=60&'+p2.toString()).then(function(r){return r.json();}); }catch(e){}
      var ext = (ex && ex.results) ? ex.results.map(normalizeExt).filter(isFuture) : [];
      items = mergeNoDup(items||[], ext);
    }

    lastResults = items.slice(); // za paginacijo + markerje
    renderResultsPage(0);
  }catch(err){
    window._toast('Iskanje ni uspelo.', false);
  }
}

/* Rezultati ‚Äì zemljevid (samo markerji) */
var btnTRM=$("#btnToggleResultsMap");
if (btnTRM) btnTRM.addEventListener("click",function(){
  var w=$("#mapSearchWrap"); if(!w) return;
  var show = (w.style.display==='none' || !w.style.display);
  w.style.display = show ? 'block' : 'none';
  btnTRM.textContent = show ? "Skrij zemljevid rezultatov" : "Poka≈æi zemljevid rezultatov";
  if (show && !mapSearch){
    mapSearch = L.map('mapSearch').setView([46.0569,14.5058], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap' }).addTo(mapSearch);
    setTimeout(fitSearchMarkers, 200);
  } else if (show){
    setTimeout(fitSearchMarkers, 200);
  }
}, false);

function renderResultsPage(page){
  currentPage = page||0;
  var list = $("#results"); if(!list) return; list.innerHTML='';
  var start = currentPage * PAGE_SIZE;
  var slice = lastResults.slice(start, start+PAGE_SIZE);

  if (!slice.length){
    list.innerHTML = '<div class="muted">Ni rezultatov.</div>';
    if (markersSearch.length){ markersSearch.forEach(function(m){m.remove();}); markersSearch=[]; }
    renderPager(); return;
  }

  if (markersSearch.length){ markersSearch.forEach(function(m){m.remove();}); markersSearch=[]; }
  slice.forEach(function(e){
    var card = renderCard(e); list.appendChild(card);
    if (mapSearch && e.venue && e.venue.lat && e.venue.lon){
      var id = hashId(e);
      var m = L.marker([e.venue.lat, e.venue.lon]).addTo(mapSearch)
        .bindPopup('<b>'+(e.title||e.name)+'</b><br>'+((e.venue&&e.venue.address)||'')+'<br>'+formatDateRange(e.start,e.end)+'<br><a href="#card-'+id+'" data-scroll-id="'+id+'">Prika≈æi</a>');
      markersSearch.push(m);
    }
  });

  list.addEventListener('click', commonCardClicks, false);
  if (mapSearch){
    mapSearch.off('popupopen');
    mapSearch.on('popupopen', function(e){
      var a = e.popup && e.popup._contentNode ? e.popup._contentNode.querySelector('[data-scroll-id]') : null;
      if (a){ a.addEventListener('click', function(ev){ ev.preventDefault(); var id=a.getAttribute('data-scroll-id'); var elc=document.getElementById('card-'+id); if(elc){ elc.scrollIntoView({behavior:'smooth',block:'center'}); elc.style.boxShadow='0 0 0 3px rgba(11,187,214,.4) inset'; setTimeout(function(){elc.style.boxShadow='';},1200); } }, false); }
    });
  }

  renderPager();
  fitSearchMarkers();
}
function renderPager(){
  var host=$("#pagination"); if(!host) return; host.innerHTML='';
  if (!lastResults.length) return;
  var pages = Math.ceil(lastResults.length / PAGE_SIZE);
  var prev = el('button','btn mini link'); prev.textContent='‚üµ Nazaj'; prev.disabled = currentPage<=0;
  prev.addEventListener('click', function(){ renderResultsPage(Math.max(currentPage-1,0)); }, false);
  var next = el('button','btn mini link'); next.textContent='Naprej ‚ü∂'; next.disabled = currentPage>=pages-1;
  next.addEventListener('click', function(){ renderResultsPage(Math.min(currentPage+1,pages-1)); }, false);
  var info = el('div','muted'); info.style.alignSelf='center'; info.textContent = (currentPage+1)+' / '+pages+' ‚Ä¢ '+lastResults.length+' rezultatov';
  host.appendChild(prev); host.appendChild(info); host.appendChild(next);
}
function fitSearchMarkers(){
  if (!mapSearch || !markersSearch.length) return;
  var g = new L.featureGroup(markersSearch);
  try{ mapSearch.fitBounds(g.getBounds().pad(0.25)); }catch(e){}
}
function showMapFor(e){
  showPanel('mapPanel');
  setTimeout(function(){
    if (!topMap){
      topMap = L.map('map').setView([46.0569,14.5058], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap' }).addTo(topMap);
    }
    topMarkers.forEach(function(m){m.remove();}); topMarkers=[];
    if (e && e.venue && e.venue.lat && e.venue.lon){
      var m = L.marker([e.venue.lat, e.venue.lon]).addTo(topMap)
        .bindPopup('<b>'+(e.title||e.name)+'</b><br>'+((e.venue&&e.venue.address)||'')+'<br>'+formatDateRange(e.start,e.end));
      topMarkers.push(m);
      topMap.setView([e.venue.lat, e.venue.lon], 13);
      try{ m.openPopup(); }catch(err){}
    }
  },50);
}

/* SKUPNI handler za klike po karticah */
function commonCardClicks(ev){
  var t=ev.target;

  var more = t.closest ? t.closest('[data-more]') : null;
  if (more){ var id=more.getAttribute('data-more'); var box=document.getElementById('more-'+id); var less=document.querySelector('[data-less="'+id+'"]'); if(box){ box.style.display='block'; more.style.display='none'; if(less) less.style.display='inline-block'; } return; }

  var less = t.closest ? t.closest('[data-less]') : null;
  if (less){ var id2=less.getAttribute('data-less'); var box2=document.getElementById('more-'+id2); var more2=document.querySelector('[data-more="'+id2+'"]'); if(box2){ box2.style.display='none'; less.style.display='none'; if(more2) more2.style.display='inline-block'; } return; }

  var share = t.closest ? t.closest('[data-share]') : null;
  if (share){ var e=ITEMS_BY_ID.get(share.getAttribute('data-share')); if(e){ var text=(e.title||e.name||'')+' ‚Äî '+formatDateRange(e.start,e.end); var url=location.origin+'/#card-'+hashId(e); if(navigator.share){ navigator.share({title:'NearGo',text:text,url:url}).catch(function(){}); } else { var mail='mailto:?subject='+encodeURIComponent('Poglej: '+(e.title||e.name||''))+'&body='+encodeURIComponent(text+'\n\n'+url); location.href=mail; } } return; }

  var ics = t.closest ? t.closest('[data-ical]') : null;
  if (ics){ var e2=ITEMS_BY_ID.get(ics.getAttribute('data-ical')); if(e2) addToCalendar({title:e2.title||e2.name,start:e2.start,end:e2.end,loc:(e2.venue&&e2.venue.address)||''}); return; }

  var mapb= t.closest ? t.closest('[data-map]') : null;
  if (mapb){ var ee=ITEMS_BY_ID.get(mapb.getAttribute('data-map')); if(ee) showMapFor(ee); return; }

  var buy = t.closest ? t.closest('[data-buy]') : null;
  if (buy){ handleBuy(buy.getAttribute('data-buy'), buy.getAttribute('data-price'), buy.getAttribute('data-label'), buy.getAttribute('data-kind')); return; }
}

/* NAKUP (Stripe Checkout) */
async function handleBuy(id, price, label, kind){
  var e = ITEMS_BY_ID.get(id); if (!e) return;
  // ƒåe je zunanji vir, odpri URL in ne Stripe
  if (isExternalAPI(e) && e.url){ window.open(e.url,'_blank'); return; }

  var isCoupon = (kind==='coupon') || ((e.offerType||e.type)==='coupon');
  var metadata = {
    type: isCoupon ? 'coupon' : 'ticket',
    event_id: e.id || '',
    event_title: e.title || e.name || '',
    event_start_iso: e.start || '',
    event_venue: (e.venue&&e.venue.address)||'',
    image_url: (e.images && e.images[0]) || '',
    source: isExternalAPI(e)?'external':'neargo'
  };

  try{
    if (isCoupon){
      var body = { type:'coupon', metadata:metadata, freeForPremium: IS_PREMIUM ? true : false };
      var r = await fetch('/api/checkout', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body) }).then(function(r){return r.json();});
      if (r && r.url) location.href = r.url; else window._toast('Plaƒçilo (kupon) ni pripravljeno.', false);
    } else {
      var amount = price ? Number(price) : Number(e.price||0);
      var lineItems = amount>0 ? [{ name: (label||'Vstopnica'), amount: amount, quantity: 1, currency:'eur' }] : [];
      var r2 = await fetch('/api/checkout', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ lineItems, metadata }) }).then(function(r){return r.json();});
      if (r2 && r2.url) location.href = r2.url; else window._toast('Plaƒçilo (vstopnica) ni pripravljeno.', false);
    }
  }catch(err){
    window._toast('Napaka pri pripravi plaƒçila.', false);
  }
}

/* ======== ZA PONUDNIKE ‚Äì obrazec ======== */
/* (Premaknjeno sem, da FORM_CATS obstaja pred prvim klicem) */
var FORM_CATS = {
  event: ["Koncerti","Hrana & pijaƒça","Dru≈æina/otroci","≈†port","Kultura","Sejmi","Ostalo"],
  service: ["Lepota","Zdravje","Wellness","≈†port & fit","Uƒçenje","Servis","Ostalo"]
};
function refreshCategories(){
  var sel=$('#category'); var entry=$('#entryType'); if(!sel||!entry) return;
  var list = FORM_CATS[ entry.value==='service' ? 'service' : 'event' ];
  sel.innerHTML = list.map(function(x){return '<option value="'+x+'">'+x+'</option>';}).join('');
}

(function formOrg(){
  var entry    = $('#entryType');
  var offerSel = $('#offerType');
  var stockInp = $('#stock');
  var desc     = $('#desc'); var descCnt = $('#descCount');

  if (desc) desc.addEventListener('input', function(){ if(descCnt) descCnt.textContent = (desc.value.length)+' / 800'; }, false);

  function syncServiceBlock(){
    var isService = entry && entry.value === 'service';
    var sb = $('#svcBlock'), sw = $('#startWrap'), ew = $('#endWrap');
    if (sb) sb.style.display = isService ? '' : 'none';
    if (sw) sw.style.display = isService ? 'none' : '';
    if (ew) ew.style.display = isService ? 'none' : '';
    if (stockInp) { if (isService) stockInp.removeAttribute('required'); else stockInp.setAttribute('required','required'); }
    refreshCategories();
  }
  if (entry) entry.addEventListener('change', syncServiceBlock, false); syncServiceBlock();

  var pt=$('#svcPriceType');
  if (pt) pt.addEventListener('change', function(){ var r=$('#svcFixedRow'); if(r) r.style.display = (pt.value==='FIXED' ? '' : 'none'); }, false);

  (function serviceAvailabilityUI(){
    var radios = $$('input[name="svcAvail"]');
    var callRow = $('#svcCallRow'), calRow = $('#svcCalendarRow'), phone = $('#svcPhone');
    function refresh(){
      var val='call'; for(var i=0;i<radios.length;i++){ if(radios[i].checked){ val=radios[i].value; break; } }
      var isCall = (val === 'call');
      if (callRow) callRow.style.display = isCall ? '' : 'none';
      if (calRow)  calRow.style.display  = !isCall ? '' : 'none';
      if (phone) { if (isCall) phone.required=true; else phone.required=false; }
    }
    radios.forEach(function(r){ r.addEventListener('change', refresh, false); });
    refresh();
  })();

  function syncEventCoupon(){
    var show = (entry && entry.value==='event' && offerSel && offerSel.value==='coupon');
    var b=$('#evtCouponBlock'); if (b) b.style.display = show ? '' : 'none';
  }
  if (offerSel) offerSel.addEventListener('change', syncEventCoupon, false);
  if (entry) entry.addEventListener('change', syncEventCoupon, false); syncEventCoupon();

  (function bindSvcCouponToggle(){
    var kind=$('#couponKind'), p=$('#couponPercent'), v=$('#couponValue'), f=$('#couponFreebie');
    var lP=$('#lblPercent'),  lV=$('#lblValue'),      lF=$('#lblFreebie');
    function toggle(){
      if(lP) lP.style.display='none'; if(lV) lV.style.display='none'; if(lF) lF.style.display='none';
      if(p) p.required=false; if(v) v.required=false; if(f) f.required=false;
      if (!kind) return;
      if (kind.value==='PERCENT'){ if(lP) lP.style.display='block'; if(p) p.required=true; }
      if (kind.value==='VALUE'){   if(lV) lV.style.display='block'; if(v) v.required=true; }
      if (kind.value==='FREEBIE'){ if(lF) lF.style.display='block'; if(f) f.required=true; }
    }
    if (kind) kind.addEventListener('change', toggle, false); toggle();
  })();

  (function bindEvtCouponToggle(){
    var kind=$('#evtCouponKind'), p=$('#evtCouponPercent'), v=$('#evtCouponValue'), f=$('#evtCouponFreebie');
    var lP=$('#evtLblPercent'),  lV=$('#evtLblValue'),      lF=$('#evtLblFreebie');
    function toggle(){
      if(lP) lP.style.display='none'; if(lV) lV.style.display='none'; if(lF) lF.style.display='none';
      if(p) p.required=false; if(v) v.required=false; if(f) f.required=false;
      if (!kind) return;
      if (kind.value==='PERCENT'){ if(lP) lP.style.display='block'; if(p) p.required=true; }
      if (kind.value==='VALUE'){   if(lV) lV.style.display='block'; if(v) v.required=true; }
      if (kind.value==='FREEBIE'){ if(lF) lF.style.display='block'; if(f) f.required=true; }
    }
    if (kind) kind.addEventListener('change', toggle, false); toggle();
  })();

  var btnAddTP = $('#btnAddTicketPrice');
  if (btnAddTP) btnAddTP.addEventListener('click', function(){
    var host = $('#ticketStepList'); if(!host) return; var row = el('div','always-two');
    row.innerHTML = '<input class="tp-label" placeholder="Naziv (npr. Osnovna)">'+
                    '<div class="euro"><input class="tp-price" type="number" min="0" step="0.01" placeholder="Cena"><span>‚Ç¨</span></div>';
    host.appendChild(row);
  }, false);
  function syncTicketBlock(){
    var isTicket = (offerSel && offerSel.value==='ticket');
    var isCoupon = (offerSel && offerSel.value==='coupon');
    var tb=$('#ticketPricesBlock'), pw=$('#priceWrap'), eb=$('#evtCouponBlock');
    if (tb) tb.style.display = isTicket ? '' : 'none';
    if (pw) pw.style.display = isTicket ? '' : 'none';
    if (eb) eb.style.display = isCoupon ? '' : 'none';
  }
  if (offerSel) offerSel.addEventListener('change', syncTicketBlock, false); syncTicketBlock();

  // Predogled slike
  (function imagePreview(){
    var inp=$('#image'), name=$('#fileName'), prev=$('#imgPreview');
    if (!inp) return;
    inp.addEventListener('change', function(){
      var f = inp.files && inp.files[0];
      if(name) name.textContent = f ? f.name : 'Fotografija ni izbrana';
      if (f){ if(prev){ prev.src = URL.createObjectURL(f); prev.style.display='block'; } }
      else { if(prev){ prev.removeAttribute('src'); prev.style.display='none'; } }
    }, false);
  })();

  // Featured -> paket
  var featured=$('#featured');
  if (featured) featured.addEventListener('change', async function(){
    if (!featured.checked) return;
    try{
      var s = await fetch('/api/iap/status').then(function(r){return r.json();});
      PROVIDER_PLAN = (s && s.providerPlan) ? s.providerPlan : 'free';
    }catch(err){ PROVIDER_PLAN='free'; }
    if (PROVIDER_PLAN==='free'){
      var msg=$('#featMsg'); if(msg) msg.textContent='Za izpostavitev potrebuje≈° paket Grow/Pro.';
      var go = confirm('Za izpostavitve je potreben paket (Grow/Pro). ≈Ωeli≈° nadgraditi?');
      if (go){ showPanel('plansPanel'); }
      featured.checked=false;
    }else{
      var msg2=$('#featMsg'); if(msg2) msg2.textContent='Izpostavljena objava bo aktivirana po potrditvi.';
    }
  }, false);

  var btnSubmit=$('#btnSubmitEvent'); if(btnSubmit) btnSubmit.addEventListener('click', submitProvider, false);
  async function submitProvider(){
    var agree=$('#agreeFees'); if(agree && !agree.checked){ window._toast('Potrdi pogoje za plaƒçljive ponudbe.', false); return; }

    var payload = collectForm(); if (!payload) return;

    // upload slike (ƒçe je)
    var imagePublicUrl=null; var imgInp=$('#image'); var f = imgInp && imgInp.files && imgInp.files[0];
    if (f){
      var fd=new FormData(); fd.append('file', f);
      try{
        var up=await fetch('/api/provider-upload',{method:'POST',body:fd}).then(function(r){return r.json();});
        if (up && up.ok && up.publicUrl) imagePublicUrl=up.publicUrl;
      }catch(e){}
    }
    if (imagePublicUrl) payload.imagePublicUrl = imagePublicUrl;

    // Osnovna cena med ticketPrices (ƒçe je potrebno)
    if (payload.entryType==='event' && payload.offerType==='ticket' && Number(payload.price||0)>0){
      payload.ticketPrices = Array.isArray(payload.ticketPrices) ? payload.ticketPrices.slice() : [];
      var base = Number(payload.price||0);
      var has=false; for(var i=0;i<payload.ticketPrices.length;i++){ if(Number(payload.ticketPrices[i].price)===base){ has=true; break; } }
      if (!has) payload.ticketPrices.unshift({ label:'Osnovna', price: base });
    }

    try{
      var r = await fetch('/api/provider-submit', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload) });
      var j = await r.json().catch(function(){return null;});
      if (r.ok && j && j.ok){
        window._toast('‚úÖ Oddaja uspe≈°na. Potrditev je na e-po≈°ti.', true);
        var m=$('#orgMsg'); if(m){ m.textContent='Oddaja uspe≈°na ‚Äì potrditev je na e-po≈°ti.'; setTimeout(function(){m.textContent='';},3500); }
      }else{
        window._toast('Napaka: '+((j&&j.error) || r.statusText), false);
      }
    }catch(err){
      window._toast('Napaka pri po≈°iljanju.', false);
    }
  }

  function collectForm(){
    var entry=$('#entryType'), org=$('#orgName'), ofn=$('#orgFullName'), mail=$('#orgEmail'),
        name=$('#eventName'), venue=$('#venue'), country=$('#country'), city=$('#city2'), url=$('#url'), desc=$('#desc');
    var type = entry ? entry.value : 'event';
    var orgV=org?org.value.trim():'', ofnV=ofn?ofn.value.trim():'', mailV=mail?mail.value.trim():'';
    var nameV=name?name.value.trim():'', venV=venue?venue.value.trim():'', cntV=country?country.value:'', cityV=city?city.value.trim():'', urlV=url?url.value.trim():'', descV=desc?desc.value.trim():'';
    if (!orgV || !ofnV || !mailV || !nameV || !venV || !cntV || !cityV || !descV){ window._toast('Izpolni polja z *', false); return null; }

    var offerSel=$('#offerType'); var offerType = offerSel ? offerSel.value : 'none';
    var feat=$('#featured'); var featured = feat ? !!feat.checked : false;

    var payload = {
      entryType: type, type:type, organizer:orgV, organizerFullName:ofnV, organizerEmail:mailV,
      eventName:nameV, venue:venV, country:cntV, city2:cityV, url:urlV, description:descV,
      offerType:offerType, saleType:offerType, featured:featured
    };

    if (type==='event'){
      var st=$('#start'), en=$('#end'); payload.start = st?st.value:''; payload.end = en?en.value:'';
      if (offerType==='ticket'){
        var base = Number(($('#price') && $('#price').value) || 0); if (base>0) payload.price=base;
        var rows=$$('#ticketStepList .always-two');
        var tps=[]; rows.forEach(function(r){
          var lbl=r.querySelector('.tp-label'), pr=r.querySelector('.tp-price');
          var p=Number(pr && pr.value || 0); if (p>0) tps.push({label:(lbl && lbl.value) || 'Vstopnica', price:p});
        });
        if (tps.length) payload.ticketPrices=tps;
        var stc=$('#stock'); if(stc) payload.stock=stc.value;
      }
      if (offerType==='coupon'){
        var k=$('#evtCouponKind'); payload.couponKind = k ? k.value : '';
        if (payload.couponKind==='PERCENT') payload.couponPercentOff = Number(($('#evtCouponPercent')&&$('#evtCouponPercent').value)||0);
        if (payload.couponKind==='VALUE')   payload.couponValueEur   = Number(($('#evtCouponValue')&&$('#evtCouponValue').value)||0);
        if (payload.couponKind==='FREEBIE') payload.couponFreebieLabel= ($('#evtCouponFreebie')&&$('#evtCouponFreebie').value||'').trim();
        var stc2=$('#stock'); if(stc2) payload.stock=stc2.value;
      }
    } else {
      var radios = $$('input[name="svcAvail"]'); var val='call'; for(var i=0;i<radios.length;i++){ if(radios[i].checked){ val=radios[i].value; break; } }
      var service = { availability: (val==='calendar'?'scheduled':'unlimited') };
      var phone=$('#svcPhone'); if (val==='call' && phone) service.phone=phone.value.trim();
      var pt=$('#svcPriceType'); if (pt && pt.value==='FIXED'){ var fp=$('#svcFixedPrice'); service.price = Number(fp && fp.value || 0); }
      else if (pt && pt.value==='RATECARD'){ var ru=$('#svcRateUrl'); if(ru && ru.value.trim()) service.rateUrl = ru.value.trim(); }
      payload.service = service;

      payload.offerType='coupon'; payload.saleType='coupon';
      var kind=$('#couponKind'); payload.couponKind = kind ? kind.value : '';
      if (payload.couponKind==='PERCENT') payload.couponPercentOff = Number(($('#couponPercent')&&$('#couponPercent').value)||0);
      if (payload.couponKind==='VALUE')   payload.couponValueEur   = Number(($('#couponValue')&&$('#couponValue').value)||0);
      if (payload.couponKind==='FREEBIE') payload.couponFreebieLabel= ($('#couponFreebie')&&$('#couponFreebie').value||'').trim();

      var stc3=$('#stock'); if(stc3 && stc3.value!=='') payload.stock = stc3.value; // opcijsko
    }
    return payload;
  }
})();

/* BOOST & PREMIUM + PAKETI */
var hb=$("#hubBoost"); if(hb) hb.addEventListener('click', async function(){
  try{ var r = await fetch('/api/iap/boost-start', { method:'POST' }).then(function(r){return r.json();}); if (r && r.url) location.href=r.url; }catch(e){ window._toast('Boost ni na voljo.', false); }
}, false);
var bgp=$("#btnGoPremium"); if(bgp) bgp.addEventListener('click', async function(){
  try{ var r = await fetch('/api/iap/start', { method:'POST' }).then(function(r){return r.json();}); if (r && r.url) location.href=r.url; }catch(e){ window._toast('Premium nakup ni na voljo.', false); }
}, false);
var ben=$("#btnEarlyNotify"); if(ben) ben.addEventListener('click', async function(){
  try{
    var ok = confirm('Predƒçasna obvestila so na voljo v Premium. Vklopim (ali nadgradim)?'); if (!ok) return;
    localStorage.setItem('ng_early_notify', '1');
    var payload = { type:'early_notify_optin', lat: (GEO && GEO.lat) || null, lon: (GEO && GEO.lon) || null };
    fetch('/api/analytics', { method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(payload) }).catch(function(){});
    window._toast('Predƒçasna obvestila vkljuƒçena (Premium).', true);
  }catch(e){}
}, false);
$('#plansPanel') && $('#plansPanel').addEventListener('click', function(e){
  var b = e.target && e.target.closest ? e.target.closest('[data-start-plan]') : null;
  if (!b) return;
  var plan = b.getAttribute('data-start-plan');
  fetch('/api/iap/provider-start?plan='+encodeURIComponent(plan), { method:'POST' })
    .then(function(r){return r.json();})
    .then(function(j){ if(j && j.url) location.href=j.url; else window._toast('Nakup paketa ni na voljo.', false); })
    .catch(function(){ window._toast('Napaka pri zagonu nakupa paketa.', false); });
}, false);

/* ‚ÄúMoje‚Äù znaƒçka */
(function updateMineBadge(){
  var badge = $('#pointsBadge'); if (!badge) return;
  try{
    var savedEmail = localStorage.getItem('user_email') || '';
    if (!savedEmail) return;
    fetch('/api/purchase-lookup?email='+encodeURIComponent(savedEmail))
      .then(function(r){return r.json();})
      .then(function(j){
        var arr = (j && (j.items || j.results)) ? (j.items || j.results) : [];
        var n = arr.length || 0;
        if (n>0){ badge.style.display='inline-block'; badge.textContent = String(n); }
      }).catch(function(){});
  }catch(e){}
})();

/* PREMIUM status */
(async function detectPremium(){
  try{
    var s = await fetch('/api/iap/status').then(function(r){return r.json();});
    IS_PREMIUM = !!(s && (s.premium===true || s.tier==='premium'));
  }catch(e){ IS_PREMIUM=false; }
})();

/* Mini toƒçke */
(function pointsLite(){
  var badge = $('#pointsBadge'); if (!badge) return;
  function add(k){ try{ var v = Number(localStorage.getItem('ng_points')||0) + k; localStorage.setItem('ng_points', v); badge.style.display='inline-block'; badge.textContent=String(v); }catch(e){} }
  var car = $('#carousel'); if (car) car.addEventListener('click', function(e){ if (e.target && e.target.closest && e.target.closest('.spot')) add(1); }, false);
  var res = $('#results');  if (res) res.addEventListener('click', function(e){ if (e.target && e.target.closest && e.target.closest('.spot')) add(1); }, false);
})();

/* Start: izpostavljeno + prva iskanja */
loadFeatured();
doSearch(0);
  </script>
</body>
</html>
